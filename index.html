<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI UI Comparator</title>
    <!-- Favicon - 琥珀金色主题 -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23f59e0b;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%23d97706;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' rx='16' fill='%230c0a09'/%3E%3Crect x='8' y='8' width='84' height='84' rx='12' fill='none' stroke='url(%23grad)' stroke-width='2'/%3E%3Ctext x='50' y='68' font-size='48' text-anchor='middle' fill='url(%23grad)' font-family='system-ui'%3E◈%3C/text%3E%3C/svg%3E" type="image/svg+xml">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23f59e0b;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%23d97706;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' rx='16' fill='%230c0a09'/%3E%3Crect x='8' y='8' width='84' height='84' rx='12' fill='none' stroke='url(%23grad)' stroke-width='2'/%3E%3Ctext x='50' y='68' font-size='48' text-anchor='middle' fill='url(%23grad)' font-family='system-ui'%3E◈%3C/text%3E%3C/svg%3E">
    
    <!-- 字体：Plus Jakarta Sans -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Plus Jakarta Sans', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        surface: {
                            DEFAULT: '#0c0a09',
                            raised: '#1c1917',
                            overlay: '#292524',
                        },
                        accent: {
                            DEFAULT: '#f59e0b',
                            hover: '#fbbf24',
                            muted: '#92400e',
                        },
                        mint: {
                            DEFAULT: '#34d399',
                            muted: '#065f46',
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        /* ═══════════════════════════════════════════════════════════
           DESIGN SYSTEM: Dark Editorial
           - Deep ink backgrounds with subtle warmth
           - Amber/gold accents for primary actions
           - Mint/emerald for success states
           - Refined typography with generous spacing
        ═══════════════════════════════════════════════════════════ */
        
        :root {
            --surface: #0c0a09;
            --surface-raised: #1c1917;
            --surface-overlay: #292524;
            --border-subtle: rgba(255, 255, 255, 0.08);
            --border-default: rgba(255, 255, 255, 0.12);
            --text-primary: #fafaf9;
            --text-secondary: #a8a29e;
            --text-muted: #78716c;
            --accent: #f59e0b;
            --accent-hover: #fbbf24;
            --accent-glow: rgba(245, 158, 11, 0.25);
            --mint: #34d399;
            --error: #f87171;
        }
        
        /* 基础样式 */
        body {
            background: var(--surface);
            background-image: 
                radial-gradient(ellipse 80% 50% at 50% -20%, rgba(245, 158, 11, 0.08), transparent),
                radial-gradient(ellipse 60% 40% at 100% 100%, rgba(52, 211, 153, 0.05), transparent);
            min-height: 100vh;
            color: var(--text-primary);
            font-feature-settings: 'cv11', 'ss01';
            letter-spacing: -0.01em;
        }
        
        /* 噪点纹理叠加 */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
            opacity: 0.02;
            pointer-events: none;
            z-index: 1000;
        }
        
        /* 卡片样式 */
        .card {
            background: var(--surface-raised);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card:hover {
            border-color: var(--border-default);
            box-shadow: 0 0 0 1px var(--border-default);
        }
        
        .card-glow {
            background: var(--surface-raised);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            position: relative;
            overflow: hidden;
        }
        
        .card-glow::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .card-glow:hover::before {
            opacity: 0.6;
        }
        
        /* 玻璃态效果 - 深色版本 */
        .glass {
            background: rgba(28, 25, 23, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border-subtle);
            box-shadow: 
                0 4px 6px -1px rgba(0, 0, 0, 0.3),
                0 2px 4px -2px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 0 rgba(255, 255, 255, 0.03);
        }
        
        .glass-dark {
            background: rgba(41, 37, 36, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border-subtle);
        }
        
        .glass-dark:hover {
            background: rgba(41, 37, 36, 0.8);
            border-color: var(--border-default);
        }
        
        /* 主按钮 */
        .btn-primary {
            background: linear-gradient(135deg, var(--accent) 0%, #d97706 100%);
            color: #0c0a09;
            font-weight: 700;
            letter-spacing: 0.02em;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, var(--accent-hover) 0%, var(--accent) 100%);
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 10px 40px -10px var(--accent-glow),
                0 4px 12px -4px rgba(0, 0, 0, 0.5);
        }
        
        .btn-primary:hover::before {
            opacity: 1;
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .btn-primary span {
            position: relative;
            z-index: 1;
        }
        
        /* 次要按钮 */
        .btn-secondary {
            background: var(--surface-overlay);
            border: 1px solid var(--border-default);
            color: var(--text-primary);
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .btn-secondary:hover {
            background: rgba(41, 37, 36, 0.9);
            border-color: var(--accent);
            color: var(--accent);
        }
        
        /* 输入框 */
        .input-field {
            background: var(--surface);
            border: 1px solid var(--border-subtle);
            color: var(--text-primary);
            transition: all 0.2s ease;
        }
        
        .input-field::placeholder {
            color: var(--text-muted);
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }
        
        /* 加载动画 - 更优雅的版本 */
        .spinner {
            width: 40px;
            height: 40px;
            border: 2px solid var(--surface-overlay);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* 脉冲发光动画 */
        @keyframes pulse-glow {
            0%, 100% { 
                box-shadow: 0 0 20px var(--accent-glow);
                opacity: 1;
            }
            50% { 
                box-shadow: 0 0 40px var(--accent-glow);
                opacity: 0.8;
            }
        }
        
        .pulse-glow {
            animation: pulse-glow 2s ease-in-out infinite;
        }
        
        /* 图片卡片 */
        .image-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: center;
        }
        
        .image-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 
                0 20px 40px -12px rgba(0, 0, 0, 0.5),
                0 0 0 1px var(--border-default);
        }
        
        /* 错落入场动画 */
        @keyframes card-enter {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.96);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .card-animate {
            animation: card-enter 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            opacity: 0;
        }
        
        .card-animate:nth-child(1) { animation-delay: 0ms; }
        .card-animate:nth-child(2) { animation-delay: 80ms; }
        .card-animate:nth-child(3) { animation-delay: 160ms; }
        .card-animate:nth-child(4) { animation-delay: 240ms; }
        .card-animate:nth-child(5) { animation-delay: 320ms; }
        .card-animate:nth-child(6) { animation-delay: 400ms; }
        
        /* 标签/徽章 */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.04em;
            text-transform: uppercase;
        }
        
        .badge-accent {
            background: rgba(245, 158, 11, 0.15);
            color: var(--accent);
            border: 1px solid rgba(245, 158, 11, 0.2);
        }
        
        .badge-mint {
            background: rgba(52, 211, 153, 0.15);
            color: var(--mint);
            border: 1px solid rgba(52, 211, 153, 0.2);
        }
        
        .badge-error {
            background: rgba(248, 113, 113, 0.15);
            color: var(--error);
            border: 1px solid rgba(248, 113, 113, 0.2);
        }
        
        /* 自定义滚动条 */
        .scrollbar-styled::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        .scrollbar-styled::-webkit-scrollbar-track {
            background: var(--surface);
            border-radius: 3px;
        }
        
        .scrollbar-styled::-webkit-scrollbar-thumb {
            background: var(--surface-overlay);
            border-radius: 3px;
        }
        
        .scrollbar-styled::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
        
        /* 隐藏滚动条 */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* 选择框样式 */
        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23a8a29e'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
            appearance: none;
        }
        
        /* 复选框自定义样式 */
        input[type="checkbox"] {
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid var(--border-default);
            border-radius: 4px;
            background: var(--surface);
            cursor: pointer;
            transition: all 0.15s ease;
            position: relative;
        }
        
        input[type="checkbox"]:checked {
            background: var(--accent);
            border-color: var(--accent);
        }
        
        input[type="checkbox"]:checked::after {
            content: '';
            position: absolute;
            left: 5px;
            top: 2px;
            width: 5px;
            height: 9px;
            border: solid #0c0a09;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }
        
        input[type="checkbox"]:focus {
            box-shadow: 0 0 0 3px var(--accent-glow);
        }
        
        /* 单选框自定义样式 */
        input[type="radio"] {
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid var(--border-default);
            border-radius: 50%;
            background: var(--surface);
            cursor: pointer;
            transition: all 0.15s ease;
            position: relative;
        }
        
        input[type="radio"]:checked {
            border-color: var(--accent);
        }
        
        input[type="radio"]:checked::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }
        
        input[type="radio"]:focus {
            box-shadow: 0 0 0 3px var(--accent-glow);
        }
        
        /* 模态框背景动画 */
        .modal-backdrop {
            animation: fade-in 0.2s ease;
        }
        
        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* 文字渐变效果 */
        .text-gradient {
            background: linear-gradient(135deg, var(--accent) 0%, #fcd34d 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* 分隔线 */
        .divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--border-subtle), transparent);
        }
        
        /* 提示框样式 */
        .tip-box {
            background: rgba(245, 158, 11, 0.08);
            border: 1px solid rgba(245, 158, 11, 0.2);
            border-radius: 10px;
            padding: 12px 16px;
        }
        
        .tip-box-info {
            background: rgba(96, 165, 250, 0.08);
            border: 1px solid rgba(96, 165, 250, 0.2);
        }
        
        /* 头部标题装饰 */
        .title-decoration {
            position: relative;
        }
        
        .title-decoration::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 0;
            width: 40px;
            height: 3px;
            background: var(--accent);
            border-radius: 2px;
        }
    </style>
</head>
<body class="p-4 md:p-8 font-sans antialiased">
    <div class="max-w-7xl mx-auto relative">
        <!-- Header -->
        <header class="glass rounded-2xl p-5 mb-8 border border-stone-800/50">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <!-- Logo -->
                    <div class="w-11 h-11 rounded-xl bg-gradient-to-br from-amber-500 to-amber-600 flex items-center justify-center shadow-lg shadow-amber-500/20">
                        <span class="text-stone-900 text-xl font-bold">◈</span>
                    </div>
                <div>
                        <h1 class="text-2xl font-bold tracking-tight">
                            <span class="text-gradient">AI UI</span>
                            <span class="text-stone-100"> Comparator</span>
                        </h1>
                        <p class="text-stone-500 text-sm mt-0.5">多模型 UI 设计对比生成器</p>
                </div>
                </div>
                <div class="flex gap-3">
                    <button onclick="showHistory()" class="btn-secondary px-4 py-2.5 rounded-xl text-sm flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        历史记录
                    </button>
                    <button onclick="showSettings()" class="btn-secondary px-4 py-2.5 rounded-xl text-sm flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        设置
                </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="grid md:grid-cols-12 gap-6">
            <!-- Left: Input Panel -->
            <div class="md:col-span-4">
                <div class="glass rounded-2xl p-6 sticky top-4 max-h-[calc(100vh-2rem)] overflow-y-auto scrollbar-styled">
                    <h2 class="text-lg font-bold text-stone-100 mb-5 flex items-center gap-2">
                        <span class="w-8 h-8 rounded-lg bg-amber-500/10 flex items-center justify-center">
                            <svg class="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                        </span>
                        输入需求
                    </h2>
                    
                    <!-- Prompt Input -->
                    <div class="mb-5">
                        <label class="text-stone-400 text-xs font-medium mb-2 block uppercase tracking-wider">描述你想要的UI界面</label>
                        <div class="relative">
                        <textarea 
                            id="promptInput"
                                rows="4"
                                maxlength="500"
                                class="w-full p-4 pr-16 pb-16 rounded-xl input-field resize-none text-sm leading-relaxed"
                                placeholder="例如：极简风格的移动APP登录页面，包含logo、邮箱输入、密码输入、登录按钮..."
                        ></textarea>
                            
                            <!-- 图片上传区域（左下角） -->
                            <div class="absolute bottom-5 left-3 flex items-center gap-2 flex-wrap">
                                <div id="referenceImagesContainer" class="flex items-center gap-2 flex-wrap"></div>
                                <input 
                                    type="file" 
                                    id="referenceImageInput" 
                                    accept="image/*" 
                                    class="hidden"
                                    onchange="handleImageUpload(event)"
                                    multiple
                                >
                                <button 
                                    type="button"
                                    onclick="document.getElementById('referenceImageInput').click()"
                                    class="w-9 h-9 flex items-center justify-center bg-stone-800 hover:bg-stone-700 text-stone-400 hover:text-amber-500 rounded-lg transition border border-stone-700"
                                    title="添加参考图片"
                                >
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                </button>
                            </div>
                            
                            <!-- 字符计数（右下角） -->
                            <div class="absolute bottom-4 right-4 text-stone-600 text-xs font-mono">
                                <span id="charCount">0</span><span class="text-stone-700">/500</span>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Templates -->
                    <div class="mb-5">
                        <label class="text-stone-400 text-xs font-medium mb-2 block uppercase tracking-wider">快捷模板</label>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="useTemplate('dashboard')" class="text-xs bg-stone-800/50 hover:bg-stone-800 text-stone-400 hover:text-amber-500 font-medium px-3 py-1.5 rounded-lg transition border border-stone-700/50 hover:border-amber-500/30">理财仪表盘</button>
                            <button onclick="useTemplate('search-result')" class="text-xs bg-stone-800/50 hover:bg-stone-800 text-stone-400 hover:text-amber-500 font-medium px-3 py-1.5 rounded-lg transition border border-stone-700/50 hover:border-amber-500/30">搜索场内</button>
                            <button onclick="useTemplate('campaign')" class="text-xs bg-stone-800/50 hover:bg-stone-800 text-stone-400 hover:text-amber-500 font-medium px-3 py-1.5 rounded-lg transition border border-stone-700/50 hover:border-amber-500/30">运营活动</button>
                        </div>
                    </div>

                    <div class="divider my-5"></div>

                        <!-- Platform Selection -->
                    <div class="mb-5">
                        <label class="text-stone-400 text-xs font-medium mb-3 block uppercase tracking-wider">目标平台</label>
                        <div class="grid grid-cols-2 gap-3">
                            <label class="flex items-center justify-center gap-2 bg-stone-800/30 hover:bg-stone-800/50 p-3 rounded-xl cursor-pointer transition border border-stone-700/50 has-[:checked]:border-amber-500/50 has-[:checked]:bg-amber-500/10">
                                <input type="radio" name="platform" value="mobile" class="sr-only" checked>
                                <svg class="w-5 h-5 text-stone-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                                <span class="text-stone-300 font-medium text-sm">手机端</span>
                            </label>
                            <label class="flex items-center justify-center gap-2 bg-stone-800/30 hover:bg-stone-800/50 p-3 rounded-xl cursor-pointer transition border border-stone-700/50 has-[:checked]:border-amber-500/50 has-[:checked]:bg-amber-500/10">
                                <input type="radio" name="platform" value="desktop" class="sr-only">
                                <svg class="w-5 h-5 text-stone-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                                <span class="text-stone-300 font-medium text-sm">PC端</span>
                            </label>
                        </div>
                    </div>

                    <!-- Model Selection -->
                    <div class="mb-5">
                        <label class="text-stone-400 text-xs font-medium mb-3 block uppercase tracking-wider">选择AI模型</label>
                        <div class="space-y-2 max-h-52 overflow-y-auto scrollbar-styled pr-1" id="modelSelectionList">
                                <!-- 模型列表将在这里动态生成 -->
                        </div>
                    </div>

                    <!-- Cost Estimate and Generate Button -->
                    <div class="mt-6">
                        <div class="bg-stone-800/50 p-4 rounded-t-xl border border-stone-700/50 border-b-0">
                            <div class="flex justify-between items-center">
                                <span class="text-stone-400 text-sm">预计成本</span>
                                <span id="costEstimate" class="text-amber-500 font-bold font-mono text-lg">$0.00</span>
                        </div>
                    </div>
                    <button 
                        onclick="startGeneration()"
                        id="generateBtn"
                            class="w-full btn-primary py-4 rounded-b-xl rounded-t-none text-base flex items-center justify-center gap-2"
                    >
                            <span>开始生成</span>
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    </button>
                    </div>
                </div>
            </div>

            <!-- Right: Results Panel -->
            <div class="md:col-span-8">
                <!-- Progress -->
                <div id="progressSection" class="glass rounded-2xl p-6 mb-6 hidden">
                    <h2 class="text-lg font-bold text-stone-100 mb-4 flex items-center gap-2">
                        <div class="spinner w-5 h-5"></div>
                        生成进度
                    </h2>
                    <div class="space-y-3" id="progressList"></div>
                </div>

                <!-- Results -->
                <div id="resultsContainer" class="glass rounded-2xl p-6 flex flex-col min-h-[600px]">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-lg font-bold text-stone-100 flex items-center gap-2">
                            <span class="w-8 h-8 rounded-lg bg-emerald-500/10 flex items-center justify-center">
                                <svg class="w-4 h-4 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            </span>
                            生成结果
                        </h2>
                        <span id="totalCostDisplay" class="text-sm text-stone-500 hidden">
                            本次花费 <span id="totalCostValue" class="font-mono text-amber-500">$0.00</span>
                        </span>
                    </div>
                    <div id="resultsGrid" class="grid grid-cols-1 sm:grid-cols-2 gap-5 flex-1 items-start">
                        <!-- Empty State -->
                        <div class="col-span-2 flex items-center justify-center text-center min-h-[450px]">
                            <div class="max-w-sm">
                                <div class="w-20 h-20 mx-auto mb-6 rounded-2xl bg-stone-800/50 flex items-center justify-center border border-stone-700/50">
                                    <svg class="w-10 h-10 text-stone-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                </div>
                                <h3 class="text-stone-300 font-semibold mb-2">准备开始创作</h3>
                                <p class="text-stone-500 text-sm leading-relaxed">输入你的 UI 设计需求，选择想要对比的 AI 模型，点击生成按钮即可开始</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black/70 backdrop-blur-md hidden items-center justify-center p-4 z-50 modal-backdrop">
        <div class="glass rounded-2xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto scrollbar-styled border border-stone-700/50">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold text-stone-100 flex items-center gap-3">
                    <span class="w-10 h-10 rounded-xl bg-stone-800 flex items-center justify-center">
                        <svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    </span>
                    设置
                </h2>
                <button onclick="closeSettings()" class="w-10 h-10 rounded-xl bg-stone-800 hover:bg-stone-700 flex items-center justify-center text-stone-400 hover:text-stone-200 transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <!-- API Key 配置 -->
            <div class="mb-6">
                <label class="text-stone-400 text-xs font-medium mb-3 block uppercase tracking-wider">OpenRouter API Key（可选）</label>
                <div class="tip-box-info mb-3">
                    <p class="text-blue-400 text-xs flex items-start gap-2">
                        <svg class="w-4 h-4 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span>如果不填写，将使用服务器端的公用 API Key。填写你自己的 API Key 后，将优先使用你的 Key。</span>
                    </p>
                </div>
                <input 
                    type="password" 
                    id="apiKeyInput"
                    placeholder="sk-or-v1-..." 
                    class="w-full p-3 rounded-xl input-field text-sm"
                >
                <p class="text-stone-500 text-xs mt-2">
                    获取 API Key：<a href="https://openrouter.ai/keys" target="_blank" class="text-amber-500 hover:text-amber-400 hover:underline">openrouter.ai/keys</a>
                </p>
            </div>

            <div class="divider my-6"></div>

            <!-- Model Selection -->
            <div class="mb-6">
                <div class="flex items-center justify-between mb-3">
                    <label class="text-stone-400 text-xs font-medium block uppercase tracking-wider">选择AI模型</label>
                    <button onclick="resetToDefaultModels()" class="text-xs bg-stone-800 hover:bg-stone-700 text-stone-400 hover:text-amber-500 font-medium px-3 py-1.5 rounded-lg transition border border-stone-700">
                        恢复默认
                </button>
            </div>
                <div class="tip-box mb-3">
                    <p class="text-amber-400/80 text-xs flex items-start gap-2">
                        <svg class="w-4 h-4 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                        <span>至少需要选择一个模型才能生成内容</span>
                    </p>
                    </div>
                <div id="settingsModelList" class="space-y-2 max-h-80 overflow-y-auto scrollbar-styled pr-1">
                    <!-- 模型列表将在这里动态生成 -->
                </div>
            </div>

            <div class="divider my-6"></div>

            <!-- Debug Mode -->
            <div class="mb-6">
                <label class="flex items-center cursor-pointer group">
                    <input type="checkbox" id="debugMode" class="mr-3">
                    <span class="text-stone-300 text-sm font-medium group-hover:text-stone-100 transition">启用调试模式</span>
                </label>
                <p class="text-stone-500 text-xs mt-2 ml-7">
                    开启后会在控制台显示详细的 API 请求和响应信息
                </p>
            </div>

            <div class="flex gap-3 mt-8">
                <button onclick="saveSettings()" class="flex-1 btn-primary py-3.5 rounded-xl font-semibold">
                    <span>保存设置</span>
                </button>
                <button onclick="closeSettings()" class="flex-1 btn-secondary py-3.5 rounded-xl font-semibold">
                    取消
                </button>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="fixed inset-0 bg-black/70 backdrop-blur-md hidden items-center justify-center p-4 z-50 modal-backdrop">
        <div class="glass rounded-2xl p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto scrollbar-styled border border-stone-700/50">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold text-stone-100 flex items-center gap-3">
                    <span class="w-10 h-10 rounded-xl bg-stone-800 flex items-center justify-center">
                        <svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </span>
                    生成历史
                </h2>
                <button onclick="closeHistory()" class="w-10 h-10 rounded-xl bg-stone-800 hover:bg-stone-700 flex items-center justify-center text-stone-400 hover:text-stone-200 transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <!-- 花费明细统计 -->
            <div id="costStatistics" class="mb-5 bg-stone-800/50 rounded-xl p-4 border border-stone-700/50 hidden">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-sm font-semibold text-stone-200 flex items-center gap-2">
                        <svg class="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        花费统计
                    </h3>
                    <button id="toggleCostStats" onclick="toggleCostStatistics()" class="text-xs bg-stone-700 hover:bg-stone-600 text-stone-300 font-medium px-3 py-1.5 rounded-lg transition">
                        <span id="toggleCostStatsText">展开详情</span>
                    </button>
                </div>
                <div id="costStatsSummary" class="text-sm text-stone-300">
                    <!-- 默认显示的摘要信息 -->
                </div>
                <div id="costStatsDetails" class="space-y-2 text-sm hidden mt-4 pt-4 border-t border-stone-700/50">
                    <!-- 详细统计内容将在这里动态加载 -->
                </div>
            </div>
            
            <!-- 搜索和筛选 -->
            <div class="mb-5 space-y-3">
                <div class="flex gap-3">
                    <div class="flex-1 relative">
                        <svg class="w-4 h-4 text-stone-500 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    <input 
                        type="text" 
                        id="historySearch" 
                            placeholder="搜索历史记录..." 
                            class="w-full pl-10 pr-4 py-2.5 rounded-xl input-field text-sm"
                        oninput="filterHistory()"
                    >
                    </div>
                    <select 
                        id="historyFilter" 
                        class="px-4 py-2.5 rounded-xl input-field text-sm min-w-[140px]"
                        onchange="filterHistory()"
                    >
                        <option value="all">全部</option>
                        <option value="mobile">手机端</option>
                        <option value="desktop">PC端</option>
                        <option value="today">今天</option>
                        <option value="week">最近一周</option>
                        <option value="month">最近一月</option>
                    </select>
                </div>
                <div class="text-stone-500 text-xs">
                    共 <span id="historyCount" class="text-amber-500 font-medium">0</span> 条记录
                </div>
            </div>
            
            <div id="historyList" class="space-y-3">
                <!-- 历史记录将在这里动态加载 -->
            </div>
            
            <div id="historyEmpty" class="text-center py-16 hidden">
                <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-stone-800/50 flex items-center justify-center border border-stone-700/50">
                    <svg class="w-8 h-8 text-stone-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                </div>
                <p class="text-stone-300 font-medium mb-1">暂无历史记录</p>
                <p class="text-stone-500 text-sm">开始生成你的第一个UI设计吧</p>
            </div>
            
            <div id="historyNoResults" class="text-center py-16 hidden">
                <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-stone-800/50 flex items-center justify-center border border-stone-700/50">
                    <svg class="w-8 h-8 text-stone-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
                <p class="text-stone-300 font-medium mb-1">没有找到匹配的记录</p>
                <p class="text-stone-500 text-sm">尝试调整搜索条件</p>
            </div>
            
            <div class="mt-6 flex gap-3">
                <button onclick="clearAllHistory()" class="flex-1 btn-secondary py-3 rounded-xl font-semibold text-red-400 hover:text-red-300 hover:border-red-500/50">
                    清空全部
                </button>
                <button onclick="closeHistory()" class="flex-1 btn-secondary py-3 rounded-xl font-semibold">
                    关闭
                </button>
            </div>
        </div>
    </div>

    <!-- Image Preview Modal -->
    <div id="imageModal" class="fixed inset-0 bg-black/90 backdrop-blur-md hidden items-center justify-center p-4 z-50 modal-backdrop" onclick="closeImageModal()">
        <div class="max-w-5xl max-h-[90vh] overflow-auto relative">
            <button class="absolute top-4 right-4 w-10 h-10 rounded-xl bg-stone-800/80 hover:bg-stone-700 flex items-center justify-center text-stone-400 hover:text-stone-200 transition z-10" onclick="event.stopPropagation(); closeImageModal();">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <img id="modalImage" src="" class="w-full rounded-xl shadow-2xl">
        </div>
    </div>

    <script>
        // 配置
        // OpenRouter API 配置
        const OPENROUTER_API_BASE = 'https://openrouter.ai/api/v1';
        const OPENROUTER_PROXY_URL = '/api/openrouter'; // 服务器端代理 URL
        
        // 获取 API 配置（URL 和 headers）
        function getApiConfig() {
            const userApiKey = localStorage.getItem('openrouter_api_key');
            if (userApiKey && userApiKey.trim()) {
                // 使用用户自定义 API Key，直接调用 OpenRouter API
                return {
                    url: `${OPENROUTER_API_BASE}/chat/completions`,
                    headers: {
                        'Authorization': `Bearer ${userApiKey.trim()}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': window.location.origin,
                        'X-Title': 'AI UI Comparator'
                    }
                };
            } else {
                // 使用服务器端代理
                return {
                    url: OPENROUTER_PROXY_URL,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };
            }
        }
        
        /**
         * 模型配置
         * 
         * 注意：所有模型（包括未来添加的模型和自定义模型）都会自动包含平台信息
         * - 平台信息（手机端/PC端）会自动添加到 API 请求中
         * - 用户在界面选择平台后，所有模型都会收到相应的平台信息
         * - 自定义模型通过设置界面添加时，也会自动支持平台信息
         * 
         * 添加新模型时，只需设置以下字段：
         * - name: 显示名称
         * - model: 模型ID（如 'provider/model-name'）
         * - cost: 每次生成的成本（美元）
         * - type: 'image' 表示直接生成图片，'text-to-image-desc' 表示先生成描述再生成图片
         */
        const MODEL_CONFIGS = {
            'gemini': {
                name: 'Gemini Image',
                model: 'google/gemini-2.5-flash-image-preview',
                cost: 0.04,
                type: 'image'
            },
            'gemini-flash': {
                name: 'Gemini 2.5 Flash Image',
                model: 'google/gemini-2.5-flash-image',
                cost: 0.05,
                type: 'image'
            },
            'gemini-pro': {
                name: 'Gemini 3 Pro Image',
                model: 'google/gemini-3-pro-image-preview',
                cost: 0.05,
                type: 'image'
            },
            'gemini-3-pro': {
                name: 'Gemini 3 Pro Preview',
                model: 'google/gemini-3-pro-preview',
                cost: 0.07,
                type: 'text-to-image-desc' // 该模型返回文本描述，需要转换为图像
            },
            'flux': {
                name: 'Flux Pro',
                model: 'black-forest-labs/flux.2-pro',
                cost: 0.06,
                type: 'image'
            },
            'gpt5': {
                name: 'GPT-5 Image',
                model: 'openai/gpt-5-image',
                cost: 0.05,
                type: 'image'
            },
            'claude': {
                name: 'Claude 3.5 (描述)',
                model: 'anthropic/claude-3.5-sonnet',
                cost: 0.06,
                type: 'text-to-image-desc'
            },
            'claude-code': {
                name: 'Claude 3.5 (代码)',
                model: 'anthropic/claude-3.5-sonnet',
                cost: 0.04,
                type: 'code',
                timeout: 100000 // 100s，Claude 3.5 偶尔较慢
            },
            'gpt4-code': {
                name: 'GPT-4 Turbo (代码)',
                model: 'openai/gpt-4-turbo',
                cost: 0.02,
                type: 'code',
                timeout: 110000 // 110s，GPT-4 Turbo 生成完整页面需要时间
            },
            'deepseek-code': {
                name: 'DeepSeek Coder (代码)',
                model: 'deepseek/deepseek-chat', // 使用 deepseek-chat，deepseek-coder 可能不可用
                cost: 0.01,
                type: 'code',
                timeout: 120000 // 120s，DeepSeek 响应较慢
            },
            'gpt4o-code': {
                name: 'GPT-4o (代码)',
                model: 'openai/gpt-4o',
                cost: 0.01,
                type: 'code',
                timeout: 100000
            },
            'qwen-coder': {
                name: 'Qwen 2.5 (代码)',
                model: 'qwen/qwen-2.5-72b-instruct',
                cost: 0.01,
                type: 'code',
                timeout: 300000 // Zeabur无超时限制，延长到300秒
            },
            'deepseek-v3': {
                name: 'DeepSeek V3 (代码)',
                model: 'deepseek/deepseek-chat-v3.1',
                cost: 0.01,
                type: 'code',
                timeout: 300000 // Zeabur无超时限制，延长到300秒（5分钟）
            },
            'claude-opus': {
                name: 'Claude Opus 4.5 (代码)',
                model: 'anthropic/claude-opus-4.5',
                cost: 0.2,
                type: 'code',
                timeout: 150000 // Opus 非常慢，给足 150s
            },
            'grok-fast': {
                name: 'Grok 4.1 Fast (代码)',
                model: 'x-ai/grok-4.1-fast',
                cost: 0.01,
                type: 'code',
                timeout: 300000 // Zeabur无超时限制，延长到300秒
            },
            'claude-sonnet-4.5': {
                name: 'Claude Sonnet 4.5 (代码)',
                model: 'anthropic/claude-sonnet-4.5',
                cost: 0.08,
                type: 'code',
                timeout: 130000
            },
            'claude-haiku-4.5': {
                name: 'Claude Haiku 4.5 (代码)',
                model: 'anthropic/claude-haiku-4.5',
                cost: 0.03, // 用户设置的价格
                type: 'code',
                timeout: 90000 // Haiku 响应较快，90s 应该足够
            },
            // 以下模型暂时不可用，已注释
            // 'deepseek-chat-v3': {
            //     name: 'DeepSeek Chat v3.1 (代码) (免费)',
            //     model: 'deepseek/deepseek-chat-v3.1',
            //     cost: 0,
            //     type: 'code'
            // },
            // 'deepseek-r1': {
            //     name: 'DeepSeek R1 Distill (代码) (免费)',
            //     model: 'deepseek/deepseek-r1-distill-qwen-8b',
            //     cost: 0,
            //     type: 'code'
            // },
            // 'qwen-coder-plus': {
            //     name: 'Qwen3 Coder Plus (代码)',
            //     model: 'qwen/qwen3-coder-plus',
            //     cost: 0.001,
            //     type: 'code'
            // }
        };

        // 模板
        const TEMPLATES = {
            login: '生成一个专业、可信的理财首页界面，整体风格克制、低饱和、偏长期投资。\n\n顶部为资产与行情概览区，展示总资产、昨日收益、累计收益，数字渐进加载，行情用细微动态线条表达。\n\n主体为基金产品列表，按指数、主动、固收+分区。单个产品卡片包含近一年收益、风险等级、波动特征，核心数据高亮，展开后显示更多参数，展开过程平滑自然。\n\n穿插理财资讯模块，以简洁信息流展示市场解读。\n\n设置基金经理卡片，展示从业年限、管理规模、代表产品，点击显示管理理念。\n\n底部或侧边为行情模块，支持指数切换，曲线动态重绘。\n\n整体交互自然流畅，信息层级清晰，强调可理解、可比较、可决策。',
            dashboard: '生成深色模式、科技感强的理财仪表盘，深灰＋霓虹蓝紫光效，信息边界用细线与微弱发光区分。顶部展示总资产、昨日收益、累计收益，数字能量条式渐进动画，收益波动以光线脉冲呈现。中部为资产分布仪表区（环形图/能量环），进入视图时依次点亮，点击资产分类后以折叠卡片展开并伴随光线扩散。右侧为风险与健康度模块（雷达图/评分卡），切换时光效淡入，高评分蓝光强调，低评分暗红提示。底部展示"调仓、买入、分析报告"入口，按钮带呼吸光效，保持稳健金融氛围。整体未来感、可视化强、交互克制。',
            profile: '基金详情页围绕"可理解、可比较、可决策"构建信息结构。顶部展示基金名称、类型标签（如指数/固收+），以及核心收益指标（近1年收益、今年以来、成立以来），数值以渐进加载动画呈现，并附带轻微涨跌动态线条，强调趋势感。\n\n页面中段为收益走势图，支持切换 1月 / 6月 / 1年 / 最大区间。切换时曲线动态重绘，并以淡入方式呈现。图下提供关键参数：最大回撤、波动率、夏普比率等，用于帮助用户快速判断风险收益特征。\n\n持仓结构模块采用可展开卡片，展示行业占比、重仓资产等，展开与收起动作带有轻微弹性动效。\n\n基金经理信息区以卡片形式呈现，从业年限、管理规模、代表产品及过往业绩，点击可查看更完整履历与管理理念。\n\n页面底部为固定操作区，提供"买入""定投"按钮。"买入"按钮轻微呼吸动效，用于强调主要行为入口。页面滑动时按钮吸附底部保持可见。整体交互克制，信息清晰，支持用户做出稳健的长期决策。',
            'search-result': '用户搜索一只场内基金后，结果页展示该场内产品的基础信息，同时联动展示跟踪同一指数的场外对应产品。页面明确提示：场外申购更便捷、无开户门槛、费率更低，适合作为多数用户的买入选择；而场内需券商开户、交易机制复杂、存在溢价折价风险。\n\n在结果中，场外产品的"买入"按钮带有轻微的呼吸闪烁动效，引导用户优先选择场外申购；场内产品的买入按钮保持静态状态，减少误触与错误路径。整体强调透明对比、清晰引导、降低新手的交易复杂度。',
            campaign: '生成一个春节喜庆的运营活动页面，橙红色调。活动内容为：买入理财产品得积分，积分能兑微信立减金。页面需包含理财产品卡片，卡片上应有图表展示该产品的运营数据或特点。整体设计要突出节日氛围和活动吸引力。'
        };

        // API Key 已移至服务器端（Vercel Serverless Function）
        // 前端无需配置 API Key，所有请求通过 /api/openrouter 代理
        // 需要在 Vercel 项目设置中配置环境变量 OPENROUTER_API_KEY
        let currentResults = [];
        let debugMode = localStorage.getItem('debug_mode') === 'true';
        let generationHistory = JSON.parse(localStorage.getItem('generation_history') || '[]');
        let referenceImages = []; // 存储参考图片的数组，每个元素包含 {id, data}

        // 处理图片上传（支持多张）
        function handleImageUpload(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;
            
            files.forEach(file => {
                // 检查文件类型
                if (!file.type.startsWith('image/')) {
                    alert(`⚠️ ${file.name} 不是图片文件`);
                    return;
                }
                
                // 检查文件大小（限制 10MB）
                if (file.size > 10 * 1024 * 1024) {
                    alert(`⚠️ ${file.name} 文件大小超过 10MB`);
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageId = Date.now() + Math.random();
                    const imageData = {
                        id: imageId,
                        data: e.target.result // base64 数据
                    };
                    
                    referenceImages.push(imageData);
                    renderReferenceImages();
                    
                    console.log('✅ 参考图片已上传:', imageId);
                };
                reader.onerror = () => {
                    alert(`⚠️ ${file.name} 读取失败`);
                };
                reader.readAsDataURL(file);
            });
            
            // 清空 input，允许重复选择同一文件
            event.target.value = '';
        }

        // 渲染参考图片列表
        function renderReferenceImages() {
            const container = document.getElementById('referenceImagesContainer');
            container.innerHTML = '';
            
            referenceImages.forEach((image, index) => {
                const imageItem = document.createElement('div');
                imageItem.className = 'relative group';
                imageItem.innerHTML = `
                    <img 
                        src="${image.data}" 
                        alt="参考图片 ${index + 1}" 
                        class="w-12 h-12 object-cover rounded-lg border-2 border-gray-300 cursor-pointer hover:border-purple-500 transition"
                        onclick="showImageModal('${image.data}')"
                    >
                    <button 
                        onclick="removeReferenceImage(${image.id})"
                        class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full flex items-center justify-center hover:bg-red-600 transition opacity-0 group-hover:opacity-100 text-xs"
                        title="删除图片"
                    >
                        ×
                        </button>
                `;
                container.appendChild(imageItem);
            });
        }

        // 移除指定参考图片
        function removeReferenceImage(imageId) {
            referenceImages = referenceImages.filter(img => img.id !== imageId);
            renderReferenceImages();
            console.log('🗑️ 参考图片已移除:', imageId);
        }

        // 调试日志函数
        function debugLog(...args) {
            if (debugMode) {
                console.log(...args);
            }
        }

        // 加载设置中的模型列表
        function loadSettingsModelList() {
            const container = document.getElementById('settingsModelList');
            if (!container) return;
            
            container.innerHTML = '';
            
            // 推荐的6个模型（默认选中的）
            // 1）Gemini 2.5 Flash Image (免费)
            // 2）Gemini 3 Pro Image (免费)
            // 3）Claude 3.5 (描述)
            // 4）Grok 4.1 Fast (代码)
            // 5）Claude Haiku 4.5 (代码)
            // 6）DeepSeek Coder (代码)
            const defaultMainPageModels = [
                'gemini-flash',      // Gemini 2.5 Flash Image (免费)
                'gemini-pro',        // Gemini 3 Pro Image (免费)
                'claude',            // Claude 3.5 (描述)
                'grok-fast',         // Grok 4.1 Fast (代码)
                'claude-haiku-4.5',  // Claude Haiku 4.5 (代码)
                'deepseek-code'      // DeepSeek Coder (代码)
            ];
            
            // 获取保存的选中模型
            const savedSelected = JSON.parse(localStorage.getItem('selected_models') || '[]');
            
            // 判断是否使用了默认的5个推荐模型
            const isDefaultSelection = savedSelected.length === defaultMainPageModels.length &&
                savedSelected.every(key => defaultMainPageModels.includes(key)) &&
                defaultMainPageModels.every(key => savedSelected.includes(key));
            
            // 设置页面总是显示所有模型
            const modelsToShow = Object.keys(MODEL_CONFIGS).filter(key => !key.startsWith('custom-'));
            
            // 获取所有模型并排序（按价格从低到高）
            const sortedModels = modelsToShow
                .map(key => ({
                    key: key,
                    ...MODEL_CONFIGS[key]
                }))
                .sort((a, b) => a.cost - b.cost); // 按价格从低到高排序
            
            // 确定默认选中状态：如果没有保存的，或者保存的是默认6个，则默认选中这6个
            const defaultSelected = savedSelected.length === 0 || isDefaultSelection
                ? defaultMainPageModels
                : savedSelected;
            
            // 生成模型选择项
            sortedModels.forEach(model => {
            const label = document.createElement('label');
            label.className = 'flex items-center bg-stone-800/30 hover:bg-stone-800/60 p-3 rounded-xl cursor-pointer transition border border-stone-700/50 hover:border-stone-600/50 group';
                
                // 检查是否已选中
                const isChecked = defaultSelected.includes(model.key);
                
                const costDisplay = model.cost === 0 
                    ? '<span class="badge badge-mint text-[10px]">FREE</span>'
                    : `<span class="text-stone-500 text-xs font-mono">$${model.cost.toFixed(2)}</span>`;
                
                const typeDisplay = model.type === 'code' 
                    ? '<span class="text-blue-400 text-xs">代码</span>'
                    : model.type === 'image'
                    ? '<span class="text-purple-400 text-xs">图片</span>'
                    : '<span class="text-amber-400 text-xs">描述</span>';
                
            label.innerHTML = `
                    <input type="checkbox" id="settings-model-${model.key}" class="mr-3" ${isChecked ? 'checked' : ''}>
                <span class="text-stone-200 font-medium flex-1 text-sm group-hover:text-stone-100 transition">${model.name}</span>
                    ${typeDisplay}
                    <span class="mx-2 text-stone-700">·</span>
                    ${costDisplay}
                `;
                
                container.appendChild(label);
            });
        }
        
        // 加载主界面的模型列表
        function loadModelSelectionList() {
            const container = document.getElementById('modelSelectionList');
            if (!container) return;
            
            container.innerHTML = '';
            
            // 主页面默认显示的模型列表（推荐的8个模型）
            const defaultMainPageModels = [
                'gemini-flash',      // Gemini 2.5 Flash Image (免费)
                'gemini-pro',        // Gemini 3 Pro Image (免费)
                'claude',            // Claude 3.5 (描述)
                'grok-fast',         // Grok 4.1 Fast (代码)
                'claude-haiku-4.5',  // Claude Haiku 4.5 (代码)
                'deepseek-code',     // DeepSeek Coder (代码)
                'qwen-coder',        // Qwen 2.5 (代码)
                'deepseek-v3'        // DeepSeek V3 (代码)
            ];
            
            // 获取设置中保存的勾选状态
            const savedSelected = JSON.parse(localStorage.getItem('selected_models') || '[]');
            
            // 判断用户是否在设置中修改过模型选择
            // 如果保存的选择与默认6个完全相同，说明用户没有修改过
            const isDefaultSelection = savedSelected.length === defaultMainPageModels.length &&
                savedSelected.every(key => defaultMainPageModels.includes(key)) &&
                defaultMainPageModels.every(key => savedSelected.includes(key));
            
            // 确定要显示的模型列表
            const availableModels = (savedSelected.length > 0 && !isDefaultSelection)
                ? savedSelected.filter(key => MODEL_CONFIGS[key]) // 用户修改过，显示设置中选中的模型
                : defaultMainPageModels.filter(key => MODEL_CONFIGS[key]); // 用户未修改，显示推荐的6个模型
            
            if (availableModels.length === 0) {
                container.innerHTML = '<div class="text-stone-500 text-sm p-3">请在设置中选择至少一个模型</div>';
                return;
            }
            
            // 获取上次生成时的选择（如果有）
            const lastGenerationModels = JSON.parse(localStorage.getItem('last_generation_models') || '[]');
            
            // 获取可用模型并排序（按价格从低到高）
            const sortedModels = availableModels
                .map(key => ({
                    key: key,
                    ...MODEL_CONFIGS[key]
                }))
                .sort((a, b) => a.cost - b.cost);
            
            // 确定默认勾选状态
            let defaultChecked = [];
            
            if (savedSelected.length > 0 && !isDefaultSelection) {
                // 用户在设置中修改过：默认全部勾选设置中选中的模型
                defaultChecked = availableModels;
            } else {
                // 用户没有修改过：默认只勾选免费模型，但如果有上次生成使用的模型，优先使用上次的
            if (lastGenerationModels.length > 0) {
                // 检查上次选择的模型是否都在当前可用模型中
                const validLastModels = lastGenerationModels.filter(key => availableModels.includes(key));
                    if (validLastModels.length > 0) {
                        // 使用上次的选择
                    defaultChecked = validLastModels;
                } else {
                        // 上次选择无效，默认只勾选免费模型
                    defaultChecked = availableModels.filter(key => MODEL_CONFIGS[key] && MODEL_CONFIGS[key].cost === 0);
                }
            } else {
                    // 没有上次选择，默认只勾选免费模型
                defaultChecked = availableModels.filter(key => MODEL_CONFIGS[key] && MODEL_CONFIGS[key].cost === 0);
                }
            }
            
            // 生成模型选择项（只显示可用模型）
            sortedModels.forEach(model => {
            const label = document.createElement('label');
            label.className = 'flex items-center bg-stone-800/30 hover:bg-stone-800/60 p-2.5 rounded-lg cursor-pointer transition border border-stone-700/30 hover:border-stone-600/50 group';
                
                // 默认勾选（全部勾选或使用上次选择）
                const isChecked = defaultChecked.includes(model.key);
                
                const costDisplay = model.cost === 0 
                    ? '<span class="text-emerald-400 text-[10px] font-semibold uppercase tracking-wider">Free</span>'
                    : `<span class="text-stone-500 text-xs font-mono">$${model.cost.toFixed(2)}</span>`;
                
                const typeIcon = model.type === 'code' 
                    ? '<svg class="w-3.5 h-3.5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>'
                    : model.type === 'image'
                    ? '<svg class="w-3.5 h-3.5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>'
                    : '<svg class="w-3.5 h-3.5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>';
                
            label.innerHTML = `
                    <input type="checkbox" id="model-${model.key}" class="mr-2.5" ${isChecked ? 'checked' : ''}>
                <span class="text-stone-300 font-medium flex-1 text-sm group-hover:text-stone-100 transition truncate">${model.name}</span>
                    ${typeIcon}
                    <span class="ml-2">${costDisplay}</span>
            `;
            
            // 添加事件监听
                const checkbox = label.querySelector('input');
                checkbox.addEventListener('change', () => {
                    updateCostEstimate();
                    saveLastGenerationModels(); // 保存当前选择
                });
                
                container.appendChild(label);
            });
            
            // 更新成本估算
            updateCostEstimate();
        }
        
        // 保存上次生成时的模型选择
        function saveLastGenerationModels() {
            const selectedModels = [];
            for (let key in MODEL_CONFIGS) {
                const checkbox = document.getElementById(`model-${key}`);
                if (checkbox && checkbox.checked) {
                    selectedModels.push(key);
                }
            }
            localStorage.setItem('last_generation_models', JSON.stringify(selectedModels));
        }
        

        // 页面加载时初始化
        window.onload = () => {
            // API Key 已移至服务器端，前端无需检查
            updateCharCount();
            loadModelSelectionList(); // 加载模型列表（默认勾选设置中已选的模型）

            // 恢复调试模式设置
            const debugCheckbox = document.getElementById('debugMode');
            if (debugCheckbox) {
                debugCheckbox.checked = debugMode;
            }
            
            // 同步右侧结果区域高度与左侧输入面板
            setTimeout(() => {
                syncResultsHeight();
            }, 100);
            
            // 监听窗口大小变化
            window.addEventListener('resize', () => {
                syncResultsHeight();
            });
        };
        
        // 同步右侧结果区域高度与左侧输入面板
        function syncResultsHeight() {
            const leftPanel = document.querySelector('.md\\:col-span-1 > div');
            const resultsContainer = document.getElementById('resultsContainer');
            
            if (leftPanel && resultsContainer) {
                // 获取左侧面板的实际高度
                const leftHeight = leftPanel.offsetHeight;
                // 设置右侧结果区域的最小高度
                resultsContainer.style.minHeight = `${leftHeight}px`;
            }
        }


        // 字符计数
        document.getElementById('promptInput').addEventListener('input', (e) => {
            updateCharCount();
        });

        // 支持粘贴图片（Cmd+V / Ctrl+V）
        document.getElementById('promptInput').addEventListener('paste', async (e) => {
            const items = e.clipboardData?.items;
            if (!items) return;

            // 查找图片类型的剪贴板项
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                
                // 检查是否是图片类型
                if (item.type.indexOf('image') !== -1) {
                    e.preventDefault(); // 阻止默认粘贴行为
                    
                    const file = item.getAsFile();
                    if (!file) continue;
                    
                    // 检查文件大小（限制 10MB）
                    if (file.size > 10 * 1024 * 1024) {
                        alert('⚠️ 图片文件大小超过 10MB');
                        continue;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const imageId = Date.now() + Math.random();
                        const imageData = {
                            id: imageId,
                            data: event.target.result // base64 数据
                        };
                        
                        referenceImages.push(imageData);
                        renderReferenceImages();
                        
                        console.log('✅ 图片已从剪贴板粘贴:', imageId);
                        
                        // 显示提示
                        showToast('✅ 图片已粘贴');
                    };
                    reader.onerror = () => {
                        alert('⚠️ 图片读取失败');
                    };
                    reader.readAsDataURL(file);
                }
            }
        });

        function updateCharCount() {
            const input = document.getElementById('promptInput');
            const count = input.value.length;
            const charCountElement = document.getElementById('charCount');
            const parentElement = charCountElement.parentElement;
            
            // 字符计数样式：接近限制时显示警告色
            if (count > 500) {
                input.value = input.value.substring(0, 500);
                charCountElement.textContent = 500;
                parentElement.className = 'absolute bottom-4 right-4 text-red-400 text-xs font-mono font-semibold';
            } else {
                charCountElement.textContent = count;
                if (count > 450) {
                    parentElement.className = 'absolute bottom-4 right-4 text-amber-400 text-xs font-mono';
                } else {
                    parentElement.className = 'absolute bottom-4 right-4 text-stone-600 text-xs font-mono';
                }
            }
        }

        // 成本估算
        function updateCostEstimate() {
            let total = 0;
            for (let key in MODEL_CONFIGS) {
                const checkbox = document.getElementById(`model-${key}`);
                if (checkbox && checkbox.checked) {
                    total += MODEL_CONFIGS[key].cost;
                }
            }
            document.getElementById('costEstimate').textContent = `$${total.toFixed(2)}`;
        }

        // 监听模型选择变化
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            cb.addEventListener('change', updateCostEstimate);
        });

        // 设置相关
        function showSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
            document.getElementById('settingsModal').classList.add('flex');
            // 加载保存的 API Key
            const savedApiKey = localStorage.getItem('openrouter_api_key') || '';
            document.getElementById('apiKeyInput').value = savedApiKey;
            loadSettingsModelList(); // 加载设置中的模型列表
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
            document.getElementById('settingsModal').classList.remove('flex');
        }

        function resetToDefaultModels() {
            if (!confirm('确定要恢复默认模型选择吗？这将重置为您推荐的模型列表。')) {
                return;
            }
            
            // 默认主页面显示的模型列表（推荐的8个模型）
            const defaultMainPageModels = [
                'gemini-flash',      // Gemini 2.5 Flash Image (免费)
                'gemini-pro',        // Gemini 3 Pro Image (免费)
                'claude',            // Claude 3.5 (描述)
                'grok-fast',         // Grok 4.1 Fast (代码)
                'claude-haiku-4.5',  // Claude Haiku 4.5 (代码)
                'deepseek-code',     // DeepSeek Coder (代码)
                'qwen-coder',        // Qwen 2.5 (代码)
                'deepseek-v3'        // DeepSeek V3 (代码)
            ];
            
            // 保存默认选择（保存推荐的8个模型）
            localStorage.setItem('selected_models', JSON.stringify(defaultMainPageModels));
            
            // 清除上次生成时的选择
            localStorage.removeItem('last_generation_models');
            
            // 更新设置页面的模型列表显示（会默认选中这6个）
            loadSettingsModelList();
            
            // 更新主界面显示（会显示这5个模型，默认只勾选免费模型）
            loadModelSelectionList();
            
            alert('✅ 已恢复默认模型选择\n\n主页面将显示推荐的6个模型，默认勾选免费模型');
        }

        function saveSettings() {
            // 保存 API Key（可选）
            const apiKeyInput = document.getElementById('apiKeyInput');
            const apiKey = apiKeyInput.value.trim();
            if (apiKey) {
                localStorage.setItem('openrouter_api_key', apiKey);
            } else {
                // 如果清空，移除保存的 API Key，使用服务器端公用 Key
                localStorage.removeItem('openrouter_api_key');
            }

                // 保存调试模式设置
                const debugCheckbox = document.getElementById('debugMode');
                debugMode = debugCheckbox.checked;
                localStorage.setItem('debug_mode', debugMode.toString());
                
                // 保存选中的模型
                const selectedModels = [];
                const checkboxes = document.querySelectorAll('#settingsModelList input[type="checkbox"]:checked');
                checkboxes.forEach(cb => {
                    selectedModels.push(cb.id.replace('settings-model-', ''));
                });
                
                // 验证至少选择一个模型
                if (selectedModels.length === 0) {
                    alert('⚠️ 请至少选择一个模型');
                    return;
                }
            
                // 默认的8个模型
                const defaultMainPageModels = [
                    'gemini-flash',
                    'gemini-pro',
                    'claude',
                    'grok-fast',
                    'claude-haiku-4.5',
                    'deepseek-code',
                    'qwen-coder',
                    'deepseek-v3'
                ];
            
            // 判断是否与默认8个完全相同
            const isDefaultSelection = selectedModels.length === defaultMainPageModels.length &&
                selectedModels.every(key => defaultMainPageModels.includes(key)) &&
                defaultMainPageModels.every(key => selectedModels.includes(key));
                
                localStorage.setItem('selected_models', JSON.stringify(selectedModels));
                
            // 如果用户选择的是默认6个，不清除上次生成的选择（保持记忆）
            // 如果用户选择的是其他模型，清除上次生成的选择（因为模型列表变了）
            if (!isDefaultSelection) {
                localStorage.removeItem('last_generation_models');
            }
                
            // 更新主界面显示
                loadModelSelectionList();

                closeSettings();
                alert('✅ 设置已保存，主界面已更新');
        }

        // 模板相关
        function useTemplate(type) {
            document.getElementById('promptInput').value = TEMPLATES[type];
            updateCharCount();
        }

        // 生成相关
        async function startGeneration() {
            // API Key 已移至服务器端，无需验证

            const prompt = document.getElementById('promptInput').value.trim();
            if (!prompt) {
                alert('⚠️ 请输入UI设计需求');
                return;
            }

            // 获取选中的模型
            // 从主界面获取当前勾选的模型
            const selectedModels = [];
            for (let key in MODEL_CONFIGS) {
                const checkbox = document.getElementById(`model-${key}`);
                if (checkbox && checkbox.checked) {
                    selectedModels.push(key);
                }
            }

            if (selectedModels.length === 0) {
                alert('⚠️ 请至少选择一个模型');
                return;
            }
            
            // 保存当前选择，用于下次加载时恢复
            localStorage.setItem('last_generation_models', JSON.stringify(selectedModels));

            // 禁用按钮
            const btn = document.getElementById('generateBtn');
            btn.disabled = true;
            btn.textContent = '🔄 生成中...';

            // 清空结果并隐藏进度区域
            currentResults = [];
            document.getElementById('resultsGrid').innerHTML = '';
            document.getElementById('progressSection').classList.add('hidden');

            // 重置总成本显示
            const totalCostDisplay = document.getElementById('totalCostDisplay');
            const totalCostValue = document.getElementById('totalCostValue');
            if (totalCostDisplay && totalCostValue) {
                totalCostDisplay.classList.add('hidden');
                totalCostValue.textContent = '$0.00';
            }

            // 获取平台选择
            const platformRadio = document.querySelector('input[name="platform"]:checked');
            const platform = platformRadio ? platformRadio.value : 'mobile';
            const platformText = platform === 'mobile' ? 'mobile app (iOS/Android)' : 'desktop web application';
            const platformTitle = platform === 'mobile' ? 'mobile app UI design' : 'desktop web UI design';

            // 优化Prompt（加入UI设计约束）
            let platformConstraints = '';
            if (platform === 'mobile') {
                platformConstraints = `
Mobile-specific constraints (CRITICAL - must follow):
- Layout: Portrait orientation (vertical/portrait layout), single column design
- Screen ratio: 9:16 or similar mobile aspect ratio (tall and narrow)
- Navigation: Include mobile navigation elements (bottom tab bar, hamburger menu, or top navigation bar)
- Status bar: Include iOS status bar (with time, battery, signal) or Android status bar at the top
- Touch targets: Large touch-friendly buttons and interactive elements (minimum 44x44px equivalent)
- Spacing: Generous padding and margins suitable for mobile screens
- Typography: Mobile-optimized font sizes, readable on small screens
- Components: Mobile-specific UI patterns (swipe gestures, pull-to-refresh indicators, mobile cards)
- Avoid: Desktop layouts, horizontal scrolling, multi-column grids, wide desktop-style navigation`;
            } else {
                platformConstraints = `
Desktop-specific constraints (CRITICAL - must follow):
- Layout: Landscape orientation (horizontal/wide layout), multi-column design allowed
- Screen ratio: 16:9 or similar desktop aspect ratio (wide and short)
- Navigation: Include desktop navigation elements (top menu bar, sidebar navigation, breadcrumbs)
- Window controls: Include browser window controls or desktop app window frame
- Mouse interactions: Desktop-optimized hover states and clickable elements
- Spacing: Desktop-appropriate spacing, can be more compact than mobile
- Typography: Desktop-optimized font sizes, can be smaller than mobile
- Components: Desktop-specific UI patterns (dropdown menus, tooltips, right-click context menus)
- Avoid: Mobile layouts, portrait orientation, bottom navigation bars, mobile-specific gestures`;
            }

            const optimizedPrompt = `Create a clean, modern ${platformTitle}.

User requirements: ${prompt}

Design constraints:
- Style: flat design, minimalist, professional interface
- Platform: ${platformText}
- Layout: clear visual hierarchy, proper spacing
- Elements: realistic UI components (buttons, inputs, cards)
- Colors: harmonious color scheme
- Output: high-fidelity UI mockup, NOT illustration
${platformConstraints}

Avoid: 3D elements, realistic photos, cartoon style`;

            // 为每个模型创建占位符卡片
            selectedModels.forEach(modelKey => {
                addResultCardPlaceholder(modelKey);
            });

            // 限制并发数量，避免429限流错误
            const MAX_CONCURRENT = 4; // 最多同时4个请求
            const REQUEST_DELAY = 300; // 每个请求之间延迟300ms
            
            // 分批处理请求，控制并发数量
            const processInBatches = async (items, batchSize, delay) => {
                const results = [];
                for (let i = 0; i < items.length; i += batchSize) {
                    const batch = items.slice(i, i + batchSize);
                    const batchPromises = batch.map(async (modelKey, index) => {
                        // 每个请求之间添加延迟，避免同时发起
                        if (index > 0) {
                            await new Promise(resolve => setTimeout(resolve, delay));
                        }
                        return generateWithModel(modelKey, optimizedPrompt, platform);
                    });
                    const batchResults = await Promise.allSettled(batchPromises);
                    results.push(...batchResults);
                }
                return results;
            };

            try {
                // 分批处理，控制并发数量
                const results = await processInBatches(selectedModels, MAX_CONCURRENT, REQUEST_DELAY);
                
                // 从 Promise 结果中提取实际的结果数据
                const allResults = results
                    .filter(r => r.status === 'fulfilled' && r.value)
                    .map(r => r.value);
                
                // 等待一小段时间，确保所有结果都已添加到 currentResults（包括成功和失败的）
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // 合并两个结果源，确保所有结果都被保存
                // 创建一个 Map 来去重，优先使用 currentResults（包含完整图片数据）
                const resultsMap = new Map();
                
                // 先添加 currentResults（优先，包含完整数据）
                currentResults.forEach(result => {
                    resultsMap.set(result.modelName, {
                        modelName: result.modelName,
                        imageUrl: result.imageUrl || '',
                        codeContent: result.codeContent || null,
                        cost: result.cost || 0,
                        isError: result.isError || false,
                        errorMsg: result.errorMsg || ''
                    });
                });
                
                // 再添加 allResults 中 currentResults 没有的结果
                allResults.forEach(result => {
                    if (!resultsMap.has(result.modelName)) {
                        resultsMap.set(result.modelName, {
                            modelName: result.modelName,
                            imageUrl: result.imageUrl || '',
                            codeContent: result.codeContent || null,
                            cost: result.cost || 0,
                            isError: result.isError || false,
                            errorMsg: result.errorMsg || ''
                        });
                    } else {
                        // 如果 currentResults 中没有 imageUrl，但 allResults 有，则补充
                        const existing = resultsMap.get(result.modelName);
                        if (!existing.imageUrl && result.imageUrl) {
                            existing.imageUrl = result.imageUrl;
                        }
                        if (!existing.codeContent && result.codeContent) {
                            existing.codeContent = result.codeContent;
                        }
                    }
                });
                
                // 转换为数组，按 selectedModels 的顺序排序
                const resultsToSave = selectedModels.map(modelKey => {
                    const config = MODEL_CONFIGS[modelKey];
                    const modelName = config ? config.name : modelKey;
                    return resultsMap.get(modelName) || {
                        modelName: modelName,
                        imageUrl: '',
                        codeContent: null,
                        cost: config ? config.cost : 0,
                        isError: true,
                        errorMsg: '结果未找到'
                    };
                });
                
                // 保存历史记录（无论结果数量是否完全匹配，只要有结果就保存）
                if (resultsToSave.length > 0) {
                    console.log('📜 准备保存历史记录:', {
                        prompt: prompt.substring(0, 50),
                        platform: platform,
                        selectedModelsCount: selectedModels.length,
                        resultsToSaveCount: resultsToSave.length,
                        currentResultsCount: currentResults.length,
                        collectedResultsCount: allResults.length,
                        mergedResultsCount: resultsMap.size,
                        resultsToSave: resultsToSave.map(r => ({ name: r.modelName, hasImage: !!r.imageUrl, isError: r.isError }))
                    });
                    
                    await saveGenerationHistory(prompt, platform, selectedModels, resultsToSave);
                    
                    debugLog('✅ 历史记录已保存，结果数量:', resultsToSave.length);
                    console.log('✅ 历史记录保存成功');
                    
                    // 输出实际成本汇总（便于查看和更新配置）
                    console.log('\n💰 ========== 本次生成实际成本汇总 ==========');
                    const costSummary = resultsToSave
                        .filter(r => !r.isError && r.cost !== null && r.cost !== undefined)
                        .map(r => ({
                            modelName: r.modelName,
                            actualCost: r.cost
                        }))
                        .sort((a, b) => b.actualCost - a.actualCost); // 按成本从高到低排序
                    
                    let totalCost = 0;
                    if (costSummary.length > 0) {
                        costSummary.forEach(item => {
                            // 单模型成本：两位小数显示，最低0.01但只用于展示
                            const displayCostPerModel = item.actualCost === 0
                                ? 0
                                : Math.max(0.01, parseFloat(item.actualCost.toFixed(2)));
                            console.log(`  ${item.modelName}: $${displayCostPerModel.toFixed(2)}`);
                            totalCost += item.actualCost || 0;
                        });
                        
                        // 总成本计算：基于实际总和，再按规则显示
                        const rawTotal = totalCost || 0;
                        const displayTotal = rawTotal === 0
                            ? 0
                            : Math.max(0.01, parseFloat(rawTotal.toFixed(2)));
                        console.log(`\n  总计: $${displayTotal.toFixed(2)}`);
                        console.log('==========================================\n');

                        // 更新界面上的总成本显示
                        const totalCostDisplayEl = document.getElementById('totalCostDisplay');
                        const totalCostValueEl = document.getElementById('totalCostValue');
                        if (totalCostDisplayEl && totalCostValueEl) {
                            totalCostDisplayEl.classList.remove('hidden');
                            totalCostValueEl.textContent = `$${displayTotal.toFixed(2)}`;
                        }
                    } else {
                        console.log('  （没有获取到实际成本数据）');
                        console.log('==========================================\n');
                    }
                    
                    // 验证保存是否成功
                    setTimeout(() => {
                        const savedHistory = JSON.parse(localStorage.getItem('generation_history') || '[]');
                        console.log('🔍 验证保存结果 - 历史记录总数:', savedHistory.length);
                        if (savedHistory.length > 0) {
                            console.log('🔍 最新一条历史记录:', {
                                id: savedHistory[0].id,
                                prompt: savedHistory[0].prompt.substring(0, 30),
                                resultsCount: savedHistory[0].results.length
                            });
                        }
                    }, 100);
                } else {
                    console.error('❌ 没有结果可保存到历史记录');
                    console.error('  - 选中模型数量:', selectedModels.length);
                    console.error('  - currentResults.length:', currentResults.length);
                    console.error('  - allResults.length:', allResults.length);
                    console.error('  - resultsToSave.length:', resultsToSave.length);
                    console.error('  - resultsMap.size:', resultsMap.size);
                    debugLog('⚠️ 没有结果可保存到历史记录');
                }
            } catch (error) {
                console.error('生成过程中出错:', error);
            } finally {
                // 确保按钮状态总是恢复
            btn.disabled = false;
            btn.textContent = '🚀 开始生成';
            }
        }

        async function generateWithModel(modelKey, prompt, platform = 'mobile') {
            const config = MODEL_CONFIGS[modelKey];

            try {
                let imageUrl = null;
                let codeContent = null;
                let actualCost = config.cost; // 默认使用配置的成本
                let wasTruncated = false; // 默认未截断

                if (config.type === 'image') {
                    // 直接生成图片的模型（Gemini, Flux, GPT-5）
                    const imageResult = await generateImage(config.model, prompt, platform);
                    if (typeof imageResult === 'object' && imageResult.imageUrl) {
                        imageUrl = imageResult.imageUrl;
                        actualCost = imageResult.actualCost !== null ? imageResult.actualCost : actualCost;
                    } else {
                        imageUrl = imageResult;
                    }
                } else if (config.type === 'code') {
                    // 生成代码的模型
                    const codeResult = await generateCode(config, prompt, platform);
                    if (typeof codeResult === 'object' && codeResult.code) {
                        codeContent = codeResult.code;
                        actualCost = codeResult.actualCost !== null ? codeResult.actualCost : actualCost;
                        wasTruncated = codeResult.wasTruncated || false;
                    } else {
                        codeContent = codeResult.code || codeResult;
                        wasTruncated = codeResult.wasTruncated || false;
                    }
                } else {
                    // Claude：生成描述后用免费的Gemini生成图
                    const descResult = await generateDescription(config.model, prompt);
                    let description;
                    if (typeof descResult === 'object' && descResult.description) {
                        description = descResult.description;
                        actualCost = descResult.actualCost !== null ? descResult.actualCost : actualCost;
                    } else {
                        description = descResult;
                    }
                    
                    const imageResult = await generateImage('google/gemini-2.5-flash-image-preview', description, platform);
                    if (typeof imageResult === 'object' && imageResult.imageUrl) {
                        imageUrl = imageResult.imageUrl;
                        // 累加成本（描述 + 图片生成）
                        if (imageResult.actualCost !== null) {
                            actualCost = (actualCost || 0) + imageResult.actualCost;
                        }
                    } else {
                        imageUrl = imageResult;
                    }
                }

                // 成功：更新结果卡片（传入实际成本和截断标志）
                updateResultCard(modelKey, imageUrl, codeContent, false, '', actualCost, wasTruncated);
                
                const result = { 
                    modelName: config.name, 
                    imageUrl: imageUrl, 
                    codeContent: codeContent,
                    cost: actualCost, // 使用实际成本
                    isError: false, 
                    errorMsg: '' 
                };
                currentResults.push(result);
                
                // 返回结果，用于历史记录
                return result;
                
            } catch (error) {
                console.error(`${config.name} 生成失败:`, error);
                
                // 失败：更新结果卡片显示错误
                updateResultCard(modelKey, null, null, true, error.message);
                
                const result = { 
                    modelName: config.name, 
                    imageUrl: '', 
                    cost: config.cost, 
                    isError: true, 
                    errorMsg: error.message, 
                    codeContent: null 
                };
                currentResults.push(result);
                
                // 返回结果，用于历史记录
                return result;
            }
        }

        /**
         * 生成图片
         * @param {string} model - 模型ID
         * @param {string} prompt - 提示词（已包含平台信息）
         * @param {string} platform - 平台类型：'mobile' 或 'desktop'
         * 
         * 注意：所有模型（包括自定义模型）都会自动包含平台信息
         * - 平台信息会在 prompt 中明确标注
         * - 确保生成的UI设计符合所选平台特性
         */
        async function generateImage(model, prompt, platform = 'mobile') {
            debugLog('🚀 Calling model:', model);
            debugLog('📝 Prompt:', prompt.substring(0, 100) + '...');
            debugLog('📱 Platform:', platform);

            // 准备平台信息
            const platformInfo = platform === 'mobile' 
                ? 'mobile app (iOS/Android)' 
                : 'desktop web application';

            // 根据模型类型构建不同的请求体
            // 如果有关参考图片，使用多模态格式
            let content;
            if (referenceImages.length > 0) {
                // 多模态格式：文本 + 多张图片
                content = [
                    {
                        type: 'text',
                        text: prompt
                    },
                    ...referenceImages.map(img => ({
                        type: 'image_url',
                        image_url: {
                            url: img.data
                        }
                    }))
                ];
                debugLog(`📷 包含 ${referenceImages.length} 张参考图片`);
            } else {
                // 纯文本格式
                content = prompt;
            }
            
            const requestBody = {
                model: model,
                messages: [
                    {
                        role: 'user',
                        content: content
                    }
                ]
            };

            // 只对支持的模型添加 modalities
            if (model.includes('gemini') && model.includes('image')) {
                requestBody.modalities = ["image", "text"];
                
                // 对于所有 Gemini 图像模型，确保平台信息在 prompt 中明确显示
                // 即使 prompt 中已有平台信息，也再次明确标注以确保模型理解
                const platformEmphasis = platform === 'mobile' 
                    ? `\n\nIMPORTANT: This must be a MOBILE APP UI design with portrait orientation, mobile navigation (bottom tabs or hamburger menu), status bar, and touch-friendly elements. The layout must be vertical/single-column, NOT desktop-style.`
                    : `\n\nIMPORTANT: This must be a DESKTOP WEB APPLICATION UI design with landscape orientation, desktop navigation (top menu or sidebar), and mouse-optimized elements. The layout can be multi-column, NOT mobile-style.`;
                
                if (!prompt.includes('IMPORTANT: This must be')) {
                    const newPrompt = `${prompt}${platformEmphasis}`;
                    if (referenceImages.length > 0) {
                        requestBody.messages[0].content = [
                            { type: 'text', text: newPrompt },
                            ...referenceImages.map(img => ({
                                type: 'image_url',
                                image_url: { url: img.data }
                            }))
                        ];
                    } else {
                        requestBody.messages[0].content = newPrompt;
                    }
                    debugLog('📱 Added explicit platform emphasis for Gemini model:', platform);
                }
            } else {
                // 对于其他模型（包括自定义模型），也确保平台信息明确
                const platformEmphasis = platform === 'mobile' 
                    ? `\n\nIMPORTANT: This must be a MOBILE APP UI design with portrait orientation, mobile navigation, status bar, and touch-friendly elements.`
                    : `\n\nIMPORTANT: This must be a DESKTOP WEB APPLICATION UI design with landscape orientation and desktop navigation.`;
                
                // 检查 prompt 中是否已有明确的平台强调
                const hasPlatformEmphasis = prompt.includes('IMPORTANT: This must be') || 
                                          prompt.includes('MOBILE APP UI') || 
                                          prompt.includes('DESKTOP WEB APPLICATION');
                
                if (!hasPlatformEmphasis) {
                    const newPrompt = `${prompt}${platformEmphasis}`;
                    if (referenceImages.length > 0) {
                        requestBody.messages[0].content = [
                            { type: 'text', text: newPrompt },
                            ...referenceImages.map(img => ({
                                type: 'image_url',
                                image_url: { url: img.data }
                            }))
                        ];
                    } else {
                        requestBody.messages[0].content = newPrompt;
                    }
                    debugLog('📱 Added platform emphasis for model:', model, platform);
                }
            }

            debugLog('📤 Request body:', JSON.stringify(requestBody, null, 2));

            const apiConfig = getApiConfig();
            const response = await fetch(apiConfig.url, {
                method: 'POST',
                headers: apiConfig.headers,
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('❌ API Error Response:', errorText);
                let errorMessage = '生成失败';
                const statusCode = response.status;
                
                try {
                    const error = JSON.parse(errorText);
                    
                    // 针对不同状态码提供详细的错误提示
                    if (statusCode === 403) {
                        // 403 权限错误 - 检查是否是地区限制
                        errorMessage = '图片生成失败: 403 - 权限错误';
                        
                        // 检查 metadata.raw 中的详细信息
                        if (error.error?.metadata?.raw) {
                            try {
                                const rawError = JSON.parse(error.error.metadata.raw);
                                if (rawError.error?.code === 'unsupported_country_region_territory') {
                                    errorMessage = '图片生成失败: 403 - 您所在的地区/国家不受支持\n\n原因：该模型提供商不支持您当前所在的地理位置。\n解决方案：\n1. 使用VPN切换到支持的地区\n2. 联系模型提供商了解支持的地区列表\n3. 尝试使用其他模型';
                                } else if (rawError.error?.message) {
                                    errorMessage = `图片生成失败: 403 - ${rawError.error.message}\n\n可能的原因：\n- API密钥权限不足\n- 地区限制\n- 账户被限制访问`;
                                }
                } catch (e) {
                                // 如果解析失败，使用原始错误信息
                                if (error.error?.message) {
                                    errorMessage = `图片生成失败: 403 - ${error.error.message}\n\n可能的原因：\n- API密钥权限不足\n- 地区限制\n- 账户被限制访问`;
                                }
                            }
                        } else if (error.error?.message) {
                            errorMessage = `图片生成失败: 403 - ${error.error.message}\n\n可能的原因：\n- API密钥权限不足\n- 地区限制\n- 账户被限制访问`;
                        }
                    } else if (statusCode === 429) {
                        errorMessage = '图片生成失败: 429 - 请求频率过高\n\n原因：免费模型限流或API调用次数超限\n解决方案：\n1. 稍后重试\n2. 添加自己的API密钥以获取更高限额';
                    } else if (statusCode === 401) {
                        errorMessage = '图片生成失败: 401 - API密钥无效\n\n原因：服务器端API密钥配置错误或已过期\n解决方案：请联系管理员检查服务器配置';
                    } else {
                        errorMessage = error.error?.message || error.message || `图片生成失败: ${statusCode}`;
                    }
                } catch (e) {
                    // JSON解析失败，使用状态码
                    if (statusCode === 403) {
                        errorMessage = '图片生成失败: 403 - 权限错误\n\n可能的原因：\n- API密钥权限不足\n- 地区限制\n- 账户被限制访问';
                    } else if (statusCode === 429) {
                        errorMessage = '图片生成失败: 429 - 请求频率过高，请稍后重试';
                    } else {
                        errorMessage = `图片生成失败: ${statusCode} - ${errorText.substring(0, 100)}`;
                    }
                }
                
                throw new Error(errorMessage);
            }

            const data = await response.json();
            debugLog('✅ Full API Response:', JSON.stringify(data, null, 2));

            // 检查响应中是否有错误信息（即使状态码是200，也可能包含错误）
            if (data.error) {
                const errorMsg = data.error.message || data.error.code || 'Provider returned error';
                console.error('❌ API返回错误:', errorMsg);
                throw new Error(`图片生成失败: ${errorMsg}\n\n模型: ${model}\n\n可能的原因：\n- 模型提供商返回错误\n- 模型暂时不可用\n- 请求参数不正确\n\n解决方案：\n1. 稍后重试\n2. 检查模型是否可用\n3. 尝试使用其他模型`);
            }

            // 检查是否有 choices 或有效数据
            if (!data.choices || !Array.isArray(data.choices) || data.choices.length === 0) {
                console.error('❌ API响应格式异常:', data);
                throw new Error(`图片生成失败: API响应格式异常\n\n模型: ${model}\n响应: ${JSON.stringify(data).substring(0, 200)}\n\n可能的原因：\n- 模型返回了意外的响应格式\n- 模型暂时不可用\n\n解决方案：\n1. 稍后重试\n2. 尝试使用其他模型`);
            }

            // 尝试所有choices（有些模型可能返回多个choices）
            let imageUrl = null;
            if (data.choices && Array.isArray(data.choices)) {
                for (let i = 0; i < data.choices.length; i++) {
                    const choice = data.choices[i];
                    debugLog(`🔍 Checking choice[${i}]`);
                    
                    // 检查 finish_reason，如果是 error 或 content_filter，说明生成失败
                    if (choice.finish_reason === 'error' || choice.finish_reason === 'content_filter') {
                        const errorMsg = choice.message?.content || choice.delta?.content || 'Provider returned error';
                        console.error(`❌ Choice[${i}] finish_reason: ${choice.finish_reason}, error: ${errorMsg}`);
                        throw new Error(`图片生成失败: ${errorMsg}\n\n模型: ${model}\n状态: ${choice.finish_reason}\n\n可能的原因：\n- 模型提供商返回错误\n- 内容被过滤\n- 模型暂时不可用\n\n解决方案：\n1. 稍后重试\n2. 修改提示词\n3. 尝试使用其他模型`);
                    }
                    
                    // 检查 message
                    if (choice.message) {
                        // 检查 message 中是否有错误内容
                        if (typeof choice.message.content === 'string' && 
                            (choice.message.content.includes('error') || 
                             choice.message.content.includes('Error') ||
                             choice.message.content.includes('Provider returned error'))) {
                            console.error(`❌ Choice[${i}] message contains error:`, choice.message.content);
                            throw new Error(`图片生成失败: ${choice.message.content}\n\n模型: ${model}\n\n可能的原因：\n- 模型提供商返回错误\n- 模型暂时不可用\n\n解决方案：\n1. 稍后重试\n2. 尝试使用其他模型`);
                        }
                        
                        debugLog('📦 Message keys:', Object.keys(choice.message));
                        debugLog('📦 Message structure:', JSON.stringify(choice.message, null, 2));
                        imageUrl = extractImageFromResponse(choice.message);
                        if (imageUrl) break;
                    }
                    
                    // 检查是否有 delta（流式响应）
                    if (choice.delta) {
                        debugLog('📦 Delta keys:', Object.keys(choice.delta));
                        imageUrl = extractImageFromResponse(choice.delta);
                        if (imageUrl) break;
                    }
                }
            }
            
            // 如果没有找到，尝试从第一个choice的message提取（向后兼容）
            if (!imageUrl) {
            const message = data.choices?.[0]?.message;
                if (message) {
                    debugLog('📦 Fallback: Checking first choice message');
                    debugLog('📦 Message keys:', Object.keys(message));
                    debugLog('📦 Message structure:', JSON.stringify(message, null, 2));
                    imageUrl = extractImageFromResponse(message);
                } else {
                console.error('❌ No message in response');
                console.error('Full data:', JSON.stringify(data, null, 2));
                throw new Error('API响应格式错误：没有message');
                }
            }

            if (!imageUrl) {
                console.error('❌ No image found in response');
                console.error('Full API response:', JSON.stringify(data, null, 2));
                // 尝试获取第一个message用于错误信息
                const firstMessage = data.choices?.[0]?.message || data.choices?.[0]?.delta;
                if (firstMessage) {
                    console.error('Available message fields:', Object.keys(firstMessage));
                    console.error('Full message:', JSON.stringify(firstMessage, null, 2));
                }
                throw new Error('模型返回了数据，但没有找到图片。请检查控制台日志查看详细响应。');
            }

            debugLog('✅ Successfully extracted image');
            debugLog('Image type:', typeof imageUrl);
            debugLog('Image length:', imageUrl.length);
            debugLog('Image preview:', imageUrl.substring(0, 100));

            // 从 API 响应中提取实际成本（如果有）
            const actualCost = data.usage?.total_cost || data.usage?.cost || null;
            if (actualCost !== null) {
                console.log(`💰 [${model}] 实际成本: $${actualCost.toFixed(4)}`);
                debugLog('💰 实际成本:', actualCost);
                return { imageUrl, actualCost };
            }

            return imageUrl;
        }

        // 从API响应中提取图片URL的统一函数
        function extractImageFromResponse(message) {
            // 递归搜索函数，用于深度搜索所有可能的字段
            function deepSearch(obj, visited = new Set()) {
                if (!obj || typeof obj !== 'object' || visited.has(obj)) {
                    return null;
                }
                visited.add(obj);
                
                // 如果是数组，遍历每个元素
                if (Array.isArray(obj)) {
                    for (let item of obj) {
                        const result = deepSearch(item, visited);
                        if (result) return result;
                    }
                    return null;
                }
                
                // 检查是否是base64图片数据或URL
                if (typeof obj === 'string') {
                    // 已经是完整的 data:image URL
                    if (obj.startsWith('data:image/')) {
                        debugLog('✅ Found base64 image (data:image)');
                        return obj;
                    }
                    // 检查是否是HTTP(S) URL
                    if (obj.startsWith('http://') || obj.startsWith('https://')) {
                        debugLog('✅ Found HTTP URL');
                        return obj;
                    }
                    // 对于很长的字符串，可能是base64图片数据
                    // 只在明确可能是图片数据的情况下才处理（避免误判普通文本）
                    if (obj.length > 500 && /^[A-Za-z0-9+/=\s]+$/.test(obj.replace(/\s/g, ''))) {
                        debugLog('🔍 Found potential base64 string, length:', obj.length);
                        // 对于明确是base64格式的长字符串，尝试添加前缀
                        const cleanBase64 = obj.replace(/\s/g, '');
                        // PNG magic number (base64编码后是 iVBORw0KGgo)
                        if (cleanBase64.startsWith('iVBORw0KGgo')) {
                            debugLog('✅ Detected PNG base64');
                            return `data:image/png;base64,${cleanBase64}`;
                        }
                        // JPEG magic number (base64编码后是 /9j/)
                        if (cleanBase64.startsWith('/9j/')) {
                            debugLog('✅ Detected JPEG base64');
                            return `data:image/jpeg;base64,${cleanBase64}`;
                        }
                    }
                    return null;
                }
                
                // 检查常见的关键字段
                const imageFields = ['image', 'image_url', 'url', 'data', 'b64_json', 'base64'];
                for (let field of imageFields) {
                    if (obj[field]) {
                        debugLog(`🔍 Found field: ${field}, type: ${typeof obj[field]}`);
                        
                        // 特殊处理：image_url 可能是对象 {url: "..."}
                        if (field === 'image_url' && typeof obj[field] === 'object' && !Array.isArray(obj[field])) {
                            if (obj[field].url) {
                                debugLog(`✅ Found image_url.url`);
                                const urlValue = obj[field].url;
                                if (typeof urlValue === 'string' && (urlValue.startsWith('data:image/') || urlValue.startsWith('http'))) {
                                    return urlValue;
                                }
                            }
                        }
                        
                        // 如果字段值是字符串，直接检查
                        if (typeof obj[field] === 'string') {
                            if (obj[field].startsWith('data:image/')) {
                                debugLog(`✅ Found ${field} (data:image)`);
                                return obj[field];
                            }
                            if (obj[field].startsWith('http://') || obj[field].startsWith('https://')) {
                                debugLog(`✅ Found ${field} (HTTP URL)`);
                                return obj[field];
                            }
                            // 对于 b64_json 字段，添加前缀
                            if (field === 'b64_json' && obj[field].length > 100) {
                                debugLog(`✅ Found ${field} (base64), adding prefix`);
                                return `data:image/png;base64,${obj[field]}`;
                            }
                        }
                        // 递归搜索
                        const result = deepSearch(obj[field], visited);
                        if (result) {
                            // 如果是b64_json且结果没有前缀，添加前缀
                            if (field === 'b64_json' && typeof result === 'string' && !result.startsWith('data:') && !result.startsWith('http')) {
                                return `data:image/png;base64,${result}`;
                            }
                            return result;
                        }
                    }
                }
                
                // 递归搜索所有属性
                for (let key in obj) {
                    if (obj.hasOwnProperty(key) && !['reasoning', 'text', 'role'].includes(key)) {
                        const result = deepSearch(obj[key], visited);
                        if (result) return result;
                    }
                }
                
                return null;
            }
            
            // 方法1: 检查 content 数组 (最常见的格式)
            if (Array.isArray(message.content)) {
                debugLog('🔍 Checking content array, length:', message.content.length);
                for (let i = 0; i < message.content.length; i++) {
                    const item = message.content[i];
                    debugLog(`  [${i}] type:`, item.type, 'keys:', Object.keys(item));

                    // Gemini 格式: {type: "image_url", image_url: {url: "data:image/..."}}
                    if (item.type === 'image_url') {
                        if (typeof item.image_url === 'string') {
                            debugLog('✅ Found image_url (string)');
                            return item.image_url;
                        }
                        if (item.image_url && typeof item.image_url === 'object') {
                            if (item.image_url.url) {
                            debugLog('✅ Found image_url.url');
                            return item.image_url.url;
                            }
                            // 深度搜索 image_url 对象
                            const found = deepSearch(item.image_url);
                            if (found) return found;
                        }
                    }

                    // Claude/GPT 格式: {type: "image", source: {data: "..."}}
                    if (item.type === 'image') {
                        if (item.url) {
                            debugLog('✅ Found item.url');
                            return item.url;
                        }
                        if (item.data) {
                            debugLog('✅ Found item.data');
                            return item.data;
                        }
                        if (item.source && item.source.data) {
                            debugLog('✅ Found item.source.data');
                            return item.source.data;
                        }
                        // 深度搜索整个item
                        const found = deepSearch(item);
                        if (found) return found;
                    }
                }
            }

            // 方法2: content 是字符串，可能包含URL或markdown
            if (typeof message.content === 'string') {
                debugLog('🔍 Checking string content');
                const url = extractImageUrl(message.content);
                if (url) {
                    debugLog('✅ Extracted URL from string');
                    return url;
                }
                // 检查是否是base64字符串
                if (message.content.length > 100 && message.content.startsWith('iVBORw0KGgo') || message.content.startsWith('/9j/')) {
                    debugLog('✅ Found base64 in string content');
                    const prefix = message.content.startsWith('iVBORw0KGgo') ? 'data:image/png;base64,' : 'data:image/jpeg;base64,';
                    return prefix + message.content;
                }
            }

            // 方法3: 检查 images 数组
            if (Array.isArray(message.images) && message.images.length > 0) {
                debugLog('🔍 Checking images array');
                const found = deepSearch(message.images);
                if (found) return found;
            }

            // 方法4: 直接字段
            if (message.image) {
                debugLog('✅ Found message.image');
                const found = deepSearch(message.image);
                if (found) return found;
                return message.image;
            }
            if (message.image_url) {
                debugLog('✅ Found message.image_url');
                const found = deepSearch(message.image_url);
                if (found) return found;
                return message.image_url;
            }

            // 方法5: 深度搜索整个message对象（处理可能的嵌套结构）
            debugLog('🔍 Deep searching entire message object');
            const found = deepSearch(message);
            if (found) {
                debugLog('✅ Found image through deep search');
                return found;
            }

            // 未找到
            return null;
        }

        // 图片URL解析器
        function extractImageUrl(text) {
            // 方法1: Markdown格式 ![](url)
            let match = text.match(/!\[.*?\]\((https?:\/\/\S+?\.(?:png|jpg|jpeg|webp))\)/i);
            if (match) return match[1];
            
            // 方法2: 纯URL
            match = text.match(/(https?:\/\/\S+?\.(?:png|jpg|jpeg|webp))/i);
            if (match) return match[1];
            
            // 方法3: 任何https链接（最后尝试）
            match = text.match(/(https?:\/\/[^\s<>"]+)/i);
            if (match) return match[1];
            
            return null;
        }

        async function generateDescription(model, prompt) {
            const apiConfig = getApiConfig();
            const response = await fetch(apiConfig.url, {
                method: 'POST',
                headers: apiConfig.headers,
                body: JSON.stringify({
                    model: model,
                    messages: [
                        {
                            role: 'user',
                            content: `Based on this UI requirement, create a detailed description for image generation:\n\n${prompt}\n\nProvide a concise, visual description focusing on layout, colors, and UI elements.`
                        }
                    ]
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('❌ 描述生成API错误:', errorText);
                let errorMessage = '描述生成失败';
                const statusCode = response.status;
                
                try {
                    const error = JSON.parse(errorText);
                    
                    if (statusCode === 403) {
                        errorMessage = '描述生成失败: 403 - 权限错误';
                        if (error.error?.metadata?.raw) {
                            try {
                                const rawError = JSON.parse(error.error.metadata.raw);
                                if (rawError.error?.code === 'unsupported_country_region_territory') {
                                    errorMessage = '描述生成失败: 403 - 您所在的地区/国家不受支持\n\n原因：该模型提供商不支持您当前所在的地理位置。\n解决方案：使用VPN或尝试其他模型';
                                } else if (rawError.error?.message) {
                                    errorMessage = `描述生成失败: 403 - ${rawError.error.message}`;
                                }
                            } catch (e) {
                                if (error.error?.message) {
                                    errorMessage = `描述生成失败: 403 - ${error.error.message}`;
                                }
                            }
                        } else if (error.error?.message) {
                            errorMessage = `描述生成失败: 403 - ${error.error.message}`;
                        }
                    } else if (statusCode === 429) {
                        errorMessage = '描述生成失败: 429 - 请求频率过高，请稍后重试';
                    } else if (error.error?.message) {
                        errorMessage = `描述生成失败: ${statusCode} - ${error.error.message}`;
                    }
                } catch (e) {
                    if (statusCode === 403) {
                        errorMessage = '描述生成失败: 403 - 权限错误，可能是地区限制';
                    } else {
                        errorMessage = `描述生成失败: ${statusCode}`;
                    }
                }
                
                throw new Error(errorMessage);
            }

            const data = await response.json();
            const message = data.choices?.[0]?.message;
            
            if (!message) {
                throw new Error('API响应格式错误：没有message');
            }
            
            let description = '';
            
            // 处理 content 字段
            if (typeof message.content === 'string') {
                description = message.content;
            } else if (Array.isArray(message.content)) {
                // 如果 content 是数组，提取所有文本内容
                description = message.content
                    .filter(item => item.type === 'text' && item.text)
                    .map(item => item.text)
                    .join('\n');
            }
            
            // 如果描述为空，尝试使用 reasoning（某些模型可能将描述放在 reasoning 中）
            if (!description && message.reasoning) {
                description = typeof message.reasoning === 'string' 
                    ? message.reasoning 
                    : JSON.stringify(message.reasoning);
            }
            
            if (!description) {
                console.error('❌ 无法提取描述内容');
                console.error('Message structure:', JSON.stringify(message, null, 2));
                throw new Error('无法从模型响应中提取描述内容');
            }
            
            // 清理描述：移除可能的 markdown 标记、代码块等
            description = description.trim();
            
            // 如果描述太长，尝试提取核心部分（前2000字符通常足够用于图像生成）
            if (description.length > 2000) {
                console.warn('⚠️ 描述过长，截取前2000字符用于图像生成');
                description = description.substring(0, 2000);
            }
            
            debugLog('📝 提取的描述:', description.substring(0, 200));
            
            // 从 API 响应中提取实际成本（OpenRouter 返回在 usage 中）
            const actualCost = data.usage?.total_cost || data.usage?.cost || null;
            if (actualCost !== null) {
                console.log(`💰 [${model}] 实际成本: $${actualCost.toFixed(4)}`);
                debugLog('💰 实际成本:', actualCost);
                return { description, actualCost };
            }
            
            return description;
        }

        /**
         * 生成代码
         */
        async function generateCode(modelInput, prompt, platform = 'mobile') {
            // 允许传入模型配置对象或纯字符串
            const modelConfig = typeof modelInput === 'object' ? modelInput : { model: modelInput };
            const model = modelConfig.model || '';
            const platformInfo = platform === 'mobile' 
                ? 'mobile app (iOS/Android)' 
                : 'desktop web application';
            
            // 语言约束：默认使用中文展示界面文案
            // 如果用户在提示词中明确提到英文/English/海外等，则不强制中文
            const lowerPrompt = (prompt || '').toLowerCase();
            const hasForeignHint = /english|英文|overseas|海外|global|intl|international/.test(lowerPrompt);
            const chineseLanguageHint = hasForeignHint 
                ? '' 
                : '\n\n重要：请使用简体中文展示界面中的所有文本（标题、按钮、标签、导航、提示信息等），除非提示词中明确要求使用其他语言。不要输出英文 UI 文本（品牌名和专有名词除外）。';
            
            // 构建prompt（完整版：Zeabur无超时限制，可以使用详细设计指南）
            let codePrompt = `${prompt}${chineseLanguageHint}

请生成**有设计感**的 ${platformInfo} UI 界面代码。

🎨 设计原则（必须遵循）：
1. **独特风格** - 避免通用模板，选择明确的设计方向（极简/杂志风/工业风/柔和自然风）
2. **视觉记忆点** - 创造一个独特元素（特殊排版/微妙动效/独特配色/精致细节）
3. **精致细节** - 注重字体大小、行高、间距、圆角的协调统一

⚡ 技术要求：
1. 完整可运行的 HTML（包含内联CSS和必要JS）
2. 适配${platform === 'mobile' ? '移动端' : '桌面端'}，使用Flexbox或Grid布局
3. **严禁占位符**：所有图标/图表/装饰必须用CSS渐变、几何形状或内联SVG实现
4. 直接输出纯HTML代码，不要markdown标记（\`\`\`html等）

📐 示例技巧：
- 图标：用CSS画圆形、三角形、线条组合
- 图表：用内联SVG绘制（<svg><rect>柱状图、<polyline>折线图、<path>饼图）
- 背景：用CSS渐变（linear-gradient、radial-gradient）
- 头像：用CSS圆形+渐变背景+文字首字母

🚫 **绝对禁止**：
- ❌ 空的<div>占位符（如 <div style="background:#ddd; height:200px"></div>）
- ❌ 注释占位（<!-- 图表位置 -->）
- ❌ 任何灰色/空白占位区域
- ✅ 必须用实际的SVG代码绘制图表，例如：
  <svg width="100%" height="200">
    <rect x="10" y="50" width="30" height="100" fill="#ff6b6b"/>
    <rect x="50" y="80" width="30" height="70" fill="#4ecdc4"/>
  </svg>

请直接输出HTML代码，确保所有视觉元素都是实际渲染的内容。`;

            // 调试：输出完整的 prompt（如果启用调试模式）
            debugLog('📝 完整代码生成 Prompt:', codePrompt.substring(0, 500) + '...');
            if (chineseLanguageHint) {
                console.log('✅ 已添加中文语言约束');
                debugLog('✅ 已添加中文语言约束');
            } else {
                console.log('ℹ️ 未添加中文约束（检测到用户要求使用其他语言）');
                debugLog('ℹ️ 未添加中文约束（检测到用户要求使用其他语言）');
            }

            // 构建消息内容
            let content;
            if (referenceImages.length > 0) {
                // 包含参考图片
                content = [
                    {
                        type: 'text',
                        text: codePrompt
                    },
                    ...referenceImages.map(img => ({
                        type: 'image_url',
                        image_url: {
                            url: img.data
                        }
                    }))
                ];
            } else {
                content = codePrompt;
            }

            // 设置超时时间（根据模型类型动态调整）
            const controller = new AbortController();
            const getTimeout = (model, customTimeout) => {
                if (customTimeout) return customTimeout;
                // 对于响应较慢的模型，给予更长的超时时间
                if (model.includes('claude-opus')) {
                    return 150000; // Claude Opus: 150秒（非常慢）
                } else if (model.includes('claude-sonnet-4.5')) {
                    return 120000; // Claude Sonnet 4.5: 120秒
                } else if (model.includes('deepseek') || model.includes('qwen')) {
                    return 100000; // DeepSeek/Qwen: 100秒
                } else if (model.includes('gpt-4')) {
                    return 110000; // GPT-4 系列：110秒
                } else {
                    return 90000; // 默认：90秒
                }
            };
            const timeoutDuration = getTimeout(model, modelConfig.timeout);
            const timeoutId = setTimeout(() => controller.abort(), timeoutDuration);
            
            // 带重试机制的请求函数（针对429错误）
            const makeRequestWithRetry = async (requestBody, maxRetries = 2) => {
                let lastError;
                
                for (let attempt = 0; attempt <= maxRetries; attempt++) {
                    try {
                        const apiConfig = getApiConfig();
                        const response = await fetch(apiConfig.url, {
                    method: 'POST',
                    headers: apiConfig.headers,
                            body: JSON.stringify(requestBody),
                    signal: controller.signal
                });
                        
                        // 如果是429错误且还有重试次数，进行重试
                        if (response.status === 429 && attempt < maxRetries) {
                            const retryDelay = Math.min(2000 * Math.pow(2, attempt), 10000); // 指数退避：2s, 4s, 最多10s
                            debugLog(`⚠️ 429限流错误，${retryDelay}ms后重试 (${attempt + 1}/${maxRetries})`);
                            await new Promise(resolve => setTimeout(resolve, retryDelay));
                            continue; // 重试
                        }
                
                clearTimeout(timeoutId);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('代码生成API错误:', errorText);
                    
                    // 解析错误信息，提供更友好的错误提示
                    let errorMessage = `代码生成失败: ${response.status}`;
                    const statusCode = response.status;
                    
                    try {
                        const errorData = JSON.parse(errorText);
                        
                        // 针对不同状态码提供详细的错误提示
                        if (statusCode === 403) {
                            // 403 权限错误 - 检查是否是地区限制
                            errorMessage = '代码生成失败: 403 - 权限错误';
                            
                            // 检查 metadata.raw 中的详细信息
                            if (errorData.error?.metadata?.raw) {
                                try {
                                    const rawError = JSON.parse(errorData.error.metadata.raw);
                                    if (rawError.error?.code === 'unsupported_country_region_territory') {
                                        errorMessage = '代码生成失败: 403 - 您所在的地区/国家不受支持\n\n原因：该模型提供商不支持您当前所在的地理位置。\n解决方案：\n1. 使用VPN切换到支持的地区\n2. 联系模型提供商了解支持的地区列表\n3. 尝试使用其他模型';
                                    } else if (rawError.error?.message) {
                                        errorMessage = `代码生成失败: 403 - ${rawError.error.message}\n\n可能的原因：\n- API密钥权限不足\n- 地区限制\n- 账户被限制访问`;
                                    }
                                } catch (e) {
                                    // 如果解析失败，使用原始错误信息
                                    if (errorData.error?.message) {
                                        errorMessage = `代码生成失败: 403 - ${errorData.error.message}\n\n可能的原因：\n- API密钥权限不足\n- 地区限制\n- 账户被限制访问`;
                                    }
                                }
                            } else if (errorData.error?.message) {
                                errorMessage = `代码生成失败: 403 - ${errorData.error.message}\n\n可能的原因：\n- API密钥权限不足\n- 地区限制\n- 账户被限制访问`;
                            }
                        } else if (statusCode === 429) {
                            errorMessage = '代码生成失败: 429 - 请求频率过高\n\n原因：免费模型限流或API调用次数超限\n解决方案：\n1. 稍后重试\n2. 添加自己的API密钥以获取更高限额';
                        } else if (statusCode === 402) {
                            errorMessage = '代码生成失败: 402 - 余额不足\n\n原因：OpenRouter账户credits不足\n解决方案：\n1. 前往OpenRouter充值credits\n2. 减少请求的token数量\n3. 使用免费模型';
                        } else if (statusCode === 401) {
                                    errorMessage = '代码生成失败: 401 - API密钥无效\n\n原因：服务器端API密钥配置错误或已过期\n解决方案：请联系管理员检查服务器配置';
                        } else if (statusCode === 404) {
                            errorMessage = '代码生成失败: 404 - 模型不存在\n\n原因：模型ID错误或模型已下架\n解决方案：\n1. 检查模型名称是否正确\n2. 查看OpenRouter支持的模型列表';
                        } else if (errorData.error?.message) {
                            errorMessage = `代码生成失败: ${statusCode} - ${errorData.error.message}`;
                        }
                    } catch (e) {
                        // JSON解析失败，使用状态码
                        if (statusCode === 403) {
                            errorMessage = '代码生成失败: 403 - 权限错误\n\n可能的原因：\n- API密钥权限不足\n- 地区限制\n- 账户被限制访问';
                        } else if (statusCode === 429) {
                            errorMessage = '代码生成失败: 429 - 请求频率过高，请稍后重试';
                        } else {
                            errorMessage = `代码生成失败: ${statusCode} - ${errorText.substring(0, 100)}`;
                        }
                    }
                    
                    throw new Error(errorMessage);
                }
                        
                        // 成功返回响应
                        return response;
                    } catch (error) {
                        lastError = error;
                        // 如果是429错误且还有重试次数，继续重试
                        if (error.message.includes('429') && attempt < maxRetries) {
                            continue;
                        }
                        // 其他错误或重试次数用完，抛出错误
                        throw error;
                    }
                }
                
                // 所有重试都失败
                throw lastError;
            };
            
            try {
                const requestBody = {
                    model: model,
                    messages: [
                        {
                            role: 'user',
                            content: content
                        }
                    ],
                    // 优化max_tokens：平衡速度和完整性
                    max_tokens: (() => {
                        // Zeabur无超时限制 - 可以大幅提升max_tokens生成更完整的代码
                        // 4000 tokens ≈ 3000-3500字代码，可以生成复杂完整的UI
                        if (model.includes(':free')) {
                            return 3000; // 免费模型：3000 tokens
                        } else if (model.includes('deepseek') || model.includes('qwen')) {
                            return 4000; // DeepSeek/Qwen：4000 tokens（Zeabur无超时限制）
                        } else if (model.includes('grok')) {
                            return 4000; // Grok：4000 tokens（Zeabur无超时限制）
                        } else {
                            return 4000; // Claude等快速模型：4000 tokens
                        }
                    })(),
                    // 添加temperature控制 - 更确定性，生成更快
                    temperature: 0.7
                };
                
                const response = await makeRequestWithRetry(requestBody);

                const data = await response.json();
                
                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('API返回格式错误');
                }
                
                // 检查是否因为 max_tokens 限制导致代码被截断
                const choice = data.choices[0];
                let wasTruncated = false;
                if (choice.finish_reason === 'length') {
                    console.warn('⚠️ 代码生成可能被截断（达到 max_tokens 限制）');
                    debugLog('⚠️ finish_reason: length - 代码可能不完整');
                    wasTruncated = true;
                    // 在界面上显示警告
                    showToast('⚠️ 代码可能不完整（已达生成限制），建议简化需求或升级计划', 5000);
                }
                
                let code = data.choices[0].message.content;
                
                // 记录代码长度，用于诊断
                debugLog('📏 生成的代码长度:', code.length, '字符');
                debugLog('📏 生成的代码 tokens 估算:', Math.ceil(code.length / 4), 'tokens');
                
                // 清理/提取代码块，防止在 iframe 中显示 ```html
                const sanitizeCode = (raw) => {
                    if (!raw) return '';
                    let cleaned = raw.trim();
                    
                    // 移除所有 markdown 代码块标记（包括 ```html, ```, ```html\n 等）
                    // 优先提取 markdown 代码块内容
                    const blockMatch = cleaned.match(/```[a-zA-Z]*\s*([\s\S]*?)```/);
                    if (blockMatch && blockMatch[1]) {
                        cleaned = blockMatch[1].trim();
                    } else {
                        // 如果没有匹配到标准代码块，但存在起始 ```
                        if (cleaned.startsWith('```')) {
                            // 移除开头的 ```html 或 ``` 标记
                            cleaned = cleaned.replace(/^```[a-zA-Z]*\s*/,'').replace(/```$/g, '').trim();
                        }
                    }
                    
                    // 额外清理：移除可能残留的 "html" 文本（如果出现在代码开头）
                    // 但保留代码中实际包含的 "html" 字符串
                    if (cleaned.startsWith('html\n') || cleaned.startsWith('html\r\n')) {
                        cleaned = cleaned.substring(4).trim();
                    }
                    if (cleaned.startsWith('html')) {
                        // 检查是否是独立的 "html" 单词（后面跟着换行或空格）
                        const htmlMatch = cleaned.match(/^html[\s\n\r]+/);
                        if (htmlMatch) {
                            cleaned = cleaned.substring(htmlMatch[0].length).trim();
                        }
                    }
                    
                    // 移除代码开头的任何纯文本 "html" 标记（如果后面跟着换行）
                    cleaned = cleaned.replace(/^html\s*\n\s*/i, '');
                    
                    return cleaned;
                };
                
                code = sanitizeCode(code);
                
                // 调试：记录清理后的代码开头（用于排查问题）
                debugLog('🧹 清理后的代码开头:', code.substring(0, 200));
                
                if (!code || code.trim().length === 0) {
                    throw new Error('生成的代码为空');
                }
                
                // 确保代码包含基本的HTML结构
                if (!code.includes('<html') && !code.includes('<!DOCTYPE')) {
                    // 如果没有完整的HTML结构，尝试包装它
                    if (code.includes('<body') || code.includes('<div')) {
                        code = `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generated UI</title>
</head>
${code.includes('<body') ? code : '<body>' + code + '</body>'}
</html>`;
                    } else {
                        // 仍然没有结构时，简单包裹到 body 内，避免 iframe 中显示 ```html 文本
                        code = `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generated UI</title>
</head>
<body>
${code}
</body>
</html>`;
                    }
                }
                
                // 从 API 响应中提取实际成本（OpenRouter 返回在 usage 中）
                const actualCost = data.usage?.total_cost || data.usage?.cost || null;
                if (actualCost !== null || wasTruncated) {
                    console.log(`💰 [${model}] 实际成本: $${actualCost ? actualCost.toFixed(4) : '未知'}`);
                    debugLog('💰 实际成本:', actualCost);
                    return { code, actualCost, wasTruncated };
                }

                return { code, wasTruncated };
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    const timeoutSeconds = Math.round(timeoutDuration / 1000);
                    throw new Error(`代码生成失败: 请求超时（${timeoutSeconds}秒）\n\n原因：请求时间过长，可能网络较慢或模型响应慢\n解决方案：\n1. 检查网络连接\n2. 稍后重试\n3. 选择响应更快的模型（如Gemini 3 Pro Image或Claude 3.5）\n4. 简化提示词以减少生成时间\n5. 如果是慢速模型（如Opus、Sonnet），可能需要更多时间，请耐心等待`);
                } else if (error.message && error.message.includes('Failed to fetch')) {
                    // 网络错误
                    throw new Error(`代码生成失败: 网络连接错误\n\n原因：无法连接到OpenRouter API服务器\n可能的原因：\n- 网络连接不稳定\n- 防火墙或代理设置问题\n- API服务器暂时不可用\n- 模型ID可能不正确（${model}）\n\n解决方案：\n1. 检查网络连接\n2. 检查防火墙/代理设置\n3. 确认模型ID是否正确\n4. 稍后重试\n5. 尝试使用其他模型`);
                } else if (error.message && error.message.includes('ERR_HTTP2')) {
                    // HTTP/2协议错误
                    throw new Error(`代码生成失败: HTTP协议错误\n\n原因：HTTP/2协议错误，可能是网络或服务器问题\n可能的原因：\n- 网络连接不稳定\n- 服务器暂时不可用\n- 模型ID可能不正确（${model}）\n\n解决方案：\n1. 检查网络连接\n2. 确认模型ID是否正确\n3. 稍后重试\n4. 尝试使用其他模型`);
                } else {
                    // 其他错误，如果已经有详细错误信息就使用，否则添加模型信息
                    if (error.message && !error.message.includes('代码生成失败')) {
                        throw new Error(`代码生成失败: ${error.message}\n\n模型: ${model}\n\n如果问题持续，请尝试：\n1. 检查模型ID是否正确\n2. 检查网络连接\n3. 尝试使用其他模型`);
                    }
                    throw error;
                }
            }
        }

        // 结果卡片占位符相关
        function addResultCardPlaceholder(modelKey) {
            const config = MODEL_CONFIGS[modelKey];
            const card = document.createElement('div');
            card.id = `result-card-${modelKey}`;
            card.className = 'image-card card-glow rounded-xl overflow-hidden card-animate';
            
            // 生成中的占位符
            const placeholderDiv = document.createElement('div');
            placeholderDiv.className = 'bg-stone-900/50 flex items-center justify-center p-6';
            placeholderDiv.style.height = '400px';
            placeholderDiv.innerHTML = `
                <div class="text-center">
                    <div class="spinner mx-auto mb-4"></div>
                    <div class="text-stone-300 text-sm font-medium mb-1">${config.name}</div>
                    <div class="text-stone-500 text-xs">生成中...</div>
                </div>
            `;
            
            const infoDiv = document.createElement('div');
            infoDiv.className = 'p-4 bg-stone-800/50 border-t border-stone-700/30';
            infoDiv.innerHTML = `
                <div class="flex justify-between items-center">
                    <span class="text-stone-200 font-semibold text-sm">${config.name}</span>
                    <span class="text-stone-500 text-xs font-mono">$${config.cost.toFixed(2)}</span>
                </div>
            `;
            
            card.appendChild(placeholderDiv);
            card.appendChild(infoDiv);
            document.getElementById('resultsGrid').appendChild(card);
        }

        // 更新结果卡片状态
        function updateResultCard(modelKey, imageUrl = null, codeContent = null, isError = false, errorMsg = '', actualCost = null, wasTruncated = false) {
            const card = document.getElementById(`result-card-${modelKey}`);
            if (!card) {
                console.warn(`Card not found for model: ${modelKey}`);
                return;
            }
            
            const config = MODEL_CONFIGS[modelKey];
            // 优先使用实际成本，如果没有则使用配置的成本
            const displayCost = actualCost !== null ? actualCost : (config ? config.cost : 0);
            
            // 清空卡片内容
            card.innerHTML = '';
            
            if (isError) {
                // 错误状态 - 统一尺寸
                const errorDiv = document.createElement('div');
                errorDiv.className = 'bg-red-500/5 flex items-center justify-center p-6';
                errorDiv.style.height = '400px';
                errorDiv.innerHTML = `
                    <div class="text-center">
                        <div class="w-12 h-12 mx-auto mb-3 rounded-xl bg-red-500/10 flex items-center justify-center">
                            <svg class="w-6 h-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                        <div class="text-red-400 text-sm font-medium mb-2">生成失败</div>
                        <div class="text-stone-500 text-xs max-h-20 overflow-y-auto px-4">${errorMsg || '未知错误'}</div>
                    </div>
                `;
                
                const infoDiv = document.createElement('div');
                infoDiv.className = 'p-4 bg-stone-800/50 border-t border-stone-700/30';
                infoDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-stone-200 font-semibold text-sm">${config.name}</span>
                        <span class="text-stone-500 text-xs font-mono">$${displayCost.toFixed(4)}</span>
                    </div>
                    <button class="w-full bg-stone-700 hover:bg-stone-600 text-stone-300 font-medium text-sm py-2.5 rounded-lg transition flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        重试
                    </button>
                `;
                const retryButton = infoDiv.querySelector('button');
                if (retryButton) {
                    console.log('🔘 绑定重试按钮事件，模型:', config.name, 'modelKey:', modelKey);
                    retryButton.onclick = () => {
                        console.log('🖱️ 重试按钮被点击（事件触发）', config.name);
                        retryModel(config.name);
                    };
                } else {
                    console.error('❌ 未找到重试按钮元素');
                }

                card.appendChild(errorDiv);
                card.appendChild(infoDiv);
            } else if (codeContent) {
                // 代码内容 - 统一尺寸，只显示首屏
                const codeContainer = document.createElement('div');
                codeContainer.className = 'bg-stone-900/30 flex flex-col overflow-hidden';
                codeContainer.style.height = '500px';
                
                const previewArea = document.createElement('div');
                previewArea.className = 'flex-1 relative cursor-pointer hover:opacity-95 transition overflow-hidden';
                previewArea.style.minHeight = '0';
                previewArea.style.display = 'flex';
                previewArea.style.alignItems = 'center';
                previewArea.style.justifyContent = 'center';
                previewArea.style.background = 'linear-gradient(135deg, #1c1917 0%, #0c0a09 100%)';
                previewArea.title = '点击查看大图';
                
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'absolute inset-0 flex items-center justify-center bg-stone-900';
                loadingDiv.innerHTML = '<div class="spinner"></div>';
                previewArea.appendChild(loadingDiv);
                
                const iframe = document.createElement('iframe');
                iframe.className = 'border-0 rounded-lg shadow-2xl';
                iframe.style.opacity = '0';
                iframe.style.transition = 'opacity 0.3s';
                iframe.style.pointerEvents = 'none';
                iframe.setAttribute('scrolling', 'no');
                
                const platformRadio = document.querySelector('input[name="platform"]:checked');
                const currentPlatform = platformRadio ? platformRadio.value : 'mobile';
                
                if (currentPlatform === 'mobile') {
                    iframe.style.width = '280px';
                    iframe.style.height = '380px';
                    iframe.width = '375';
                    iframe.height = '500';
                    iframe.style.transform = 'scale(0.75)';
                    iframe.style.transformOrigin = 'center center';
                } else {
                    iframe.style.width = '100%';
                    iframe.style.height = '100%';
                    iframe.style.maxWidth = '800px';
                }
                
                iframe.srcdoc = codeContent;
                
                iframe.onload = () => {
                    setTimeout(() => {
                        iframe.style.opacity = '1';
                        if (previewArea.contains(loadingDiv)) {
                            previewArea.removeChild(loadingDiv);
                        }
                        
                        try {
                            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                            if (iframeDoc && iframeDoc.body) {
                                iframeDoc.body.style.overflow = 'hidden';
                                iframeDoc.body.style.height = '100%';
                            }
                            if (iframeDoc && iframeDoc.documentElement) {
                                iframeDoc.documentElement.style.overflow = 'hidden';
                                iframeDoc.documentElement.style.height = '100%';
                            }
                        } catch (e) {
                            // 跨域限制，忽略
                        }
                    }, 500);
                };
                
                iframe.onerror = () => {
                    if (previewArea.contains(loadingDiv)) {
                        loadingDiv.innerHTML = '<div class="text-stone-500 text-sm">加载失败</div>';
                    }
                };
                
                previewArea.appendChild(iframe);
                previewArea.onclick = (e) => {
                    e.stopPropagation();
                    const platformRadio = document.querySelector('input[name="platform"]:checked');
                    const currentPlatform = platformRadio ? platformRadio.value : 'mobile';
                    showCodePreview(codeContent, config.name, currentPlatform);
                };
                
                codeContainer.appendChild(previewArea);
                
                const infoDiv = document.createElement('div');
                infoDiv.className = 'p-3 bg-stone-800/50 flex-shrink-0 border-t border-stone-700/30';
                infoDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-stone-200 font-semibold text-sm">${config.name}</span>
                        <span class="text-stone-500 text-xs font-mono">$${displayCost.toFixed(4)}</span>
                    </div>
                    ${wasTruncated ? `
                    <div class="mb-2 px-2 py-1.5 bg-amber-500/10 border border-amber-500/20 rounded-lg flex items-center gap-2">
                        <svg class="w-3.5 h-3.5 text-amber-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                        <span class="text-amber-400 text-xs">代码可能不完整</span>
                    </div>
                    ` : ''}
                    <div class="flex gap-2">
                        <button class="flex-1 bg-stone-700 hover:bg-stone-600 text-stone-300 font-medium text-xs py-2 rounded-lg transition flex items-center justify-center gap-1.5">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
                            代码
                        </button>
                        <button class="flex-1 bg-stone-700 hover:bg-stone-600 text-stone-300 font-medium text-xs py-2 rounded-lg transition flex items-center justify-center gap-1.5">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            下载
                        </button>
                    </div>
                `;
                
                infoDiv.querySelectorAll('button')[0].onclick = (e) => {
                    e.stopPropagation();
                    showCodeModal(codeContent, config.name);
                };
                
                infoDiv.querySelectorAll('button')[1].onclick = async (e) => {
                    e.stopPropagation();
                    const platformRadio = document.querySelector('input[name="platform"]:checked');
                    const currentPlatform = platformRadio ? platformRadio.value : 'mobile';
                    
                    // 显示加载提示
                    showToast('🖼️ 正在生成图片...', 2000);
                    
                    try {
                        // 将代码转换为图片
                        const imageData = await codeToImage(codeContent, currentPlatform);
                        
                        if (imageData) {
                            // 下载图片
                            await downloadImage(imageData, config.name);
                            showToast('✅ 图片已生成并下载', 2000);
                        } else {
                            // 如果生成失败，打开全屏预览让用户截图
                            showCodePreview(codeContent, config.name, currentPlatform);
                            setTimeout(() => {
                                showToast('💡 提示：请在全屏预览中按 Cmd+Shift+4 (Mac) 或 Win+Shift+S (Windows) 截图保存', 4000);
                            }, 500);
                        }
                    } catch (error) {
                        console.error('生成图片失败:', error);
                        // 如果生成失败，打开全屏预览让用户截图
                        showCodePreview(codeContent, config.name, currentPlatform);
                        setTimeout(() => {
                            showToast('💡 提示：请在全屏预览中按 Cmd+Shift+4 (Mac) 或 Win+Shift+S (Windows) 截图保存', 4000);
                        }, 500);
                    }
                };
                
                codeContainer.appendChild(infoDiv);
                card.appendChild(codeContainer);
            } else if (imageUrl) {
                // 图片内容 - 统一尺寸，移动端保持手机屏幕比例
                const isBase64 = imageUrl.startsWith('data:image');
                const isHttpUrl = imageUrl.startsWith('http');
                
                if (isBase64 || isHttpUrl) {
                    const imgContainer = document.createElement('div');
                    imgContainer.className = 'relative';
                    imgContainer.style.height = '400px';
                    imgContainer.style.width = '100%';
                    imgContainer.style.display = 'flex';
                    imgContainer.style.alignItems = 'center';
                    imgContainer.style.justifyContent = 'center';
                    imgContainer.style.background = 'linear-gradient(135deg, #1c1917 0%, #0c0a09 100%)';

                    const platformRadio = document.querySelector('input[name="platform"]:checked');
                    const currentPlatform = platformRadio ? platformRadio.value : 'mobile';

                    if (currentPlatform === 'mobile') {
                        imgContainer.style.padding = '20px 16px';
                    }

                    // 添加加载指示器
                    const loadingIndicator = document.createElement('div');
                    loadingIndicator.className = 'absolute inset-0 flex items-center justify-center bg-stone-900/50';
                    loadingIndicator.innerHTML = '<div class="spinner"></div>';
                    imgContainer.appendChild(loadingIndicator);

                    const img = document.createElement('img');
                    img.className = 'object-contain rounded-lg shadow-2xl';
                    img.style.maxWidth = '100%';
                    img.style.maxHeight = '100%';
                    img.style.width = 'auto';
                    img.style.height = 'auto';
                    img.style.opacity = '0';
                    img.style.transition = 'opacity 0.3s ease';
                    img.alt = config.name;

                    img.onload = function() {
                        console.log('✅ 图片加载成功:', config.name);
                        // 移除加载指示器
                        if (imgContainer.contains(loadingIndicator)) {
                            imgContainer.removeChild(loadingIndicator);
                        }
                        // 显示图片
                        img.style.opacity = '1';
                    };

                    img.onerror = function() {
                        console.error('❌ 图片加载失败:', config.name);
                        imgContainer.innerHTML = `
                            <div class="w-full h-full flex flex-col items-center justify-center p-4">
                                <div class="w-12 h-12 mx-auto mb-3 rounded-xl bg-amber-500/10 flex items-center justify-center">
                                    <svg class="w-6 h-6 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                                </div>
                                <div class="text-stone-500 text-xs text-center">图片加载失败</div>
                            </div>
                        `;
                    };

                    // 先添加到DOM再设置src，确保onload能正确触发
                    imgContainer.appendChild(img);
                    img.src = imageUrl;
                    
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'p-4 bg-stone-800/50 border-t border-stone-700/30';
                    infoDiv.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-stone-200 font-semibold text-sm">${config.name}</span>
                            <span class="text-stone-500 text-xs font-mono">$${displayCost.toFixed(4)}</span>
                        </div>
                        <div class="flex gap-2">
                            <button class="flex-1 bg-stone-700 hover:bg-stone-600 text-stone-300 font-medium text-xs py-2 rounded-lg transition flex items-center justify-center gap-1.5">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                下载图片
                            </button>
                        </div>
                    `;
                    
                    infoDiv.querySelector('button').onclick = (e) => {
                        e.stopPropagation();
                        downloadImage(imageUrl, config.name);
                    };
                    
                    card.appendChild(imgContainer);
                    card.appendChild(infoDiv);
                    card.style.cursor = 'pointer';
                    card.onclick = () => showImageModal(imageUrl);
                }
            }
        }

        // 结果相关
        function addResultCard(modelName, imageUrl, cost, isError = false, errorMsg = '', codeContent = null) {
            currentResults.push({ modelName, imageUrl, cost, isError, errorMsg, codeContent });
            
            const card = document.createElement('div');
            card.className = 'image-card card-glow rounded-xl overflow-hidden card-animate';
            
            if (isError) {
                // 错误卡片 - 统一尺寸
                const errorDiv = document.createElement('div');
                errorDiv.className = 'bg-red-500/5 flex items-center justify-center p-6';
                errorDiv.style.height = '400px';
                errorDiv.innerHTML = `
                    <div class="text-center">
                        <div class="w-12 h-12 mx-auto mb-3 rounded-xl bg-red-500/10 flex items-center justify-center">
                            <svg class="w-6 h-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                        <div class="text-red-400 text-sm font-medium mb-2">生成失败</div>
                        <div class="text-stone-500 text-xs px-4">${errorMsg}</div>
                    </div>
                `;
                
                const infoDiv = document.createElement('div');
                infoDiv.className = 'p-4 bg-stone-800/50 border-t border-stone-700/30';
                infoDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-stone-200 font-semibold text-sm">${modelName}</span>
                        <span class="text-stone-500 text-xs font-mono">$${cost.toFixed(2)}</span>
                    </div>
                    <button class="w-full bg-stone-700 hover:bg-stone-600 text-stone-300 font-medium text-sm py-2.5 rounded-lg transition flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        重试
                    </button>
                `;
                const retryButton2 = infoDiv.querySelector('button');
                if (retryButton2) {
                    console.log('🔘 [addResultCard] 绑定重试按钮事件，模型:', modelName);
                    retryButton2.onclick = () => {
                        console.log('🖱️ [addResultCard] 重试按钮被点击', modelName);
                        retryModel(modelName);
                    };
                } else {
                    console.error('❌ [addResultCard] 未找到重试按钮元素');
                }

                card.appendChild(errorDiv);
                card.appendChild(infoDiv);
            } else {
                console.log('📦 Creating result card for:', modelName);
                console.log('📦 ImageURL type:', typeof imageUrl);
                console.log('📦 ImageURL length:', imageUrl ? imageUrl.length : 0);
                console.log('📦 ImageURL preview:', imageUrl ? imageUrl.substring(0, 100) : 'null');
                
                // 检查是否是有效的图片数据
                const isBase64 = imageUrl && imageUrl.startsWith('data:image');
                const isHttpUrl = imageUrl && imageUrl.startsWith('http');
                
                console.log('📦 isBase64:', isBase64);
                console.log('📦 isHttpUrl:', isHttpUrl);
                
                // 如果是代码内容
                if (codeContent) {
                    // 代码预览卡片 - 统一尺寸，只显示首屏
                    const codeContainer = document.createElement('div');
                    codeContainer.className = 'bg-stone-900/30 flex flex-col overflow-hidden';
                    codeContainer.style.height = '500px';
                    
                    // 代码预览区域
                    const previewArea = document.createElement('div');
                    previewArea.className = 'flex-1 relative cursor-pointer hover:opacity-95 transition overflow-hidden';
                    previewArea.style.minHeight = '0';
                    previewArea.style.display = 'flex';
                    previewArea.style.alignItems = 'center';
                    previewArea.style.justifyContent = 'center';
                    previewArea.style.background = 'linear-gradient(135deg, #1c1917 0%, #0c0a09 100%)';
                    previewArea.title = '点击查看大图';
                    
                    // 添加加载指示器
                    const loadingDiv = document.createElement('div');
                    loadingDiv.className = 'absolute inset-0 flex items-center justify-center bg-stone-900';
                    loadingDiv.innerHTML = '<div class="spinner"></div>';
                    previewArea.appendChild(loadingDiv);
                    
                    // 使用 iframe 预览代码
                    const iframe = document.createElement('iframe');
                    iframe.className = 'border-0 rounded-lg shadow-2xl';
                    iframe.style.opacity = '0';
                    iframe.style.transition = 'opacity 0.3s';
                    iframe.style.pointerEvents = 'none';
                    iframe.setAttribute('scrolling', 'no');
                    
                    const platformRadio = document.querySelector('input[name="platform"]:checked');
                    const currentPlatform = platformRadio ? platformRadio.value : 'mobile';
                    
                    if (currentPlatform === 'mobile') {
                        iframe.style.width = '280px';
                        iframe.style.height = '380px';
                        iframe.width = '375';
                        iframe.height = '500';
                        iframe.style.transform = 'scale(0.75)';
                        iframe.style.transformOrigin = 'center center';
                    } else {
                        iframe.style.width = '100%';
                        iframe.style.height = '100%';
                        iframe.style.maxWidth = '800px';
                    }
                    
                    iframe.srcdoc = codeContent;
                    
                    iframe.onload = () => {
                        setTimeout(() => {
                            iframe.style.opacity = '1';
                            if (previewArea.contains(loadingDiv)) {
                                previewArea.removeChild(loadingDiv);
                            }
                            
                            try {
                                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                                if (iframeDoc && iframeDoc.body) {
                                    iframeDoc.body.style.overflow = 'hidden';
                                    iframeDoc.body.style.height = '100%';
                                }
                                if (iframeDoc && iframeDoc.documentElement) {
                                    iframeDoc.documentElement.style.overflow = 'hidden';
                                    iframeDoc.documentElement.style.height = '100%';
                                }
                        } catch (e) {
                            // 跨域限制，忽略
                        }
                        }, 500);
                    };
                    
                    iframe.onerror = () => {
                        if (previewArea.contains(loadingDiv)) {
                            loadingDiv.innerHTML = '<div class="text-stone-500 text-sm">加载失败</div>';
                        }
                    };
                    
                    previewArea.appendChild(iframe);
                    previewArea.style.cursor = 'pointer';
                    previewArea.onclick = (e) => {
                        e.stopPropagation();
                        const platformRadio = document.querySelector('input[name="platform"]:checked');
                        const currentPlatform = platformRadio ? platformRadio.value : 'mobile';
                        showCodePreview(codeContent, modelName, currentPlatform);
                    };
                    
                    
                    codeContainer.appendChild(previewArea);
                    
                    // 信息区域
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'p-3 bg-stone-800/50 flex-shrink-0 border-t border-stone-700/30';
                    infoDiv.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-stone-200 font-semibold text-sm">${modelName}</span>
                            <span class="text-stone-500 text-xs font-mono">$${cost.toFixed(2)}</span>
                        </div>
                        <div class="flex gap-2">
                            <button class="flex-1 bg-stone-700 hover:bg-stone-600 text-stone-300 font-medium text-xs py-2 rounded-lg transition flex items-center justify-center gap-1.5">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
                                代码
                            </button>
                            <button class="flex-1 bg-stone-700 hover:bg-stone-600 text-stone-300 font-medium text-xs py-2 rounded-lg transition flex items-center justify-center gap-1.5">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                下载
                            </button>
                        </div>
                    `;
                    
                    // 查看代码按钮
                    infoDiv.querySelectorAll('button')[0].onclick = (e) => {
                        e.stopPropagation();
                        showCodeModal(codeContent, modelName);
                    };
                    
                    // 下载图片按钮（将代码转换为图片并下载）
                    infoDiv.querySelectorAll('button')[1].onclick = async (e) => {
                        e.stopPropagation();
                        const platformRadio = document.querySelector('input[name="platform"]:checked');
                        const currentPlatform = platformRadio ? platformRadio.value : 'mobile';
                        
                        // 显示加载提示
                        showToast('🖼️ 正在生成图片...', 2000);
                        
                        try {
                            // 将代码转换为图片
                            const imageData = await codeToImage(codeContent, currentPlatform);
                            
                            if (imageData) {
                                // 下载图片
                                await downloadImage(imageData, modelName);
                                showToast('✅ 图片已生成并下载', 2000);
                            } else {
                                // 如果生成失败，打开全屏预览让用户截图
                        showCodePreview(codeContent, modelName, currentPlatform);
                        setTimeout(() => {
                            showToast('💡 提示：请在全屏预览中按 Cmd+Shift+4 (Mac) 或 Win+Shift+S (Windows) 截图保存', 4000);
                        }, 500);
                            }
                        } catch (error) {
                            console.error('生成图片失败:', error);
                            // 如果生成失败，打开全屏预览让用户截图
                            showCodePreview(codeContent, modelName, currentPlatform);
                            setTimeout(() => {
                                showToast('💡 提示：请在全屏预览中按 Cmd+Shift+4 (Mac) 或 Win+Shift+S (Windows) 截图保存', 4000);
                            }, 500);
                        }
                    };
                    
                    codeContainer.appendChild(infoDiv);
                    card.appendChild(codeContainer);
                    document.getElementById('resultsGrid').appendChild(card);
                    return;
                }
                
                if (isBase64 || isHttpUrl) {
                    const imgContainer = document.createElement('div');
                    imgContainer.className = 'relative';
                    imgContainer.style.height = '400px';
                    imgContainer.style.width = '100%';
                    imgContainer.style.display = 'flex';
                    imgContainer.style.alignItems = 'center';
                    imgContainer.style.justifyContent = 'center';
                    imgContainer.style.background = 'linear-gradient(135deg, #1c1917 0%, #0c0a09 100%)';
                    
                    const platformRadio = document.querySelector('input[name="platform"]:checked');
                    const currentPlatform = platformRadio ? platformRadio.value : 'mobile';
                    
                    if (currentPlatform === 'mobile') {
                        imgContainer.style.padding = '20px 16px';
                    }
                    
                    const img = document.createElement('img');
                    img.className = 'object-contain rounded-lg shadow-2xl';
                    img.style.maxWidth = '100%';
                    img.style.maxHeight = '100%';
                    img.style.width = 'auto';
                    img.style.height = 'auto';
                    img.alt = modelName;
                    
                    img.onload = function() {
                        console.log('✅ 图片加载成功:', modelName);
                    };
                    
                    img.onerror = function() {
                        console.error('❌ 图片加载失败:', modelName);
                        imgContainer.innerHTML = `
                            <div class="w-full h-full flex flex-col items-center justify-center p-4">
                                <div class="w-12 h-12 mx-auto mb-3 rounded-xl bg-amber-500/10 flex items-center justify-center">
                                    <svg class="w-6 h-6 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                                </div>
                                <div class="text-stone-400 text-xs text-center mb-2">图片加载失败</div>
                                <div class="text-stone-600 text-xs text-center">数据长度: ${imageUrl.length}</div>
                            </div>
                        `;
                    };
                    
                    img.src = imageUrl;
                    imgContainer.appendChild(img);
                    
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'p-4 bg-stone-800/50 border-t border-stone-700/30';
                    infoDiv.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-stone-200 font-semibold text-sm">${modelName}</span>
                            <span class="text-stone-500 text-xs font-mono">$${cost.toFixed(2)}</span>
                        </div>
                        <div class="flex gap-2">
                            <button class="flex-1 bg-stone-700 hover:bg-stone-600 text-stone-300 font-medium text-xs py-2 rounded-lg transition flex items-center justify-center gap-1.5">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                下载图片
                            </button>
                        </div>
                    `;
                    
                    const button = infoDiv.querySelector('button');
                    button.onclick = (e) => {
                        e.stopPropagation();
                        downloadImage(imageUrl, modelName);
                    };
                    
                    card.appendChild(imgContainer);
                    card.appendChild(infoDiv);
                    
                    card.style.cursor = 'pointer';
                    card.onclick = () => showImageModal(imageUrl);
                    
                } else {
                    // 不是图片格式
                    console.warn('⚠️ 返回的不是图片格式');
                    const dataDiv = document.createElement('div');
                    dataDiv.className = 'bg-stone-900/50 flex items-center justify-center p-6 overflow-auto';
                    dataDiv.style.height = '400px';
                    dataDiv.innerHTML = `
                        <div class="text-center w-full">
                            <div class="w-12 h-12 mx-auto mb-3 rounded-xl bg-blue-500/10 flex items-center justify-center">
                                <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            </div>
                            <div class="text-blue-400 text-sm font-medium mb-2">返回了数据</div>
                            <div class="text-stone-500 text-xs mb-3">但不是图片格式</div>
                            <div class="bg-stone-800/50 p-2 rounded-lg text-left border border-stone-700/50">
                                <pre class="text-xs overflow-auto max-h-32 text-stone-400">${imageUrl ? imageUrl.substring(0, 200) : '无数据'}</pre>
                            </div>
                        </div>
                    `;
                    
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'p-4 bg-stone-800/50 border-t border-stone-700/30';
                    infoDiv.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-stone-200 font-semibold text-sm">${modelName}</span>
                            <span class="text-stone-500 text-xs font-mono">$${cost.toFixed(2)}</span>
                        </div>
                        <button class="w-full bg-stone-700 hover:bg-stone-600 text-stone-300 font-medium text-sm py-2.5 rounded-lg transition flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                            查看完整数据
                        </button>
                    `;
                    infoDiv.querySelector('button').onclick = () => showRawData(modelName);
                    
                    card.appendChild(dataDiv);
                    card.appendChild(infoDiv);
                }
            }
            
            document.getElementById('resultsGrid').appendChild(card);
        }
        
        function showRawData(modelName) {
            const result = currentResults.find(r => r.modelName === modelName);
            if (!result) {
                alert('未找到数据');
                return;
            }
            
            const data = result.imageUrl;
            const len = data ? data.length : 0;
            
            console.log('='.repeat(50));
            console.log('模型:', modelName);
            console.log('数据类型:', typeof data);
            console.log('数据长度:', len);
            console.log('完整数据:', data);
            console.log('='.repeat(50));
            
            alert(`模型: ${modelName}\n\n数据长度: ${len} 字符\n\n前500个字符:\n${data ? data.substring(0, 500) : '无数据'}\n\n完整数据已输出到Console`);
        }
        
        function copyToClipboard(modelName) {
            const result = currentResults.find(r => r.modelName === modelName);
            if (!result || !result.imageUrl) {
                alert('无数据可复制');
                return;
            }
            
            navigator.clipboard.writeText(result.imageUrl).then(() => {
                alert('Base64已复制到剪贴板');
            }).catch(err => {
                console.error('复制失败:', err);
                alert('复制失败，请查看Console');
            });
        }

        function retryModel(modelName) {
            console.log('🔄 重试按钮被点击，模型名称:', modelName);

            // 找到对应的模型key
            const modelKey = Object.keys(MODEL_CONFIGS).find(
                key => MODEL_CONFIGS[key].name === modelName
            );

            console.log('📍 查找模型key结果:', modelKey);

            if (!modelKey) {
                console.error('❌ 模型未找到，modelName:', modelName);
                console.log('📋 当前所有模型配置:', Object.keys(MODEL_CONFIGS));
                alert('模型未找到');
                return;
            }

            // 获取当前prompt
            const prompt = document.getElementById('promptInput').value.trim();
            if (!prompt) {
                alert('请输入UI设计需求');
                return;
            }

            // 获取平台选择
            const platformRadio = document.querySelector('input[name="platform"]:checked');
            const platform = platformRadio ? platformRadio.value : 'mobile';
            const platformInfo = platform === 'mobile' ? 'mobile app (iOS/Android)' : 'desktop web application';

            // 使用与主生成流程相同的完整设计指南
            // 检测是否有语言要求
            const hasForeignHint = /英文|english|日文|japanese|韩文|korean|法文|french|德文|german/i.test(prompt);
            const chineseLanguageHint = hasForeignHint
                ? ''
                : '\n\n重要：请使用简体中文展示界面中的所有文本（标题、按钮、标签、导航、提示信息等），除非提示词中明确要求使用其他语言。不要输出英文 UI 文本（品牌名和专有名词除外）。';

            // 构建完整prompt（与主生成流程保持一致）
            const codePrompt = `${prompt}${chineseLanguageHint}

生成生产级、有独特设计感的 ${platformInfo} UI 界面代码。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🎯 NON-NEGOTIABLES（不可妥协的要求）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
1. 完整可运行的HTML（包含内联CSS和必要JS）
2. **严禁占位符**：所有图标/图表/图片必须用CSS或内联SVG实际绘制
3. 避免通用AI模板 - 必须有明确的设计个性
4. 直接输出纯HTML代码，不要markdown标记（\`\`\`html等）
5. 适配${platform === 'mobile' ? '移动端' : '桌面端'}，使用Flexbox或Grid布局

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🎨 DESIGN THINKING（设计思考框架）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
**明确选择一个设计方向**（必选其一）：
• 极简主义 - 大量留白、简洁线条、克制的配色
• 杂志风格 - 大胆排版、强烈对比、衬线字体
• 工业风格 - 深色基调、棱角分明、技术感
• 自然柔和 - 圆润形状、温暖色调、舒适间距
• Brutalism - 粗犷排版、黑白对比、几何形状

**创造一个独特记忆点**：
• 特殊排版（如：旋转文字、竖排标题、超大字号）
• 微妙动效（如：悬停平滑变色、渐进式加载）
• 独特配色（如：深蓝+荧光绿、黑白+亮橙）
• 精致细节（如：细微阴影、微渐变、精确圆角）

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🎨 AESTHETICS（美学指南）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【Typography 排版】
• 字体配对：选择有个性的字体组合（如：衬线标题+无衬线正文）
• 字阶系统：建立清晰的字号层级（标题48px → 副标题24px → 正文16px）
• 行高控制：标题1.2、正文1.6-1.8、紧凑卡片1.4
• 字重变化：用字重（font-weight）而非颜色区分层级

【Color & Theme 配色】
• 使用CSS变量定义配色：--color-primary、--color-accent、--color-bg
• 明确主色调基调：冷色系（蓝/绿/紫）或暖色系（橙/红/黄）
• 限制颜色数量：1个主色 + 1个强调色 + 灰度系统（3-5个灰阶）
• 背景细节：用微妙渐变或纹理，避免纯白（#fff）/纯黑（#000）

【Motion 动效】
• 悬停反馈：所有可交互元素必须有悬停状态（颜色/缩放/阴影变化）
• 过渡时长：快速响应0.2s、常规0.3s、缓慢展开0.5s
• 缓动函数：使用cubic-bezier实现自然动效（如：cubic-bezier(0.4,0,0.2,1)）
• 加载状态：用CSS动画实现加载效果（旋转/脉冲/骨架屏）

【Layout 布局】
• 打破对称：尝试不对称布局（如：左侧2/3内容 + 右侧1/3侧边栏）
• 负空间运用：重要元素周围留出充足空间（padding/margin至少20px）
• 网格对齐：即使不对称，也要保持隐形网格对齐（每8px或16px对齐）
• 视觉焦点：用大小/颜色/位置引导用户视线流动

【Backgrounds 背景】
• 渐变背景：linear-gradient(135deg, #667eea 0%, #764ba2 100%)
• 纹理背景：用SVG或CSS pattern创建微妙纹理
• 卡片层次：用box-shadow或border区分前后关系（不要纯色边框）

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📐 TECHNICAL IMPLEMENTATION（技术实现）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【图标实现（必须用实际代码）】
• 简单图标：用CSS绘制（border-radius圆形、::before/::after伪元素、transform旋转）
• 复杂图标：内联SVG（<svg><path d="..."/></svg>）
• 示例：搜索图标 <svg width="20" height="20"><circle cx="8" cy="8" r="7" stroke="currentColor" fill="none"/><line x1="13" y1="13" x2="19" y2="19" stroke="currentColor"/></svg>

【图表实现（严禁占位符）】
• 柱状图：<svg><rect x="0" y="20" width="30" height="80" fill="#3b82f6"/><rect x="40" y="40" width="30" height="60" fill="#10b981"/>...</svg>
• 折线图：<svg><polyline points="0,100 50,80 100,60 150,70 200,40" stroke="#3b82f6" fill="none"/></svg>
• 饼图：<svg><circle cx="50" cy="50" r="40" fill="none" stroke="#3b82f6" stroke-width="80" stroke-dasharray="251 0"/></svg>
• 进度条：<div style="background:#e5e7eb;border-radius:999px"><div style="width:65%;height:8px;background:linear-gradient(90deg,#3b82f6,#8b5cf6);border-radius:999px"></div></div>

【头像/图片实现】
• 用户头像：<div style="width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;color:white;font-weight:600">张</div>
• 产品图片：用几何形状+渐变模拟（<div style="width:100%;height:200px;background:linear-gradient(135deg,#ffeaa7,#fab1a0);border-radius:12px"></div>）
• Logo占位：用首字母或几何图形（不要灰色矩形）

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🚫 ANTI-PATTERNS（绝对避免）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
• ❌ 空的<div>占位符（<div style="background:#ddd;height:200px"></div>）
• ❌ 注释占位（<!-- 这里放图片 -->）
• ❌ 灰色/空白占位区域（必须用实际SVG或CSS绘制）
• ❌ 紫色渐变泛滥（除非明确要求）
• ❌ 通用SaaS模板外观（Tailwind默认样式）
• ❌ 过度使用圆角（所有元素都是16px圆角）
• ❌ 纯白背景+纯黑文字（缺乏设计感）
• ❌ 所有按钮都是蓝色（缺乏层级区分）

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ CHECKLIST（交付前检查）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
□ 所有图标/图表都有实际SVG或CSS实现（无占位符）
□ 选择了明确的设计风格（极简/杂志/工业/自然）
□ 至少有一个独特记忆点（排版/配色/动效/细节）
□ 字体大小有清晰层级（至少3个字号）
□ 配色方案明确（主色+强调色+灰度）
□ 所有交互元素有悬停状态
□ 布局有意识运用负空间（不拥挤）
□ 代码完整可运行（复制粘贴即可使用）

请直接输出HTML代码，确保每个视觉元素都是实际渲染的内容（无任何占位符）。`;

            console.log('🔄 重试生成:', modelName);
            generateWithModel(modelKey, codePrompt, platform);
        }

        function showImageModal(imageUrl) {
            document.getElementById('modalImage').src = imageUrl;
            document.getElementById('imageModal').classList.remove('hidden');
            document.getElementById('imageModal').classList.add('flex');
        }

        function closeImageModal() {
            document.getElementById('imageModal').classList.add('hidden');
            document.getElementById('imageModal').classList.remove('flex');
        }

        /**
         * 下载代码为 HTML 文件
         */
        function downloadCode(codeContent, modelName) {
            try {
                // 清理文件名，移除特殊字符
                const cleanName = modelName.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '_');
                const fileName = `${cleanName}_${Date.now()}.html`;
                
                // 创建 Blob 对象
                const blob = new Blob([codeContent], { type: 'text/html;charset=utf-8' });
                const downloadUrl = URL.createObjectURL(blob);
                
                // 创建下载链接
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                // 清理 URL
                URL.revokeObjectURL(downloadUrl);
            } catch (error) {
                console.error('下载代码失败:', error);
                alert('⚠️ 下载失败，请复制代码后手动保存');
            }
        }

        /**
         * 下载图片，去除背景并裁剪到内容边缘
         */
        async function downloadImage(url, modelName) {
            try {
                // 创建图片对象
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                await new Promise((resolve, reject) => {
                    img.onload = resolve;
                    img.onerror = reject;
                    img.src = url;
                });
                
                // 创建 Canvas
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = img.width;
                canvas.height = img.height;
                
                // 绘制图片
                ctx.drawImage(img, 0, 0);
                
                // 获取图片数据
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                // 检测内容边界（去除白色/浅色背景）
                let minX = canvas.width, minY = canvas.height, maxX = 0, maxY = 0;
                let hasContent = false;
                
                // 遍历像素，找到内容边界
                for (let y = 0; y < canvas.height; y++) {
                    for (let x = 0; x < canvas.width; x++) {
                        const idx = (y * canvas.width + x) * 4;
                        const r = data[idx];
                        const g = data[idx + 1];
                        const b = data[idx + 2];
                        const a = data[idx + 3];
                        
                        // 检测非背景像素（不是纯白或接近白色，且不透明）
                        // 白色背景通常是 RGB(240,240,240) 以上或接近透明
                        const isBackground = (r > 240 && g > 240 && b > 240) || a < 10;
                        
                        if (!isBackground) {
                            hasContent = true;
                            minX = Math.min(minX, x);
                            minY = Math.min(minY, y);
                            maxX = Math.max(maxX, x);
                            maxY = Math.max(maxY, y);
                        }
                    }
                }
                
                // 如果找到内容，裁剪到边界；否则使用原图
                let finalCanvas = canvas;
                if (hasContent && (minX < maxX && minY < maxY)) {
                    const width = maxX - minX + 1;
                    const height = maxY - minY + 1;
                    
                    // 创建新 Canvas，只包含内容区域
                    finalCanvas = document.createElement('canvas');
                    finalCanvas.width = width;
                    finalCanvas.height = height;
                    const finalCtx = finalCanvas.getContext('2d');
                    
                    // 绘制裁剪后的内容（带透明背景）
                    finalCtx.drawImage(
                        canvas,
                        minX, minY, width, height,
                        0, 0, width, height
                    );
                } else {
                    // 如果没有检测到边界，创建透明背景版本
                    finalCanvas = document.createElement('canvas');
                    finalCanvas.width = canvas.width;
                    finalCanvas.height = canvas.height;
                    const finalCtx = finalCanvas.getContext('2d');
                    
                    // 绘制原图
                    finalCtx.drawImage(img, 0, 0);
                }
                
                // 转换为 Blob 并下载
                finalCanvas.toBlob((blob) => {
                    if (!blob) {
                        throw new Error('无法创建图片');
                    }
                    
                    const downloadUrl = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = `${modelName}_${Date.now()}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(downloadUrl);
                }, 'image/png');
                
            } catch (error) {
                console.error('下载失败:', error);
                // 如果处理失败，尝试直接下载原图
                try {
                    const response = await fetch(url);
                    const blob = await response.blob();
                    const downloadUrl = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = `${modelName}_${Date.now()}.png`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(downloadUrl);
                } catch (fallbackError) {
                alert('⚠️ 下载失败，请右键保存图片');
            }
            }
        }

        /**
         * 生成图片缩略图（小尺寸，用于历史记录显示）
         */
        async function generateThumbnail(imageUrl, maxSize = 150) {
            return new Promise((resolve, reject) => {
                if (!imageUrl || imageUrl.startsWith('http')) {
                    // HTTP URL 直接返回，不生成缩略图
                    resolve(imageUrl);
                    return;
                }
                
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                img.onload = () => {
                    try {
                        // 计算缩略图尺寸（保持宽高比）
                        let width = img.width;
                        let height = img.height;
                        const ratio = Math.min(maxSize / width, maxSize / height);
                        width = Math.floor(width * ratio);
                        height = Math.floor(height * ratio);
                        
                        // 创建 Canvas 并绘制缩略图
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // 转换为 base64（质量降低以减小文件大小）
                        const thumbnail = canvas.toDataURL('image/jpeg', 0.7);
                        resolve(thumbnail);
                    } catch (error) {
                        console.error('生成缩略图失败:', error);
                        resolve(null);
                    }
                };
                
                img.onerror = () => {
                    resolve(null);
                };
                
                img.src = imageUrl;
            });
        }

        /**
         * 将代码内容转换为图片（完整首屏截图）
         */
        async function codeToImage(codeContent, platform = 'mobile') {
            return new Promise((resolve, reject) => {
                try {
                    // 根据平台设置尺寸
                    let targetWidth, targetHeight;
                    if (platform === 'mobile') {
                        targetWidth = 375;
                        targetHeight = 812; // iPhone标准高度
                    } else {
                        targetWidth = 1920;
                        targetHeight = 1080; // 桌面标准高度
                    }
                    
                    // 创建一个隐藏的iframe来渲染代码
                    const iframe = document.createElement('iframe');
                    iframe.style.position = 'fixed';
                    iframe.style.left = '-9999px';
                    iframe.style.top = '-9999px';
                    iframe.style.width = targetWidth + 'px';
                    iframe.style.height = targetHeight + 'px';
                    iframe.style.border = 'none';
                    iframe.style.backgroundColor = '#ffffff';
                    iframe.setAttribute('scrolling', 'no');
                    
                    // 确保iframe的尺寸属性也设置
                    iframe.width = targetWidth;
                    iframe.height = targetHeight;
                    
                    iframe.srcdoc = codeContent;
                    
                    document.body.appendChild(iframe);
                    
                    let isResolved = false;
                    let timeoutId;
                    
                    // 清理函数
                    const cleanup = () => {
                        if (timeoutId) clearTimeout(timeoutId);
                        if (document.body.contains(iframe)) {
                            document.body.removeChild(iframe);
                        }
                    };
                    
                    // 等待iframe加载完成
                    iframe.onload = () => {
                        // 等待内容渲染和图片加载
                        setTimeout(async () => {
                            try {
                                if (isResolved) return;
                                
                                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                                
                                if (!iframeDoc) {
                                    if (!isResolved) {
                                        isResolved = true;
                                        cleanup();
                                        reject(new Error('无法访问iframe文档'));
                                    }
                                    return;
                                }
                                
                                // 等待所有图片加载完成
                                const images = iframeDoc.querySelectorAll('img');
                                const imagePromises = Array.from(images).map(img => {
                                    if (img.complete) return Promise.resolve();
                                    return new Promise((resolve, reject) => {
                                        img.onload = resolve;
                                        img.onerror = resolve; // 即使加载失败也继续
                                        setTimeout(resolve, 5000); // 增加到5秒超时（复杂页面图片可能较多）
                                    });
                                });
                                
                                await Promise.all(imagePromises);
                                
                                // 再等待一下确保渲染完成（增加等待时间）
                                await new Promise(resolve => setTimeout(resolve, 1000));
                                
                                if (isResolved) return;
                                
                                // 使用html2canvas截图
                                if (typeof html2canvas !== 'undefined') {
                                    // 使用documentElement确保捕获整个页面
                                    const elementToCapture = iframeDoc.documentElement;
                                    
                                    if (!elementToCapture) {
                                        if (!isResolved) {
                                            isResolved = true;
                                            cleanup();
                                            reject(new Error('无法访问documentElement'));
                                        }
                                        return;
                                    }
                                    
                                    try {
                                        const canvas = await html2canvas(elementToCapture, {
                                            scale: 1,
                                            useCORS: true,
                                            allowTaint: true,
                                            backgroundColor: null, // 使用原始背景
                                            logging: false,
                                            width: targetWidth,
                                            height: targetHeight,
                                            windowWidth: targetWidth,
                                            windowHeight: targetHeight,
                                            x: 0,
                                            y: 0
                                        });
                                        
                                        // 确保canvas尺寸正确
                                        const finalCanvas = document.createElement('canvas');
                                        finalCanvas.width = targetWidth;
                                        finalCanvas.height = targetHeight;
                                        const ctx = finalCanvas.getContext('2d');
                                        
                                        // 绘制到正确尺寸的canvas
                                        ctx.drawImage(canvas, 0, 0, targetWidth, targetHeight);
                                        
                                        const imageData = finalCanvas.toDataURL('image/png', 1.0);
                                        
                                        if (!isResolved) {
                                            isResolved = true;
                                            cleanup();
                                            resolve(imageData);
                                        }
                                    } catch (html2canvasError) {
                                        console.error('html2canvas错误:', html2canvasError);
                                        if (!isResolved) {
                                            isResolved = true;
                                            cleanup();
                                            reject(html2canvasError);
                                        }
                                    }
                                } else {
                                    // 如果没有html2canvas，生成占位图
                                    const canvas = document.createElement('canvas');
                                    canvas.width = targetWidth;
                                    canvas.height = targetHeight;
                                    const ctx = canvas.getContext('2d');
                                    ctx.fillStyle = '#f3f4f6';
                                    ctx.fillRect(0, 0, targetWidth, targetHeight);
                                    ctx.fillStyle = '#9ca3af';
                                    ctx.font = '24px Arial';
                                    ctx.textAlign = 'center';
                                    ctx.textBaseline = 'middle';
                                    ctx.fillText('代码预览', targetWidth / 2, targetHeight / 2);
                                    
                                    const imageData = canvas.toDataURL('image/png', 1.0);
                                    if (!isResolved) {
                                        isResolved = true;
                                        cleanup();
                                        resolve(imageData);
                                    }
                                }
                            } catch (error) {
                                console.error('代码转图片失败:', error);
                                if (!isResolved) {
                                    isResolved = true;
                                    cleanup();
                                    reject(error);
                                }
                            }
                        }, 1000); // 初始等待1秒
                    };
                    
                    // 如果iframe加载失败
                    iframe.onerror = () => {
                        if (!isResolved) {
                            isResolved = true;
                            cleanup();
                            reject(new Error('iframe加载失败'));
                        }
                    };
                    
                    // 设置超时（增加到40秒，因为复杂的HTML代码需要更多时间渲染和截图）
                    timeoutId = setTimeout(() => {
                        if (!isResolved) {
                            isResolved = true;
                            cleanup();
                            reject(new Error('代码转图片超时（40秒）'));
                        }
                    }, 40000); // 40秒超时
                } catch (error) {
                    console.error('代码转图片失败:', error);
                    reject(error);
                }
            });
        }

        /**
         * 为代码内容生成缩略图（通过iframe渲染后截图）
         */
        async function generateCodeThumbnail(codeContent, maxSize = 150, platform = 'mobile') {
            return new Promise(async (resolve) => {
                try {
                    // 使用codeToImage生成完整图片
                    const fullImage = await codeToImage(codeContent, platform);
                    
                    if (!fullImage) {
                        resolve(null);
                        return;
                    }
                    
                    // 创建图片对象并缩放为缩略图
                    const img = new Image();
                    img.onload = () => {
                        try {
                            // 计算缩略图尺寸（保持宽高比）
                            let width = img.width;
                            let height = img.height;
                            const ratio = Math.min(maxSize / width, maxSize / height);
                            width = Math.floor(width * ratio);
                            height = Math.floor(height * ratio);
                            
                            // 创建 Canvas 并绘制缩略图
                            const canvas = document.createElement('canvas');
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            // 转换为 base64（质量降低以减小文件大小）
                            const thumbnail = canvas.toDataURL('image/jpeg', 0.7);
                            resolve(thumbnail);
                        } catch (error) {
                            console.error('生成缩略图失败:', error);
                            resolve(null);
                        }
                    };
                    
                    img.onerror = () => {
                        resolve(null);
                    };
                    
                    img.src = fullImage;
                } catch (error) {
                    console.error('生成代码缩略图失败:', error);
                    resolve(null);
                }
            });
        }

        // 历史记录相关函数
        async function saveGenerationHistory(prompt, platform, selectedModels, results) {
            console.log('🔵 saveGenerationHistory 被调用:', {
                promptLength: prompt.length,
                platform: platform,
                selectedModelsCount: selectedModels.length,
                resultsCount: results.length,
                results: results.map(r => ({ name: r.modelName, hasImage: !!r.imageUrl, isError: r.isError }))
            });
            
            try {
                // 每次保存前都从 localStorage 重新加载，确保不会覆盖其他记录
                const existingHistory = JSON.parse(localStorage.getItem('generation_history') || '[]');
                console.log('🔵 现有历史记录数量:', existingHistory.length);
                
                // 为每个结果生成缩略图（异步）
                const processedResults = await Promise.all(results.map(async (r) => {
                    const result = {
                        modelName: r.modelName,
                        cost: r.cost,
                        isError: r.isError,
                        errorMsg: r.errorMsg,
                        thumbnail: null,
                        imageUrl: null, // 保存完整图片数据
                        codeContent: null // 保存代码内容用于历史记录预览
                    };
                    
                    // 如果成功且有图片，保存完整图片数据并生成缩略图
                    if (!r.isError && r.imageUrl) {
                        // 保存完整图片数据（base64 或 URL）
                        result.imageUrl = r.imageUrl;
                        // 生成缩略图
                        result.thumbnail = await generateThumbnail(r.imageUrl, 150);
                        console.log('📸 生成缩略图:', r.modelName, result.thumbnail ? '成功' : '失败');
                    }
                    
                    // 如果成功且有代码内容，保存代码内容用于预览
                    if (!r.isError && r.codeContent) {
                        result.codeContent = r.codeContent;
                        // 为代码内容生成缩略图（通过iframe渲染后截图）
                        try {
                            result.thumbnail = await generateCodeThumbnail(r.codeContent, 150, platform);
                            console.log('📸 生成代码缩略图:', r.modelName, result.thumbnail ? '成功' : '失败');
                        } catch (error) {
                            console.error('生成代码缩略图失败:', error);
                            result.thumbnail = null;
                        }
                    }
                    
                    return result;
                }));
                
            const historyItem = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                prompt: prompt,
                platform: platform,
                platformText: platform === 'mobile' ? '手机端' : 'PC端',
                selectedModels: selectedModels,
                    results: processedResults,
                totalCost: results.reduce((sum, r) => sum + (r.cost || 0), 0)
            };
                
                console.log('🔵 创建历史记录项:', {
                    id: historyItem.id,
                    resultsCount: historyItem.results.length,
                    results: historyItem.results.map(r => r.modelName)
                });
            
            // 添加到历史记录数组的开头（最新的在前面）
                existingHistory.unshift(historyItem);
            
            // 限制历史记录数量（最多保存50条）
                const finalHistory = existingHistory.length > 50 
                    ? existingHistory.slice(0, 50) 
                    : existingHistory;
                
                // 更新全局变量
                generationHistory = finalHistory;
            
            // 保存到 localStorage
                localStorage.setItem('generation_history', JSON.stringify(finalHistory));
                
                // 验证保存是否成功
                const verifyHistory = JSON.parse(localStorage.getItem('generation_history') || '[]');
                console.log('✅ 历史记录已保存:', {
                    id: historyItem.id,
                    prompt: prompt.substring(0, 30) + '...',
                    resultsCount: results.length,
                    totalHistoryCount: finalHistory.length,
                    verifyCount: verifyHistory.length,
                    saved: verifyHistory.length > 0 && verifyHistory[0].id === historyItem.id
                });
                
                if (verifyHistory.length === 0 || verifyHistory[0].id !== historyItem.id) {
                    console.error('❌ 保存验证失败！历史记录可能未正确保存');
                }

                // 保存到服务器（全站统计）
                try {
                    const totalCost = results.reduce((sum, r) => sum + (r.cost || 0), 0);
                    await fetch('/api/stats', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            results: results.map(r => ({
                                modelName: r.modelName,
                                cost: r.cost || 0,
                                isError: r.isError || false
                            })),
                            totalCost: totalCost
                        })
                    });
                    console.log('✅ 全站统计数据已保存到服务器');
                } catch (error) {
                    console.error('⚠️ 保存全站统计数据失败（不影响本地使用）:', error);
                }
            } catch (error) {
                console.error('❌ 保存历史记录失败:', error);
                console.error('错误堆栈:', error.stack);
                console.error('错误详情:', {
                    promptLength: prompt.length,
                    platform: platform,
                    resultsCount: results.length,
                    errorMessage: error.message
                });
                // 尝试保存简化版本（不生成缩略图）
                try {
                    const existingHistory = JSON.parse(localStorage.getItem('generation_history') || '[]');
                    const simplifiedHistoryItem = {
                        id: Date.now(),
                        timestamp: new Date().toISOString(),
                        prompt: prompt,
                        platform: platform,
                        platformText: platform === 'mobile' ? '手机端' : 'PC端',
                        selectedModels: selectedModels,
                        results: results.map(r => ({
                            modelName: r.modelName,
                            cost: r.cost || 0,
                            isError: r.isError || false,
                            errorMsg: r.errorMsg || '',
                            thumbnail: null,
                            imageUrl: r.imageUrl || null,
                            codeContent: r.codeContent || null
                        })),
                        totalCost: results.reduce((sum, r) => sum + (r.cost || 0), 0)
                    };
                    existingHistory.unshift(simplifiedHistoryItem);
                    const finalHistory = existingHistory.length > 50 ? existingHistory.slice(0, 50) : existingHistory;
                    generationHistory = finalHistory;
                    localStorage.setItem('generation_history', JSON.stringify(finalHistory));
                    console.log('✅ 已保存简化版历史记录（无缩略图）');
                } catch (fallbackError) {
                    console.error('❌ 保存简化版历史记录也失败:', fallbackError);
                }
            }
        }

        function showHistory() {
            document.getElementById('historyModal').classList.remove('hidden');
            document.getElementById('historyModal').classList.add('flex');
            loadHistory();
        }

        function closeHistory() {
            document.getElementById('historyModal').classList.add('hidden');
            document.getElementById('historyModal').classList.remove('flex');
        }

        let filteredHistory = [];

        async function loadHistory() {
            // 从 localStorage 重新加载（确保是最新的）
            generationHistory = JSON.parse(localStorage.getItem('generation_history') || '[]');
            filteredHistory = generationHistory;
            
            // 从服务器加载全站统计数据
            await loadServerStatistics();
            
            filterHistory();
        }

        async function loadServerStatistics() {
            try {
                const response = await fetch('/api/stats');
                if (response.ok) {
                    const serverStats = await response.json();
                    // 将服务器统计数据存储到全局变量，供 updateCostStatistics 使用
                    window.serverStatistics = serverStats;
                    console.log('✅ 全站统计数据已加载:', serverStats);
                } else {
                    console.warn('⚠️ 获取全站统计数据失败:', response.status);
                    window.serverStatistics = null;
                }
            } catch (error) {
                console.warn('⚠️ 获取全站统计数据失败（可能服务器未配置）:', error);
                window.serverStatistics = null;
            }
        }

        function filterHistory() {
            const historyList = document.getElementById('historyList');
            const historyEmpty = document.getElementById('historyEmpty');
            const historyNoResults = document.getElementById('historyNoResults');
            const historyCount = document.getElementById('historyCount');
            
            const searchText = (document.getElementById('historySearch')?.value || '').toLowerCase();
            const filterValue = document.getElementById('historyFilter')?.value || 'all';
            
            // 筛选历史记录
            filteredHistory = generationHistory.filter(item => {
                // 搜索筛选
                if (searchText) {
                    const promptMatch = item.prompt.toLowerCase().includes(searchText);
                    const modelMatch = item.selectedModels.some(key => {
                        const config = MODEL_CONFIGS[key];
                        return config && config.name.toLowerCase().includes(searchText);
                    });
                    if (!promptMatch && !modelMatch) return false;
                }
                
                // 平台筛选
                if (filterValue === 'mobile' && item.platform !== 'mobile') return false;
                if (filterValue === 'desktop' && item.platform !== 'desktop') return false;
                
                // 时间筛选
                if (filterValue === 'today' || filterValue === 'week' || filterValue === 'month') {
                    const itemDate = new Date(item.timestamp);
                    const now = new Date();
                    const diffTime = now - itemDate;
                    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                    
                    if (filterValue === 'today' && diffDays > 0) return false;
                    if (filterValue === 'week' && diffDays > 7) return false;
                    if (filterValue === 'month' && diffDays > 30) return false;
                }
                
                return true;
            });
            
            // 更新计数
            if (historyCount) {
                historyCount.textContent = filteredHistory.length;
            }
            
            // 更新花费明细统计
            updateCostStatistics(filteredHistory);
            
            // 显示/隐藏空状态
            if (generationHistory.length === 0) {
                historyList.innerHTML = '';
                historyEmpty.classList.remove('hidden');
                if (historyNoResults) historyNoResults.classList.add('hidden');
                document.getElementById('costStatistics')?.classList.add('hidden');
                return;
            }
            
            if (filteredHistory.length === 0) {
                historyList.innerHTML = '';
            historyEmpty.classList.add('hidden');
                if (historyNoResults) historyNoResults.classList.remove('hidden');
                document.getElementById('costStatistics')?.classList.add('hidden');
                return;
            }
            
            historyEmpty.classList.add('hidden');
            if (historyNoResults) historyNoResults.classList.add('hidden');
            historyList.innerHTML = '';
            
            filteredHistory.forEach((item, index) => {
                const historyCard = document.createElement('div');
                historyCard.className = 'bg-stone-800/30 rounded-xl p-4 mb-3 border border-stone-700/30 hover:border-stone-600/50 transition';
                
                const date = new Date(item.timestamp);
                const dateStr = date.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const modelsList = item.selectedModels.map(key => {
                    const config = MODEL_CONFIGS[key];
                    return config ? config.name : key;
                }).join(', ');
                
                const successCount = item.results.filter(r => !r.isError).length;
                const errorCount = item.results.filter(r => r.isError).length;
                
                historyCard.innerHTML = `
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1">
                            <div class="text-stone-200 font-semibold mb-1.5 text-sm">${item.prompt.substring(0, 50)}${item.prompt.length > 50 ? '...' : ''}</div>
                            <div class="text-stone-500 text-xs flex flex-wrap gap-x-3 gap-y-1">
                                <span class="flex items-center gap-1">${item.platform === 'mobile' ? '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>' : '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>'} ${item.platformText}</span>
                                <span class="text-amber-500 font-mono">$${item.totalCost.toFixed(2)}</span>
                                <span class="text-emerald-400">${successCount} 成功</span>
                                ${errorCount > 0 ? `<span class="text-red-400">${errorCount} 失败</span>` : ''}
                            </div>
                            <div class="text-stone-600 text-xs mt-1.5">${dateStr}</div>
                        </div>
                        <div class="flex gap-2 ml-4">
                            <button onclick="viewHistoryItem(${item.id})" class="bg-stone-700 hover:bg-stone-600 text-stone-300 text-xs px-3 py-1.5 rounded-lg transition">
                                查看
                            </button>
                            <button onclick="regenerateFromHistory(${item.id})" class="bg-stone-700 hover:bg-stone-600 text-stone-300 text-xs px-3 py-1.5 rounded-lg transition">
                                重新生成
                            </button>
                            <button onclick="deleteHistoryItem(${item.id})" class="bg-stone-700 hover:bg-red-600/80 text-stone-300 hover:text-red-200 text-xs px-3 py-1.5 rounded-lg transition">
                                删除
                            </button>
                        </div>
                    </div>
                    <div class="flex gap-2 flex-wrap" id="history-thumbnails-${item.id}">
                        ${item.results.slice(0, 4).map((r, idx) => {
                            if (r.isError) {
                                return `<div class="w-16 h-16 bg-red-500/10 rounded-lg flex items-center justify-center border border-red-500/20"><svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>`;
                            } else if (r.thumbnail) {
                                return `<img src="${r.thumbnail}" alt="${r.modelName}" class="w-16 h-16 object-cover rounded-lg cursor-pointer border border-stone-700/50 hover:border-stone-500" title="${r.modelName}" data-full-image="${r.imageUrl ? escapeHtml(r.imageUrl) : ''}">`;
                            } else if (r.imageUrl && (r.imageUrl.startsWith('data:image') || r.imageUrl.startsWith('http'))) {
                                return `<img src="${r.imageUrl}" alt="${r.modelName}" class="w-16 h-16 object-cover rounded-lg cursor-pointer border border-stone-700/50 hover:border-stone-500" title="${r.modelName}" data-full-image="${escapeHtml(r.imageUrl)}">`;
                            } else if (r.codeContent) {
                                const codePreviewId = `code-preview-${item.id}-${idx}`;
                                return `<div class="w-16 h-16 bg-stone-900 rounded-lg border border-stone-700/50 overflow-hidden relative cursor-pointer code-thumbnail group hover:border-stone-500" data-code="${escapeHtml(JSON.stringify(r.codeContent))}" data-model="${escapeHtml(r.modelName)}" title="${r.modelName}">
                                    <iframe id="${codePreviewId}" srcdoc="${escapeHtml(r.codeContent)}" class="w-full h-full border-0 pointer-events-none" style="transform: scale(0.2); transform-origin: 0 0; width: 500%; height: 500%;"></iframe>
                                    <div class="absolute inset-0 bg-blue-500/20 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                        <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
                                    </div>
                                </div>`;
                            } else {
                                return `<div class="w-16 h-16 bg-stone-800 rounded-lg flex items-center justify-center border border-stone-700/50" title="${r.modelName}"><svg class="w-5 h-5 text-stone-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg></div>`;
                            }
                        }).join('')}
                        ${item.results.length > 4 ? `<div class="w-16 h-16 bg-stone-800 rounded-lg flex items-center justify-center text-stone-400 text-xs font-medium border border-stone-700/50">+${item.results.length - 4}</div>` : ''}
                    </div>
                `;
                
                historyList.appendChild(historyCard);
                
                // 为缩略图添加点击事件（查看大图）
                const thumbnails = historyCard.querySelectorAll(`#history-thumbnails-${item.id} img`);
                thumbnails.forEach(img => {
                    img.addEventListener('click', () => {
                        // 优先使用完整图片，如果没有则使用缩略图
                        const fullImage = img.getAttribute('data-full-image');
                        showImageModal(fullImage || img.src);
                    });
                });
                
                // 为代码预览缩略图添加点击事件（查看代码预览）
                const codeThumbnails = historyCard.querySelectorAll(`#history-thumbnails-${item.id} .code-thumbnail`);
                codeThumbnails.forEach(thumb => {
                    thumb.addEventListener('click', () => {
                        try {
                            const codeContent = JSON.parse(thumb.getAttribute('data-code'));
                            const modelName = thumb.getAttribute('data-model');
                            const platformRadio = document.querySelector('input[name="platform"]:checked');
                            const currentPlatform = platformRadio ? platformRadio.value : 'mobile';
                            showCodePreview(codeContent, modelName, currentPlatform);
                        } catch (e) {
                            console.error('解析代码内容失败:', e);
                        }
                    });
                });
            });
        }

        function updateCostStatistics(historyItems) {
            const costStatsEl = document.getElementById('costStatistics');
            const costStatsSummaryEl = document.getElementById('costStatsSummary');
            const costStatsDetailsEl = document.getElementById('costStatsDetails');
            
            if (!costStatsEl || !costStatsSummaryEl || !costStatsDetailsEl) return;
            
            // 优先使用服务器统计数据（全站统计）
            const serverStats = window.serverStatistics;
            
            let sortedStats = [];
            let grandTotal = 0;
            let totalGenerations = 0;
            let grandAverage = 0;
            let isServerStats = false;

            if (serverStats && serverStats.modelStats && serverStats.modelStats.length > 0) {
                // 使用服务器统计数据（全站）
                sortedStats = serverStats.modelStats;
                grandTotal = serverStats.grandTotal || 0;
                totalGenerations = serverStats.totalGenerations || 0;
                grandAverage = serverStats.grandAverage || 0;
                isServerStats = true;
            } else if (historyItems.length > 0) {
                // 使用本地历史记录统计
                const modelStats = {};
                
                historyItems.forEach(item => {
                    if (!item.results || !Array.isArray(item.results)) return;
                    
                    item.results.forEach(result => {
                        if (!result.modelName) return;
                        const cost = result.cost || 0;
                        
                        if (!modelStats[result.modelName]) {
                            modelStats[result.modelName] = {
                                totalCost: 0,
                                count: 0
                            };
                        }
                        
                        modelStats[result.modelName].totalCost += cost;
                        modelStats[result.modelName].count += 1;
                    });
                });
                
                sortedStats = Object.entries(modelStats)
                    .map(([modelName, stats]) => ({
                        modelName,
                        totalCost: stats.totalCost,
                        count: stats.count,
                        averageCost: stats.totalCost / stats.count
                    }))
                    .sort((a, b) => b.totalCost - a.totalCost);
                
                grandTotal = sortedStats.reduce((sum, stat) => sum + stat.totalCost, 0);
                totalGenerations = sortedStats.reduce((sum, stat) => sum + stat.count, 0);
                grandAverage = totalGenerations > 0 ? grandTotal / totalGenerations : 0;
            }
            
            if (sortedStats.length === 0) {
                costStatsEl.classList.add('hidden');
                return;
            }
            
            // 显示统计
            costStatsEl.classList.remove('hidden');
            
            // 默认显示的摘要（只显示平均每次）
            const statsLabel = isServerStats ? '全站平均每次' : '平均每次';
            costStatsSummaryEl.innerHTML = `
                <div class="flex items-center gap-2 text-gray-700">
                    <span class="text-gray-600">${statsLabel}：</span>
                    <span class="text-lg font-bold text-gray-800">$${grandAverage.toFixed(4)}</span>
                    ${isServerStats ? '<span class="text-xs text-purple-600 ml-1">🌐 全站</span>' : ''}
                </div>
            `;
            
            // 详细内容（默认隐藏）
            const detailsTitle = isServerStats ? '按模型统计（全站）' : '按模型统计';
            let detailsHtml = `
                ${isServerStats ? '<div class="text-purple-600 text-xs font-medium mb-2">🌐 全站统计数据</div>' : ''}
                <div class="grid grid-cols-3 gap-4 mb-3 pb-3 border-b border-gray-300">
                    <div class="text-center">
                        <div class="text-gray-600 text-xs">${isServerStats ? '全站总花费' : '总花费'}</div>
                        <div class="text-lg font-bold text-gray-800">$${grandTotal.toFixed(2)}</div>
                    </div>
                    <div class="text-center">
                        <div class="text-gray-600 text-xs">${isServerStats ? '全站生成次数' : '总生成次数'}</div>
                        <div class="text-lg font-bold text-gray-800">${totalGenerations}</div>
                    </div>
                    <div class="text-center">
                        <div class="text-gray-600 text-xs">平均每次</div>
                        <div class="text-lg font-bold text-gray-800">$${grandAverage.toFixed(4)}</div>
                    </div>
                </div>
                <div class="space-y-2">
                    <div class="text-gray-700 font-semibold text-xs mb-2">${detailsTitle}：</div>
            `;
            
            sortedStats.forEach(stat => {
                detailsHtml += `
                    <div class="flex items-center justify-between py-2 px-3 bg-white/30 rounded-lg">
                        <div class="flex-1">
                            <div class="text-gray-800 font-medium text-sm">${stat.modelName}</div>
                            <div class="text-gray-600 text-xs mt-0.5">生成 ${stat.count} 次</div>
                        </div>
                        <div class="text-right">
                            <div class="text-gray-800 font-bold text-sm">$${stat.totalCost.toFixed(2)}</div>
                            <div class="text-gray-600 text-xs">平均 $${stat.averageCost.toFixed(4)}</div>
                        </div>
                    </div>
                `;
            });
            
            detailsHtml += `</div>`;
            costStatsDetailsEl.innerHTML = detailsHtml;
            
            // 确保详细内容默认隐藏
            costStatsDetailsEl.classList.add('hidden');
            
            // 更新按钮文本
            const toggleBtnText = document.getElementById('toggleCostStatsText');
            if (toggleBtnText) {
                toggleBtnText.textContent = '展开';
            }
        }

        function toggleCostStatistics() {
            const costStatsDetailsEl = document.getElementById('costStatsDetails');
            const toggleBtnText = document.getElementById('toggleCostStatsText');
            
            if (!costStatsDetailsEl || !toggleBtnText) return;
            
            const isHidden = costStatsDetailsEl.classList.contains('hidden');
            if (isHidden) {
                costStatsDetailsEl.classList.remove('hidden');
                toggleBtnText.textContent = '收起';
            } else {
                costStatsDetailsEl.classList.add('hidden');
                toggleBtnText.textContent = '展开';
            }
        }

        function viewHistoryItem(historyId) {
            const item = generationHistory.find(h => h.id === historyId) || filteredHistory.find(h => h.id === historyId);
            if (!item) {
                alert('历史记录不存在');
                return;
            }
            
            // 清空当前结果
            currentResults = [];
            document.getElementById('resultsGrid').innerHTML = '';
            
            // 加载历史结果 - 使用保存的图片数据
            item.results.forEach(result => {
                if (result.isError) {
                    // 错误结果
                    addResultCard(result.modelName, '', result.cost, true, result.errorMsg, null);
                } else {
                    // 成功结果 - 使用保存的图片URL或代码内容
                    if (result.imageUrl) {
                        // 有图片URL，正常显示
                        addResultCard(result.modelName, result.imageUrl, result.cost, false, '', result.codeContent);
                    } else if (result.codeContent) {
                        // 只有代码内容，显示代码预览
                        addResultCard(result.modelName, '', result.cost, false, '', result.codeContent);
                    } else {
                        // 没有图片也没有代码，显示提示
                        const card = document.createElement('div');
                        card.className = 'image-card glass-dark rounded-2xl overflow-hidden';
                        card.innerHTML = `
                            <div class="aspect-square bg-blue-50 flex items-center justify-center p-6">
                                <div class="text-center">
                                    <div class="text-4xl mb-2">📷</div>
                                    <div class="text-blue-600 text-sm font-medium mb-2">图片数据未保存</div>
                                    <div class="text-gray-600 text-xs mb-3">历史记录中不包含图片数据</div>
                                    <button class="glass text-blue-600 font-medium text-sm px-4 py-2 rounded-lg hover:bg-white/30 transition">
                                        🔄 重新生成
                                    </button>
                                </div>
                            </div>
                            <div class="p-4">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-gray-800 font-semibold">${result.modelName}</span>
                                    <span class="text-gray-600 text-sm">$${result.cost.toFixed(2)}</span>
                                </div>
                            </div>
                        `;
                        card.querySelector('button').onclick = () => {
                            closeHistory();
                            regenerateFromHistory(historyId);
                        };
                        document.getElementById('resultsGrid').appendChild(card);
                    }
                }
            });
            
            // 填充输入框
            document.getElementById('promptInput').value = item.prompt;
            updateCharCount();
            
            // 设置平台选择
            const platformRadio = document.querySelector(`input[name="platform"][value="${item.platform}"]`);
            if (platformRadio) {
                platformRadio.checked = true;
            }
            
            // 设置模型选择
            Object.keys(MODEL_CONFIGS).forEach(key => {
                const checkbox = document.getElementById(`model-${key}`);
                if (checkbox) {
                    checkbox.checked = item.selectedModels.includes(key);
                }
            });
            
            updateCostEstimate();
            
            // 关闭历史记录模态框
            closeHistory();
            
            // 滚动到结果区域
            document.getElementById('resultsGrid').scrollIntoView({ behavior: 'smooth' });
        }

        function regenerateFromHistory(historyId) {
            const item = generationHistory.find(h => h.id === historyId) || filteredHistory.find(h => h.id === historyId);
            if (!item) {
                alert('历史记录不存在');
                return;
            }
            
            // 填充输入框
            document.getElementById('promptInput').value = item.prompt;
            updateCharCount();
            
            // 设置平台选择
            const platformRadio = document.querySelector(`input[name="platform"][value="${item.platform}"]`);
            if (platformRadio) {
                platformRadio.checked = true;
            }
            
            // 设置模型选择
            Object.keys(MODEL_CONFIGS).forEach(key => {
                const checkbox = document.getElementById(`model-${key}`);
                if (checkbox) {
                    checkbox.checked = item.selectedModels.includes(key);
                }
            });
            
            updateCostEstimate();
            
            // 关闭历史记录模态框
            closeHistory();
            
            // 开始生成
            startGeneration();
        }

        function deleteHistoryItem(historyId) {
            if (!confirm('确定要删除这条历史记录吗？')) {
                return;
            }
            
            generationHistory = generationHistory.filter(h => h.id !== historyId);
            localStorage.setItem('generation_history', JSON.stringify(generationHistory));
            loadHistory();
        }

        function clearAllHistory() {
            if (!confirm('确定要清空所有历史记录吗？此操作不可恢复！')) {
                return;
            }
            
            generationHistory = [];
            localStorage.setItem('generation_history', JSON.stringify(generationHistory));
            loadHistory();
        }

        // 显示提示消息
        function showToast(message, duration = 2000) {
            // 创建 toast 元素
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-6 right-6 bg-stone-800 text-stone-100 px-5 py-3 rounded-xl shadow-xl border border-stone-700/50 z-50 transition-all opacity-0 translate-y-2 text-sm font-medium';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // 显示动画
            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateY(0)';
            }, 10);
            
            // 自动移除
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(8px)';
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, duration);
        }

        // HTML 转义函数
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 显示代码预览大图（全屏预览）
        function showCodePreview(codeContent, modelName, platform = 'mobile') {
            // 创建全屏预览模态框
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 z-50';
            
            const modalContent = document.createElement('div');
            
            // 根据平台调整预览尺寸，支持拖拽调整大小
            if (platform === 'mobile') {
                // 移动端：使用 iPhone 16 屏幕比例，增加高度，支持调整
                modalContent.className = 'relative flex flex-col';
                modalContent.style.width = '393px'; // iPhone 16 宽度
                modalContent.style.height = '900px'; // 增加高度，从852px增加到900px
                modalContent.style.minWidth = '300px'; // 最小宽度，支持调整
                modalContent.style.minHeight = '600px'; // 最小高度，支持调整
                modalContent.style.maxWidth = '90vw'; // 在小屏幕上自适应
                modalContent.style.maxHeight = '95vh'; // 增加最大高度，从90vh到95vh
                modalContent.style.resize = 'both'; // 允许双向调整大小
                modalContent.style.overflow = 'auto'; // 允许滚动
            } else {
                // PC端：使用桌面屏幕比例，增加高度，支持调整
                modalContent.className = 'relative flex flex-col';
                modalContent.style.width = '90vw';
                modalContent.style.maxWidth = '1400px'; // 增加最大宽度
                modalContent.style.height = '85vh'; // 增加高度，从80vh到85vh
                modalContent.style.minWidth = '600px'; // 最小宽度
                modalContent.style.minHeight = '500px'; // 最小高度
                modalContent.style.maxHeight = '90vh'; // 增加最大高度
                modalContent.style.resize = 'both'; // 允许双向调整大小
                modalContent.style.overflow = 'auto'; // 允许滚动
            }
            
            const header = document.createElement('div');
            header.className = 'flex items-center justify-between mb-4 bg-stone-900/80 p-4 rounded-t-xl border border-stone-700/50 border-b-0';
            header.innerHTML = `
                <h2 class="text-lg font-bold text-stone-100">${modelName}</h2>
                <button class="close-preview-btn w-10 h-10 rounded-xl bg-stone-800 hover:bg-stone-700 flex items-center justify-center text-stone-400 hover:text-stone-200 transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            `;
            
            const iframeContainer = document.createElement('div');
            iframeContainer.className = 'flex-1 bg-white rounded-xl overflow-hidden shadow-2xl';
            iframeContainer.style.minHeight = '0';
            
            const iframe = document.createElement('iframe');
            iframe.className = 'w-full h-full border-0';
            iframe.srcdoc = codeContent;
            iframeContainer.appendChild(iframe);
            
            const footer = document.createElement('div');
            footer.className = 'mt-4 flex gap-3 bg-stone-900/80 p-4 rounded-b-xl border border-stone-700/50 border-t-0';
            footer.innerHTML = `
                <button class="copy-preview-btn flex-1 bg-stone-700 hover:bg-stone-600 text-stone-200 font-semibold py-3 rounded-xl transition flex items-center justify-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                    复制代码
                </button>
                <button class="download-preview-btn flex-1 bg-stone-700 hover:bg-stone-600 text-stone-200 font-semibold py-3 rounded-xl transition flex items-center justify-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    下载代码
                </button>
                <button class="close-preview-btn flex-1 btn-secondary py-3 rounded-xl font-semibold">
                    关闭
                </button>
            `;
            
            // 关闭按钮
            header.querySelector('.close-preview-btn').onclick = () => {
                modal.remove();
                document.removeEventListener('keydown', handleEsc);
            };
            footer.querySelectorAll('.close-preview-btn').forEach(btn => {
                btn.onclick = () => {
                    modal.remove();
                    document.removeEventListener('keydown', handleEsc);
                };
            });
            
            // 复制代码按钮
            footer.querySelector('.copy-preview-btn').onclick = () => {
                navigator.clipboard.writeText(codeContent).then(() => {
                    showToast('✅ 代码已复制到剪贴板');
                }).catch(err => {
                    console.error('复制失败:', err);
                    alert('复制失败，请查看Console');
                });
            };
            
            // 下载代码按钮
            footer.querySelector('.download-preview-btn').onclick = () => {
                downloadCode(codeContent, modelName);
            };
            
            modalContent.appendChild(header);
            modalContent.appendChild(iframeContainer);
            modalContent.appendChild(footer);
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // 按 ESC 键关闭
            const handleEsc = (e) => {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', handleEsc);
                }
            };
            document.addEventListener('keydown', handleEsc);
        }
    </script>
</body>
</html>
