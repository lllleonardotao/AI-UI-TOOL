<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI UI Comparator</title>
    <!-- Favicon - SVGæ ¼å¼ï¼Œä½¿ç”¨é¡µé¢ä¸»é¢˜æ¸å˜è‰² -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23667eea;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%23764ba2;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' rx='20' fill='url(%23grad)'/%3E%3Ctext x='50' y='70' font-size='60' text-anchor='middle' fill='white' font-family='Arial,sans-serif'%3EğŸ¨%3C/text%3E%3C/svg%3E" type="image/svg+xml">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23667eea;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%23764ba2;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' rx='20' fill='url(%23grad)'/%3E%3Ctext x='50' y='70' font-size='60' text-anchor='middle' fill='white' font-family='Arial,sans-serif'%3EğŸ¨%3C/text%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* ç»ç’ƒæ€æ•ˆæœ - å¢å¼ºå¯¹æ¯”åº¦ */
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
        }
        
        .glass-dark {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* æ¸å˜èƒŒæ™¯ */
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        /* æŒ‰é’®åŠ¨ç”» */
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* å›¾ç‰‡å¡ç‰‡ */
        .image-card {
            transition: all 0.3s ease;
        }
        
        .image-card:hover {
            transform: scale(1.05);
        }
        
        /* éšè—æ»šåŠ¨æ¡ä½†ä¿æŒåŠŸèƒ½ */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="glass rounded-3xl p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">âœ¨ AI UI Comparator</h1>
                    <p class="text-gray-600">ä¸€é”®å¯¹æ¯”å¤šä¸ªAIæ¨¡å‹çš„UIè®¾è®¡ç”Ÿæˆæ•ˆæœ</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="showHistory()" class="glass-dark text-gray-800 font-medium px-4 py-2 rounded-xl hover:bg-white/30 transition">
                        ğŸ“œ å†å²è®°å½•
                    </button>
                <button onclick="showSettings()" class="glass-dark text-gray-800 font-medium px-4 py-2 rounded-xl hover:bg-white/30 transition">
                    âš™ï¸ è®¾ç½®
                </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="grid md:grid-cols-3 gap-6">
            <!-- Left: Input Panel -->
            <div class="md:col-span-1">
                <div class="glass rounded-3xl p-6 sticky top-4 max-h-[calc(100vh-2rem)] overflow-y-auto">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ’¬ è¾“å…¥éœ€æ±‚</h2>
                    
                    <!-- Prompt Input -->
                    <div class="mb-4">
                        <label class="text-gray-700 text-sm font-medium mb-2 block">æè¿°ä½ æƒ³è¦çš„UIç•Œé¢</label>
                        <div class="relative">
                        <textarea 
                            id="promptInput"
                            rows="3"
                            maxlength="500"
                                class="w-full p-4 pr-16 pb-20 rounded-xl bg-white/50 border border-gray-300 text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none"
                            placeholder="ä¾‹å¦‚ï¼šæç®€é£æ ¼çš„ç§»åŠ¨APPç™»å½•é¡µé¢ï¼ŒåŒ…å«logoã€é‚®ç®±è¾“å…¥ã€å¯†ç è¾“å…¥ã€ç™»å½•æŒ‰é’®ï¼Œç»ç’ƒæ€è®¾è®¡ï¼Œç™½è‰²èƒŒæ™¯"
                        ></textarea>
                            
                            <!-- å›¾ç‰‡ä¸Šä¼ åŒºåŸŸï¼ˆå·¦ä¸‹è§’ï¼‰ -->
                            <div class="absolute bottom-6 left-2 flex items-center gap-2 flex-wrap">
                                <!-- å·²ä¸Šä¼ çš„å›¾ç‰‡é¢„è§ˆ -->
                                <div id="referenceImagesContainer" class="flex items-center gap-2 flex-wrap"></div>
                                
                                <!-- æ·»åŠ å›¾ç‰‡æŒ‰é’® -->
                                <input 
                                    type="file" 
                                    id="referenceImageInput" 
                                    accept="image/*" 
                                    class="hidden"
                                    onchange="handleImageUpload(event)"
                                    multiple
                                >
                                <button 
                                    type="button"
                                    onclick="document.getElementById('referenceImageInput').click()"
                                    class="w-10 h-10 flex items-center justify-center bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition shadow-lg"
                                    title="æ·»åŠ å‚è€ƒå›¾ç‰‡"
                                >
                                    <span class="text-xl font-bold">+</span>
                                </button>
                            </div>
                            
                            <!-- å­—ç¬¦è®¡æ•°ï¼ˆå³ä¸‹è§’ï¼‰ -->
                            <div class="absolute bottom-5 right-3 text-gray-500 text-xs">
                            <span id="charCount">0</span>/500
                            </div>
                        </div>
                    </div>

                    <!-- Quick Templates (ç§»åˆ°è¾“å…¥æ¡†ä¸‹æ–¹) -->
                    <div class="mb-4">
                        <div class="flex flex-wrap gap-2">
                            <button onclick="useTemplate('dashboard')" class="text-xs glass-dark text-gray-700 font-medium px-3 py-1 rounded-lg hover:bg-white/20 transition">ç†è´¢ä»ªè¡¨ç›˜</button>
                            <button onclick="useTemplate('search-result')" class="text-xs glass-dark text-gray-700 font-medium px-3 py-1 rounded-lg hover:bg-white/20 transition">æœç´¢åœºå†…</button>
                            <button onclick="useTemplate('campaign')" class="text-xs glass-dark text-gray-700 font-medium px-3 py-1 rounded-lg hover:bg-white/20 transition">è¿è¥æ´»åŠ¨</button>
                        </div>
                    </div>

                    <!-- å¹¶æ’æ˜¾ç¤ºï¼šç›®æ ‡å¹³å°ã€é€‰æ‹©AIæ¨¡å‹ã€é¢„è®¡æˆæœ¬ -->
                    <div class="grid grid-cols-1 gap-4 mb-4">
                        <!-- Platform Selection -->
                        <div>
                        <label class="text-gray-700 text-sm font-medium mb-2 block">ğŸ“± ç›®æ ‡å¹³å°</label>
                        <div class="flex gap-2">
                            <label class="flex-1 flex items-center justify-center glass-dark p-3 rounded-lg cursor-pointer hover:bg-white/20 transition">
                                <input type="radio" name="platform" value="mobile" class="mr-2" checked>
                                    <span class="text-gray-800 font-medium text-sm">æ‰‹æœºç«¯</span>
                            </label>
                            <label class="flex-1 flex items-center justify-center glass-dark p-3 rounded-lg cursor-pointer hover:bg-white/20 transition">
                                <input type="radio" name="platform" value="desktop" class="mr-2">
                                    <span class="text-gray-800 font-medium text-sm">PCç«¯</span>
                            </label>
                        </div>
                    </div>

                    <!-- Model Selection -->
                        <div>
                        <label class="text-gray-700 text-sm font-medium mb-2 block">ğŸ¨ é€‰æ‹©AIæ¨¡å‹</label>
                            <div class="space-y-2 max-h-48 overflow-y-auto" id="modelSelectionList">
                                <!-- æ¨¡å‹åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        </div>
                    </div>

                    <!-- Cost Estimate and Generate Button (è´´åœ¨ä¸€èµ·) -->
                    <div class="space-y-0">
                    <!-- Cost Estimate -->
                        <div class="bg-purple-100 p-3 rounded-t-xl">
                        <div class="flex justify-between text-gray-700 text-sm font-medium">
                            <span>é¢„è®¡æˆæœ¬</span>
                            <span id="costEstimate" class="font-mono">$0.10</span>
                        </div>
                    </div>

                    <!-- Generate Button -->
                    <button 
                        onclick="startGeneration()"
                        id="generateBtn"
                            class="w-full btn-primary text-white font-bold py-4 rounded-b-xl rounded-t-none"
                    >
                        ğŸš€ å¼€å§‹ç”Ÿæˆ
                    </button>
                    </div>
                </div>
            </div>

            <!-- Right: Results Panel -->
            <div class="md:col-span-2">
                <!-- Progress -->
                <div id="progressSection" class="glass rounded-3xl p-6 mb-6 hidden">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">â³ ç”Ÿæˆè¿›åº¦</h2>
                    <div class="space-y-3" id="progressList"></div>
                </div>

                <!-- Results -->
                <div id="resultsContainer" class="glass rounded-3xl p-6 flex flex-col">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold text-gray-800">ğŸ“Š ç”Ÿæˆç»“æœ</h2>
                        <span id="totalCostDisplay" class="text-sm text-gray-500 hidden">
                            æœ¬æ¬¡ç”Ÿæˆæ€»è®¡èŠ±è´¹ <span id="totalCostValue" class="font-mono">$0.00</span>
                        </span>
                    </div>
                    <div id="resultsGrid" class="grid grid-cols-1 sm:grid-cols-2 gap-4 flex-1 min-h-[500px] items-center">
                        <!-- Empty State -->
                        <div class="col-span-2 flex items-center justify-center text-center text-gray-500 min-h-[400px]">
                            <div>
                            <div class="text-6xl mb-4">ğŸ¨</div>
                            <p>è¾“å…¥ä½ çš„éœ€æ±‚ï¼Œç‚¹å‡»ç”ŸæˆæŒ‰é’®å¼€å§‹åˆ›ä½œ</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
        <div class="glass rounded-3xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">âš™ï¸ è®¾ç½®</h2>
            
            <!-- API Key é…ç½® -->
            <div class="mb-6">
                <label class="text-gray-700 text-sm font-medium mb-2 block">ğŸ”‘ OpenRouter API Keyï¼ˆå¯é€‰ï¼‰</label>
                <div class="mb-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                    <p class="text-blue-800 text-xs">
                        ğŸ’¡ å¦‚æœä¸å¡«å†™ï¼Œå°†ä½¿ç”¨æœåŠ¡å™¨ç«¯çš„å…¬ç”¨ API Keyã€‚å¡«å†™ä½ è‡ªå·±çš„ API Key åï¼Œå°†ä¼˜å…ˆä½¿ç”¨ä½ çš„ Keyã€‚
                    </p>
                </div>
                <input 
                    type="password" 
                    id="apiKeyInput"
                    placeholder="sk-or-v1-..." 
                    class="w-full p-3 rounded-lg bg-white/50 border border-gray-300 text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500"
                >
                <p class="text-gray-600 text-xs mt-1">
                    è·å– API Keyï¼š<a href="https://openrouter.ai/keys" target="_blank" class="text-purple-600 hover:underline">https://openrouter.ai/keys</a>
                </p>
            </div>

            <!-- Model Selection -->
            <div class="mb-6">
                <div class="flex items-center justify-between mb-2">
                    <label class="text-gray-700 text-sm font-medium block">ğŸ¨ é€‰æ‹©AIæ¨¡å‹ï¼ˆè‡³å°‘é€‰æ‹©ä¸€ä¸ªï¼‰</label>
                    <button onclick="resetToDefaultModels()" class="text-xs glass-dark text-gray-700 font-medium px-3 py-1 rounded-lg hover:bg-white/30 transition">
                        ğŸ”„ æ¢å¤é»˜è®¤é€‰æ‹©
                </button>
            </div>
                <div class="mb-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <p class="text-yellow-800 text-xs">ğŸ’¡ è‡³å°‘éœ€è¦é€‰æ‹©ä¸€ä¸ªæ¨¡å‹æ‰èƒ½ç”Ÿæˆå†…å®¹</p>
                    </div>
                <div id="settingsModelList" class="space-y-2 max-h-96 overflow-y-auto">
                    <!-- æ¨¡å‹åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <!-- Debug Mode -->
            <div class="mb-6">
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" id="debugMode" class="mr-2">
                    <span class="text-gray-700 text-sm font-medium">ğŸ› å¯ç”¨è°ƒè¯•æ¨¡å¼ï¼ˆæ˜¾ç¤ºè¯¦ç»†æ—¥å¿—ï¼‰</span>
                </label>
                <p class="text-gray-600 text-xs mt-1 ml-6">
                    å¼€å¯åä¼šåœ¨æ§åˆ¶å°æ˜¾ç¤ºè¯¦ç»†çš„APIè¯·æ±‚å’Œå“åº”ä¿¡æ¯
                </p>
            </div>

            <div class="flex gap-3">
                <button onclick="saveSettings()" class="flex-1 btn-primary text-white font-bold py-3 rounded-xl">
                    ä¿å­˜
                </button>
                <button onclick="closeSettings()" class="flex-1 glass-dark text-gray-800 font-bold py-3 rounded-xl hover:bg-white/30 transition">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
        <div class="glass rounded-3xl p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-bold text-gray-800">ğŸ“œ ç”Ÿæˆå†å²</h2>
                <button onclick="closeHistory()" class="text-gray-600 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            
            <!-- èŠ±è´¹æ˜ç»†ç»Ÿè®¡ -->
            <div id="costStatistics" class="mb-4 glass-dark rounded-xl p-4 hidden">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-lg font-bold text-gray-800">ğŸ’° èŠ±è´¹æ˜ç»†ç»Ÿè®¡</h3>
                    <button id="toggleCostStats" onclick="toggleCostStatistics()" class="text-gray-600 hover:text-gray-800 text-sm font-medium px-3 py-1 rounded-lg hover:bg-white/30 transition">
                        <span id="toggleCostStatsText">å±•å¼€</span>
                    </button>
                </div>
                <div id="costStatsSummary" class="text-sm">
                    <!-- é»˜è®¤æ˜¾ç¤ºçš„æ‘˜è¦ä¿¡æ¯ -->
                </div>
                <div id="costStatsDetails" class="space-y-2 text-sm hidden">
                    <!-- è¯¦ç»†ç»Ÿè®¡å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                </div>
            </div>
            
            <!-- æœç´¢å’Œç­›é€‰ -->
            <div class="mb-4 space-y-2">
                <div class="flex gap-2">
                    <input 
                        type="text" 
                        id="historySearch" 
                        placeholder="ğŸ” æœç´¢å†å²è®°å½•..." 
                        class="flex-1 p-2 rounded-lg bg-white/50 border border-gray-300 text-gray-800 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
                        oninput="filterHistory()"
                    >
                    <select 
                        id="historyFilter" 
                        class="p-2 rounded-lg bg-white/50 border border-gray-300 text-gray-800 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
                        onchange="filterHistory()"
                    >
                        <option value="all">å…¨éƒ¨</option>
                        <option value="mobile">æ‰‹æœºç«¯</option>
                        <option value="desktop">PCç«¯</option>
                        <option value="today">ä»Šå¤©</option>
                        <option value="week">æœ€è¿‘ä¸€å‘¨</option>
                        <option value="month">æœ€è¿‘ä¸€æœˆ</option>
                    </select>
                </div>
                <div class="text-gray-600 text-xs">
                    å…± <span id="historyCount">0</span> æ¡è®°å½•
                </div>
            </div>
            
            <div id="historyList" class="space-y-3">
                <!-- å†å²è®°å½•å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
            </div>
            
            <div id="historyEmpty" class="text-center py-12 text-gray-500 hidden">
                <div class="text-6xl mb-4">ğŸ“</div>
                <p>è¿˜æ²¡æœ‰ç”Ÿæˆå†å²è®°å½•</p>
                <p class="text-sm mt-2">å¼€å§‹ç”Ÿæˆä½ çš„ç¬¬ä¸€ä¸ªUIè®¾è®¡å§ï¼</p>
            </div>
            
            <div id="historyNoResults" class="text-center py-12 text-gray-500 hidden">
                <div class="text-6xl mb-4">ğŸ”</div>
                <p>æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„å†å²è®°å½•</p>
                <p class="text-sm mt-2">å°è¯•è°ƒæ•´æœç´¢æ¡ä»¶</p>
            </div>
            
            <div class="mt-4 flex gap-3">
                <button onclick="clearAllHistory()" class="flex-1 glass-dark text-gray-800 font-bold py-3 rounded-xl hover:bg-white/30 transition">
                    ğŸ—‘ï¸ æ¸…ç©ºå…¨éƒ¨
                </button>
                <button onclick="closeHistory()" class="flex-1 glass-dark text-gray-800 font-bold py-3 rounded-xl hover:bg-white/30 transition">
                    å…³é—­
                </button>
            </div>
        </div>
    </div>

    <!-- Image Preview Modal -->
    <div id="imageModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center p-4 z-50" onclick="closeImageModal()">
        <div class="max-w-4xl max-h-[90vh] overflow-auto">
            <img id="modalImage" src="" class="w-full rounded-2xl">
        </div>
    </div>

    <script>
        // é…ç½®
        // OpenRouter API é…ç½®
        const OPENROUTER_API_BASE = 'https://openrouter.ai/api/v1';
        const OPENROUTER_PROXY_URL = '/api/openrouter'; // æœåŠ¡å™¨ç«¯ä»£ç† URL
        
        // è·å– API é…ç½®ï¼ˆURL å’Œ headersï¼‰
        function getApiConfig() {
            const userApiKey = localStorage.getItem('openrouter_api_key');
            if (userApiKey && userApiKey.trim()) {
                // ä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰ API Keyï¼Œç›´æ¥è°ƒç”¨ OpenRouter API
                return {
                    url: `${OPENROUTER_API_BASE}/chat/completions`,
                    headers: {
                        'Authorization': `Bearer ${userApiKey.trim()}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': window.location.origin,
                        'X-Title': 'AI UI Comparator'
                    }
                };
            } else {
                // ä½¿ç”¨æœåŠ¡å™¨ç«¯ä»£ç†
                return {
                    url: OPENROUTER_PROXY_URL,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };
            }
        }
        
        /**
         * æ¨¡å‹é…ç½®
         * 
         * æ³¨æ„ï¼šæ‰€æœ‰æ¨¡å‹ï¼ˆåŒ…æ‹¬æœªæ¥æ·»åŠ çš„æ¨¡å‹å’Œè‡ªå®šä¹‰æ¨¡å‹ï¼‰éƒ½ä¼šè‡ªåŠ¨åŒ…å«å¹³å°ä¿¡æ¯
         * - å¹³å°ä¿¡æ¯ï¼ˆæ‰‹æœºç«¯/PCç«¯ï¼‰ä¼šè‡ªåŠ¨æ·»åŠ åˆ° API è¯·æ±‚ä¸­
         * - ç”¨æˆ·åœ¨ç•Œé¢é€‰æ‹©å¹³å°åï¼Œæ‰€æœ‰æ¨¡å‹éƒ½ä¼šæ”¶åˆ°ç›¸åº”çš„å¹³å°ä¿¡æ¯
         * - è‡ªå®šä¹‰æ¨¡å‹é€šè¿‡è®¾ç½®ç•Œé¢æ·»åŠ æ—¶ï¼Œä¹Ÿä¼šè‡ªåŠ¨æ”¯æŒå¹³å°ä¿¡æ¯
         * 
         * æ·»åŠ æ–°æ¨¡å‹æ—¶ï¼Œåªéœ€è®¾ç½®ä»¥ä¸‹å­—æ®µï¼š
         * - name: æ˜¾ç¤ºåç§°
         * - model: æ¨¡å‹IDï¼ˆå¦‚ 'provider/model-name'ï¼‰
         * - cost: æ¯æ¬¡ç”Ÿæˆçš„æˆæœ¬ï¼ˆç¾å…ƒï¼‰
         * - type: 'image' è¡¨ç¤ºç›´æ¥ç”Ÿæˆå›¾ç‰‡ï¼Œ'text-to-image-desc' è¡¨ç¤ºå…ˆç”Ÿæˆæè¿°å†ç”Ÿæˆå›¾ç‰‡
         */
        const MODEL_CONFIGS = {
            'gemini': {
                name: 'Gemini Image',
                model: 'google/gemini-2.5-flash-image-preview',
                cost: 0.04,
                type: 'image'
            },
            'gemini-flash': {
                name: 'Gemini 2.5 Flash Image',
                model: 'google/gemini-2.5-flash-image',
                cost: 0.05,
                type: 'image'
            },
            'gemini-pro': {
                name: 'Gemini 3 Pro Image',
                model: 'google/gemini-3-pro-image-preview',
                cost: 0.05,
                type: 'image'
            },
            'gemini-3-pro': {
                name: 'Gemini 3 Pro Preview',
                model: 'google/gemini-3-pro-preview',
                cost: 0.07,
                type: 'text-to-image-desc' // è¯¥æ¨¡å‹è¿”å›æ–‡æœ¬æè¿°ï¼Œéœ€è¦è½¬æ¢ä¸ºå›¾åƒ
            },
            'flux': {
                name: 'Flux Pro',
                model: 'black-forest-labs/flux.2-pro',
                cost: 0.06,
                type: 'image'
            },
            'gpt5': {
                name: 'GPT-5 Image',
                model: 'openai/gpt-5-image',
                cost: 0.05,
                type: 'image'
            },
            'claude': {
                name: 'Claude 3.5 (æè¿°)',
                model: 'anthropic/claude-3.5-sonnet',
                cost: 0.06,
                type: 'text-to-image-desc'
            },
            'claude-code': {
                name: 'Claude 3.5 (ä»£ç )',
                model: 'anthropic/claude-3.5-sonnet',
                cost: 0.04,
                type: 'code',
                timeout: 100000 // 100sï¼ŒClaude 3.5 å¶å°”è¾ƒæ…¢
            },
            'gpt4-code': {
                name: 'GPT-4 Turbo (ä»£ç )',
                model: 'openai/gpt-4-turbo',
                cost: 0.02,
                type: 'code',
                timeout: 110000 // 110sï¼ŒGPT-4 Turbo ç”Ÿæˆå®Œæ•´é¡µé¢éœ€è¦æ—¶é—´
            },
            'deepseek-code': {
                name: 'DeepSeek Coder (ä»£ç )',
                model: 'deepseek/deepseek-chat', // ä½¿ç”¨ deepseek-chatï¼Œdeepseek-coder å¯èƒ½ä¸å¯ç”¨
                cost: 0.01,
                type: 'code',
                timeout: 120000 // 120sï¼ŒDeepSeek å“åº”è¾ƒæ…¢
            },
            'gpt4o-code': {
                name: 'GPT-4o (ä»£ç )',
                model: 'openai/gpt-4o',
                cost: 0.01,
                type: 'code',
                timeout: 100000
            },
            'qwen-coder': {
                name: 'Qwen 2.5 (ä»£ç )',
                model: 'qwen/qwen-2.5-72b-instruct',
                cost: 0.01,
                type: 'code',
                timeout: 110000
            },
            'deepseek-v3': {
                name: 'DeepSeek V3 (ä»£ç )',
                model: 'deepseek/deepseek-chat-v3.1',
                cost: 0.01,
                type: 'code',
                timeout: 130000
            },
            'claude-opus': {
                name: 'Claude Opus 4.5 (ä»£ç )',
                model: 'anthropic/claude-opus-4.5',
                cost: 0.2,
                type: 'code',
                timeout: 150000 // Opus éå¸¸æ…¢ï¼Œç»™è¶³ 150s
            },
            'grok-fast': {
                name: 'Grok 4.1 Fast (ä»£ç )',
                model: 'x-ai/grok-4.1-fast',
                cost: 0.01,
                type: 'code',
                timeout: 100000
            },
            'claude-sonnet-4.5': {
                name: 'Claude Sonnet 4.5 (ä»£ç )',
                model: 'anthropic/claude-sonnet-4.5',
                cost: 0.08,
                type: 'code',
                timeout: 130000
            },
            'claude-haiku-4.5': {
                name: 'Claude Haiku 4.5 (ä»£ç )',
                model: 'anthropic/claude-haiku-4.5',
                cost: 0.03, // ç”¨æˆ·è®¾ç½®çš„ä»·æ ¼
                type: 'code',
                timeout: 90000 // Haiku å“åº”è¾ƒå¿«ï¼Œ90s åº”è¯¥è¶³å¤Ÿ
            },
            // ä»¥ä¸‹æ¨¡å‹æš‚æ—¶ä¸å¯ç”¨ï¼Œå·²æ³¨é‡Š
            // 'deepseek-chat-v3': {
            //     name: 'DeepSeek Chat v3.1 (ä»£ç ) (å…è´¹)',
            //     model: 'deepseek/deepseek-chat-v3.1',
            //     cost: 0,
            //     type: 'code'
            // },
            // 'deepseek-r1': {
            //     name: 'DeepSeek R1 Distill (ä»£ç ) (å…è´¹)',
            //     model: 'deepseek/deepseek-r1-distill-qwen-8b',
            //     cost: 0,
            //     type: 'code'
            // },
            // 'qwen-coder-plus': {
            //     name: 'Qwen3 Coder Plus (ä»£ç )',
            //     model: 'qwen/qwen3-coder-plus',
            //     cost: 0.001,
            //     type: 'code'
            // }
        };

        // æ¨¡æ¿
        const TEMPLATES = {
            login: 'ç”Ÿæˆä¸€ä¸ªä¸“ä¸šã€å¯ä¿¡çš„ç†è´¢é¦–é¡µç•Œé¢ï¼Œæ•´ä½“é£æ ¼å…‹åˆ¶ã€ä½é¥±å’Œã€åé•¿æœŸæŠ•èµ„ã€‚\n\né¡¶éƒ¨ä¸ºèµ„äº§ä¸è¡Œæƒ…æ¦‚è§ˆåŒºï¼Œå±•ç¤ºæ€»èµ„äº§ã€æ˜¨æ—¥æ”¶ç›Šã€ç´¯è®¡æ”¶ç›Šï¼Œæ•°å­—æ¸è¿›åŠ è½½ï¼Œè¡Œæƒ…ç”¨ç»†å¾®åŠ¨æ€çº¿æ¡è¡¨è¾¾ã€‚\n\nä¸»ä½“ä¸ºåŸºé‡‘äº§å“åˆ—è¡¨ï¼ŒæŒ‰æŒ‡æ•°ã€ä¸»åŠ¨ã€å›ºæ”¶+åˆ†åŒºã€‚å•ä¸ªäº§å“å¡ç‰‡åŒ…å«è¿‘ä¸€å¹´æ”¶ç›Šã€é£é™©ç­‰çº§ã€æ³¢åŠ¨ç‰¹å¾ï¼Œæ ¸å¿ƒæ•°æ®é«˜äº®ï¼Œå±•å¼€åæ˜¾ç¤ºæ›´å¤šå‚æ•°ï¼Œå±•å¼€è¿‡ç¨‹å¹³æ»‘è‡ªç„¶ã€‚\n\nç©¿æ’ç†è´¢èµ„è®¯æ¨¡å—ï¼Œä»¥ç®€æ´ä¿¡æ¯æµå±•ç¤ºå¸‚åœºè§£è¯»ã€‚\n\nè®¾ç½®åŸºé‡‘ç»ç†å¡ç‰‡ï¼Œå±•ç¤ºä»ä¸šå¹´é™ã€ç®¡ç†è§„æ¨¡ã€ä»£è¡¨äº§å“ï¼Œç‚¹å‡»æ˜¾ç¤ºç®¡ç†ç†å¿µã€‚\n\nåº•éƒ¨æˆ–ä¾§è¾¹ä¸ºè¡Œæƒ…æ¨¡å—ï¼Œæ”¯æŒæŒ‡æ•°åˆ‡æ¢ï¼Œæ›²çº¿åŠ¨æ€é‡ç»˜ã€‚\n\næ•´ä½“äº¤äº’è‡ªç„¶æµç•…ï¼Œä¿¡æ¯å±‚çº§æ¸…æ™°ï¼Œå¼ºè°ƒå¯ç†è§£ã€å¯æ¯”è¾ƒã€å¯å†³ç­–ã€‚',
            dashboard: 'ç”Ÿæˆæ·±è‰²æ¨¡å¼ã€ç§‘æŠ€æ„Ÿå¼ºçš„ç†è´¢ä»ªè¡¨ç›˜ï¼Œæ·±ç°ï¼‹éœ“è™¹è“ç´«å…‰æ•ˆï¼Œä¿¡æ¯è¾¹ç•Œç”¨ç»†çº¿ä¸å¾®å¼±å‘å…‰åŒºåˆ†ã€‚é¡¶éƒ¨å±•ç¤ºæ€»èµ„äº§ã€æ˜¨æ—¥æ”¶ç›Šã€ç´¯è®¡æ”¶ç›Šï¼Œæ•°å­—èƒ½é‡æ¡å¼æ¸è¿›åŠ¨ç”»ï¼Œæ”¶ç›Šæ³¢åŠ¨ä»¥å…‰çº¿è„‰å†²å‘ˆç°ã€‚ä¸­éƒ¨ä¸ºèµ„äº§åˆ†å¸ƒä»ªè¡¨åŒºï¼ˆç¯å½¢å›¾/èƒ½é‡ç¯ï¼‰ï¼Œè¿›å…¥è§†å›¾æ—¶ä¾æ¬¡ç‚¹äº®ï¼Œç‚¹å‡»èµ„äº§åˆ†ç±»åä»¥æŠ˜å å¡ç‰‡å±•å¼€å¹¶ä¼´éšå…‰çº¿æ‰©æ•£ã€‚å³ä¾§ä¸ºé£é™©ä¸å¥åº·åº¦æ¨¡å—ï¼ˆé›·è¾¾å›¾/è¯„åˆ†å¡ï¼‰ï¼Œåˆ‡æ¢æ—¶å…‰æ•ˆæ·¡å…¥ï¼Œé«˜è¯„åˆ†è“å…‰å¼ºè°ƒï¼Œä½è¯„åˆ†æš—çº¢æç¤ºã€‚åº•éƒ¨å±•ç¤º"è°ƒä»“ã€ä¹°å…¥ã€åˆ†ææŠ¥å‘Š"å…¥å£ï¼ŒæŒ‰é’®å¸¦å‘¼å¸å…‰æ•ˆï¼Œä¿æŒç¨³å¥é‡‘èæ°›å›´ã€‚æ•´ä½“æœªæ¥æ„Ÿã€å¯è§†åŒ–å¼ºã€äº¤äº’å…‹åˆ¶ã€‚',
            profile: 'åŸºé‡‘è¯¦æƒ…é¡µå›´ç»•"å¯ç†è§£ã€å¯æ¯”è¾ƒã€å¯å†³ç­–"æ„å»ºä¿¡æ¯ç»“æ„ã€‚é¡¶éƒ¨å±•ç¤ºåŸºé‡‘åç§°ã€ç±»å‹æ ‡ç­¾ï¼ˆå¦‚æŒ‡æ•°/å›ºæ”¶+ï¼‰ï¼Œä»¥åŠæ ¸å¿ƒæ”¶ç›ŠæŒ‡æ ‡ï¼ˆè¿‘1å¹´æ”¶ç›Šã€ä»Šå¹´ä»¥æ¥ã€æˆç«‹ä»¥æ¥ï¼‰ï¼Œæ•°å€¼ä»¥æ¸è¿›åŠ è½½åŠ¨ç”»å‘ˆç°ï¼Œå¹¶é™„å¸¦è½»å¾®æ¶¨è·ŒåŠ¨æ€çº¿æ¡ï¼Œå¼ºè°ƒè¶‹åŠ¿æ„Ÿã€‚\n\né¡µé¢ä¸­æ®µä¸ºæ”¶ç›Šèµ°åŠ¿å›¾ï¼Œæ”¯æŒåˆ‡æ¢ 1æœˆ / 6æœˆ / 1å¹´ / æœ€å¤§åŒºé—´ã€‚åˆ‡æ¢æ—¶æ›²çº¿åŠ¨æ€é‡ç»˜ï¼Œå¹¶ä»¥æ·¡å…¥æ–¹å¼å‘ˆç°ã€‚å›¾ä¸‹æä¾›å…³é”®å‚æ•°ï¼šæœ€å¤§å›æ’¤ã€æ³¢åŠ¨ç‡ã€å¤æ™®æ¯”ç‡ç­‰ï¼Œç”¨äºå¸®åŠ©ç”¨æˆ·å¿«é€Ÿåˆ¤æ–­é£é™©æ”¶ç›Šç‰¹å¾ã€‚\n\næŒä»“ç»“æ„æ¨¡å—é‡‡ç”¨å¯å±•å¼€å¡ç‰‡ï¼Œå±•ç¤ºè¡Œä¸šå æ¯”ã€é‡ä»“èµ„äº§ç­‰ï¼Œå±•å¼€ä¸æ”¶èµ·åŠ¨ä½œå¸¦æœ‰è½»å¾®å¼¹æ€§åŠ¨æ•ˆã€‚\n\nåŸºé‡‘ç»ç†ä¿¡æ¯åŒºä»¥å¡ç‰‡å½¢å¼å‘ˆç°ï¼Œä»ä¸šå¹´é™ã€ç®¡ç†è§„æ¨¡ã€ä»£è¡¨äº§å“åŠè¿‡å¾€ä¸šç»©ï¼Œç‚¹å‡»å¯æŸ¥çœ‹æ›´å®Œæ•´å±¥å†ä¸ç®¡ç†ç†å¿µã€‚\n\né¡µé¢åº•éƒ¨ä¸ºå›ºå®šæ“ä½œåŒºï¼Œæä¾›"ä¹°å…¥""å®šæŠ•"æŒ‰é’®ã€‚"ä¹°å…¥"æŒ‰é’®è½»å¾®å‘¼å¸åŠ¨æ•ˆï¼Œç”¨äºå¼ºè°ƒä¸»è¦è¡Œä¸ºå…¥å£ã€‚é¡µé¢æ»‘åŠ¨æ—¶æŒ‰é’®å¸é™„åº•éƒ¨ä¿æŒå¯è§ã€‚æ•´ä½“äº¤äº’å…‹åˆ¶ï¼Œä¿¡æ¯æ¸…æ™°ï¼Œæ”¯æŒç”¨æˆ·åšå‡ºç¨³å¥çš„é•¿æœŸå†³ç­–ã€‚',
            'search-result': 'ç”¨æˆ·æœç´¢ä¸€åªåœºå†…åŸºé‡‘åï¼Œç»“æœé¡µå±•ç¤ºè¯¥åœºå†…äº§å“çš„åŸºç¡€ä¿¡æ¯ï¼ŒåŒæ—¶è”åŠ¨å±•ç¤ºè·Ÿè¸ªåŒä¸€æŒ‡æ•°çš„åœºå¤–å¯¹åº”äº§å“ã€‚é¡µé¢æ˜ç¡®æç¤ºï¼šåœºå¤–ç”³è´­æ›´ä¾¿æ·ã€æ— å¼€æˆ·é—¨æ§›ã€è´¹ç‡æ›´ä½ï¼Œé€‚åˆä½œä¸ºå¤šæ•°ç”¨æˆ·çš„ä¹°å…¥é€‰æ‹©ï¼›è€Œåœºå†…éœ€åˆ¸å•†å¼€æˆ·ã€äº¤æ˜“æœºåˆ¶å¤æ‚ã€å­˜åœ¨æº¢ä»·æŠ˜ä»·é£é™©ã€‚\n\nåœ¨ç»“æœä¸­ï¼Œåœºå¤–äº§å“çš„"ä¹°å…¥"æŒ‰é’®å¸¦æœ‰è½»å¾®çš„å‘¼å¸é—ªçƒåŠ¨æ•ˆï¼Œå¼•å¯¼ç”¨æˆ·ä¼˜å…ˆé€‰æ‹©åœºå¤–ç”³è´­ï¼›åœºå†…äº§å“çš„ä¹°å…¥æŒ‰é’®ä¿æŒé™æ€çŠ¶æ€ï¼Œå‡å°‘è¯¯è§¦ä¸é”™è¯¯è·¯å¾„ã€‚æ•´ä½“å¼ºè°ƒé€æ˜å¯¹æ¯”ã€æ¸…æ™°å¼•å¯¼ã€é™ä½æ–°æ‰‹çš„äº¤æ˜“å¤æ‚åº¦ã€‚',
            campaign: 'ç”Ÿæˆä¸€ä¸ªæ˜¥èŠ‚å–œåº†çš„è¿è¥æ´»åŠ¨é¡µé¢ï¼Œæ©™çº¢è‰²è°ƒã€‚æ´»åŠ¨å†…å®¹ä¸ºï¼šä¹°å…¥ç†è´¢äº§å“å¾—ç§¯åˆ†ï¼Œç§¯åˆ†èƒ½å…‘å¾®ä¿¡ç«‹å‡é‡‘ã€‚é¡µé¢éœ€åŒ…å«ç†è´¢äº§å“å¡ç‰‡ï¼Œå¡ç‰‡ä¸Šåº”æœ‰å›¾è¡¨å±•ç¤ºè¯¥äº§å“çš„è¿è¥æ•°æ®æˆ–ç‰¹ç‚¹ã€‚æ•´ä½“è®¾è®¡è¦çªå‡ºèŠ‚æ—¥æ°›å›´å’Œæ´»åŠ¨å¸å¼•åŠ›ã€‚'
        };

        // API Key å·²ç§»è‡³æœåŠ¡å™¨ç«¯ï¼ˆVercel Serverless Functionï¼‰
        // å‰ç«¯æ— éœ€é…ç½® API Keyï¼Œæ‰€æœ‰è¯·æ±‚é€šè¿‡ /api/openrouter ä»£ç†
        // éœ€è¦åœ¨ Vercel é¡¹ç›®è®¾ç½®ä¸­é…ç½®ç¯å¢ƒå˜é‡ OPENROUTER_API_KEY
        let currentResults = [];
        let debugMode = localStorage.getItem('debug_mode') === 'true';
        let generationHistory = JSON.parse(localStorage.getItem('generation_history') || '[]');
        let referenceImages = []; // å­˜å‚¨å‚è€ƒå›¾ç‰‡çš„æ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ åŒ…å« {id, data}

        // å¤„ç†å›¾ç‰‡ä¸Šä¼ ï¼ˆæ”¯æŒå¤šå¼ ï¼‰
        function handleImageUpload(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;
            
            files.forEach(file => {
                // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                if (!file.type.startsWith('image/')) {
                    alert(`âš ï¸ ${file.name} ä¸æ˜¯å›¾ç‰‡æ–‡ä»¶`);
                    return;
                }
                
                // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ 10MBï¼‰
                if (file.size > 10 * 1024 * 1024) {
                    alert(`âš ï¸ ${file.name} æ–‡ä»¶å¤§å°è¶…è¿‡ 10MB`);
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageId = Date.now() + Math.random();
                    const imageData = {
                        id: imageId,
                        data: e.target.result // base64 æ•°æ®
                    };
                    
                    referenceImages.push(imageData);
                    renderReferenceImages();
                    
                    console.log('âœ… å‚è€ƒå›¾ç‰‡å·²ä¸Šä¼ :', imageId);
                };
                reader.onerror = () => {
                    alert(`âš ï¸ ${file.name} è¯»å–å¤±è´¥`);
                };
                reader.readAsDataURL(file);
            });
            
            // æ¸…ç©º inputï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
            event.target.value = '';
        }

        // æ¸²æŸ“å‚è€ƒå›¾ç‰‡åˆ—è¡¨
        function renderReferenceImages() {
            const container = document.getElementById('referenceImagesContainer');
            container.innerHTML = '';
            
            referenceImages.forEach((image, index) => {
                const imageItem = document.createElement('div');
                imageItem.className = 'relative group';
                imageItem.innerHTML = `
                    <img 
                        src="${image.data}" 
                        alt="å‚è€ƒå›¾ç‰‡ ${index + 1}" 
                        class="w-12 h-12 object-cover rounded-lg border-2 border-gray-300 cursor-pointer hover:border-purple-500 transition"
                        onclick="showImageModal('${image.data}')"
                    >
                    <button 
                        onclick="removeReferenceImage(${image.id})"
                        class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full flex items-center justify-center hover:bg-red-600 transition opacity-0 group-hover:opacity-100 text-xs"
                        title="åˆ é™¤å›¾ç‰‡"
                    >
                        Ã—
                        </button>
                `;
                container.appendChild(imageItem);
            });
        }

        // ç§»é™¤æŒ‡å®šå‚è€ƒå›¾ç‰‡
        function removeReferenceImage(imageId) {
            referenceImages = referenceImages.filter(img => img.id !== imageId);
            renderReferenceImages();
            console.log('ğŸ—‘ï¸ å‚è€ƒå›¾ç‰‡å·²ç§»é™¤:', imageId);
        }

        // è°ƒè¯•æ—¥å¿—å‡½æ•°
        function debugLog(...args) {
            if (debugMode) {
                console.log(...args);
            }
        }

        // åŠ è½½è®¾ç½®ä¸­çš„æ¨¡å‹åˆ—è¡¨
        function loadSettingsModelList() {
            const container = document.getElementById('settingsModelList');
            if (!container) return;
            
            container.innerHTML = '';
            
            // æ¨èçš„5ä¸ªæ¨¡å‹ï¼ˆé»˜è®¤é€‰ä¸­çš„ï¼‰
            // 1ï¼‰Gemini 2.5 Flash Image (å…è´¹)
            // 2ï¼‰Gemini 3 Pro Image (å…è´¹)
            // 3ï¼‰Claude 3.5 (æè¿°)
            // 4ï¼‰Grok 4.1 Fast (ä»£ç )
            // 5ï¼‰Claude Sonnet 4.5 (ä»£ç )
            const defaultMainPageModels = [
                'gemini-flash',      // Gemini 2.5 Flash Image (å…è´¹)
                'gemini-pro',        // Gemini 3 Pro Image (å…è´¹)
                'claude',            // Claude 3.5 (æè¿°)
                'grok-fast',         // Grok 4.1 Fast (ä»£ç )
                'claude-sonnet-4.5'  // Claude Sonnet 4.5 (ä»£ç )
            ];
            
            // è·å–ä¿å­˜çš„é€‰ä¸­æ¨¡å‹
            const savedSelected = JSON.parse(localStorage.getItem('selected_models') || '[]');
            
            // åˆ¤æ–­æ˜¯å¦ä½¿ç”¨äº†é»˜è®¤çš„5ä¸ªæ¨èæ¨¡å‹
            const isDefaultSelection = savedSelected.length === defaultMainPageModels.length &&
                savedSelected.every(key => defaultMainPageModels.includes(key)) &&
                defaultMainPageModels.every(key => savedSelected.includes(key));
            
            // è®¾ç½®é¡µé¢æ€»æ˜¯æ˜¾ç¤ºæ‰€æœ‰æ¨¡å‹
            const modelsToShow = Object.keys(MODEL_CONFIGS).filter(key => !key.startsWith('custom-'));
            
            // è·å–æ‰€æœ‰æ¨¡å‹å¹¶æ’åºï¼ˆæŒ‰ä»·æ ¼ä»ä½åˆ°é«˜ï¼‰
            const sortedModels = modelsToShow
                .map(key => ({
                    key: key,
                    ...MODEL_CONFIGS[key]
                }))
                .sort((a, b) => a.cost - b.cost); // æŒ‰ä»·æ ¼ä»ä½åˆ°é«˜æ’åº
            
            // ç¡®å®šé»˜è®¤é€‰ä¸­çŠ¶æ€ï¼šå¦‚æœæ²¡æœ‰ä¿å­˜çš„ï¼Œæˆ–è€…ä¿å­˜çš„æ˜¯é»˜è®¤6ä¸ªï¼Œåˆ™é»˜è®¤é€‰ä¸­è¿™6ä¸ª
            const defaultSelected = savedSelected.length === 0 || isDefaultSelection
                ? defaultMainPageModels
                : savedSelected;
            
            // ç”Ÿæˆæ¨¡å‹é€‰æ‹©é¡¹
            sortedModels.forEach(model => {
            const label = document.createElement('label');
            label.className = 'flex items-center glass-dark p-3 rounded-lg cursor-pointer hover:bg-white/20 transition';
                
                // æ£€æŸ¥æ˜¯å¦å·²é€‰ä¸­
                const isChecked = defaultSelected.includes(model.key);
                
                const costDisplay = model.cost === 0 
                    ? '<span class="text-green-600 text-xs font-bold">å…è´¹ ğŸ‰</span>'
                    : `<span class="text-gray-600 text-xs">$${model.cost.toFixed(2)}</span>`;
                
                const typeDisplay = model.type === 'code' 
                    ? '<span class="text-blue-600 text-xs ml-2">ğŸ’» ä»£ç </span>'
                    : model.type === 'image'
                    ? '<span class="text-purple-600 text-xs ml-2">ğŸ–¼ï¸ å›¾ç‰‡</span>'
                    : '<span class="text-gray-600 text-xs ml-2">ğŸ“ æè¿°</span>';
                
            label.innerHTML = `
                    <input type="checkbox" id="settings-model-${model.key}" class="mr-3" ${isChecked ? 'checked' : ''}>
                <span class="text-gray-800 font-medium flex-1">${model.name}</span>
                    ${typeDisplay}
                    ${costDisplay}
                `;
                
                container.appendChild(label);
            });
        }
        
        // åŠ è½½ä¸»ç•Œé¢çš„æ¨¡å‹åˆ—è¡¨
        function loadModelSelectionList() {
            const container = document.getElementById('modelSelectionList');
            if (!container) return;
            
            container.innerHTML = '';
            
            // ä¸»é¡µé¢é»˜è®¤æ˜¾ç¤ºçš„æ¨¡å‹åˆ—è¡¨ï¼ˆæ¨èçš„5ä¸ªæ¨¡å‹ï¼‰
            const defaultMainPageModels = [
                'gemini-flash',      // Gemini 2.5 Flash Image (å…è´¹)
                'gemini-pro',        // Gemini 3 Pro Image (å…è´¹)
                'claude',            // Claude 3.5 (æè¿°)
                'grok-fast',         // Grok 4.1 Fast (ä»£ç )
                'claude-sonnet-4.5'  // Claude Sonnet 4.5 (ä»£ç )
            ];
            
            // è·å–è®¾ç½®ä¸­ä¿å­˜çš„å‹¾é€‰çŠ¶æ€
            const savedSelected = JSON.parse(localStorage.getItem('selected_models') || '[]');
            
            // åˆ¤æ–­ç”¨æˆ·æ˜¯å¦åœ¨è®¾ç½®ä¸­ä¿®æ”¹è¿‡æ¨¡å‹é€‰æ‹©
            // å¦‚æœä¿å­˜çš„é€‰æ‹©ä¸é»˜è®¤5ä¸ªå®Œå…¨ç›¸åŒï¼Œè¯´æ˜ç”¨æˆ·æ²¡æœ‰ä¿®æ”¹è¿‡
            const isDefaultSelection = savedSelected.length === defaultMainPageModels.length &&
                savedSelected.every(key => defaultMainPageModels.includes(key)) &&
                defaultMainPageModels.every(key => savedSelected.includes(key));
            
            // ç¡®å®šè¦æ˜¾ç¤ºçš„æ¨¡å‹åˆ—è¡¨
            const availableModels = (savedSelected.length > 0 && !isDefaultSelection)
                ? savedSelected.filter(key => MODEL_CONFIGS[key]) // ç”¨æˆ·ä¿®æ”¹è¿‡ï¼Œæ˜¾ç¤ºè®¾ç½®ä¸­é€‰ä¸­çš„æ¨¡å‹
                : defaultMainPageModels.filter(key => MODEL_CONFIGS[key]); // ç”¨æˆ·æœªä¿®æ”¹ï¼Œæ˜¾ç¤ºæ¨èçš„5ä¸ªæ¨¡å‹
            
            if (availableModels.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-sm p-3">è¯·åœ¨è®¾ç½®ä¸­é€‰æ‹©è‡³å°‘ä¸€ä¸ªæ¨¡å‹</div>';
                return;
            }
            
            // è·å–ä¸Šæ¬¡ç”Ÿæˆæ—¶çš„é€‰æ‹©ï¼ˆå¦‚æœæœ‰ï¼‰
            const lastGenerationModels = JSON.parse(localStorage.getItem('last_generation_models') || '[]');
            
            // è·å–å¯ç”¨æ¨¡å‹å¹¶æ’åºï¼ˆæŒ‰ä»·æ ¼ä»ä½åˆ°é«˜ï¼‰
            const sortedModels = availableModels
                .map(key => ({
                    key: key,
                    ...MODEL_CONFIGS[key]
                }))
                .sort((a, b) => a.cost - b.cost);
            
            // ç¡®å®šé»˜è®¤å‹¾é€‰çŠ¶æ€
            let defaultChecked = [];
            
            if (savedSelected.length > 0 && !isDefaultSelection) {
                // ç”¨æˆ·åœ¨è®¾ç½®ä¸­ä¿®æ”¹è¿‡ï¼šé»˜è®¤å…¨éƒ¨å‹¾é€‰è®¾ç½®ä¸­é€‰ä¸­çš„æ¨¡å‹
                defaultChecked = availableModels;
            } else {
                // ç”¨æˆ·æ²¡æœ‰ä¿®æ”¹è¿‡ï¼šé»˜è®¤åªå‹¾é€‰å…è´¹æ¨¡å‹ï¼Œä½†å¦‚æœæœ‰ä¸Šæ¬¡ç”Ÿæˆä½¿ç”¨çš„æ¨¡å‹ï¼Œä¼˜å…ˆä½¿ç”¨ä¸Šæ¬¡çš„
            if (lastGenerationModels.length > 0) {
                // æ£€æŸ¥ä¸Šæ¬¡é€‰æ‹©çš„æ¨¡å‹æ˜¯å¦éƒ½åœ¨å½“å‰å¯ç”¨æ¨¡å‹ä¸­
                const validLastModels = lastGenerationModels.filter(key => availableModels.includes(key));
                    if (validLastModels.length > 0) {
                        // ä½¿ç”¨ä¸Šæ¬¡çš„é€‰æ‹©
                    defaultChecked = validLastModels;
                } else {
                        // ä¸Šæ¬¡é€‰æ‹©æ— æ•ˆï¼Œé»˜è®¤åªå‹¾é€‰å…è´¹æ¨¡å‹
                    defaultChecked = availableModels.filter(key => MODEL_CONFIGS[key] && MODEL_CONFIGS[key].cost === 0);
                }
            } else {
                    // æ²¡æœ‰ä¸Šæ¬¡é€‰æ‹©ï¼Œé»˜è®¤åªå‹¾é€‰å…è´¹æ¨¡å‹
                defaultChecked = availableModels.filter(key => MODEL_CONFIGS[key] && MODEL_CONFIGS[key].cost === 0);
                }
            }
            
            // ç”Ÿæˆæ¨¡å‹é€‰æ‹©é¡¹ï¼ˆåªæ˜¾ç¤ºå¯ç”¨æ¨¡å‹ï¼‰
            sortedModels.forEach(model => {
            const label = document.createElement('label');
            label.className = 'flex items-center glass-dark p-3 rounded-lg cursor-pointer hover:bg-white/20 transition';
                
                // é»˜è®¤å‹¾é€‰ï¼ˆå…¨éƒ¨å‹¾é€‰æˆ–ä½¿ç”¨ä¸Šæ¬¡é€‰æ‹©ï¼‰
                const isChecked = defaultChecked.includes(model.key);
                
                const costDisplay = model.cost === 0 
                    ? '<span class="text-green-600 text-xs font-bold">å…è´¹ ğŸ‰</span>'
                    : `<span class="text-gray-600 text-xs">$${model.cost.toFixed(2)}</span>`;
                
                const typeDisplay = model.type === 'code' 
                    ? '<span class="text-blue-600 text-xs ml-2">ğŸ’»</span>'
                    : model.type === 'image'
                    ? '<span class="text-purple-600 text-xs ml-2">ğŸ–¼ï¸</span>'
                    : '<span class="text-gray-600 text-xs ml-2">ğŸ“</span>';
                
            label.innerHTML = `
                    <input type="checkbox" id="model-${model.key}" class="mr-3" ${isChecked ? 'checked' : ''}>
                <span class="text-gray-800 font-medium flex-1">${model.name}</span>
                    ${typeDisplay}
                    ${costDisplay}
            `;
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬
                const checkbox = label.querySelector('input');
                checkbox.addEventListener('change', () => {
                    updateCostEstimate();
                    saveLastGenerationModels(); // ä¿å­˜å½“å‰é€‰æ‹©
                });
                
                container.appendChild(label);
            });
            
            // æ›´æ–°æˆæœ¬ä¼°ç®—
            updateCostEstimate();
        }
        
        // ä¿å­˜ä¸Šæ¬¡ç”Ÿæˆæ—¶çš„æ¨¡å‹é€‰æ‹©
        function saveLastGenerationModels() {
            const selectedModels = [];
            for (let key in MODEL_CONFIGS) {
                const checkbox = document.getElementById(`model-${key}`);
                if (checkbox && checkbox.checked) {
                    selectedModels.push(key);
                }
            }
            localStorage.setItem('last_generation_models', JSON.stringify(selectedModels));
        }
        

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = () => {
            // API Key å·²ç§»è‡³æœåŠ¡å™¨ç«¯ï¼Œå‰ç«¯æ— éœ€æ£€æŸ¥
            updateCharCount();
            loadModelSelectionList(); // åŠ è½½æ¨¡å‹åˆ—è¡¨ï¼ˆé»˜è®¤å‹¾é€‰è®¾ç½®ä¸­å·²é€‰çš„æ¨¡å‹ï¼‰

            // æ¢å¤è°ƒè¯•æ¨¡å¼è®¾ç½®
            const debugCheckbox = document.getElementById('debugMode');
            if (debugCheckbox) {
                debugCheckbox.checked = debugMode;
            }
            
            // åŒæ­¥å³ä¾§ç»“æœåŒºåŸŸé«˜åº¦ä¸å·¦ä¾§è¾“å…¥é¢æ¿
            setTimeout(() => {
                syncResultsHeight();
            }, 100);
            
            // ç›‘å¬çª—å£å¤§å°å˜åŒ–
            window.addEventListener('resize', () => {
                syncResultsHeight();
            });
        };
        
        // åŒæ­¥å³ä¾§ç»“æœåŒºåŸŸé«˜åº¦ä¸å·¦ä¾§è¾“å…¥é¢æ¿
        function syncResultsHeight() {
            const leftPanel = document.querySelector('.md\\:col-span-1 > div');
            const resultsContainer = document.getElementById('resultsContainer');
            
            if (leftPanel && resultsContainer) {
                // è·å–å·¦ä¾§é¢æ¿çš„å®é™…é«˜åº¦
                const leftHeight = leftPanel.offsetHeight;
                // è®¾ç½®å³ä¾§ç»“æœåŒºåŸŸçš„æœ€å°é«˜åº¦
                resultsContainer.style.minHeight = `${leftHeight}px`;
            }
        }


        // å­—ç¬¦è®¡æ•°
        document.getElementById('promptInput').addEventListener('input', (e) => {
            updateCharCount();
        });

        // æ”¯æŒç²˜è´´å›¾ç‰‡ï¼ˆCmd+V / Ctrl+Vï¼‰
        document.getElementById('promptInput').addEventListener('paste', async (e) => {
            const items = e.clipboardData?.items;
            if (!items) return;

            // æŸ¥æ‰¾å›¾ç‰‡ç±»å‹çš„å‰ªè´´æ¿é¡¹
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯å›¾ç‰‡ç±»å‹
                if (item.type.indexOf('image') !== -1) {
                    e.preventDefault(); // é˜»æ­¢é»˜è®¤ç²˜è´´è¡Œä¸º
                    
                    const file = item.getAsFile();
                    if (!file) continue;
                    
                    // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ 10MBï¼‰
                    if (file.size > 10 * 1024 * 1024) {
                        alert('âš ï¸ å›¾ç‰‡æ–‡ä»¶å¤§å°è¶…è¿‡ 10MB');
                        continue;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const imageId = Date.now() + Math.random();
                        const imageData = {
                            id: imageId,
                            data: event.target.result // base64 æ•°æ®
                        };
                        
                        referenceImages.push(imageData);
                        renderReferenceImages();
                        
                        console.log('âœ… å›¾ç‰‡å·²ä»å‰ªè´´æ¿ç²˜è´´:', imageId);
                        
                        // æ˜¾ç¤ºæç¤º
                        showToast('âœ… å›¾ç‰‡å·²ç²˜è´´');
                    };
                    reader.onerror = () => {
                        alert('âš ï¸ å›¾ç‰‡è¯»å–å¤±è´¥');
                    };
                    reader.readAsDataURL(file);
                }
            }
        });

        function updateCharCount() {
            const input = document.getElementById('promptInput');
            const count = input.value.length;
            const charCountElement = document.getElementById('charCount');
            const parentElement = charCountElement.parentElement;
            
            // å­—ç¬¦è®¡æ•°æ ·å¼ï¼šæ¥è¿‘é™åˆ¶æ—¶æ˜¾ç¤ºè­¦å‘Šè‰²
            if (count > 500) {
                input.value = input.value.substring(0, 500);
                charCountElement.textContent = 500;
                parentElement.className = 'absolute bottom-5 right-3 text-red-500 text-xs font-semibold';
            } else {
                charCountElement.textContent = count;
                if (count > 450) {
                    parentElement.className = 'absolute bottom-5 right-3 text-orange-500 text-xs';
                } else {
                    parentElement.className = 'absolute bottom-5 right-3 text-gray-500 text-xs';
                }
            }
        }

        // æˆæœ¬ä¼°ç®—
        function updateCostEstimate() {
            let total = 0;
            for (let key in MODEL_CONFIGS) {
                const checkbox = document.getElementById(`model-${key}`);
                if (checkbox && checkbox.checked) {
                    total += MODEL_CONFIGS[key].cost;
                }
            }
            document.getElementById('costEstimate').textContent = `$${total.toFixed(2)}`;
        }

        // ç›‘å¬æ¨¡å‹é€‰æ‹©å˜åŒ–
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            cb.addEventListener('change', updateCostEstimate);
        });

        // è®¾ç½®ç›¸å…³
        function showSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
            document.getElementById('settingsModal').classList.add('flex');
            // åŠ è½½ä¿å­˜çš„ API Key
            const savedApiKey = localStorage.getItem('openrouter_api_key') || '';
            document.getElementById('apiKeyInput').value = savedApiKey;
            loadSettingsModelList(); // åŠ è½½è®¾ç½®ä¸­çš„æ¨¡å‹åˆ—è¡¨
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
            document.getElementById('settingsModal').classList.remove('flex');
        }

        function resetToDefaultModels() {
            if (!confirm('ç¡®å®šè¦æ¢å¤é»˜è®¤æ¨¡å‹é€‰æ‹©å—ï¼Ÿè¿™å°†é‡ç½®ä¸ºæ‚¨æ¨èçš„æ¨¡å‹åˆ—è¡¨ã€‚')) {
                return;
            }
            
            // é»˜è®¤ä¸»é¡µé¢æ˜¾ç¤ºçš„æ¨¡å‹åˆ—è¡¨ï¼ˆæ¨èçš„5ä¸ªæ¨¡å‹ï¼‰
            const defaultMainPageModels = [
                'gemini-flash',      // Gemini 2.5 Flash Image (å…è´¹)
                'gemini-pro',        // Gemini 3 Pro Image (å…è´¹)
                'claude',            // Claude 3.5 (æè¿°)
                'grok-fast',         // Grok 4.1 Fast (ä»£ç )
                'claude-sonnet-4.5'  // Claude Sonnet 4.5 (ä»£ç )
            ];
            
            // ä¿å­˜é»˜è®¤é€‰æ‹©ï¼ˆä¿å­˜æ¨èçš„5ä¸ªæ¨¡å‹ï¼‰
            localStorage.setItem('selected_models', JSON.stringify(defaultMainPageModels));
            
            // æ¸…é™¤ä¸Šæ¬¡ç”Ÿæˆæ—¶çš„é€‰æ‹©
            localStorage.removeItem('last_generation_models');
            
            // æ›´æ–°è®¾ç½®é¡µé¢çš„æ¨¡å‹åˆ—è¡¨æ˜¾ç¤ºï¼ˆä¼šé»˜è®¤é€‰ä¸­è¿™6ä¸ªï¼‰
            loadSettingsModelList();
            
            // æ›´æ–°ä¸»ç•Œé¢æ˜¾ç¤ºï¼ˆä¼šæ˜¾ç¤ºè¿™5ä¸ªæ¨¡å‹ï¼Œé»˜è®¤åªå‹¾é€‰å…è´¹æ¨¡å‹ï¼‰
            loadModelSelectionList();
            
            alert('âœ… å·²æ¢å¤é»˜è®¤æ¨¡å‹é€‰æ‹©\n\nä¸»é¡µé¢å°†æ˜¾ç¤ºæ¨èçš„5ä¸ªæ¨¡å‹ï¼Œé»˜è®¤å‹¾é€‰å…è´¹æ¨¡å‹');
        }

        function saveSettings() {
            // ä¿å­˜ API Keyï¼ˆå¯é€‰ï¼‰
            const apiKeyInput = document.getElementById('apiKeyInput');
            const apiKey = apiKeyInput.value.trim();
            if (apiKey) {
                localStorage.setItem('openrouter_api_key', apiKey);
            } else {
                // å¦‚æœæ¸…ç©ºï¼Œç§»é™¤ä¿å­˜çš„ API Keyï¼Œä½¿ç”¨æœåŠ¡å™¨ç«¯å…¬ç”¨ Key
                localStorage.removeItem('openrouter_api_key');
            }

                // ä¿å­˜è°ƒè¯•æ¨¡å¼è®¾ç½®
                const debugCheckbox = document.getElementById('debugMode');
                debugMode = debugCheckbox.checked;
                localStorage.setItem('debug_mode', debugMode.toString());
                
                // ä¿å­˜é€‰ä¸­çš„æ¨¡å‹
                const selectedModels = [];
                const checkboxes = document.querySelectorAll('#settingsModelList input[type="checkbox"]:checked');
                checkboxes.forEach(cb => {
                    selectedModels.push(cb.id.replace('settings-model-', ''));
                });
                
                // éªŒè¯è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ¨¡å‹
                if (selectedModels.length === 0) {
                    alert('âš ï¸ è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ¨¡å‹');
                    return;
                }
            
                // é»˜è®¤çš„5ä¸ªæ¨¡å‹
                const defaultMainPageModels = [
                    'gemini-flash',
                    'gemini-pro',
                    'claude',
                    'grok-fast',
                    'claude-sonnet-4.5'
                ];
            
            // åˆ¤æ–­æ˜¯å¦ä¸é»˜è®¤5ä¸ªå®Œå…¨ç›¸åŒ
            const isDefaultSelection = selectedModels.length === defaultMainPageModels.length &&
                selectedModels.every(key => defaultMainPageModels.includes(key)) &&
                defaultMainPageModels.every(key => selectedModels.includes(key));
                
                localStorage.setItem('selected_models', JSON.stringify(selectedModels));
                
            // å¦‚æœç”¨æˆ·é€‰æ‹©çš„æ˜¯é»˜è®¤6ä¸ªï¼Œä¸æ¸…é™¤ä¸Šæ¬¡ç”Ÿæˆçš„é€‰æ‹©ï¼ˆä¿æŒè®°å¿†ï¼‰
            // å¦‚æœç”¨æˆ·é€‰æ‹©çš„æ˜¯å…¶ä»–æ¨¡å‹ï¼Œæ¸…é™¤ä¸Šæ¬¡ç”Ÿæˆçš„é€‰æ‹©ï¼ˆå› ä¸ºæ¨¡å‹åˆ—è¡¨å˜äº†ï¼‰
            if (!isDefaultSelection) {
                localStorage.removeItem('last_generation_models');
            }
                
            // æ›´æ–°ä¸»ç•Œé¢æ˜¾ç¤º
                loadModelSelectionList();

                closeSettings();
                alert('âœ… è®¾ç½®å·²ä¿å­˜ï¼Œä¸»ç•Œé¢å·²æ›´æ–°');
        }

        // æ¨¡æ¿ç›¸å…³
        function useTemplate(type) {
            document.getElementById('promptInput').value = TEMPLATES[type];
            updateCharCount();
        }

        // ç”Ÿæˆç›¸å…³
        async function startGeneration() {
            // API Key å·²ç§»è‡³æœåŠ¡å™¨ç«¯ï¼Œæ— éœ€éªŒè¯

            const prompt = document.getElementById('promptInput').value.trim();
            if (!prompt) {
                alert('âš ï¸ è¯·è¾“å…¥UIè®¾è®¡éœ€æ±‚');
                return;
            }

            // è·å–é€‰ä¸­çš„æ¨¡å‹
            // ä»ä¸»ç•Œé¢è·å–å½“å‰å‹¾é€‰çš„æ¨¡å‹
            const selectedModels = [];
            for (let key in MODEL_CONFIGS) {
                const checkbox = document.getElementById(`model-${key}`);
                if (checkbox && checkbox.checked) {
                    selectedModels.push(key);
                }
            }

            if (selectedModels.length === 0) {
                alert('âš ï¸ è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ¨¡å‹');
                return;
            }
            
            // ä¿å­˜å½“å‰é€‰æ‹©ï¼Œç”¨äºä¸‹æ¬¡åŠ è½½æ—¶æ¢å¤
            localStorage.setItem('last_generation_models', JSON.stringify(selectedModels));

            // ç¦ç”¨æŒ‰é’®
            const btn = document.getElementById('generateBtn');
            btn.disabled = true;
            btn.textContent = 'ğŸ”„ ç”Ÿæˆä¸­...';

            // æ¸…ç©ºç»“æœå¹¶éšè—è¿›åº¦åŒºåŸŸ
            currentResults = [];
            document.getElementById('resultsGrid').innerHTML = '';
            document.getElementById('progressSection').classList.add('hidden');

            // é‡ç½®æ€»æˆæœ¬æ˜¾ç¤º
            const totalCostDisplay = document.getElementById('totalCostDisplay');
            const totalCostValue = document.getElementById('totalCostValue');
            if (totalCostDisplay && totalCostValue) {
                totalCostDisplay.classList.add('hidden');
                totalCostValue.textContent = '$0.00';
            }

            // è·å–å¹³å°é€‰æ‹©
            const platformRadio = document.querySelector('input[name="platform"]:checked');
            const platform = platformRadio ? platformRadio.value : 'mobile';
            const platformText = platform === 'mobile' ? 'mobile app (iOS/Android)' : 'desktop web application';
            const platformTitle = platform === 'mobile' ? 'mobile app UI design' : 'desktop web UI design';

            // ä¼˜åŒ–Promptï¼ˆåŠ å…¥UIè®¾è®¡çº¦æŸï¼‰
            let platformConstraints = '';
            if (platform === 'mobile') {
                platformConstraints = `
Mobile-specific constraints (CRITICAL - must follow):
- Layout: Portrait orientation (vertical/portrait layout), single column design
- Screen ratio: 9:16 or similar mobile aspect ratio (tall and narrow)
- Navigation: Include mobile navigation elements (bottom tab bar, hamburger menu, or top navigation bar)
- Status bar: Include iOS status bar (with time, battery, signal) or Android status bar at the top
- Touch targets: Large touch-friendly buttons and interactive elements (minimum 44x44px equivalent)
- Spacing: Generous padding and margins suitable for mobile screens
- Typography: Mobile-optimized font sizes, readable on small screens
- Components: Mobile-specific UI patterns (swipe gestures, pull-to-refresh indicators, mobile cards)
- Avoid: Desktop layouts, horizontal scrolling, multi-column grids, wide desktop-style navigation`;
            } else {
                platformConstraints = `
Desktop-specific constraints (CRITICAL - must follow):
- Layout: Landscape orientation (horizontal/wide layout), multi-column design allowed
- Screen ratio: 16:9 or similar desktop aspect ratio (wide and short)
- Navigation: Include desktop navigation elements (top menu bar, sidebar navigation, breadcrumbs)
- Window controls: Include browser window controls or desktop app window frame
- Mouse interactions: Desktop-optimized hover states and clickable elements
- Spacing: Desktop-appropriate spacing, can be more compact than mobile
- Typography: Desktop-optimized font sizes, can be smaller than mobile
- Components: Desktop-specific UI patterns (dropdown menus, tooltips, right-click context menus)
- Avoid: Mobile layouts, portrait orientation, bottom navigation bars, mobile-specific gestures`;
            }

            const optimizedPrompt = `Create a clean, modern ${platformTitle}.

User requirements: ${prompt}

Design constraints:
- Style: flat design, minimalist, professional interface
- Platform: ${platformText}
- Layout: clear visual hierarchy, proper spacing
- Elements: realistic UI components (buttons, inputs, cards)
- Colors: harmonious color scheme
- Output: high-fidelity UI mockup, NOT illustration
${platformConstraints}

Avoid: 3D elements, realistic photos, cartoon style`;

            // ä¸ºæ¯ä¸ªæ¨¡å‹åˆ›å»ºå ä½ç¬¦å¡ç‰‡
            selectedModels.forEach(modelKey => {
                addResultCardPlaceholder(modelKey);
            });

            // é™åˆ¶å¹¶å‘æ•°é‡ï¼Œé¿å…429é™æµé”™è¯¯
            const MAX_CONCURRENT = 4; // æœ€å¤šåŒæ—¶4ä¸ªè¯·æ±‚
            const REQUEST_DELAY = 300; // æ¯ä¸ªè¯·æ±‚ä¹‹é—´å»¶è¿Ÿ300ms
            
            // åˆ†æ‰¹å¤„ç†è¯·æ±‚ï¼Œæ§åˆ¶å¹¶å‘æ•°é‡
            const processInBatches = async (items, batchSize, delay) => {
                const results = [];
                for (let i = 0; i < items.length; i += batchSize) {
                    const batch = items.slice(i, i + batchSize);
                    const batchPromises = batch.map(async (modelKey, index) => {
                        // æ¯ä¸ªè¯·æ±‚ä¹‹é—´æ·»åŠ å»¶è¿Ÿï¼Œé¿å…åŒæ—¶å‘èµ·
                        if (index > 0) {
                            await new Promise(resolve => setTimeout(resolve, delay));
                        }
                        return generateWithModel(modelKey, optimizedPrompt, platform);
                    });
                    const batchResults = await Promise.allSettled(batchPromises);
                    results.push(...batchResults);
                }
                return results;
            };

            try {
                // åˆ†æ‰¹å¤„ç†ï¼Œæ§åˆ¶å¹¶å‘æ•°é‡
                const results = await processInBatches(selectedModels, MAX_CONCURRENT, REQUEST_DELAY);
                
                // ä» Promise ç»“æœä¸­æå–å®é™…çš„ç»“æœæ•°æ®
                const allResults = results
                    .filter(r => r.status === 'fulfilled' && r.value)
                    .map(r => r.value);
                
                // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ï¼Œç¡®ä¿æ‰€æœ‰ç»“æœéƒ½å·²æ·»åŠ åˆ° currentResultsï¼ˆåŒ…æ‹¬æˆåŠŸå’Œå¤±è´¥çš„ï¼‰
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // åˆå¹¶ä¸¤ä¸ªç»“æœæºï¼Œç¡®ä¿æ‰€æœ‰ç»“æœéƒ½è¢«ä¿å­˜
                // åˆ›å»ºä¸€ä¸ª Map æ¥å»é‡ï¼Œä¼˜å…ˆä½¿ç”¨ currentResultsï¼ˆåŒ…å«å®Œæ•´å›¾ç‰‡æ•°æ®ï¼‰
                const resultsMap = new Map();
                
                // å…ˆæ·»åŠ  currentResultsï¼ˆä¼˜å…ˆï¼ŒåŒ…å«å®Œæ•´æ•°æ®ï¼‰
                currentResults.forEach(result => {
                    resultsMap.set(result.modelName, {
                        modelName: result.modelName,
                        imageUrl: result.imageUrl || '',
                        codeContent: result.codeContent || null,
                        cost: result.cost || 0,
                        isError: result.isError || false,
                        errorMsg: result.errorMsg || ''
                    });
                });
                
                // å†æ·»åŠ  allResults ä¸­ currentResults æ²¡æœ‰çš„ç»“æœ
                allResults.forEach(result => {
                    if (!resultsMap.has(result.modelName)) {
                        resultsMap.set(result.modelName, {
                            modelName: result.modelName,
                            imageUrl: result.imageUrl || '',
                            codeContent: result.codeContent || null,
                            cost: result.cost || 0,
                            isError: result.isError || false,
                            errorMsg: result.errorMsg || ''
                        });
                    } else {
                        // å¦‚æœ currentResults ä¸­æ²¡æœ‰ imageUrlï¼Œä½† allResults æœ‰ï¼Œåˆ™è¡¥å……
                        const existing = resultsMap.get(result.modelName);
                        if (!existing.imageUrl && result.imageUrl) {
                            existing.imageUrl = result.imageUrl;
                        }
                        if (!existing.codeContent && result.codeContent) {
                            existing.codeContent = result.codeContent;
                        }
                    }
                });
                
                // è½¬æ¢ä¸ºæ•°ç»„ï¼ŒæŒ‰ selectedModels çš„é¡ºåºæ’åº
                const resultsToSave = selectedModels.map(modelKey => {
                    const config = MODEL_CONFIGS[modelKey];
                    const modelName = config ? config.name : modelKey;
                    return resultsMap.get(modelName) || {
                        modelName: modelName,
                        imageUrl: '',
                        codeContent: null,
                        cost: config ? config.cost : 0,
                        isError: true,
                        errorMsg: 'ç»“æœæœªæ‰¾åˆ°'
                    };
                });
                
                // ä¿å­˜å†å²è®°å½•ï¼ˆæ— è®ºç»“æœæ•°é‡æ˜¯å¦å®Œå…¨åŒ¹é…ï¼Œåªè¦æœ‰ç»“æœå°±ä¿å­˜ï¼‰
                if (resultsToSave.length > 0) {
                    console.log('ğŸ“œ å‡†å¤‡ä¿å­˜å†å²è®°å½•:', {
                        prompt: prompt.substring(0, 50),
                        platform: platform,
                        selectedModelsCount: selectedModels.length,
                        resultsToSaveCount: resultsToSave.length,
                        currentResultsCount: currentResults.length,
                        collectedResultsCount: allResults.length,
                        mergedResultsCount: resultsMap.size,
                        resultsToSave: resultsToSave.map(r => ({ name: r.modelName, hasImage: !!r.imageUrl, isError: r.isError }))
                    });
                    
                    await saveGenerationHistory(prompt, platform, selectedModels, resultsToSave);
                    
                    debugLog('âœ… å†å²è®°å½•å·²ä¿å­˜ï¼Œç»“æœæ•°é‡:', resultsToSave.length);
                    console.log('âœ… å†å²è®°å½•ä¿å­˜æˆåŠŸ');
                    
                    // è¾“å‡ºå®é™…æˆæœ¬æ±‡æ€»ï¼ˆä¾¿äºæŸ¥çœ‹å’Œæ›´æ–°é…ç½®ï¼‰
                    console.log('\nğŸ’° ========== æœ¬æ¬¡ç”Ÿæˆå®é™…æˆæœ¬æ±‡æ€» ==========');
                    const costSummary = resultsToSave
                        .filter(r => !r.isError && r.cost !== null && r.cost !== undefined)
                        .map(r => ({
                            modelName: r.modelName,
                            actualCost: r.cost
                        }))
                        .sort((a, b) => b.actualCost - a.actualCost); // æŒ‰æˆæœ¬ä»é«˜åˆ°ä½æ’åº
                    
                    let totalCost = 0;
                    if (costSummary.length > 0) {
                        costSummary.forEach(item => {
                            // å•æ¨¡å‹æˆæœ¬ï¼šä¸¤ä½å°æ•°æ˜¾ç¤ºï¼Œæœ€ä½0.01ä½†åªç”¨äºå±•ç¤º
                            const displayCostPerModel = item.actualCost === 0
                                ? 0
                                : Math.max(0.01, parseFloat(item.actualCost.toFixed(2)));
                            console.log(`  ${item.modelName}: $${displayCostPerModel.toFixed(2)}`);
                            totalCost += item.actualCost || 0;
                        });
                        
                        // æ€»æˆæœ¬è®¡ç®—ï¼šåŸºäºå®é™…æ€»å’Œï¼Œå†æŒ‰è§„åˆ™æ˜¾ç¤º
                        const rawTotal = totalCost || 0;
                        const displayTotal = rawTotal === 0
                            ? 0
                            : Math.max(0.01, parseFloat(rawTotal.toFixed(2)));
                        console.log(`\n  æ€»è®¡: $${displayTotal.toFixed(2)}`);
                        console.log('==========================================\n');

                        // æ›´æ–°ç•Œé¢ä¸Šçš„æ€»æˆæœ¬æ˜¾ç¤º
                        const totalCostDisplayEl = document.getElementById('totalCostDisplay');
                        const totalCostValueEl = document.getElementById('totalCostValue');
                        if (totalCostDisplayEl && totalCostValueEl) {
                            totalCostDisplayEl.classList.remove('hidden');
                            totalCostValueEl.textContent = `$${displayTotal.toFixed(2)}`;
                        }
                    } else {
                        console.log('  ï¼ˆæ²¡æœ‰è·å–åˆ°å®é™…æˆæœ¬æ•°æ®ï¼‰');
                        console.log('==========================================\n');
                    }
                    
                    // éªŒè¯ä¿å­˜æ˜¯å¦æˆåŠŸ
                    setTimeout(() => {
                        const savedHistory = JSON.parse(localStorage.getItem('generation_history') || '[]');
                        console.log('ğŸ” éªŒè¯ä¿å­˜ç»“æœ - å†å²è®°å½•æ€»æ•°:', savedHistory.length);
                        if (savedHistory.length > 0) {
                            console.log('ğŸ” æœ€æ–°ä¸€æ¡å†å²è®°å½•:', {
                                id: savedHistory[0].id,
                                prompt: savedHistory[0].prompt.substring(0, 30),
                                resultsCount: savedHistory[0].results.length
                            });
                        }
                    }, 100);
                } else {
                    console.error('âŒ æ²¡æœ‰ç»“æœå¯ä¿å­˜åˆ°å†å²è®°å½•');
                    console.error('  - é€‰ä¸­æ¨¡å‹æ•°é‡:', selectedModels.length);
                    console.error('  - currentResults.length:', currentResults.length);
                    console.error('  - allResults.length:', allResults.length);
                    console.error('  - resultsToSave.length:', resultsToSave.length);
                    console.error('  - resultsMap.size:', resultsMap.size);
                    debugLog('âš ï¸ æ²¡æœ‰ç»“æœå¯ä¿å­˜åˆ°å†å²è®°å½•');
                }
            } catch (error) {
                console.error('ç”Ÿæˆè¿‡ç¨‹ä¸­å‡ºé”™:', error);
            } finally {
                // ç¡®ä¿æŒ‰é’®çŠ¶æ€æ€»æ˜¯æ¢å¤
            btn.disabled = false;
            btn.textContent = 'ğŸš€ å¼€å§‹ç”Ÿæˆ';
            }
        }

        async function generateWithModel(modelKey, prompt, platform = 'mobile') {
            const config = MODEL_CONFIGS[modelKey];

            try {
                let imageUrl = null;
                let codeContent = null;
                let actualCost = config.cost; // é»˜è®¤ä½¿ç”¨é…ç½®çš„æˆæœ¬
                
                if (config.type === 'image') {
                    // ç›´æ¥ç”Ÿæˆå›¾ç‰‡çš„æ¨¡å‹ï¼ˆGemini, Flux, GPT-5ï¼‰
                    const imageResult = await generateImage(config.model, prompt, platform);
                    if (typeof imageResult === 'object' && imageResult.imageUrl) {
                        imageUrl = imageResult.imageUrl;
                        actualCost = imageResult.actualCost !== null ? imageResult.actualCost : actualCost;
                    } else {
                        imageUrl = imageResult;
                    }
                } else if (config.type === 'code') {
                    // ç”Ÿæˆä»£ç çš„æ¨¡å‹
                    const codeResult = await generateCode(config, prompt, platform);
                    if (typeof codeResult === 'object' && codeResult.code) {
                        codeContent = codeResult.code;
                        actualCost = codeResult.actualCost !== null ? codeResult.actualCost : actualCost;
                    } else {
                        codeContent = codeResult;
                    }
                } else {
                    // Claudeï¼šç”Ÿæˆæè¿°åç”¨å…è´¹çš„Geminiç”Ÿæˆå›¾
                    const descResult = await generateDescription(config.model, prompt);
                    let description;
                    if (typeof descResult === 'object' && descResult.description) {
                        description = descResult.description;
                        actualCost = descResult.actualCost !== null ? descResult.actualCost : actualCost;
                    } else {
                        description = descResult;
                    }
                    
                    const imageResult = await generateImage('google/gemini-2.5-flash-image-preview', description, platform);
                    if (typeof imageResult === 'object' && imageResult.imageUrl) {
                        imageUrl = imageResult.imageUrl;
                        // ç´¯åŠ æˆæœ¬ï¼ˆæè¿° + å›¾ç‰‡ç”Ÿæˆï¼‰
                        if (imageResult.actualCost !== null) {
                            actualCost = (actualCost || 0) + imageResult.actualCost;
                        }
                    } else {
                        imageUrl = imageResult;
                    }
                }

                // æˆåŠŸï¼šæ›´æ–°ç»“æœå¡ç‰‡ï¼ˆä¼ å…¥å®é™…æˆæœ¬ï¼‰
                updateResultCard(modelKey, imageUrl, codeContent, false, '', actualCost);
                
                const result = { 
                    modelName: config.name, 
                    imageUrl: imageUrl, 
                    codeContent: codeContent,
                    cost: actualCost, // ä½¿ç”¨å®é™…æˆæœ¬
                    isError: false, 
                    errorMsg: '' 
                };
                currentResults.push(result);
                
                // è¿”å›ç»“æœï¼Œç”¨äºå†å²è®°å½•
                return result;
                
            } catch (error) {
                console.error(`${config.name} ç”Ÿæˆå¤±è´¥:`, error);
                
                // å¤±è´¥ï¼šæ›´æ–°ç»“æœå¡ç‰‡æ˜¾ç¤ºé”™è¯¯
                updateResultCard(modelKey, null, null, true, error.message);
                
                const result = { 
                    modelName: config.name, 
                    imageUrl: '', 
                    cost: config.cost, 
                    isError: true, 
                    errorMsg: error.message, 
                    codeContent: null 
                };
                currentResults.push(result);
                
                // è¿”å›ç»“æœï¼Œç”¨äºå†å²è®°å½•
                return result;
            }
        }

        /**
         * ç”Ÿæˆå›¾ç‰‡
         * @param {string} model - æ¨¡å‹ID
         * @param {string} prompt - æç¤ºè¯ï¼ˆå·²åŒ…å«å¹³å°ä¿¡æ¯ï¼‰
         * @param {string} platform - å¹³å°ç±»å‹ï¼š'mobile' æˆ– 'desktop'
         * 
         * æ³¨æ„ï¼šæ‰€æœ‰æ¨¡å‹ï¼ˆåŒ…æ‹¬è‡ªå®šä¹‰æ¨¡å‹ï¼‰éƒ½ä¼šè‡ªåŠ¨åŒ…å«å¹³å°ä¿¡æ¯
         * - å¹³å°ä¿¡æ¯ä¼šåœ¨ prompt ä¸­æ˜ç¡®æ ‡æ³¨
         * - ç¡®ä¿ç”Ÿæˆçš„UIè®¾è®¡ç¬¦åˆæ‰€é€‰å¹³å°ç‰¹æ€§
         */
        async function generateImage(model, prompt, platform = 'mobile') {
            debugLog('ğŸš€ Calling model:', model);
            debugLog('ğŸ“ Prompt:', prompt.substring(0, 100) + '...');
            debugLog('ğŸ“± Platform:', platform);

            // å‡†å¤‡å¹³å°ä¿¡æ¯
            const platformInfo = platform === 'mobile' 
                ? 'mobile app (iOS/Android)' 
                : 'desktop web application';

            // æ ¹æ®æ¨¡å‹ç±»å‹æ„å»ºä¸åŒçš„è¯·æ±‚ä½“
            // å¦‚æœæœ‰å…³å‚è€ƒå›¾ç‰‡ï¼Œä½¿ç”¨å¤šæ¨¡æ€æ ¼å¼
            let content;
            if (referenceImages.length > 0) {
                // å¤šæ¨¡æ€æ ¼å¼ï¼šæ–‡æœ¬ + å¤šå¼ å›¾ç‰‡
                content = [
                    {
                        type: 'text',
                        text: prompt
                    },
                    ...referenceImages.map(img => ({
                        type: 'image_url',
                        image_url: {
                            url: img.data
                        }
                    }))
                ];
                debugLog(`ğŸ“· åŒ…å« ${referenceImages.length} å¼ å‚è€ƒå›¾ç‰‡`);
            } else {
                // çº¯æ–‡æœ¬æ ¼å¼
                content = prompt;
            }
            
            const requestBody = {
                model: model,
                messages: [
                    {
                        role: 'user',
                        content: content
                    }
                ]
            };

            // åªå¯¹æ”¯æŒçš„æ¨¡å‹æ·»åŠ  modalities
            if (model.includes('gemini') && model.includes('image')) {
                requestBody.modalities = ["image", "text"];
                
                // å¯¹äºæ‰€æœ‰ Gemini å›¾åƒæ¨¡å‹ï¼Œç¡®ä¿å¹³å°ä¿¡æ¯åœ¨ prompt ä¸­æ˜ç¡®æ˜¾ç¤º
                // å³ä½¿ prompt ä¸­å·²æœ‰å¹³å°ä¿¡æ¯ï¼Œä¹Ÿå†æ¬¡æ˜ç¡®æ ‡æ³¨ä»¥ç¡®ä¿æ¨¡å‹ç†è§£
                const platformEmphasis = platform === 'mobile' 
                    ? `\n\nIMPORTANT: This must be a MOBILE APP UI design with portrait orientation, mobile navigation (bottom tabs or hamburger menu), status bar, and touch-friendly elements. The layout must be vertical/single-column, NOT desktop-style.`
                    : `\n\nIMPORTANT: This must be a DESKTOP WEB APPLICATION UI design with landscape orientation, desktop navigation (top menu or sidebar), and mouse-optimized elements. The layout can be multi-column, NOT mobile-style.`;
                
                if (!prompt.includes('IMPORTANT: This must be')) {
                    const newPrompt = `${prompt}${platformEmphasis}`;
                    if (referenceImages.length > 0) {
                        requestBody.messages[0].content = [
                            { type: 'text', text: newPrompt },
                            ...referenceImages.map(img => ({
                                type: 'image_url',
                                image_url: { url: img.data }
                            }))
                        ];
                    } else {
                        requestBody.messages[0].content = newPrompt;
                    }
                    debugLog('ğŸ“± Added explicit platform emphasis for Gemini model:', platform);
                }
            } else {
                // å¯¹äºå…¶ä»–æ¨¡å‹ï¼ˆåŒ…æ‹¬è‡ªå®šä¹‰æ¨¡å‹ï¼‰ï¼Œä¹Ÿç¡®ä¿å¹³å°ä¿¡æ¯æ˜ç¡®
                const platformEmphasis = platform === 'mobile' 
                    ? `\n\nIMPORTANT: This must be a MOBILE APP UI design with portrait orientation, mobile navigation, status bar, and touch-friendly elements.`
                    : `\n\nIMPORTANT: This must be a DESKTOP WEB APPLICATION UI design with landscape orientation and desktop navigation.`;
                
                // æ£€æŸ¥ prompt ä¸­æ˜¯å¦å·²æœ‰æ˜ç¡®çš„å¹³å°å¼ºè°ƒ
                const hasPlatformEmphasis = prompt.includes('IMPORTANT: This must be') || 
                                          prompt.includes('MOBILE APP UI') || 
                                          prompt.includes('DESKTOP WEB APPLICATION');
                
                if (!hasPlatformEmphasis) {
                    const newPrompt = `${prompt}${platformEmphasis}`;
                    if (referenceImages.length > 0) {
                        requestBody.messages[0].content = [
                            { type: 'text', text: newPrompt },
                            ...referenceImages.map(img => ({
                                type: 'image_url',
                                image_url: { url: img.data }
                            }))
                        ];
                    } else {
                        requestBody.messages[0].content = newPrompt;
                    }
                    debugLog('ğŸ“± Added platform emphasis for model:', model, platform);
                }
            }

            debugLog('ğŸ“¤ Request body:', JSON.stringify(requestBody, null, 2));

            const apiConfig = getApiConfig();
            const response = await fetch(apiConfig.url, {
                method: 'POST',
                headers: apiConfig.headers,
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('âŒ API Error Response:', errorText);
                let errorMessage = 'ç”Ÿæˆå¤±è´¥';
                const statusCode = response.status;
                
                try {
                    const error = JSON.parse(errorText);
                    
                    // é’ˆå¯¹ä¸åŒçŠ¶æ€ç æä¾›è¯¦ç»†çš„é”™è¯¯æç¤º
                    if (statusCode === 403) {
                        // 403 æƒé™é”™è¯¯ - æ£€æŸ¥æ˜¯å¦æ˜¯åœ°åŒºé™åˆ¶
                        errorMessage = 'å›¾ç‰‡ç”Ÿæˆå¤±è´¥: 403 - æƒé™é”™è¯¯';
                        
                        // æ£€æŸ¥ metadata.raw ä¸­çš„è¯¦ç»†ä¿¡æ¯
                        if (error.error?.metadata?.raw) {
                            try {
                                const rawError = JSON.parse(error.error.metadata.raw);
                                if (rawError.error?.code === 'unsupported_country_region_territory') {
                                    errorMessage = 'å›¾ç‰‡ç”Ÿæˆå¤±è´¥: 403 - æ‚¨æ‰€åœ¨çš„åœ°åŒº/å›½å®¶ä¸å—æ”¯æŒ\n\nåŸå› ï¼šè¯¥æ¨¡å‹æä¾›å•†ä¸æ”¯æŒæ‚¨å½“å‰æ‰€åœ¨çš„åœ°ç†ä½ç½®ã€‚\nè§£å†³æ–¹æ¡ˆï¼š\n1. ä½¿ç”¨VPNåˆ‡æ¢åˆ°æ”¯æŒçš„åœ°åŒº\n2. è”ç³»æ¨¡å‹æä¾›å•†äº†è§£æ”¯æŒçš„åœ°åŒºåˆ—è¡¨\n3. å°è¯•ä½¿ç”¨å…¶ä»–æ¨¡å‹';
                                } else if (rawError.error?.message) {
                                    errorMessage = `å›¾ç‰‡ç”Ÿæˆå¤±è´¥: 403 - ${rawError.error.message}\n\nå¯èƒ½çš„åŸå› ï¼š\n- APIå¯†é’¥æƒé™ä¸è¶³\n- åœ°åŒºé™åˆ¶\n- è´¦æˆ·è¢«é™åˆ¶è®¿é—®`;
                                }
                } catch (e) {
                                // å¦‚æœè§£æå¤±è´¥ï¼Œä½¿ç”¨åŸå§‹é”™è¯¯ä¿¡æ¯
                                if (error.error?.message) {
                                    errorMessage = `å›¾ç‰‡ç”Ÿæˆå¤±è´¥: 403 - ${error.error.message}\n\nå¯èƒ½çš„åŸå› ï¼š\n- APIå¯†é’¥æƒé™ä¸è¶³\n- åœ°åŒºé™åˆ¶\n- è´¦æˆ·è¢«é™åˆ¶è®¿é—®`;
                                }
                            }
                        } else if (error.error?.message) {
                            errorMessage = `å›¾ç‰‡ç”Ÿæˆå¤±è´¥: 403 - ${error.error.message}\n\nå¯èƒ½çš„åŸå› ï¼š\n- APIå¯†é’¥æƒé™ä¸è¶³\n- åœ°åŒºé™åˆ¶\n- è´¦æˆ·è¢«é™åˆ¶è®¿é—®`;
                        }
                    } else if (statusCode === 429) {
                        errorMessage = 'å›¾ç‰‡ç”Ÿæˆå¤±è´¥: 429 - è¯·æ±‚é¢‘ç‡è¿‡é«˜\n\nåŸå› ï¼šå…è´¹æ¨¡å‹é™æµæˆ–APIè°ƒç”¨æ¬¡æ•°è¶…é™\nè§£å†³æ–¹æ¡ˆï¼š\n1. ç¨åé‡è¯•\n2. æ·»åŠ è‡ªå·±çš„APIå¯†é’¥ä»¥è·å–æ›´é«˜é™é¢';
                    } else if (statusCode === 401) {
                        errorMessage = 'å›¾ç‰‡ç”Ÿæˆå¤±è´¥: 401 - APIå¯†é’¥æ— æ•ˆ\n\nåŸå› ï¼šæœåŠ¡å™¨ç«¯APIå¯†é’¥é…ç½®é”™è¯¯æˆ–å·²è¿‡æœŸ\nè§£å†³æ–¹æ¡ˆï¼šè¯·è”ç³»ç®¡ç†å‘˜æ£€æŸ¥æœåŠ¡å™¨é…ç½®';
                    } else {
                        errorMessage = error.error?.message || error.message || `å›¾ç‰‡ç”Ÿæˆå¤±è´¥: ${statusCode}`;
                    }
                } catch (e) {
                    // JSONè§£æå¤±è´¥ï¼Œä½¿ç”¨çŠ¶æ€ç 
                    if (statusCode === 403) {
                        errorMessage = 'å›¾ç‰‡ç”Ÿæˆå¤±è´¥: 403 - æƒé™é”™è¯¯\n\nå¯èƒ½çš„åŸå› ï¼š\n- APIå¯†é’¥æƒé™ä¸è¶³\n- åœ°åŒºé™åˆ¶\n- è´¦æˆ·è¢«é™åˆ¶è®¿é—®';
                    } else if (statusCode === 429) {
                        errorMessage = 'å›¾ç‰‡ç”Ÿæˆå¤±è´¥: 429 - è¯·æ±‚é¢‘ç‡è¿‡é«˜ï¼Œè¯·ç¨åé‡è¯•';
                    } else {
                        errorMessage = `å›¾ç‰‡ç”Ÿæˆå¤±è´¥: ${statusCode} - ${errorText.substring(0, 100)}`;
                    }
                }
                
                throw new Error(errorMessage);
            }

            const data = await response.json();
            debugLog('âœ… Full API Response:', JSON.stringify(data, null, 2));

            // æ£€æŸ¥å“åº”ä¸­æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯ï¼ˆå³ä½¿çŠ¶æ€ç æ˜¯200ï¼Œä¹Ÿå¯èƒ½åŒ…å«é”™è¯¯ï¼‰
            if (data.error) {
                const errorMsg = data.error.message || data.error.code || 'Provider returned error';
                console.error('âŒ APIè¿”å›é”™è¯¯:', errorMsg);
                throw new Error(`å›¾ç‰‡ç”Ÿæˆå¤±è´¥: ${errorMsg}\n\næ¨¡å‹: ${model}\n\nå¯èƒ½çš„åŸå› ï¼š\n- æ¨¡å‹æä¾›å•†è¿”å›é”™è¯¯\n- æ¨¡å‹æš‚æ—¶ä¸å¯ç”¨\n- è¯·æ±‚å‚æ•°ä¸æ­£ç¡®\n\nè§£å†³æ–¹æ¡ˆï¼š\n1. ç¨åé‡è¯•\n2. æ£€æŸ¥æ¨¡å‹æ˜¯å¦å¯ç”¨\n3. å°è¯•ä½¿ç”¨å…¶ä»–æ¨¡å‹`);
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰ choices æˆ–æœ‰æ•ˆæ•°æ®
            if (!data.choices || !Array.isArray(data.choices) || data.choices.length === 0) {
                console.error('âŒ APIå“åº”æ ¼å¼å¼‚å¸¸:', data);
                throw new Error(`å›¾ç‰‡ç”Ÿæˆå¤±è´¥: APIå“åº”æ ¼å¼å¼‚å¸¸\n\næ¨¡å‹: ${model}\nå“åº”: ${JSON.stringify(data).substring(0, 200)}\n\nå¯èƒ½çš„åŸå› ï¼š\n- æ¨¡å‹è¿”å›äº†æ„å¤–çš„å“åº”æ ¼å¼\n- æ¨¡å‹æš‚æ—¶ä¸å¯ç”¨\n\nè§£å†³æ–¹æ¡ˆï¼š\n1. ç¨åé‡è¯•\n2. å°è¯•ä½¿ç”¨å…¶ä»–æ¨¡å‹`);
            }

            // å°è¯•æ‰€æœ‰choicesï¼ˆæœ‰äº›æ¨¡å‹å¯èƒ½è¿”å›å¤šä¸ªchoicesï¼‰
            let imageUrl = null;
            if (data.choices && Array.isArray(data.choices)) {
                for (let i = 0; i < data.choices.length; i++) {
                    const choice = data.choices[i];
                    debugLog(`ğŸ” Checking choice[${i}]`);
                    
                    // æ£€æŸ¥ finish_reasonï¼Œå¦‚æœæ˜¯ error æˆ– content_filterï¼Œè¯´æ˜ç”Ÿæˆå¤±è´¥
                    if (choice.finish_reason === 'error' || choice.finish_reason === 'content_filter') {
                        const errorMsg = choice.message?.content || choice.delta?.content || 'Provider returned error';
                        console.error(`âŒ Choice[${i}] finish_reason: ${choice.finish_reason}, error: ${errorMsg}`);
                        throw new Error(`å›¾ç‰‡ç”Ÿæˆå¤±è´¥: ${errorMsg}\n\næ¨¡å‹: ${model}\nçŠ¶æ€: ${choice.finish_reason}\n\nå¯èƒ½çš„åŸå› ï¼š\n- æ¨¡å‹æä¾›å•†è¿”å›é”™è¯¯\n- å†…å®¹è¢«è¿‡æ»¤\n- æ¨¡å‹æš‚æ—¶ä¸å¯ç”¨\n\nè§£å†³æ–¹æ¡ˆï¼š\n1. ç¨åé‡è¯•\n2. ä¿®æ”¹æç¤ºè¯\n3. å°è¯•ä½¿ç”¨å…¶ä»–æ¨¡å‹`);
                    }
                    
                    // æ£€æŸ¥ message
                    if (choice.message) {
                        // æ£€æŸ¥ message ä¸­æ˜¯å¦æœ‰é”™è¯¯å†…å®¹
                        if (typeof choice.message.content === 'string' && 
                            (choice.message.content.includes('error') || 
                             choice.message.content.includes('Error') ||
                             choice.message.content.includes('Provider returned error'))) {
                            console.error(`âŒ Choice[${i}] message contains error:`, choice.message.content);
                            throw new Error(`å›¾ç‰‡ç”Ÿæˆå¤±è´¥: ${choice.message.content}\n\næ¨¡å‹: ${model}\n\nå¯èƒ½çš„åŸå› ï¼š\n- æ¨¡å‹æä¾›å•†è¿”å›é”™è¯¯\n- æ¨¡å‹æš‚æ—¶ä¸å¯ç”¨\n\nè§£å†³æ–¹æ¡ˆï¼š\n1. ç¨åé‡è¯•\n2. å°è¯•ä½¿ç”¨å…¶ä»–æ¨¡å‹`);
                        }
                        
                        debugLog('ğŸ“¦ Message keys:', Object.keys(choice.message));
                        debugLog('ğŸ“¦ Message structure:', JSON.stringify(choice.message, null, 2));
                        imageUrl = extractImageFromResponse(choice.message);
                        if (imageUrl) break;
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰ deltaï¼ˆæµå¼å“åº”ï¼‰
                    if (choice.delta) {
                        debugLog('ğŸ“¦ Delta keys:', Object.keys(choice.delta));
                        imageUrl = extractImageFromResponse(choice.delta);
                        if (imageUrl) break;
                    }
                }
            }
            
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œå°è¯•ä»ç¬¬ä¸€ä¸ªchoiceçš„messageæå–ï¼ˆå‘åå…¼å®¹ï¼‰
            if (!imageUrl) {
            const message = data.choices?.[0]?.message;
                if (message) {
                    debugLog('ğŸ“¦ Fallback: Checking first choice message');
                    debugLog('ğŸ“¦ Message keys:', Object.keys(message));
                    debugLog('ğŸ“¦ Message structure:', JSON.stringify(message, null, 2));
                    imageUrl = extractImageFromResponse(message);
                } else {
                console.error('âŒ No message in response');
                console.error('Full data:', JSON.stringify(data, null, 2));
                throw new Error('APIå“åº”æ ¼å¼é”™è¯¯ï¼šæ²¡æœ‰message');
                }
            }

            if (!imageUrl) {
                console.error('âŒ No image found in response');
                console.error('Full API response:', JSON.stringify(data, null, 2));
                // å°è¯•è·å–ç¬¬ä¸€ä¸ªmessageç”¨äºé”™è¯¯ä¿¡æ¯
                const firstMessage = data.choices?.[0]?.message || data.choices?.[0]?.delta;
                if (firstMessage) {
                    console.error('Available message fields:', Object.keys(firstMessage));
                    console.error('Full message:', JSON.stringify(firstMessage, null, 2));
                }
                throw new Error('æ¨¡å‹è¿”å›äº†æ•°æ®ï¼Œä½†æ²¡æœ‰æ‰¾åˆ°å›¾ç‰‡ã€‚è¯·æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—æŸ¥çœ‹è¯¦ç»†å“åº”ã€‚');
            }

            debugLog('âœ… Successfully extracted image');
            debugLog('Image type:', typeof imageUrl);
            debugLog('Image length:', imageUrl.length);
            debugLog('Image preview:', imageUrl.substring(0, 100));

            // ä» API å“åº”ä¸­æå–å®é™…æˆæœ¬ï¼ˆå¦‚æœæœ‰ï¼‰
            const actualCost = data.usage?.total_cost || data.usage?.cost || null;
            if (actualCost !== null) {
                console.log(`ğŸ’° [${model}] å®é™…æˆæœ¬: $${actualCost.toFixed(4)}`);
                debugLog('ğŸ’° å®é™…æˆæœ¬:', actualCost);
                return { imageUrl, actualCost };
            }

            return imageUrl;
        }

        // ä»APIå“åº”ä¸­æå–å›¾ç‰‡URLçš„ç»Ÿä¸€å‡½æ•°
        function extractImageFromResponse(message) {
            // é€’å½’æœç´¢å‡½æ•°ï¼Œç”¨äºæ·±åº¦æœç´¢æ‰€æœ‰å¯èƒ½çš„å­—æ®µ
            function deepSearch(obj, visited = new Set()) {
                if (!obj || typeof obj !== 'object' || visited.has(obj)) {
                    return null;
                }
                visited.add(obj);
                
                // å¦‚æœæ˜¯æ•°ç»„ï¼Œéå†æ¯ä¸ªå…ƒç´ 
                if (Array.isArray(obj)) {
                    for (let item of obj) {
                        const result = deepSearch(item, visited);
                        if (result) return result;
                    }
                    return null;
                }
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯base64å›¾ç‰‡æ•°æ®æˆ–URL
                if (typeof obj === 'string') {
                    // å·²ç»æ˜¯å®Œæ•´çš„ data:image URL
                    if (obj.startsWith('data:image/')) {
                        debugLog('âœ… Found base64 image (data:image)');
                        return obj;
                    }
                    // æ£€æŸ¥æ˜¯å¦æ˜¯HTTP(S) URL
                    if (obj.startsWith('http://') || obj.startsWith('https://')) {
                        debugLog('âœ… Found HTTP URL');
                        return obj;
                    }
                    // å¯¹äºå¾ˆé•¿çš„å­—ç¬¦ä¸²ï¼Œå¯èƒ½æ˜¯base64å›¾ç‰‡æ•°æ®
                    // åªåœ¨æ˜ç¡®å¯èƒ½æ˜¯å›¾ç‰‡æ•°æ®çš„æƒ…å†µä¸‹æ‰å¤„ç†ï¼ˆé¿å…è¯¯åˆ¤æ™®é€šæ–‡æœ¬ï¼‰
                    if (obj.length > 500 && /^[A-Za-z0-9+/=\s]+$/.test(obj.replace(/\s/g, ''))) {
                        debugLog('ğŸ” Found potential base64 string, length:', obj.length);
                        // å¯¹äºæ˜ç¡®æ˜¯base64æ ¼å¼çš„é•¿å­—ç¬¦ä¸²ï¼Œå°è¯•æ·»åŠ å‰ç¼€
                        const cleanBase64 = obj.replace(/\s/g, '');
                        // PNG magic number (base64ç¼–ç åæ˜¯ iVBORw0KGgo)
                        if (cleanBase64.startsWith('iVBORw0KGgo')) {
                            debugLog('âœ… Detected PNG base64');
                            return `data:image/png;base64,${cleanBase64}`;
                        }
                        // JPEG magic number (base64ç¼–ç åæ˜¯ /9j/)
                        if (cleanBase64.startsWith('/9j/')) {
                            debugLog('âœ… Detected JPEG base64');
                            return `data:image/jpeg;base64,${cleanBase64}`;
                        }
                    }
                    return null;
                }
                
                // æ£€æŸ¥å¸¸è§çš„å…³é”®å­—æ®µ
                const imageFields = ['image', 'image_url', 'url', 'data', 'b64_json', 'base64'];
                for (let field of imageFields) {
                    if (obj[field]) {
                        debugLog(`ğŸ” Found field: ${field}, type: ${typeof obj[field]}`);
                        
                        // ç‰¹æ®Šå¤„ç†ï¼šimage_url å¯èƒ½æ˜¯å¯¹è±¡ {url: "..."}
                        if (field === 'image_url' && typeof obj[field] === 'object' && !Array.isArray(obj[field])) {
                            if (obj[field].url) {
                                debugLog(`âœ… Found image_url.url`);
                                const urlValue = obj[field].url;
                                if (typeof urlValue === 'string' && (urlValue.startsWith('data:image/') || urlValue.startsWith('http'))) {
                                    return urlValue;
                                }
                            }
                        }
                        
                        // å¦‚æœå­—æ®µå€¼æ˜¯å­—ç¬¦ä¸²ï¼Œç›´æ¥æ£€æŸ¥
                        if (typeof obj[field] === 'string') {
                            if (obj[field].startsWith('data:image/')) {
                                debugLog(`âœ… Found ${field} (data:image)`);
                                return obj[field];
                            }
                            if (obj[field].startsWith('http://') || obj[field].startsWith('https://')) {
                                debugLog(`âœ… Found ${field} (HTTP URL)`);
                                return obj[field];
                            }
                            // å¯¹äº b64_json å­—æ®µï¼Œæ·»åŠ å‰ç¼€
                            if (field === 'b64_json' && obj[field].length > 100) {
                                debugLog(`âœ… Found ${field} (base64), adding prefix`);
                                return `data:image/png;base64,${obj[field]}`;
                            }
                        }
                        // é€’å½’æœç´¢
                        const result = deepSearch(obj[field], visited);
                        if (result) {
                            // å¦‚æœæ˜¯b64_jsonä¸”ç»“æœæ²¡æœ‰å‰ç¼€ï¼Œæ·»åŠ å‰ç¼€
                            if (field === 'b64_json' && typeof result === 'string' && !result.startsWith('data:') && !result.startsWith('http')) {
                                return `data:image/png;base64,${result}`;
                            }
                            return result;
                        }
                    }
                }
                
                // é€’å½’æœç´¢æ‰€æœ‰å±æ€§
                for (let key in obj) {
                    if (obj.hasOwnProperty(key) && !['reasoning', 'text', 'role'].includes(key)) {
                        const result = deepSearch(obj[key], visited);
                        if (result) return result;
                    }
                }
                
                return null;
            }
            
            // æ–¹æ³•1: æ£€æŸ¥ content æ•°ç»„ (æœ€å¸¸è§çš„æ ¼å¼)
            if (Array.isArray(message.content)) {
                debugLog('ğŸ” Checking content array, length:', message.content.length);
                for (let i = 0; i < message.content.length; i++) {
                    const item = message.content[i];
                    debugLog(`  [${i}] type:`, item.type, 'keys:', Object.keys(item));

                    // Gemini æ ¼å¼: {type: "image_url", image_url: {url: "data:image/..."}}
                    if (item.type === 'image_url') {
                        if (typeof item.image_url === 'string') {
                            debugLog('âœ… Found image_url (string)');
                            return item.image_url;
                        }
                        if (item.image_url && typeof item.image_url === 'object') {
                            if (item.image_url.url) {
                            debugLog('âœ… Found image_url.url');
                            return item.image_url.url;
                            }
                            // æ·±åº¦æœç´¢ image_url å¯¹è±¡
                            const found = deepSearch(item.image_url);
                            if (found) return found;
                        }
                    }

                    // Claude/GPT æ ¼å¼: {type: "image", source: {data: "..."}}
                    if (item.type === 'image') {
                        if (item.url) {
                            debugLog('âœ… Found item.url');
                            return item.url;
                        }
                        if (item.data) {
                            debugLog('âœ… Found item.data');
                            return item.data;
                        }
                        if (item.source && item.source.data) {
                            debugLog('âœ… Found item.source.data');
                            return item.source.data;
                        }
                        // æ·±åº¦æœç´¢æ•´ä¸ªitem
                        const found = deepSearch(item);
                        if (found) return found;
                    }
                }
            }

            // æ–¹æ³•2: content æ˜¯å­—ç¬¦ä¸²ï¼Œå¯èƒ½åŒ…å«URLæˆ–markdown
            if (typeof message.content === 'string') {
                debugLog('ğŸ” Checking string content');
                const url = extractImageUrl(message.content);
                if (url) {
                    debugLog('âœ… Extracted URL from string');
                    return url;
                }
                // æ£€æŸ¥æ˜¯å¦æ˜¯base64å­—ç¬¦ä¸²
                if (message.content.length > 100 && message.content.startsWith('iVBORw0KGgo') || message.content.startsWith('/9j/')) {
                    debugLog('âœ… Found base64 in string content');
                    const prefix = message.content.startsWith('iVBORw0KGgo') ? 'data:image/png;base64,' : 'data:image/jpeg;base64,';
                    return prefix + message.content;
                }
            }

            // æ–¹æ³•3: æ£€æŸ¥ images æ•°ç»„
            if (Array.isArray(message.images) && message.images.length > 0) {
                debugLog('ğŸ” Checking images array');
                const found = deepSearch(message.images);
                if (found) return found;
            }

            // æ–¹æ³•4: ç›´æ¥å­—æ®µ
            if (message.image) {
                debugLog('âœ… Found message.image');
                const found = deepSearch(message.image);
                if (found) return found;
                return message.image;
            }
            if (message.image_url) {
                debugLog('âœ… Found message.image_url');
                const found = deepSearch(message.image_url);
                if (found) return found;
                return message.image_url;
            }

            // æ–¹æ³•5: æ·±åº¦æœç´¢æ•´ä¸ªmessageå¯¹è±¡ï¼ˆå¤„ç†å¯èƒ½çš„åµŒå¥—ç»“æ„ï¼‰
            debugLog('ğŸ” Deep searching entire message object');
            const found = deepSearch(message);
            if (found) {
                debugLog('âœ… Found image through deep search');
                return found;
            }

            // æœªæ‰¾åˆ°
            return null;
        }

        // å›¾ç‰‡URLè§£æå™¨
        function extractImageUrl(text) {
            // æ–¹æ³•1: Markdownæ ¼å¼ ![](url)
            let match = text.match(/!\[.*?\]\((https?:\/\/\S+?\.(?:png|jpg|jpeg|webp))\)/i);
            if (match) return match[1];
            
            // æ–¹æ³•2: çº¯URL
            match = text.match(/(https?:\/\/\S+?\.(?:png|jpg|jpeg|webp))/i);
            if (match) return match[1];
            
            // æ–¹æ³•3: ä»»ä½•httpsé“¾æ¥ï¼ˆæœ€åå°è¯•ï¼‰
            match = text.match(/(https?:\/\/[^\s<>"]+)/i);
            if (match) return match[1];
            
            return null;
        }

        async function generateDescription(model, prompt) {
            const apiConfig = getApiConfig();
            const response = await fetch(apiConfig.url, {
                method: 'POST',
                headers: apiConfig.headers,
                body: JSON.stringify({
                    model: model,
                    messages: [
                        {
                            role: 'user',
                            content: `Based on this UI requirement, create a detailed description for image generation:\n\n${prompt}\n\nProvide a concise, visual description focusing on layout, colors, and UI elements.`
                        }
                    ]
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('âŒ æè¿°ç”ŸæˆAPIé”™è¯¯:', errorText);
                let errorMessage = 'æè¿°ç”Ÿæˆå¤±è´¥';
                const statusCode = response.status;
                
                try {
                    const error = JSON.parse(errorText);
                    
                    if (statusCode === 403) {
                        errorMessage = 'æè¿°ç”Ÿæˆå¤±è´¥: 403 - æƒé™é”™è¯¯';
                        if (error.error?.metadata?.raw) {
                            try {
                                const rawError = JSON.parse(error.error.metadata.raw);
                                if (rawError.error?.code === 'unsupported_country_region_territory') {
                                    errorMessage = 'æè¿°ç”Ÿæˆå¤±è´¥: 403 - æ‚¨æ‰€åœ¨çš„åœ°åŒº/å›½å®¶ä¸å—æ”¯æŒ\n\nåŸå› ï¼šè¯¥æ¨¡å‹æä¾›å•†ä¸æ”¯æŒæ‚¨å½“å‰æ‰€åœ¨çš„åœ°ç†ä½ç½®ã€‚\nè§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨VPNæˆ–å°è¯•å…¶ä»–æ¨¡å‹';
                                } else if (rawError.error?.message) {
                                    errorMessage = `æè¿°ç”Ÿæˆå¤±è´¥: 403 - ${rawError.error.message}`;
                                }
                            } catch (e) {
                                if (error.error?.message) {
                                    errorMessage = `æè¿°ç”Ÿæˆå¤±è´¥: 403 - ${error.error.message}`;
                                }
                            }
                        } else if (error.error?.message) {
                            errorMessage = `æè¿°ç”Ÿæˆå¤±è´¥: 403 - ${error.error.message}`;
                        }
                    } else if (statusCode === 429) {
                        errorMessage = 'æè¿°ç”Ÿæˆå¤±è´¥: 429 - è¯·æ±‚é¢‘ç‡è¿‡é«˜ï¼Œè¯·ç¨åé‡è¯•';
                    } else if (error.error?.message) {
                        errorMessage = `æè¿°ç”Ÿæˆå¤±è´¥: ${statusCode} - ${error.error.message}`;
                    }
                } catch (e) {
                    if (statusCode === 403) {
                        errorMessage = 'æè¿°ç”Ÿæˆå¤±è´¥: 403 - æƒé™é”™è¯¯ï¼Œå¯èƒ½æ˜¯åœ°åŒºé™åˆ¶';
                    } else {
                        errorMessage = `æè¿°ç”Ÿæˆå¤±è´¥: ${statusCode}`;
                    }
                }
                
                throw new Error(errorMessage);
            }

            const data = await response.json();
            const message = data.choices?.[0]?.message;
            
            if (!message) {
                throw new Error('APIå“åº”æ ¼å¼é”™è¯¯ï¼šæ²¡æœ‰message');
            }
            
            let description = '';
            
            // å¤„ç† content å­—æ®µ
            if (typeof message.content === 'string') {
                description = message.content;
            } else if (Array.isArray(message.content)) {
                // å¦‚æœ content æ˜¯æ•°ç»„ï¼Œæå–æ‰€æœ‰æ–‡æœ¬å†…å®¹
                description = message.content
                    .filter(item => item.type === 'text' && item.text)
                    .map(item => item.text)
                    .join('\n');
            }
            
            // å¦‚æœæè¿°ä¸ºç©ºï¼Œå°è¯•ä½¿ç”¨ reasoningï¼ˆæŸäº›æ¨¡å‹å¯èƒ½å°†æè¿°æ”¾åœ¨ reasoning ä¸­ï¼‰
            if (!description && message.reasoning) {
                description = typeof message.reasoning === 'string' 
                    ? message.reasoning 
                    : JSON.stringify(message.reasoning);
            }
            
            if (!description) {
                console.error('âŒ æ— æ³•æå–æè¿°å†…å®¹');
                console.error('Message structure:', JSON.stringify(message, null, 2));
                throw new Error('æ— æ³•ä»æ¨¡å‹å“åº”ä¸­æå–æè¿°å†…å®¹');
            }
            
            // æ¸…ç†æè¿°ï¼šç§»é™¤å¯èƒ½çš„ markdown æ ‡è®°ã€ä»£ç å—ç­‰
            description = description.trim();
            
            // å¦‚æœæè¿°å¤ªé•¿ï¼Œå°è¯•æå–æ ¸å¿ƒéƒ¨åˆ†ï¼ˆå‰2000å­—ç¬¦é€šå¸¸è¶³å¤Ÿç”¨äºå›¾åƒç”Ÿæˆï¼‰
            if (description.length > 2000) {
                console.warn('âš ï¸ æè¿°è¿‡é•¿ï¼Œæˆªå–å‰2000å­—ç¬¦ç”¨äºå›¾åƒç”Ÿæˆ');
                description = description.substring(0, 2000);
            }
            
            debugLog('ğŸ“ æå–çš„æè¿°:', description.substring(0, 200));
            
            // ä» API å“åº”ä¸­æå–å®é™…æˆæœ¬ï¼ˆOpenRouter è¿”å›åœ¨ usage ä¸­ï¼‰
            const actualCost = data.usage?.total_cost || data.usage?.cost || null;
            if (actualCost !== null) {
                console.log(`ğŸ’° [${model}] å®é™…æˆæœ¬: $${actualCost.toFixed(4)}`);
                debugLog('ğŸ’° å®é™…æˆæœ¬:', actualCost);
                return { description, actualCost };
            }
            
            return description;
        }

        /**
         * ç”Ÿæˆä»£ç 
         */
        async function generateCode(modelInput, prompt, platform = 'mobile') {
            // å…è®¸ä¼ å…¥æ¨¡å‹é…ç½®å¯¹è±¡æˆ–çº¯å­—ç¬¦ä¸²
            const modelConfig = typeof modelInput === 'object' ? modelInput : { model: modelInput };
            const model = modelConfig.model || '';
            const platformInfo = platform === 'mobile' 
                ? 'mobile app (iOS/Android)' 
                : 'desktop web application';
            
            // è¯­è¨€çº¦æŸï¼šé»˜è®¤ä½¿ç”¨ä¸­æ–‡å±•ç¤ºç•Œé¢æ–‡æ¡ˆ
            // å¦‚æœç”¨æˆ·åœ¨æç¤ºè¯ä¸­æ˜ç¡®æåˆ°è‹±æ–‡/English/æµ·å¤–ç­‰ï¼Œåˆ™ä¸å¼ºåˆ¶ä¸­æ–‡
            const lowerPrompt = (prompt || '').toLowerCase();
            const hasForeignHint = /english|è‹±æ–‡|overseas|æµ·å¤–|global|intl|international/.test(lowerPrompt);
            const chineseLanguageHint = hasForeignHint 
                ? '' 
                : '\n\né‡è¦ï¼šè¯·ä½¿ç”¨ç®€ä½“ä¸­æ–‡å±•ç¤ºç•Œé¢ä¸­çš„æ‰€æœ‰æ–‡æœ¬ï¼ˆæ ‡é¢˜ã€æŒ‰é’®ã€æ ‡ç­¾ã€å¯¼èˆªã€æç¤ºä¿¡æ¯ç­‰ï¼‰ï¼Œé™¤éæç¤ºè¯ä¸­æ˜ç¡®è¦æ±‚ä½¿ç”¨å…¶ä»–è¯­è¨€ã€‚ä¸è¦è¾“å‡ºè‹±æ–‡ UI æ–‡æœ¬ï¼ˆå“ç‰Œåå’Œä¸“æœ‰åè¯é™¤å¤–ï¼‰ã€‚';
            
            // æ„å»ºåŒ…å«å‚è€ƒå›¾ç‰‡çš„ prompt
            let codePrompt = `${prompt}${chineseLanguageHint}

è¯·ç”Ÿæˆå®Œæ•´çš„ã€å¯ç›´æ¥è¿è¡Œçš„ ${platformInfo} UI ç•Œé¢ä»£ç ã€‚

è¦æ±‚ï¼š
1. ç”Ÿæˆå®Œæ•´çš„ HTMLã€CSS å’Œ JavaScript ä»£ç 
2. ä»£ç åº”è¯¥æ˜¯ä¸€ä¸ªå®Œæ•´çš„ã€å¯ç‹¬ç«‹è¿è¡Œçš„ HTML æ–‡ä»¶
3. ä½¿ç”¨ç°ä»£ CSSï¼ˆFlexbox/Gridï¼‰å®ç°å¸ƒå±€ï¼Œä»£ç ç®€æ´é«˜æ•ˆ
4. ç¡®ä¿ä»£ç å¯ä»¥ç›´æ¥åœ¨æµè§ˆå™¨ä¸­è¿è¡Œ
5. å¦‚æœæ˜¯ç§»åŠ¨ç«¯ï¼Œä½¿ç”¨å“åº”å¼è®¾è®¡ï¼Œé€‚é…ç§»åŠ¨å±å¹•
6. å¦‚æœæ˜¯æ¡Œé¢ç«¯ï¼Œä½¿ç”¨é€‚åˆæ¡Œé¢å±å¹•çš„å¸ƒå±€
7. ä»£ç è¦åŒ…å«æ‰€æœ‰å¿…è¦çš„æ ·å¼å’Œäº¤äº’åŠŸèƒ½
8. ä½¿ç”¨å†…è”æ ·å¼æˆ– <style> æ ‡ç­¾ï¼Œç¡®ä¿ä»£ç å¯ä»¥ç‹¬ç«‹è¿è¡Œ
9. ä¼˜å…ˆä¿è¯ä»£ç è´¨é‡å’ŒåŠŸèƒ½å®Œæ•´æ€§ï¼Œé¿å…ä¸å¿…è¦çš„å†—ä½™ä»£ç 

è¯·ç›´æ¥è¾“å‡ºå®Œæ•´çš„ HTML ä»£ç ï¼Œä¸è¦åŒ…å«ä»»ä½•è§£é‡Šæ–‡å­—ã€markdown ä»£ç å—æ ‡è®°ï¼ˆå¦‚ \`\`\`html æˆ– \`\`\`ï¼‰æˆ–ä»»ä½•å…¶ä»–æ–‡æœ¬ï¼Œåªè¾“å‡ºçº¯ HTML ä»£ç ã€‚ä¿æŒä»£ç ç®€æ´ï¼Œåœ¨ä¿è¯åŠŸèƒ½çš„å‰æä¸‹å°½é‡ç²¾ç®€ã€‚`;

            // è°ƒè¯•ï¼šè¾“å‡ºå®Œæ•´çš„ promptï¼ˆå¦‚æœå¯ç”¨è°ƒè¯•æ¨¡å¼ï¼‰
            debugLog('ğŸ“ å®Œæ•´ä»£ç ç”Ÿæˆ Prompt:', codePrompt.substring(0, 500) + '...');
            if (chineseLanguageHint) {
                console.log('âœ… å·²æ·»åŠ ä¸­æ–‡è¯­è¨€çº¦æŸ');
                debugLog('âœ… å·²æ·»åŠ ä¸­æ–‡è¯­è¨€çº¦æŸ');
            } else {
                console.log('â„¹ï¸ æœªæ·»åŠ ä¸­æ–‡çº¦æŸï¼ˆæ£€æµ‹åˆ°ç”¨æˆ·è¦æ±‚ä½¿ç”¨å…¶ä»–è¯­è¨€ï¼‰');
                debugLog('â„¹ï¸ æœªæ·»åŠ ä¸­æ–‡çº¦æŸï¼ˆæ£€æµ‹åˆ°ç”¨æˆ·è¦æ±‚ä½¿ç”¨å…¶ä»–è¯­è¨€ï¼‰');
            }

            // æ„å»ºæ¶ˆæ¯å†…å®¹
            let content;
            if (referenceImages.length > 0) {
                // åŒ…å«å‚è€ƒå›¾ç‰‡
                content = [
                    {
                        type: 'text',
                        text: codePrompt
                    },
                    ...referenceImages.map(img => ({
                        type: 'image_url',
                        image_url: {
                            url: img.data
                        }
                    }))
                ];
            } else {
                content = codePrompt;
            }

            // è®¾ç½®è¶…æ—¶æ—¶é—´ï¼ˆæ ¹æ®æ¨¡å‹ç±»å‹åŠ¨æ€è°ƒæ•´ï¼‰
            const controller = new AbortController();
            const getTimeout = (model, customTimeout) => {
                if (customTimeout) return customTimeout;
                // å¯¹äºå“åº”è¾ƒæ…¢çš„æ¨¡å‹ï¼Œç»™äºˆæ›´é•¿çš„è¶…æ—¶æ—¶é—´
                if (model.includes('claude-opus')) {
                    return 150000; // Claude Opus: 150ç§’ï¼ˆéå¸¸æ…¢ï¼‰
                } else if (model.includes('claude-sonnet-4.5')) {
                    return 120000; // Claude Sonnet 4.5: 120ç§’
                } else if (model.includes('deepseek') || model.includes('qwen')) {
                    return 100000; // DeepSeek/Qwen: 100ç§’
                } else if (model.includes('gpt-4')) {
                    return 110000; // GPT-4 ç³»åˆ—ï¼š110ç§’
                } else {
                    return 90000; // é»˜è®¤ï¼š90ç§’
                }
            };
            const timeoutDuration = getTimeout(model, modelConfig.timeout);
            const timeoutId = setTimeout(() => controller.abort(), timeoutDuration);
            
            // å¸¦é‡è¯•æœºåˆ¶çš„è¯·æ±‚å‡½æ•°ï¼ˆé’ˆå¯¹429é”™è¯¯ï¼‰
            const makeRequestWithRetry = async (requestBody, maxRetries = 2) => {
                let lastError;
                
                for (let attempt = 0; attempt <= maxRetries; attempt++) {
                    try {
                        const apiConfig = getApiConfig();
                        const response = await fetch(apiConfig.url, {
                    method: 'POST',
                    headers: apiConfig.headers,
                            body: JSON.stringify(requestBody),
                    signal: controller.signal
                });
                        
                        // å¦‚æœæ˜¯429é”™è¯¯ä¸”è¿˜æœ‰é‡è¯•æ¬¡æ•°ï¼Œè¿›è¡Œé‡è¯•
                        if (response.status === 429 && attempt < maxRetries) {
                            const retryDelay = Math.min(2000 * Math.pow(2, attempt), 10000); // æŒ‡æ•°é€€é¿ï¼š2s, 4s, æœ€å¤š10s
                            debugLog(`âš ï¸ 429é™æµé”™è¯¯ï¼Œ${retryDelay}msåé‡è¯• (${attempt + 1}/${maxRetries})`);
                            await new Promise(resolve => setTimeout(resolve, retryDelay));
                            continue; // é‡è¯•
                        }
                
                clearTimeout(timeoutId);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('ä»£ç ç”ŸæˆAPIé”™è¯¯:', errorText);
                    
                    // è§£æé”™è¯¯ä¿¡æ¯ï¼Œæä¾›æ›´å‹å¥½çš„é”™è¯¯æç¤º
                    let errorMessage = `ä»£ç ç”Ÿæˆå¤±è´¥: ${response.status}`;
                    const statusCode = response.status;
                    
                    try {
                        const errorData = JSON.parse(errorText);
                        
                        // é’ˆå¯¹ä¸åŒçŠ¶æ€ç æä¾›è¯¦ç»†çš„é”™è¯¯æç¤º
                        if (statusCode === 403) {
                            // 403 æƒé™é”™è¯¯ - æ£€æŸ¥æ˜¯å¦æ˜¯åœ°åŒºé™åˆ¶
                            errorMessage = 'ä»£ç ç”Ÿæˆå¤±è´¥: 403 - æƒé™é”™è¯¯';
                            
                            // æ£€æŸ¥ metadata.raw ä¸­çš„è¯¦ç»†ä¿¡æ¯
                            if (errorData.error?.metadata?.raw) {
                                try {
                                    const rawError = JSON.parse(errorData.error.metadata.raw);
                                    if (rawError.error?.code === 'unsupported_country_region_territory') {
                                        errorMessage = 'ä»£ç ç”Ÿæˆå¤±è´¥: 403 - æ‚¨æ‰€åœ¨çš„åœ°åŒº/å›½å®¶ä¸å—æ”¯æŒ\n\nåŸå› ï¼šè¯¥æ¨¡å‹æä¾›å•†ä¸æ”¯æŒæ‚¨å½“å‰æ‰€åœ¨çš„åœ°ç†ä½ç½®ã€‚\nè§£å†³æ–¹æ¡ˆï¼š\n1. ä½¿ç”¨VPNåˆ‡æ¢åˆ°æ”¯æŒçš„åœ°åŒº\n2. è”ç³»æ¨¡å‹æä¾›å•†äº†è§£æ”¯æŒçš„åœ°åŒºåˆ—è¡¨\n3. å°è¯•ä½¿ç”¨å…¶ä»–æ¨¡å‹';
                                    } else if (rawError.error?.message) {
                                        errorMessage = `ä»£ç ç”Ÿæˆå¤±è´¥: 403 - ${rawError.error.message}\n\nå¯èƒ½çš„åŸå› ï¼š\n- APIå¯†é’¥æƒé™ä¸è¶³\n- åœ°åŒºé™åˆ¶\n- è´¦æˆ·è¢«é™åˆ¶è®¿é—®`;
                                    }
                                } catch (e) {
                                    // å¦‚æœè§£æå¤±è´¥ï¼Œä½¿ç”¨åŸå§‹é”™è¯¯ä¿¡æ¯
                                    if (errorData.error?.message) {
                                        errorMessage = `ä»£ç ç”Ÿæˆå¤±è´¥: 403 - ${errorData.error.message}\n\nå¯èƒ½çš„åŸå› ï¼š\n- APIå¯†é’¥æƒé™ä¸è¶³\n- åœ°åŒºé™åˆ¶\n- è´¦æˆ·è¢«é™åˆ¶è®¿é—®`;
                                    }
                                }
                            } else if (errorData.error?.message) {
                                errorMessage = `ä»£ç ç”Ÿæˆå¤±è´¥: 403 - ${errorData.error.message}\n\nå¯èƒ½çš„åŸå› ï¼š\n- APIå¯†é’¥æƒé™ä¸è¶³\n- åœ°åŒºé™åˆ¶\n- è´¦æˆ·è¢«é™åˆ¶è®¿é—®`;
                            }
                        } else if (statusCode === 429) {
                            errorMessage = 'ä»£ç ç”Ÿæˆå¤±è´¥: 429 - è¯·æ±‚é¢‘ç‡è¿‡é«˜\n\nåŸå› ï¼šå…è´¹æ¨¡å‹é™æµæˆ–APIè°ƒç”¨æ¬¡æ•°è¶…é™\nè§£å†³æ–¹æ¡ˆï¼š\n1. ç¨åé‡è¯•\n2. æ·»åŠ è‡ªå·±çš„APIå¯†é’¥ä»¥è·å–æ›´é«˜é™é¢';
                        } else if (statusCode === 402) {
                            errorMessage = 'ä»£ç ç”Ÿæˆå¤±è´¥: 402 - ä½™é¢ä¸è¶³\n\nåŸå› ï¼šOpenRouterè´¦æˆ·creditsä¸è¶³\nè§£å†³æ–¹æ¡ˆï¼š\n1. å‰å¾€OpenRouterå……å€¼credits\n2. å‡å°‘è¯·æ±‚çš„tokenæ•°é‡\n3. ä½¿ç”¨å…è´¹æ¨¡å‹';
                        } else if (statusCode === 401) {
                                    errorMessage = 'ä»£ç ç”Ÿæˆå¤±è´¥: 401 - APIå¯†é’¥æ— æ•ˆ\n\nåŸå› ï¼šæœåŠ¡å™¨ç«¯APIå¯†é’¥é…ç½®é”™è¯¯æˆ–å·²è¿‡æœŸ\nè§£å†³æ–¹æ¡ˆï¼šè¯·è”ç³»ç®¡ç†å‘˜æ£€æŸ¥æœåŠ¡å™¨é…ç½®';
                        } else if (statusCode === 404) {
                            errorMessage = 'ä»£ç ç”Ÿæˆå¤±è´¥: 404 - æ¨¡å‹ä¸å­˜åœ¨\n\nåŸå› ï¼šæ¨¡å‹IDé”™è¯¯æˆ–æ¨¡å‹å·²ä¸‹æ¶\nè§£å†³æ–¹æ¡ˆï¼š\n1. æ£€æŸ¥æ¨¡å‹åç§°æ˜¯å¦æ­£ç¡®\n2. æŸ¥çœ‹OpenRouteræ”¯æŒçš„æ¨¡å‹åˆ—è¡¨';
                        } else if (errorData.error?.message) {
                            errorMessage = `ä»£ç ç”Ÿæˆå¤±è´¥: ${statusCode} - ${errorData.error.message}`;
                        }
                    } catch (e) {
                        // JSONè§£æå¤±è´¥ï¼Œä½¿ç”¨çŠ¶æ€ç 
                        if (statusCode === 403) {
                            errorMessage = 'ä»£ç ç”Ÿæˆå¤±è´¥: 403 - æƒé™é”™è¯¯\n\nå¯èƒ½çš„åŸå› ï¼š\n- APIå¯†é’¥æƒé™ä¸è¶³\n- åœ°åŒºé™åˆ¶\n- è´¦æˆ·è¢«é™åˆ¶è®¿é—®';
                        } else if (statusCode === 429) {
                            errorMessage = 'ä»£ç ç”Ÿæˆå¤±è´¥: 429 - è¯·æ±‚é¢‘ç‡è¿‡é«˜ï¼Œè¯·ç¨åé‡è¯•';
                        } else {
                            errorMessage = `ä»£ç ç”Ÿæˆå¤±è´¥: ${statusCode} - ${errorText.substring(0, 100)}`;
                        }
                    }
                    
                    throw new Error(errorMessage);
                }
                        
                        // æˆåŠŸè¿”å›å“åº”
                        return response;
                    } catch (error) {
                        lastError = error;
                        // å¦‚æœæ˜¯429é”™è¯¯ä¸”è¿˜æœ‰é‡è¯•æ¬¡æ•°ï¼Œç»§ç»­é‡è¯•
                        if (error.message.includes('429') && attempt < maxRetries) {
                            continue;
                        }
                        // å…¶ä»–é”™è¯¯æˆ–é‡è¯•æ¬¡æ•°ç”¨å®Œï¼ŒæŠ›å‡ºé”™è¯¯
                        throw error;
                    }
                }
                
                // æ‰€æœ‰é‡è¯•éƒ½å¤±è´¥
                throw lastError;
            };
            
            try {
                const requestBody = {
                    model: model,
                    messages: [
                        {
                            role: 'user',
                            content: content
                        }
                    ],
                    // ä¼˜åŒ–max_tokensï¼šå‡å°‘ç”Ÿæˆé‡ä»¥åŠ å¿«å“åº”é€Ÿåº¦
                    // å¯¹äºç‰¹å®šæ¨¡å‹ï¼Œæ ¹æ®å“åº”é€Ÿåº¦è°ƒæ•´
                    max_tokens: (() => {
                        // å¢åŠ  max_tokens ä»¥ç¡®ä¿ç”Ÿæˆå®Œæ•´çš„ä»£ç ï¼ˆç‰¹åˆ«æ˜¯åŒ…å«å›¾è¡¨ã€å¤æ‚äº¤äº’çš„é¡µé¢ï¼‰
                        if (model.includes(':free')) {
                            return 6000; // å…è´¹æ¨¡å‹ï¼šå¢åŠ åˆ°6000 tokensï¼ˆçº¦4500å­—ä»£ç ï¼‰
                        } else if (model.includes('claude-opus')) {
                            return 8000; // Claude Opusï¼šå¢åŠ åˆ°8000ï¼ˆç¡®ä¿å®Œæ•´ä»£ç ï¼Œå³ä½¿å“åº”æ…¢ä¹Ÿè¦ä¿è¯å®Œæ•´æ€§ï¼‰
                        } else if (model.includes('claude-sonnet-4.5')) {
                            return 6000; // Claude Sonnet 4.5ï¼šå¢åŠ åˆ°6000 tokens
                        } else if (model.includes('gpt-4o')) {
                            return 8000; // GPT-4oï¼šæ˜ç¡®è®¾ç½®ä¸º8000 tokensï¼ˆç¡®ä¿å®Œæ•´ä»£ç ï¼‰
                        } else if (model.includes('gpt-4')) {
                            return 8000; // GPT-4 ç³»åˆ—ï¼š8000 tokensï¼ˆç¡®ä¿å®Œæ•´ä»£ç ï¼‰
                        } else if (model.includes('deepseek') || model.includes('qwen')) {
                            return 4000; // DeepSeek/Qwenï¼š4000 tokens
                        } else {
                            return 8000; // å…¶ä»–ä»˜è´¹æ¨¡å‹ï¼š8000 tokensï¼ˆç¡®ä¿å®Œæ•´é¡µé¢ï¼‰
                        }
                    })()
                };
                
                const response = await makeRequestWithRetry(requestBody);

                const data = await response.json();
                
                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('APIè¿”å›æ ¼å¼é”™è¯¯');
                }
                
                // æ£€æŸ¥æ˜¯å¦å› ä¸º max_tokens é™åˆ¶å¯¼è‡´ä»£ç è¢«æˆªæ–­
                const choice = data.choices[0];
                if (choice.finish_reason === 'length') {
                    console.warn('âš ï¸ ä»£ç ç”Ÿæˆå¯èƒ½è¢«æˆªæ–­ï¼ˆè¾¾åˆ° max_tokens é™åˆ¶ï¼‰');
                    debugLog('âš ï¸ finish_reason: length - ä»£ç å¯èƒ½ä¸å®Œæ•´');
                }
                
                let code = data.choices[0].message.content;
                
                // è®°å½•ä»£ç é•¿åº¦ï¼Œç”¨äºè¯Šæ–­
                debugLog('ğŸ“ ç”Ÿæˆçš„ä»£ç é•¿åº¦:', code.length, 'å­—ç¬¦');
                debugLog('ğŸ“ ç”Ÿæˆçš„ä»£ç  tokens ä¼°ç®—:', Math.ceil(code.length / 4), 'tokens');
                
                // æ¸…ç†/æå–ä»£ç å—ï¼Œé˜²æ­¢åœ¨ iframe ä¸­æ˜¾ç¤º ```html
                const sanitizeCode = (raw) => {
                    if (!raw) return '';
                    let cleaned = raw.trim();
                    
                    // ç§»é™¤æ‰€æœ‰ markdown ä»£ç å—æ ‡è®°ï¼ˆåŒ…æ‹¬ ```html, ```, ```html\n ç­‰ï¼‰
                    // ä¼˜å…ˆæå– markdown ä»£ç å—å†…å®¹
                    const blockMatch = cleaned.match(/```[a-zA-Z]*\s*([\s\S]*?)```/);
                    if (blockMatch && blockMatch[1]) {
                        cleaned = blockMatch[1].trim();
                    } else {
                        // å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°æ ‡å‡†ä»£ç å—ï¼Œä½†å­˜åœ¨èµ·å§‹ ```
                        if (cleaned.startsWith('```')) {
                            // ç§»é™¤å¼€å¤´çš„ ```html æˆ– ``` æ ‡è®°
                            cleaned = cleaned.replace(/^```[a-zA-Z]*\s*/,'').replace(/```$/g, '').trim();
                        }
                    }
                    
                    // é¢å¤–æ¸…ç†ï¼šç§»é™¤å¯èƒ½æ®‹ç•™çš„ "html" æ–‡æœ¬ï¼ˆå¦‚æœå‡ºç°åœ¨ä»£ç å¼€å¤´ï¼‰
                    // ä½†ä¿ç•™ä»£ç ä¸­å®é™…åŒ…å«çš„ "html" å­—ç¬¦ä¸²
                    if (cleaned.startsWith('html\n') || cleaned.startsWith('html\r\n')) {
                        cleaned = cleaned.substring(4).trim();
                    }
                    if (cleaned.startsWith('html')) {
                        // æ£€æŸ¥æ˜¯å¦æ˜¯ç‹¬ç«‹çš„ "html" å•è¯ï¼ˆåé¢è·Ÿç€æ¢è¡Œæˆ–ç©ºæ ¼ï¼‰
                        const htmlMatch = cleaned.match(/^html[\s\n\r]+/);
                        if (htmlMatch) {
                            cleaned = cleaned.substring(htmlMatch[0].length).trim();
                        }
                    }
                    
                    // ç§»é™¤ä»£ç å¼€å¤´çš„ä»»ä½•çº¯æ–‡æœ¬ "html" æ ‡è®°ï¼ˆå¦‚æœåé¢è·Ÿç€æ¢è¡Œï¼‰
                    cleaned = cleaned.replace(/^html\s*\n\s*/i, '');
                    
                    return cleaned;
                };
                
                code = sanitizeCode(code);
                
                // è°ƒè¯•ï¼šè®°å½•æ¸…ç†åçš„ä»£ç å¼€å¤´ï¼ˆç”¨äºæ’æŸ¥é—®é¢˜ï¼‰
                debugLog('ğŸ§¹ æ¸…ç†åçš„ä»£ç å¼€å¤´:', code.substring(0, 200));
                
                if (!code || code.trim().length === 0) {
                    throw new Error('ç”Ÿæˆçš„ä»£ç ä¸ºç©º');
                }
                
                // ç¡®ä¿ä»£ç åŒ…å«åŸºæœ¬çš„HTMLç»“æ„
                if (!code.includes('<html') && !code.includes('<!DOCTYPE')) {
                    // å¦‚æœæ²¡æœ‰å®Œæ•´çš„HTMLç»“æ„ï¼Œå°è¯•åŒ…è£…å®ƒ
                    if (code.includes('<body') || code.includes('<div')) {
                        code = `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generated UI</title>
</head>
${code.includes('<body') ? code : '<body>' + code + '</body>'}
</html>`;
                    } else {
                        // ä»ç„¶æ²¡æœ‰ç»“æ„æ—¶ï¼Œç®€å•åŒ…è£¹åˆ° body å†…ï¼Œé¿å… iframe ä¸­æ˜¾ç¤º ```html æ–‡æœ¬
                        code = `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generated UI</title>
</head>
<body>
${code}
</body>
</html>`;
                    }
                }
                
                // ä» API å“åº”ä¸­æå–å®é™…æˆæœ¬ï¼ˆOpenRouter è¿”å›åœ¨ usage ä¸­ï¼‰
                const actualCost = data.usage?.total_cost || data.usage?.cost || null;
                if (actualCost !== null) {
                    console.log(`ğŸ’° [${model}] å®é™…æˆæœ¬: $${actualCost.toFixed(4)}`);
                    debugLog('ğŸ’° å®é™…æˆæœ¬:', actualCost);
                    return { code, actualCost };
                }
                
                return code;
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    const timeoutSeconds = Math.round(timeoutDuration / 1000);
                    throw new Error(`ä»£ç ç”Ÿæˆå¤±è´¥: è¯·æ±‚è¶…æ—¶ï¼ˆ${timeoutSeconds}ç§’ï¼‰\n\nåŸå› ï¼šè¯·æ±‚æ—¶é—´è¿‡é•¿ï¼Œå¯èƒ½ç½‘ç»œè¾ƒæ…¢æˆ–æ¨¡å‹å“åº”æ…¢\nè§£å†³æ–¹æ¡ˆï¼š\n1. æ£€æŸ¥ç½‘ç»œè¿æ¥\n2. ç¨åé‡è¯•\n3. é€‰æ‹©å“åº”æ›´å¿«çš„æ¨¡å‹ï¼ˆå¦‚Gemini 3 Pro Imageæˆ–Claude 3.5ï¼‰\n4. ç®€åŒ–æç¤ºè¯ä»¥å‡å°‘ç”Ÿæˆæ—¶é—´\n5. å¦‚æœæ˜¯æ…¢é€Ÿæ¨¡å‹ï¼ˆå¦‚Opusã€Sonnetï¼‰ï¼Œå¯èƒ½éœ€è¦æ›´å¤šæ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…`);
                } else if (error.message && error.message.includes('Failed to fetch')) {
                    // ç½‘ç»œé”™è¯¯
                    throw new Error(`ä»£ç ç”Ÿæˆå¤±è´¥: ç½‘ç»œè¿æ¥é”™è¯¯\n\nåŸå› ï¼šæ— æ³•è¿æ¥åˆ°OpenRouter APIæœåŠ¡å™¨\nå¯èƒ½çš„åŸå› ï¼š\n- ç½‘ç»œè¿æ¥ä¸ç¨³å®š\n- é˜²ç«å¢™æˆ–ä»£ç†è®¾ç½®é—®é¢˜\n- APIæœåŠ¡å™¨æš‚æ—¶ä¸å¯ç”¨\n- æ¨¡å‹IDå¯èƒ½ä¸æ­£ç¡®ï¼ˆ${model}ï¼‰\n\nè§£å†³æ–¹æ¡ˆï¼š\n1. æ£€æŸ¥ç½‘ç»œè¿æ¥\n2. æ£€æŸ¥é˜²ç«å¢™/ä»£ç†è®¾ç½®\n3. ç¡®è®¤æ¨¡å‹IDæ˜¯å¦æ­£ç¡®\n4. ç¨åé‡è¯•\n5. å°è¯•ä½¿ç”¨å…¶ä»–æ¨¡å‹`);
                } else if (error.message && error.message.includes('ERR_HTTP2')) {
                    // HTTP/2åè®®é”™è¯¯
                    throw new Error(`ä»£ç ç”Ÿæˆå¤±è´¥: HTTPåè®®é”™è¯¯\n\nåŸå› ï¼šHTTP/2åè®®é”™è¯¯ï¼Œå¯èƒ½æ˜¯ç½‘ç»œæˆ–æœåŠ¡å™¨é—®é¢˜\nå¯èƒ½çš„åŸå› ï¼š\n- ç½‘ç»œè¿æ¥ä¸ç¨³å®š\n- æœåŠ¡å™¨æš‚æ—¶ä¸å¯ç”¨\n- æ¨¡å‹IDå¯èƒ½ä¸æ­£ç¡®ï¼ˆ${model}ï¼‰\n\nè§£å†³æ–¹æ¡ˆï¼š\n1. æ£€æŸ¥ç½‘ç»œè¿æ¥\n2. ç¡®è®¤æ¨¡å‹IDæ˜¯å¦æ­£ç¡®\n3. ç¨åé‡è¯•\n4. å°è¯•ä½¿ç”¨å…¶ä»–æ¨¡å‹`);
                } else {
                    // å…¶ä»–é”™è¯¯ï¼Œå¦‚æœå·²ç»æœ‰è¯¦ç»†é”™è¯¯ä¿¡æ¯å°±ä½¿ç”¨ï¼Œå¦åˆ™æ·»åŠ æ¨¡å‹ä¿¡æ¯
                    if (error.message && !error.message.includes('ä»£ç ç”Ÿæˆå¤±è´¥')) {
                        throw new Error(`ä»£ç ç”Ÿæˆå¤±è´¥: ${error.message}\n\næ¨¡å‹: ${model}\n\nå¦‚æœé—®é¢˜æŒç»­ï¼Œè¯·å°è¯•ï¼š\n1. æ£€æŸ¥æ¨¡å‹IDæ˜¯å¦æ­£ç¡®\n2. æ£€æŸ¥ç½‘ç»œè¿æ¥\n3. å°è¯•ä½¿ç”¨å…¶ä»–æ¨¡å‹`);
                    }
                    throw error;
                }
            }
        }

        // ç»“æœå¡ç‰‡å ä½ç¬¦ç›¸å…³
        function addResultCardPlaceholder(modelKey) {
            const config = MODEL_CONFIGS[modelKey];
            const card = document.createElement('div');
            card.id = `result-card-${modelKey}`;
            card.className = 'image-card glass-dark rounded-2xl overflow-hidden';
            
            // ç”Ÿæˆä¸­çš„å ä½ç¬¦
            const placeholderDiv = document.createElement('div');
            placeholderDiv.className = 'aspect-square bg-gray-50 flex items-center justify-center p-6';
            placeholderDiv.innerHTML = `
                <div class="text-center">
                    <div class="spinner mx-auto mb-4"></div>
                    <div class="text-gray-700 text-sm font-medium mb-1">${config.name}</div>
                    <div class="text-gray-500 text-xs">ç”Ÿæˆä¸­...</div>
                </div>
            `;
            
            const infoDiv = document.createElement('div');
            infoDiv.className = 'p-4';
            infoDiv.innerHTML = `
                <div class="flex justify-between items-center">
                    <span class="text-gray-800 font-semibold">${config.name}</span>
                    <span class="text-gray-600 text-sm">$${config.cost.toFixed(2)}</span>
                </div>
            `;
            
            card.appendChild(placeholderDiv);
            card.appendChild(infoDiv);
            document.getElementById('resultsGrid').appendChild(card);
        }

        // æ›´æ–°ç»“æœå¡ç‰‡çŠ¶æ€
        function updateResultCard(modelKey, imageUrl = null, codeContent = null, isError = false, errorMsg = '', actualCost = null) {
            const card = document.getElementById(`result-card-${modelKey}`);
            if (!card) {
                console.warn(`Card not found for model: ${modelKey}`);
                return;
            }
            
            const config = MODEL_CONFIGS[modelKey];
            // ä¼˜å…ˆä½¿ç”¨å®é™…æˆæœ¬ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é…ç½®çš„æˆæœ¬
            const displayCost = actualCost !== null ? actualCost : (config ? config.cost : 0);
            
            // æ¸…ç©ºå¡ç‰‡å†…å®¹
            card.innerHTML = '';
            
            if (isError) {
                // é”™è¯¯çŠ¶æ€ - ç»Ÿä¸€å°ºå¯¸
                const errorDiv = document.createElement('div');
                errorDiv.className = 'bg-red-50 flex items-center justify-center p-6';
                errorDiv.style.height = '500px'; // ä¸å…¶ä»–å¡ç‰‡å†…å®¹åŒºåŸŸé«˜åº¦ä¸€è‡´
                errorDiv.innerHTML = `
                    <div class="text-center">
                        <div class="text-4xl mb-2">âŒ</div>
                        <div class="text-red-600 text-sm font-medium mb-2">ç”Ÿæˆå¤±è´¥</div>
                        <div class="text-gray-600 text-xs max-h-20 overflow-y-auto">${errorMsg || 'æœªçŸ¥é”™è¯¯'}</div>
                    </div>
                `;
                
                const infoDiv = document.createElement('div');
                infoDiv.className = 'p-4';
                infoDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-800 font-semibold">${config.name}</span>
                        <span class="text-gray-600 text-sm">$${displayCost.toFixed(4)}</span>
                    </div>
                    <button class="w-full glass text-gray-800 font-medium text-sm py-2 rounded-lg hover:bg-white/30 transition">
                        ğŸ”„ é‡è¯•
                    </button>
                `;
                infoDiv.querySelector('button').onclick = () => retryModel(config.name);
                
                card.appendChild(errorDiv);
                card.appendChild(infoDiv);
            } else if (codeContent) {
                // ä»£ç å†…å®¹ - ç»Ÿä¸€å°ºå¯¸ï¼Œåªæ˜¾ç¤ºé¦–å±
                const codeContainer = document.createElement('div');
                codeContainer.className = 'bg-gray-50 flex flex-col overflow-hidden';
                codeContainer.style.height = '600px'; // ç»Ÿä¸€é«˜åº¦
                
                const previewArea = document.createElement('div');
                previewArea.className = 'flex-1 relative border-b border-gray-200 cursor-pointer hover:opacity-90 transition overflow-hidden';
                previewArea.style.minHeight = '0';
                previewArea.style.display = 'flex';
                previewArea.style.alignItems = 'center';
                previewArea.style.justifyContent = 'center';
                previewArea.title = 'ç‚¹å‡»æŸ¥çœ‹å¤§å›¾';
                
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'absolute inset-0 flex items-center justify-center bg-gray-100';
                loadingDiv.innerHTML = '<div class="spinner"></div>';
                previewArea.appendChild(loadingDiv);
                
                const iframe = document.createElement('iframe');
                iframe.className = 'border-0';
                iframe.style.opacity = '0';
                iframe.style.transition = 'opacity 0.3s';
                iframe.style.pointerEvents = 'none'; // ç¦ç”¨iframeå†…çš„äº¤äº’ï¼Œé˜²æ­¢æ»šåŠ¨
                iframe.setAttribute('scrolling', 'no');
                
                // æ ¹æ®å¹³å°è®¾ç½®iframeå°ºå¯¸ï¼ˆç§»åŠ¨ç«¯ç»Ÿä¸€å®½åº¦ï¼Œå±…ä¸­æ˜¾ç¤ºï¼‰
                const platformRadio = document.querySelector('input[name="platform"]:checked');
                const currentPlatform = platformRadio ? platformRadio.value : 'mobile';
                
                if (currentPlatform === 'mobile') {
                    iframe.style.width = '375px';
                    iframe.style.height = '500px'; // é¦–å±é«˜åº¦ï¼Œå‡å»ä¿¡æ¯åŒºåŸŸ
                    iframe.width = '375';
                    iframe.height = '500';
                } else {
                    iframe.style.width = '100%';
                    iframe.style.height = '100%';
                    iframe.style.maxWidth = '800px'; // æ¡Œé¢ç«¯é™åˆ¶æœ€å¤§å®½åº¦
                }
                
                iframe.srcdoc = codeContent;
                
                iframe.onload = () => {
                    setTimeout(() => {
                        iframe.style.opacity = '1';
                        if (previewArea.contains(loadingDiv)) {
                            previewArea.removeChild(loadingDiv);
                        }
                        
                        // ç¦ç”¨iframeå†…çš„æ»šåŠ¨
                        try {
                            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                            if (iframeDoc && iframeDoc.body) {
                                iframeDoc.body.style.overflow = 'hidden';
                                iframeDoc.body.style.height = '100%';
                            }
                            if (iframeDoc && iframeDoc.documentElement) {
                                iframeDoc.documentElement.style.overflow = 'hidden';
                                iframeDoc.documentElement.style.height = '100%';
                            }
                        } catch (e) {
                            // è·¨åŸŸé™åˆ¶ï¼Œå¿½ç•¥
                        }
                    }, 500);
                };
                
                iframe.onerror = () => {
                    if (previewArea.contains(loadingDiv)) {
                        loadingDiv.innerHTML = '<div class="text-gray-500 text-sm">åŠ è½½å¤±è´¥ï¼Œè¯·ç‚¹å‡»æŸ¥çœ‹ä»£ç </div>';
                    }
                };
                
                previewArea.appendChild(iframe);
                previewArea.onclick = (e) => {
                    e.stopPropagation();
                    const platformRadio = document.querySelector('input[name="platform"]:checked');
                    const currentPlatform = platformRadio ? platformRadio.value : 'mobile';
                    showCodePreview(codeContent, config.name, currentPlatform);
                };
                
                codeContainer.appendChild(previewArea);
                
                const infoDiv = document.createElement('div');
                infoDiv.className = 'p-3 bg-white flex-shrink-0';
                infoDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-800 font-semibold">${config.name}</span>
                        <span class="text-gray-600 text-sm">$${displayCost.toFixed(4)}</span>
                    </div>
                    <div class="flex gap-2">
                        <button class="flex-1 glass text-gray-800 font-medium text-xs py-2 rounded-lg hover:bg-white/30 transition">
                            ğŸ‘ï¸ æŸ¥çœ‹ä»£ç 
                        </button>
                        <button class="flex-1 glass text-gray-800 font-medium text-xs py-2 rounded-lg hover:bg-white/30 transition">
                            â¬‡ï¸ ä¸‹è½½å›¾ç‰‡
                        </button>
                    </div>
                `;
                
                infoDiv.querySelectorAll('button')[0].onclick = (e) => {
                    e.stopPropagation();
                    showCodeModal(codeContent, config.name);
                };
                
                infoDiv.querySelectorAll('button')[1].onclick = async (e) => {
                    e.stopPropagation();
                    const platformRadio = document.querySelector('input[name="platform"]:checked');
                    const currentPlatform = platformRadio ? platformRadio.value : 'mobile';
                    
                    // æ˜¾ç¤ºåŠ è½½æç¤º
                    showToast('ğŸ–¼ï¸ æ­£åœ¨ç”Ÿæˆå›¾ç‰‡...', 2000);
                    
                    try {
                        // å°†ä»£ç è½¬æ¢ä¸ºå›¾ç‰‡
                        const imageData = await codeToImage(codeContent, currentPlatform);
                        
                        if (imageData) {
                            // ä¸‹è½½å›¾ç‰‡
                            await downloadImage(imageData, config.name);
                            showToast('âœ… å›¾ç‰‡å·²ç”Ÿæˆå¹¶ä¸‹è½½', 2000);
                        } else {
                            // å¦‚æœç”Ÿæˆå¤±è´¥ï¼Œæ‰“å¼€å…¨å±é¢„è§ˆè®©ç”¨æˆ·æˆªå›¾
                            showCodePreview(codeContent, config.name, currentPlatform);
                            setTimeout(() => {
                                showToast('ğŸ’¡ æç¤ºï¼šè¯·åœ¨å…¨å±é¢„è§ˆä¸­æŒ‰ Cmd+Shift+4 (Mac) æˆ– Win+Shift+S (Windows) æˆªå›¾ä¿å­˜', 4000);
                            }, 500);
                        }
                    } catch (error) {
                        console.error('ç”Ÿæˆå›¾ç‰‡å¤±è´¥:', error);
                        // å¦‚æœç”Ÿæˆå¤±è´¥ï¼Œæ‰“å¼€å…¨å±é¢„è§ˆè®©ç”¨æˆ·æˆªå›¾
                        showCodePreview(codeContent, config.name, currentPlatform);
                        setTimeout(() => {
                            showToast('ğŸ’¡ æç¤ºï¼šè¯·åœ¨å…¨å±é¢„è§ˆä¸­æŒ‰ Cmd+Shift+4 (Mac) æˆ– Win+Shift+S (Windows) æˆªå›¾ä¿å­˜', 4000);
                        }, 500);
                    }
                };
                
                codeContainer.appendChild(infoDiv);
                card.appendChild(codeContainer);
            } else if (imageUrl) {
                // å›¾ç‰‡å†…å®¹ - ç»Ÿä¸€å°ºå¯¸ï¼Œç§»åŠ¨ç«¯ä¿æŒæ‰‹æœºå±å¹•æ¯”ä¾‹
                const isBase64 = imageUrl.startsWith('data:image');
                const isHttpUrl = imageUrl.startsWith('http');
                
                if (isBase64 || isHttpUrl) {
                    // ç»Ÿä¸€å°ºå¯¸ï¼šä¸ä»£ç é¢„è§ˆå¡ç‰‡é«˜åº¦ä¸€è‡´ï¼ˆ600pxæ€»é«˜åº¦ - ä¿¡æ¯åŒºåŸŸé«˜åº¦ï¼‰
                    const imgContainer = document.createElement('div');
                    imgContainer.className = 'bg-gray-100 relative';
                    imgContainer.style.height = '500px'; // ä¸ä»£ç é¢„è§ˆåŒºåŸŸé«˜åº¦ä¸€è‡´
                    imgContainer.style.width = '100%';
                    imgContainer.style.display = 'flex';
                    imgContainer.style.alignItems = 'center';
                    imgContainer.style.justifyContent = 'center';
                    
                    // è·å–å½“å‰å¹³å°ï¼Œç§»åŠ¨ç«¯æ·»åŠ paddingä¿æŒæ‰‹æœºå±å¹•æ¯”ä¾‹
                    const platformRadio = document.querySelector('input[name="platform"]:checked');
                    const currentPlatform = platformRadio ? platformRadio.value : 'mobile';
                    
                    if (currentPlatform === 'mobile') {
                        // ç§»åŠ¨ç«¯ï¼šé¡¶éƒ¨å’Œä¸¤è¾¹ç•™å‡ºç©ºé—´ï¼Œä¿æŒæ‰‹æœºå±å¹•é¦–å±æ¯”ä¾‹
                        imgContainer.style.padding = '16px 12px';
                    }
                    
                    const img = document.createElement('img');
                    img.className = 'object-contain'; // ä½¿ç”¨containä¿æŒå®Œæ•´æ˜¾ç¤ºå’ŒåŸå§‹æ¯”ä¾‹
                    img.style.maxWidth = '100%';
                    img.style.maxHeight = '100%';
                    img.style.width = 'auto';
                    img.style.height = 'auto';
                    img.alt = config.name;
                    
                    img.onload = function() {
                        console.log('âœ… å›¾ç‰‡åŠ è½½æˆåŠŸ:', config.name);
                    };
                    
                    img.onerror = function() {
                        console.error('âŒ å›¾ç‰‡åŠ è½½å¤±è´¥:', config.name);
                        imgContainer.innerHTML = `
                            <div class="w-full h-full flex flex-col items-center justify-center p-4">
                                <div class="text-4xl mb-2">âš ï¸</div>
                                <div class="text-gray-600 text-xs text-center mb-2">å›¾ç‰‡åŠ è½½å¤±è´¥</div>
                            </div>
                        `;
                    };
                    
                    img.src = imageUrl;
                    imgContainer.appendChild(img);
                    
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'p-4';
                    infoDiv.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-gray-800 font-semibold">${config.name}</span>
                            <span class="text-gray-600 text-sm">$${displayCost.toFixed(4)}</span>
                        </div>
                        <div class="flex gap-2">
                            <button class="flex-1 glass text-gray-800 font-medium text-xs py-2 rounded-lg hover:bg-white/30 transition">
                                â¬‡ï¸ ä¸‹è½½å›¾ç‰‡
                            </button>
                        </div>
                    `;
                    
                    infoDiv.querySelector('button').onclick = (e) => {
                        e.stopPropagation();
                        downloadImage(imageUrl, config.name);
                    };
                    
                    card.appendChild(imgContainer);
                    card.appendChild(infoDiv);
                    card.style.cursor = 'pointer';
                    card.onclick = () => showImageModal(imageUrl);
                }
            }
        }

        // ç»“æœç›¸å…³
        function addResultCard(modelName, imageUrl, cost, isError = false, errorMsg = '', codeContent = null) {
            currentResults.push({ modelName, imageUrl, cost, isError, errorMsg, codeContent });
            
            const card = document.createElement('div');
            card.className = 'image-card glass-dark rounded-2xl overflow-hidden';
            
            if (isError) {
                // é”™è¯¯å¡ç‰‡ - ç»Ÿä¸€å°ºå¯¸
                const errorDiv = document.createElement('div');
                errorDiv.className = 'bg-red-50 flex items-center justify-center p-6';
                errorDiv.style.height = '500px'; // ä¸å…¶ä»–å¡ç‰‡å†…å®¹åŒºåŸŸé«˜åº¦ä¸€è‡´
                errorDiv.innerHTML = `
                    <div class="text-center">
                        <div class="text-4xl mb-2">âŒ</div>
                        <div class="text-red-600 text-sm font-medium mb-2">ç”Ÿæˆå¤±è´¥</div>
                        <div class="text-gray-600 text-xs">${errorMsg}</div>
                    </div>
                `;
                
                const infoDiv = document.createElement('div');
                infoDiv.className = 'p-4';
                infoDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-800 font-semibold">${modelName}</span>
                        <span class="text-gray-600 text-sm">$${cost.toFixed(2)}</span>
                    </div>
                    <button class="w-full glass text-gray-800 font-medium text-sm py-2 rounded-lg hover:bg-white/30 transition">
                        ğŸ”„ é‡è¯•
                    </button>
                `;
                infoDiv.querySelector('button').onclick = () => retryModel(modelName);
                
                card.appendChild(errorDiv);
                card.appendChild(infoDiv);
            } else {
                console.log('ğŸ“¦ Creating result card for:', modelName);
                console.log('ğŸ“¦ ImageURL type:', typeof imageUrl);
                console.log('ğŸ“¦ ImageURL length:', imageUrl ? imageUrl.length : 0);
                console.log('ğŸ“¦ ImageURL preview:', imageUrl ? imageUrl.substring(0, 100) : 'null');
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆçš„å›¾ç‰‡æ•°æ®
                const isBase64 = imageUrl && imageUrl.startsWith('data:image');
                const isHttpUrl = imageUrl && imageUrl.startsWith('http');
                
                console.log('ğŸ“¦ isBase64:', isBase64);
                console.log('ğŸ“¦ isHttpUrl:', isHttpUrl);
                
                // å¦‚æœæ˜¯ä»£ç å†…å®¹
                if (codeContent) {
                    // ä»£ç é¢„è§ˆå¡ç‰‡ - ç»Ÿä¸€å°ºå¯¸ï¼Œåªæ˜¾ç¤ºé¦–å±
                    const codeContainer = document.createElement('div');
                    codeContainer.className = 'bg-gray-50 flex flex-col overflow-hidden';
                    codeContainer.style.height = '600px'; // ç»Ÿä¸€é«˜åº¦
                    
                    // ä»£ç é¢„è§ˆåŒºåŸŸï¼ˆä¸»è¦éƒ¨åˆ†ï¼Œå æ®æ›´å¤šç©ºé—´ï¼‰
                    const previewArea = document.createElement('div');
                    previewArea.className = 'flex-1 relative border-b border-gray-200 cursor-pointer hover:opacity-90 transition overflow-hidden';
                    previewArea.style.minHeight = '0'; // è®©flex-1æ­£å¸¸å·¥ä½œ
                    previewArea.style.display = 'flex';
                    previewArea.style.alignItems = 'center';
                    previewArea.style.justifyContent = 'center';
                    previewArea.title = 'ç‚¹å‡»æŸ¥çœ‹å¤§å›¾';
                    
                    // æ·»åŠ åŠ è½½æŒ‡ç¤ºå™¨
                    const loadingDiv = document.createElement('div');
                    loadingDiv.className = 'absolute inset-0 flex items-center justify-center bg-gray-100';
                    loadingDiv.innerHTML = '<div class="spinner"></div>';
                    previewArea.appendChild(loadingDiv);
                    
                    // ä½¿ç”¨ iframe é¢„è§ˆä»£ç 
                    const iframe = document.createElement('iframe');
                    iframe.className = 'border-0';
                    iframe.style.opacity = '0';
                    iframe.style.transition = 'opacity 0.3s';
                    iframe.style.pointerEvents = 'none'; // ç¦ç”¨iframeå†…çš„äº¤äº’ï¼Œé˜²æ­¢æ»šåŠ¨
                    iframe.setAttribute('scrolling', 'no');
                    
                    // æ ¹æ®å¹³å°è®¾ç½®iframeå°ºå¯¸ï¼ˆç§»åŠ¨ç«¯ç»Ÿä¸€å®½åº¦ï¼Œå±…ä¸­æ˜¾ç¤ºï¼‰
                    const platformRadio = document.querySelector('input[name="platform"]:checked');
                    const currentPlatform = platformRadio ? platformRadio.value : 'mobile';
                    
                    if (currentPlatform === 'mobile') {
                        iframe.style.width = '375px';
                        iframe.style.height = '500px'; // é¦–å±é«˜åº¦ï¼Œå‡å»ä¿¡æ¯åŒºåŸŸ
                        iframe.width = '375';
                        iframe.height = '500';
                    } else {
                        iframe.style.width = '100%';
                        iframe.style.height = '100%';
                        iframe.style.maxWidth = '800px'; // æ¡Œé¢ç«¯é™åˆ¶æœ€å¤§å®½åº¦
                    }
                    
                    iframe.srcdoc = codeContent;
                    
                    // iframeåŠ è½½å®Œæˆåæ˜¾ç¤º
                    iframe.onload = () => {
                        setTimeout(() => {
                            iframe.style.opacity = '1';
                            if (previewArea.contains(loadingDiv)) {
                                previewArea.removeChild(loadingDiv);
                            }
                            
                            // ç¦ç”¨iframeå†…çš„æ»šåŠ¨
                            try {
                                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                                if (iframeDoc && iframeDoc.body) {
                                    iframeDoc.body.style.overflow = 'hidden';
                                    iframeDoc.body.style.height = '100%';
                                }
                                if (iframeDoc && iframeDoc.documentElement) {
                                    iframeDoc.documentElement.style.overflow = 'hidden';
                                    iframeDoc.documentElement.style.height = '100%';
                                }
                        } catch (e) {
                            // è·¨åŸŸé™åˆ¶ï¼Œå¿½ç•¥
                        }
                        }, 500);
                    };
                    
                    // å¦‚æœåŠ è½½å¤±è´¥ï¼Œä¹Ÿç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨
                    iframe.onerror = () => {
                        if (previewArea.contains(loadingDiv)) {
                            loadingDiv.innerHTML = '<div class="text-gray-500 text-sm">åŠ è½½å¤±è´¥ï¼Œè¯·ç‚¹å‡»æŸ¥çœ‹ä»£ç </div>';
                        }
                    };
                    
                    previewArea.appendChild(iframe);
                    
                    // ç‚¹å‡»é¢„è§ˆåŒºåŸŸå¯ä»¥æŸ¥çœ‹å¤§å›¾
                    previewArea.style.cursor = 'pointer';
                    previewArea.onclick = (e) => {
                        e.stopPropagation();
                        // è·å–å½“å‰å¹³å°ä¿¡æ¯
                        const platformRadio = document.querySelector('input[name="platform"]:checked');
                        const currentPlatform = platformRadio ? platformRadio.value : 'mobile';
                        showCodePreview(codeContent, modelName, currentPlatform);
                    };
                    
                    
                    codeContainer.appendChild(previewArea);
                    
                    // ä¿¡æ¯åŒºåŸŸï¼ˆç¼©å°ï¼‰
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'p-3 bg-white flex-shrink-0';
                    infoDiv.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-gray-800 font-semibold">${modelName}</span>
                            <span class="text-gray-600 text-sm">$${cost.toFixed(2)}</span>
                        </div>
                        <div class="flex gap-2">
                            <button class="flex-1 glass text-gray-800 font-medium text-xs py-2 rounded-lg hover:bg-white/30 transition">
                                ğŸ‘ï¸ æŸ¥çœ‹ä»£ç 
                            </button>
                            <button class="flex-1 glass text-gray-800 font-medium text-xs py-2 rounded-lg hover:bg-white/30 transition">
                                â¬‡ï¸ ä¸‹è½½å›¾ç‰‡
                            </button>
                        </div>
                    `;
                    
                    // æŸ¥çœ‹ä»£ç æŒ‰é’®
                    infoDiv.querySelectorAll('button')[0].onclick = (e) => {
                        e.stopPropagation();
                        showCodeModal(codeContent, modelName);
                    };
                    
                    // ä¸‹è½½å›¾ç‰‡æŒ‰é’®ï¼ˆå°†ä»£ç è½¬æ¢ä¸ºå›¾ç‰‡å¹¶ä¸‹è½½ï¼‰
                    infoDiv.querySelectorAll('button')[1].onclick = async (e) => {
                        e.stopPropagation();
                        const platformRadio = document.querySelector('input[name="platform"]:checked');
                        const currentPlatform = platformRadio ? platformRadio.value : 'mobile';
                        
                        // æ˜¾ç¤ºåŠ è½½æç¤º
                        showToast('ğŸ–¼ï¸ æ­£åœ¨ç”Ÿæˆå›¾ç‰‡...', 2000);
                        
                        try {
                            // å°†ä»£ç è½¬æ¢ä¸ºå›¾ç‰‡
                            const imageData = await codeToImage(codeContent, currentPlatform);
                            
                            if (imageData) {
                                // ä¸‹è½½å›¾ç‰‡
                                await downloadImage(imageData, modelName);
                                showToast('âœ… å›¾ç‰‡å·²ç”Ÿæˆå¹¶ä¸‹è½½', 2000);
                            } else {
                                // å¦‚æœç”Ÿæˆå¤±è´¥ï¼Œæ‰“å¼€å…¨å±é¢„è§ˆè®©ç”¨æˆ·æˆªå›¾
                        showCodePreview(codeContent, modelName, currentPlatform);
                        setTimeout(() => {
                            showToast('ğŸ’¡ æç¤ºï¼šè¯·åœ¨å…¨å±é¢„è§ˆä¸­æŒ‰ Cmd+Shift+4 (Mac) æˆ– Win+Shift+S (Windows) æˆªå›¾ä¿å­˜', 4000);
                        }, 500);
                            }
                        } catch (error) {
                            console.error('ç”Ÿæˆå›¾ç‰‡å¤±è´¥:', error);
                            // å¦‚æœç”Ÿæˆå¤±è´¥ï¼Œæ‰“å¼€å…¨å±é¢„è§ˆè®©ç”¨æˆ·æˆªå›¾
                            showCodePreview(codeContent, modelName, currentPlatform);
                            setTimeout(() => {
                                showToast('ğŸ’¡ æç¤ºï¼šè¯·åœ¨å…¨å±é¢„è§ˆä¸­æŒ‰ Cmd+Shift+4 (Mac) æˆ– Win+Shift+S (Windows) æˆªå›¾ä¿å­˜', 4000);
                            }, 500);
                        }
                    };
                    
                    codeContainer.appendChild(infoDiv);
                    card.appendChild(codeContainer);
                    document.getElementById('resultsGrid').appendChild(card);
                    return;
                }
                
                if (isBase64 || isHttpUrl) {
                    // ä½¿ç”¨JavaScriptåˆ›å»ºå›¾ç‰‡å…ƒç´ ï¼Œé¿å…HTMLå­—ç¬¦ä¸²é—®é¢˜
                    // ç»Ÿä¸€å°ºå¯¸ï¼šä¸ä»£ç é¢„è§ˆå¡ç‰‡é«˜åº¦ä¸€è‡´ï¼ˆ600pxæ€»é«˜åº¦ - ä¿¡æ¯åŒºåŸŸé«˜åº¦ï¼‰
                    const imgContainer = document.createElement('div');
                    imgContainer.className = 'bg-gray-100 relative';
                    imgContainer.style.height = '500px'; // ä¸ä»£ç é¢„è§ˆåŒºåŸŸé«˜åº¦ä¸€è‡´
                    imgContainer.style.width = '100%';
                    imgContainer.style.display = 'flex';
                    imgContainer.style.alignItems = 'center';
                    imgContainer.style.justifyContent = 'center';
                    
                    // è·å–å½“å‰å¹³å°ï¼Œç§»åŠ¨ç«¯æ·»åŠ paddingä¿æŒæ‰‹æœºå±å¹•æ¯”ä¾‹
                    const platformRadio = document.querySelector('input[name="platform"]:checked');
                    const currentPlatform = platformRadio ? platformRadio.value : 'mobile';
                    
                    if (currentPlatform === 'mobile') {
                        // ç§»åŠ¨ç«¯ï¼šé¡¶éƒ¨å’Œä¸¤è¾¹ç•™å‡ºç©ºé—´ï¼Œä¿æŒæ‰‹æœºå±å¹•é¦–å±æ¯”ä¾‹
                        imgContainer.style.padding = '16px 12px';
                    }
                    
                    const img = document.createElement('img');
                    img.className = 'object-contain'; // ä½¿ç”¨containä¿æŒå®Œæ•´æ˜¾ç¤ºå’ŒåŸå§‹æ¯”ä¾‹
                    img.style.maxWidth = '100%';
                    img.style.maxHeight = '100%';
                    img.style.width = 'auto';
                    img.style.height = 'auto';
                    img.alt = modelName;
                    
                    // å›¾ç‰‡åŠ è½½æˆåŠŸ
                    img.onload = function() {
                        console.log('âœ… å›¾ç‰‡åŠ è½½æˆåŠŸ:', modelName);
                    };
                    
                    // å›¾ç‰‡åŠ è½½å¤±è´¥
                    img.onerror = function() {
                        console.error('âŒ å›¾ç‰‡åŠ è½½å¤±è´¥:', modelName);
                        imgContainer.innerHTML = `
                            <div class="w-full h-full flex flex-col items-center justify-center p-4">
                                <div class="text-4xl mb-2">âš ï¸</div>
                                <div class="text-gray-600 text-xs text-center mb-2">å›¾ç‰‡åŠ è½½å¤±è´¥</div>
                                <div class="text-gray-500 text-xs text-center mb-2">æ•°æ®é•¿åº¦: ${imageUrl.length}</div>
                                <button class="text-xs text-blue-600 underline" onclick="copyToClipboard('${modelName}')">
                                    å¤åˆ¶base64
                                </button>
                            </div>
                        `;
                    };
                    
                    // è®¾ç½®src - å…³é”®ï¼
                    img.src = imageUrl;
                    
                    imgContainer.appendChild(img);
                    
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'p-4';
                    infoDiv.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-gray-800 font-semibold">${modelName}</span>
                            <span class="text-gray-600 text-sm">$${cost.toFixed(2)}</span>
                        </div>
                        <div class="flex gap-2">
                            <button class="flex-1 glass text-gray-800 font-medium text-xs py-2 rounded-lg hover:bg-white/30 transition">
                                â¬‡ï¸ ä¸‹è½½å›¾ç‰‡
                            </button>
                        </div>
                    `;
                    
                    const button = infoDiv.querySelector('button');
                    button.onclick = (e) => {
                        e.stopPropagation();
                        downloadImage(imageUrl, modelName);
                    };
                    
                    card.appendChild(imgContainer);
                    card.appendChild(infoDiv);
                    
                    card.style.cursor = 'pointer';
                    card.onclick = () => showImageModal(imageUrl);
                    
                } else {
                    // ä¸æ˜¯å›¾ç‰‡æ ¼å¼
                    console.warn('âš ï¸ è¿”å›çš„ä¸æ˜¯å›¾ç‰‡æ ¼å¼');
                    const dataDiv = document.createElement('div');
                    dataDiv.className = 'aspect-square bg-blue-50 flex items-center justify-center p-6 overflow-auto';
                    dataDiv.innerHTML = `
                        <div class="text-center w-full">
                            <div class="text-4xl mb-2">ğŸ“„</div>
                            <div class="text-blue-600 text-sm font-medium mb-2">è¿”å›äº†æ•°æ®</div>
                            <div class="text-gray-600 text-xs mb-3">ä½†ä¸æ˜¯å›¾ç‰‡æ ¼å¼</div>
                            <div class="bg-white/50 p-2 rounded text-left">
                                <pre class="text-xs overflow-auto max-h-32">${imageUrl ? imageUrl.substring(0, 200) : 'æ— æ•°æ®'}</pre>
                            </div>
                        </div>
                    `;
                    
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'p-4';
                    infoDiv.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-gray-800 font-semibold">${modelName}</span>
                            <span class="text-gray-600 text-sm">$${cost.toFixed(2)}</span>
                        </div>
                        <button class="w-full glass text-gray-800 font-medium text-sm py-2 rounded-lg hover:bg-white/30 transition">
                            ğŸ” æŸ¥çœ‹å®Œæ•´æ•°æ®
                        </button>
                    `;
                    infoDiv.querySelector('button').onclick = () => showRawData(modelName);
                    
                    card.appendChild(dataDiv);
                    card.appendChild(infoDiv);
                }
            }
            
            document.getElementById('resultsGrid').appendChild(card);
        }
        
        function showRawData(modelName) {
            const result = currentResults.find(r => r.modelName === modelName);
            if (!result) {
                alert('æœªæ‰¾åˆ°æ•°æ®');
                return;
            }
            
            const data = result.imageUrl;
            const len = data ? data.length : 0;
            
            console.log('='.repeat(50));
            console.log('æ¨¡å‹:', modelName);
            console.log('æ•°æ®ç±»å‹:', typeof data);
            console.log('æ•°æ®é•¿åº¦:', len);
            console.log('å®Œæ•´æ•°æ®:', data);
            console.log('='.repeat(50));
            
            alert(`æ¨¡å‹: ${modelName}\n\næ•°æ®é•¿åº¦: ${len} å­—ç¬¦\n\nå‰500ä¸ªå­—ç¬¦:\n${data ? data.substring(0, 500) : 'æ— æ•°æ®'}\n\nå®Œæ•´æ•°æ®å·²è¾“å‡ºåˆ°Console`);
        }
        
        function copyToClipboard(modelName) {
            const result = currentResults.find(r => r.modelName === modelName);
            if (!result || !result.imageUrl) {
                alert('æ— æ•°æ®å¯å¤åˆ¶');
                return;
            }
            
            navigator.clipboard.writeText(result.imageUrl).then(() => {
                alert('Base64å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æŸ¥çœ‹Console');
            });
        }

        function retryModel(modelName) {
            // æ‰¾åˆ°å¯¹åº”çš„æ¨¡å‹key
            const modelKey = Object.keys(MODEL_CONFIGS).find(
                key => MODEL_CONFIGS[key].name === modelName
            );
            
            if (!modelKey) {
                alert('æ¨¡å‹æœªæ‰¾åˆ°');
                return;
            }
            
            // è·å–å½“å‰prompt
            const prompt = document.getElementById('promptInput').value.trim();
            if (!prompt) {
                alert('è¯·è¾“å…¥UIè®¾è®¡éœ€æ±‚');
                return;
            }

            // è·å–å¹³å°é€‰æ‹©
            const platformRadio = document.querySelector('input[name="platform"]:checked');
            const platform = platformRadio ? platformRadio.value : 'mobile';
            const platformText = platform === 'mobile' ? 'mobile app (iOS/Android)' : 'desktop web application';
            const platformTitle = platform === 'mobile' ? 'mobile app UI design' : 'desktop web UI design';

            // é‡æ–°ç”Ÿæˆ
            const optimizedPrompt = `Create a clean, modern ${platformTitle}.

User requirements: ${prompt}

Design constraints:
- Style: flat design, minimalist, professional interface
- Platform: ${platformText}
- Layout: clear visual hierarchy, proper spacing
- Elements: realistic UI components (buttons, inputs, cards)
- Colors: harmonious color scheme
- Output: high-fidelity UI mockup, NOT illustration

Avoid: 3D elements, realistic photos, cartoon style`;

            generateWithModel(modelKey, optimizedPrompt, platform);
        }

        function showImageModal(imageUrl) {
            document.getElementById('modalImage').src = imageUrl;
            document.getElementById('imageModal').classList.remove('hidden');
            document.getElementById('imageModal').classList.add('flex');
        }

        function closeImageModal() {
            document.getElementById('imageModal').classList.add('hidden');
            document.getElementById('imageModal').classList.remove('flex');
        }

        /**
         * ä¸‹è½½ä»£ç ä¸º HTML æ–‡ä»¶
         */
        function downloadCode(codeContent, modelName) {
            try {
                // æ¸…ç†æ–‡ä»¶åï¼Œç§»é™¤ç‰¹æ®Šå­—ç¬¦
                const cleanName = modelName.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '_');
                const fileName = `${cleanName}_${Date.now()}.html`;
                
                // åˆ›å»º Blob å¯¹è±¡
                const blob = new Blob([codeContent], { type: 'text/html;charset=utf-8' });
                const downloadUrl = URL.createObjectURL(blob);
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                // æ¸…ç† URL
                URL.revokeObjectURL(downloadUrl);
            } catch (error) {
                console.error('ä¸‹è½½ä»£ç å¤±è´¥:', error);
                alert('âš ï¸ ä¸‹è½½å¤±è´¥ï¼Œè¯·å¤åˆ¶ä»£ç åæ‰‹åŠ¨ä¿å­˜');
            }
        }

        /**
         * ä¸‹è½½å›¾ç‰‡ï¼Œå»é™¤èƒŒæ™¯å¹¶è£å‰ªåˆ°å†…å®¹è¾¹ç¼˜
         */
        async function downloadImage(url, modelName) {
            try {
                // åˆ›å»ºå›¾ç‰‡å¯¹è±¡
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                await new Promise((resolve, reject) => {
                    img.onload = resolve;
                    img.onerror = reject;
                    img.src = url;
                });
                
                // åˆ›å»º Canvas
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = img.width;
                canvas.height = img.height;
                
                // ç»˜åˆ¶å›¾ç‰‡
                ctx.drawImage(img, 0, 0);
                
                // è·å–å›¾ç‰‡æ•°æ®
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                // æ£€æµ‹å†…å®¹è¾¹ç•Œï¼ˆå»é™¤ç™½è‰²/æµ…è‰²èƒŒæ™¯ï¼‰
                let minX = canvas.width, minY = canvas.height, maxX = 0, maxY = 0;
                let hasContent = false;
                
                // éå†åƒç´ ï¼Œæ‰¾åˆ°å†…å®¹è¾¹ç•Œ
                for (let y = 0; y < canvas.height; y++) {
                    for (let x = 0; x < canvas.width; x++) {
                        const idx = (y * canvas.width + x) * 4;
                        const r = data[idx];
                        const g = data[idx + 1];
                        const b = data[idx + 2];
                        const a = data[idx + 3];
                        
                        // æ£€æµ‹éèƒŒæ™¯åƒç´ ï¼ˆä¸æ˜¯çº¯ç™½æˆ–æ¥è¿‘ç™½è‰²ï¼Œä¸”ä¸é€æ˜ï¼‰
                        // ç™½è‰²èƒŒæ™¯é€šå¸¸æ˜¯ RGB(240,240,240) ä»¥ä¸Šæˆ–æ¥è¿‘é€æ˜
                        const isBackground = (r > 240 && g > 240 && b > 240) || a < 10;
                        
                        if (!isBackground) {
                            hasContent = true;
                            minX = Math.min(minX, x);
                            minY = Math.min(minY, y);
                            maxX = Math.max(maxX, x);
                            maxY = Math.max(maxY, y);
                        }
                    }
                }
                
                // å¦‚æœæ‰¾åˆ°å†…å®¹ï¼Œè£å‰ªåˆ°è¾¹ç•Œï¼›å¦åˆ™ä½¿ç”¨åŸå›¾
                let finalCanvas = canvas;
                if (hasContent && (minX < maxX && minY < maxY)) {
                    const width = maxX - minX + 1;
                    const height = maxY - minY + 1;
                    
                    // åˆ›å»ºæ–° Canvasï¼ŒåªåŒ…å«å†…å®¹åŒºåŸŸ
                    finalCanvas = document.createElement('canvas');
                    finalCanvas.width = width;
                    finalCanvas.height = height;
                    const finalCtx = finalCanvas.getContext('2d');
                    
                    // ç»˜åˆ¶è£å‰ªåçš„å†…å®¹ï¼ˆå¸¦é€æ˜èƒŒæ™¯ï¼‰
                    finalCtx.drawImage(
                        canvas,
                        minX, minY, width, height,
                        0, 0, width, height
                    );
                } else {
                    // å¦‚æœæ²¡æœ‰æ£€æµ‹åˆ°è¾¹ç•Œï¼Œåˆ›å»ºé€æ˜èƒŒæ™¯ç‰ˆæœ¬
                    finalCanvas = document.createElement('canvas');
                    finalCanvas.width = canvas.width;
                    finalCanvas.height = canvas.height;
                    const finalCtx = finalCanvas.getContext('2d');
                    
                    // ç»˜åˆ¶åŸå›¾
                    finalCtx.drawImage(img, 0, 0);
                }
                
                // è½¬æ¢ä¸º Blob å¹¶ä¸‹è½½
                finalCanvas.toBlob((blob) => {
                    if (!blob) {
                        throw new Error('æ— æ³•åˆ›å»ºå›¾ç‰‡');
                    }
                    
                    const downloadUrl = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = `${modelName}_${Date.now()}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(downloadUrl);
                }, 'image/png');
                
            } catch (error) {
                console.error('ä¸‹è½½å¤±è´¥:', error);
                // å¦‚æœå¤„ç†å¤±è´¥ï¼Œå°è¯•ç›´æ¥ä¸‹è½½åŸå›¾
                try {
                    const response = await fetch(url);
                    const blob = await response.blob();
                    const downloadUrl = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = `${modelName}_${Date.now()}.png`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(downloadUrl);
                } catch (fallbackError) {
                alert('âš ï¸ ä¸‹è½½å¤±è´¥ï¼Œè¯·å³é”®ä¿å­˜å›¾ç‰‡');
            }
            }
        }

        /**
         * ç”Ÿæˆå›¾ç‰‡ç¼©ç•¥å›¾ï¼ˆå°å°ºå¯¸ï¼Œç”¨äºå†å²è®°å½•æ˜¾ç¤ºï¼‰
         */
        async function generateThumbnail(imageUrl, maxSize = 150) {
            return new Promise((resolve, reject) => {
                if (!imageUrl || imageUrl.startsWith('http')) {
                    // HTTP URL ç›´æ¥è¿”å›ï¼Œä¸ç”Ÿæˆç¼©ç•¥å›¾
                    resolve(imageUrl);
                    return;
                }
                
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                img.onload = () => {
                    try {
                        // è®¡ç®—ç¼©ç•¥å›¾å°ºå¯¸ï¼ˆä¿æŒå®½é«˜æ¯”ï¼‰
                        let width = img.width;
                        let height = img.height;
                        const ratio = Math.min(maxSize / width, maxSize / height);
                        width = Math.floor(width * ratio);
                        height = Math.floor(height * ratio);
                        
                        // åˆ›å»º Canvas å¹¶ç»˜åˆ¶ç¼©ç•¥å›¾
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // è½¬æ¢ä¸º base64ï¼ˆè´¨é‡é™ä½ä»¥å‡å°æ–‡ä»¶å¤§å°ï¼‰
                        const thumbnail = canvas.toDataURL('image/jpeg', 0.7);
                        resolve(thumbnail);
                    } catch (error) {
                        console.error('ç”Ÿæˆç¼©ç•¥å›¾å¤±è´¥:', error);
                        resolve(null);
                    }
                };
                
                img.onerror = () => {
                    resolve(null);
                };
                
                img.src = imageUrl;
            });
        }

        /**
         * å°†ä»£ç å†…å®¹è½¬æ¢ä¸ºå›¾ç‰‡ï¼ˆå®Œæ•´é¦–å±æˆªå›¾ï¼‰
         */
        async function codeToImage(codeContent, platform = 'mobile') {
            return new Promise((resolve, reject) => {
                try {
                    // æ ¹æ®å¹³å°è®¾ç½®å°ºå¯¸
                    let targetWidth, targetHeight;
                    if (platform === 'mobile') {
                        targetWidth = 375;
                        targetHeight = 812; // iPhoneæ ‡å‡†é«˜åº¦
                    } else {
                        targetWidth = 1920;
                        targetHeight = 1080; // æ¡Œé¢æ ‡å‡†é«˜åº¦
                    }
                    
                    // åˆ›å»ºä¸€ä¸ªéšè—çš„iframeæ¥æ¸²æŸ“ä»£ç 
                    const iframe = document.createElement('iframe');
                    iframe.style.position = 'fixed';
                    iframe.style.left = '-9999px';
                    iframe.style.top = '-9999px';
                    iframe.style.width = targetWidth + 'px';
                    iframe.style.height = targetHeight + 'px';
                    iframe.style.border = 'none';
                    iframe.style.backgroundColor = '#ffffff';
                    iframe.setAttribute('scrolling', 'no');
                    
                    // ç¡®ä¿iframeçš„å°ºå¯¸å±æ€§ä¹Ÿè®¾ç½®
                    iframe.width = targetWidth;
                    iframe.height = targetHeight;
                    
                    iframe.srcdoc = codeContent;
                    
                    document.body.appendChild(iframe);
                    
                    let isResolved = false;
                    let timeoutId;
                    
                    // æ¸…ç†å‡½æ•°
                    const cleanup = () => {
                        if (timeoutId) clearTimeout(timeoutId);
                        if (document.body.contains(iframe)) {
                            document.body.removeChild(iframe);
                        }
                    };
                    
                    // ç­‰å¾…iframeåŠ è½½å®Œæˆ
                    iframe.onload = () => {
                        // ç­‰å¾…å†…å®¹æ¸²æŸ“å’Œå›¾ç‰‡åŠ è½½
                        setTimeout(async () => {
                            try {
                                if (isResolved) return;
                                
                                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                                
                                if (!iframeDoc) {
                                    if (!isResolved) {
                                        isResolved = true;
                                        cleanup();
                                        reject(new Error('æ— æ³•è®¿é—®iframeæ–‡æ¡£'));
                                    }
                                    return;
                                }
                                
                                // ç­‰å¾…æ‰€æœ‰å›¾ç‰‡åŠ è½½å®Œæˆ
                                const images = iframeDoc.querySelectorAll('img');
                                const imagePromises = Array.from(images).map(img => {
                                    if (img.complete) return Promise.resolve();
                                    return new Promise((resolve, reject) => {
                                        img.onload = resolve;
                                        img.onerror = resolve; // å³ä½¿åŠ è½½å¤±è´¥ä¹Ÿç»§ç»­
                                        setTimeout(resolve, 5000); // å¢åŠ åˆ°5ç§’è¶…æ—¶ï¼ˆå¤æ‚é¡µé¢å›¾ç‰‡å¯èƒ½è¾ƒå¤šï¼‰
                                    });
                                });
                                
                                await Promise.all(imagePromises);
                                
                                // å†ç­‰å¾…ä¸€ä¸‹ç¡®ä¿æ¸²æŸ“å®Œæˆï¼ˆå¢åŠ ç­‰å¾…æ—¶é—´ï¼‰
                                await new Promise(resolve => setTimeout(resolve, 1000));
                                
                                if (isResolved) return;
                                
                                // ä½¿ç”¨html2canvasæˆªå›¾
                                if (typeof html2canvas !== 'undefined') {
                                    // ä½¿ç”¨documentElementç¡®ä¿æ•è·æ•´ä¸ªé¡µé¢
                                    const elementToCapture = iframeDoc.documentElement;
                                    
                                    if (!elementToCapture) {
                                        if (!isResolved) {
                                            isResolved = true;
                                            cleanup();
                                            reject(new Error('æ— æ³•è®¿é—®documentElement'));
                                        }
                                        return;
                                    }
                                    
                                    try {
                                        const canvas = await html2canvas(elementToCapture, {
                                            scale: 1,
                                            useCORS: true,
                                            allowTaint: true,
                                            backgroundColor: null, // ä½¿ç”¨åŸå§‹èƒŒæ™¯
                                            logging: false,
                                            width: targetWidth,
                                            height: targetHeight,
                                            windowWidth: targetWidth,
                                            windowHeight: targetHeight,
                                            x: 0,
                                            y: 0
                                        });
                                        
                                        // ç¡®ä¿canvaså°ºå¯¸æ­£ç¡®
                                        const finalCanvas = document.createElement('canvas');
                                        finalCanvas.width = targetWidth;
                                        finalCanvas.height = targetHeight;
                                        const ctx = finalCanvas.getContext('2d');
                                        
                                        // ç»˜åˆ¶åˆ°æ­£ç¡®å°ºå¯¸çš„canvas
                                        ctx.drawImage(canvas, 0, 0, targetWidth, targetHeight);
                                        
                                        const imageData = finalCanvas.toDataURL('image/png', 1.0);
                                        
                                        if (!isResolved) {
                                            isResolved = true;
                                            cleanup();
                                            resolve(imageData);
                                        }
                                    } catch (html2canvasError) {
                                        console.error('html2canvasé”™è¯¯:', html2canvasError);
                                        if (!isResolved) {
                                            isResolved = true;
                                            cleanup();
                                            reject(html2canvasError);
                                        }
                                    }
                                } else {
                                    // å¦‚æœæ²¡æœ‰html2canvasï¼Œç”Ÿæˆå ä½å›¾
                                    const canvas = document.createElement('canvas');
                                    canvas.width = targetWidth;
                                    canvas.height = targetHeight;
                                    const ctx = canvas.getContext('2d');
                                    ctx.fillStyle = '#f3f4f6';
                                    ctx.fillRect(0, 0, targetWidth, targetHeight);
                                    ctx.fillStyle = '#9ca3af';
                                    ctx.font = '24px Arial';
                                    ctx.textAlign = 'center';
                                    ctx.textBaseline = 'middle';
                                    ctx.fillText('ä»£ç é¢„è§ˆ', targetWidth / 2, targetHeight / 2);
                                    
                                    const imageData = canvas.toDataURL('image/png', 1.0);
                                    if (!isResolved) {
                                        isResolved = true;
                                        cleanup();
                                        resolve(imageData);
                                    }
                                }
                            } catch (error) {
                                console.error('ä»£ç è½¬å›¾ç‰‡å¤±è´¥:', error);
                                if (!isResolved) {
                                    isResolved = true;
                                    cleanup();
                                    reject(error);
                                }
                            }
                        }, 1000); // åˆå§‹ç­‰å¾…1ç§’
                    };
                    
                    // å¦‚æœiframeåŠ è½½å¤±è´¥
                    iframe.onerror = () => {
                        if (!isResolved) {
                            isResolved = true;
                            cleanup();
                            reject(new Error('iframeåŠ è½½å¤±è´¥'));
                        }
                    };
                    
                    // è®¾ç½®è¶…æ—¶ï¼ˆå¢åŠ åˆ°40ç§’ï¼Œå› ä¸ºå¤æ‚çš„HTMLä»£ç éœ€è¦æ›´å¤šæ—¶é—´æ¸²æŸ“å’Œæˆªå›¾ï¼‰
                    timeoutId = setTimeout(() => {
                        if (!isResolved) {
                            isResolved = true;
                            cleanup();
                            reject(new Error('ä»£ç è½¬å›¾ç‰‡è¶…æ—¶ï¼ˆ40ç§’ï¼‰'));
                        }
                    }, 40000); // 40ç§’è¶…æ—¶
                } catch (error) {
                    console.error('ä»£ç è½¬å›¾ç‰‡å¤±è´¥:', error);
                    reject(error);
                }
            });
        }

        /**
         * ä¸ºä»£ç å†…å®¹ç”Ÿæˆç¼©ç•¥å›¾ï¼ˆé€šè¿‡iframeæ¸²æŸ“åæˆªå›¾ï¼‰
         */
        async function generateCodeThumbnail(codeContent, maxSize = 150, platform = 'mobile') {
            return new Promise(async (resolve) => {
                try {
                    // ä½¿ç”¨codeToImageç”Ÿæˆå®Œæ•´å›¾ç‰‡
                    const fullImage = await codeToImage(codeContent, platform);
                    
                    if (!fullImage) {
                        resolve(null);
                        return;
                    }
                    
                    // åˆ›å»ºå›¾ç‰‡å¯¹è±¡å¹¶ç¼©æ”¾ä¸ºç¼©ç•¥å›¾
                    const img = new Image();
                    img.onload = () => {
                        try {
                            // è®¡ç®—ç¼©ç•¥å›¾å°ºå¯¸ï¼ˆä¿æŒå®½é«˜æ¯”ï¼‰
                            let width = img.width;
                            let height = img.height;
                            const ratio = Math.min(maxSize / width, maxSize / height);
                            width = Math.floor(width * ratio);
                            height = Math.floor(height * ratio);
                            
                            // åˆ›å»º Canvas å¹¶ç»˜åˆ¶ç¼©ç•¥å›¾
                            const canvas = document.createElement('canvas');
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            // è½¬æ¢ä¸º base64ï¼ˆè´¨é‡é™ä½ä»¥å‡å°æ–‡ä»¶å¤§å°ï¼‰
                            const thumbnail = canvas.toDataURL('image/jpeg', 0.7);
                            resolve(thumbnail);
                        } catch (error) {
                            console.error('ç”Ÿæˆç¼©ç•¥å›¾å¤±è´¥:', error);
                            resolve(null);
                        }
                    };
                    
                    img.onerror = () => {
                        resolve(null);
                    };
                    
                    img.src = fullImage;
                } catch (error) {
                    console.error('ç”Ÿæˆä»£ç ç¼©ç•¥å›¾å¤±è´¥:', error);
                    resolve(null);
                }
            });
        }

        // å†å²è®°å½•ç›¸å…³å‡½æ•°
        async function saveGenerationHistory(prompt, platform, selectedModels, results) {
            console.log('ğŸ”µ saveGenerationHistory è¢«è°ƒç”¨:', {
                promptLength: prompt.length,
                platform: platform,
                selectedModelsCount: selectedModels.length,
                resultsCount: results.length,
                results: results.map(r => ({ name: r.modelName, hasImage: !!r.imageUrl, isError: r.isError }))
            });
            
            try {
                // æ¯æ¬¡ä¿å­˜å‰éƒ½ä» localStorage é‡æ–°åŠ è½½ï¼Œç¡®ä¿ä¸ä¼šè¦†ç›–å…¶ä»–è®°å½•
                const existingHistory = JSON.parse(localStorage.getItem('generation_history') || '[]');
                console.log('ğŸ”µ ç°æœ‰å†å²è®°å½•æ•°é‡:', existingHistory.length);
                
                // ä¸ºæ¯ä¸ªç»“æœç”Ÿæˆç¼©ç•¥å›¾ï¼ˆå¼‚æ­¥ï¼‰
                const processedResults = await Promise.all(results.map(async (r) => {
                    const result = {
                        modelName: r.modelName,
                        cost: r.cost,
                        isError: r.isError,
                        errorMsg: r.errorMsg,
                        thumbnail: null,
                        imageUrl: null, // ä¿å­˜å®Œæ•´å›¾ç‰‡æ•°æ®
                        codeContent: null // ä¿å­˜ä»£ç å†…å®¹ç”¨äºå†å²è®°å½•é¢„è§ˆ
                    };
                    
                    // å¦‚æœæˆåŠŸä¸”æœ‰å›¾ç‰‡ï¼Œä¿å­˜å®Œæ•´å›¾ç‰‡æ•°æ®å¹¶ç”Ÿæˆç¼©ç•¥å›¾
                    if (!r.isError && r.imageUrl) {
                        // ä¿å­˜å®Œæ•´å›¾ç‰‡æ•°æ®ï¼ˆbase64 æˆ– URLï¼‰
                        result.imageUrl = r.imageUrl;
                        // ç”Ÿæˆç¼©ç•¥å›¾
                        result.thumbnail = await generateThumbnail(r.imageUrl, 150);
                        console.log('ğŸ“¸ ç”Ÿæˆç¼©ç•¥å›¾:', r.modelName, result.thumbnail ? 'æˆåŠŸ' : 'å¤±è´¥');
                    }
                    
                    // å¦‚æœæˆåŠŸä¸”æœ‰ä»£ç å†…å®¹ï¼Œä¿å­˜ä»£ç å†…å®¹ç”¨äºé¢„è§ˆ
                    if (!r.isError && r.codeContent) {
                        result.codeContent = r.codeContent;
                        // ä¸ºä»£ç å†…å®¹ç”Ÿæˆç¼©ç•¥å›¾ï¼ˆé€šè¿‡iframeæ¸²æŸ“åæˆªå›¾ï¼‰
                        try {
                            result.thumbnail = await generateCodeThumbnail(r.codeContent, 150, platform);
                            console.log('ğŸ“¸ ç”Ÿæˆä»£ç ç¼©ç•¥å›¾:', r.modelName, result.thumbnail ? 'æˆåŠŸ' : 'å¤±è´¥');
                        } catch (error) {
                            console.error('ç”Ÿæˆä»£ç ç¼©ç•¥å›¾å¤±è´¥:', error);
                            result.thumbnail = null;
                        }
                    }
                    
                    return result;
                }));
                
            const historyItem = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                prompt: prompt,
                platform: platform,
                platformText: platform === 'mobile' ? 'æ‰‹æœºç«¯' : 'PCç«¯',
                selectedModels: selectedModels,
                    results: processedResults,
                totalCost: results.reduce((sum, r) => sum + (r.cost || 0), 0)
            };
                
                console.log('ğŸ”µ åˆ›å»ºå†å²è®°å½•é¡¹:', {
                    id: historyItem.id,
                    resultsCount: historyItem.results.length,
                    results: historyItem.results.map(r => r.modelName)
                });
            
            // æ·»åŠ åˆ°å†å²è®°å½•æ•°ç»„çš„å¼€å¤´ï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
                existingHistory.unshift(historyItem);
            
            // é™åˆ¶å†å²è®°å½•æ•°é‡ï¼ˆæœ€å¤šä¿å­˜50æ¡ï¼‰
                const finalHistory = existingHistory.length > 50 
                    ? existingHistory.slice(0, 50) 
                    : existingHistory;
                
                // æ›´æ–°å…¨å±€å˜é‡
                generationHistory = finalHistory;
            
            // ä¿å­˜åˆ° localStorage
                localStorage.setItem('generation_history', JSON.stringify(finalHistory));
                
                // éªŒè¯ä¿å­˜æ˜¯å¦æˆåŠŸ
                const verifyHistory = JSON.parse(localStorage.getItem('generation_history') || '[]');
                console.log('âœ… å†å²è®°å½•å·²ä¿å­˜:', {
                    id: historyItem.id,
                    prompt: prompt.substring(0, 30) + '...',
                    resultsCount: results.length,
                    totalHistoryCount: finalHistory.length,
                    verifyCount: verifyHistory.length,
                    saved: verifyHistory.length > 0 && verifyHistory[0].id === historyItem.id
                });
                
                if (verifyHistory.length === 0 || verifyHistory[0].id !== historyItem.id) {
                    console.error('âŒ ä¿å­˜éªŒè¯å¤±è´¥ï¼å†å²è®°å½•å¯èƒ½æœªæ­£ç¡®ä¿å­˜');
                }

                // ä¿å­˜åˆ°æœåŠ¡å™¨ï¼ˆå…¨ç«™ç»Ÿè®¡ï¼‰
                try {
                    const totalCost = results.reduce((sum, r) => sum + (r.cost || 0), 0);
                    await fetch('/api/stats', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            results: results.map(r => ({
                                modelName: r.modelName,
                                cost: r.cost || 0,
                                isError: r.isError || false
                            })),
                            totalCost: totalCost
                        })
                    });
                    console.log('âœ… å…¨ç«™ç»Ÿè®¡æ•°æ®å·²ä¿å­˜åˆ°æœåŠ¡å™¨');
                } catch (error) {
                    console.error('âš ï¸ ä¿å­˜å…¨ç«™ç»Ÿè®¡æ•°æ®å¤±è´¥ï¼ˆä¸å½±å“æœ¬åœ°ä½¿ç”¨ï¼‰:', error);
                }
            } catch (error) {
                console.error('âŒ ä¿å­˜å†å²è®°å½•å¤±è´¥:', error);
                console.error('é”™è¯¯å †æ ˆ:', error.stack);
                console.error('é”™è¯¯è¯¦æƒ…:', {
                    promptLength: prompt.length,
                    platform: platform,
                    resultsCount: results.length,
                    errorMessage: error.message
                });
                // å°è¯•ä¿å­˜ç®€åŒ–ç‰ˆæœ¬ï¼ˆä¸ç”Ÿæˆç¼©ç•¥å›¾ï¼‰
                try {
                    const existingHistory = JSON.parse(localStorage.getItem('generation_history') || '[]');
                    const simplifiedHistoryItem = {
                        id: Date.now(),
                        timestamp: new Date().toISOString(),
                        prompt: prompt,
                        platform: platform,
                        platformText: platform === 'mobile' ? 'æ‰‹æœºç«¯' : 'PCç«¯',
                        selectedModels: selectedModels,
                        results: results.map(r => ({
                            modelName: r.modelName,
                            cost: r.cost || 0,
                            isError: r.isError || false,
                            errorMsg: r.errorMsg || '',
                            thumbnail: null,
                            imageUrl: r.imageUrl || null,
                            codeContent: r.codeContent || null
                        })),
                        totalCost: results.reduce((sum, r) => sum + (r.cost || 0), 0)
                    };
                    existingHistory.unshift(simplifiedHistoryItem);
                    const finalHistory = existingHistory.length > 50 ? existingHistory.slice(0, 50) : existingHistory;
                    generationHistory = finalHistory;
                    localStorage.setItem('generation_history', JSON.stringify(finalHistory));
                    console.log('âœ… å·²ä¿å­˜ç®€åŒ–ç‰ˆå†å²è®°å½•ï¼ˆæ— ç¼©ç•¥å›¾ï¼‰');
                } catch (fallbackError) {
                    console.error('âŒ ä¿å­˜ç®€åŒ–ç‰ˆå†å²è®°å½•ä¹Ÿå¤±è´¥:', fallbackError);
                }
            }
        }

        function showHistory() {
            document.getElementById('historyModal').classList.remove('hidden');
            document.getElementById('historyModal').classList.add('flex');
            loadHistory();
        }

        function closeHistory() {
            document.getElementById('historyModal').classList.add('hidden');
            document.getElementById('historyModal').classList.remove('flex');
        }

        let filteredHistory = [];

        function loadHistory() {
            // ä» localStorage é‡æ–°åŠ è½½ï¼ˆç¡®ä¿æ˜¯æœ€æ–°çš„ï¼‰
            generationHistory = JSON.parse(localStorage.getItem('generation_history') || '[]');
            filteredHistory = generationHistory;
            filterHistory();
        }

        function filterHistory() {
            const historyList = document.getElementById('historyList');
            const historyEmpty = document.getElementById('historyEmpty');
            const historyNoResults = document.getElementById('historyNoResults');
            const historyCount = document.getElementById('historyCount');
            
            const searchText = (document.getElementById('historySearch')?.value || '').toLowerCase();
            const filterValue = document.getElementById('historyFilter')?.value || 'all';
            
            // ç­›é€‰å†å²è®°å½•
            filteredHistory = generationHistory.filter(item => {
                // æœç´¢ç­›é€‰
                if (searchText) {
                    const promptMatch = item.prompt.toLowerCase().includes(searchText);
                    const modelMatch = item.selectedModels.some(key => {
                        const config = MODEL_CONFIGS[key];
                        return config && config.name.toLowerCase().includes(searchText);
                    });
                    if (!promptMatch && !modelMatch) return false;
                }
                
                // å¹³å°ç­›é€‰
                if (filterValue === 'mobile' && item.platform !== 'mobile') return false;
                if (filterValue === 'desktop' && item.platform !== 'desktop') return false;
                
                // æ—¶é—´ç­›é€‰
                if (filterValue === 'today' || filterValue === 'week' || filterValue === 'month') {
                    const itemDate = new Date(item.timestamp);
                    const now = new Date();
                    const diffTime = now - itemDate;
                    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                    
                    if (filterValue === 'today' && diffDays > 0) return false;
                    if (filterValue === 'week' && diffDays > 7) return false;
                    if (filterValue === 'month' && diffDays > 30) return false;
                }
                
                return true;
            });
            
            // æ›´æ–°è®¡æ•°
            if (historyCount) {
                historyCount.textContent = filteredHistory.length;
            }
            
            // æ›´æ–°èŠ±è´¹æ˜ç»†ç»Ÿè®¡
            updateCostStatistics(filteredHistory);
            
            // æ˜¾ç¤º/éšè—ç©ºçŠ¶æ€
            if (generationHistory.length === 0) {
                historyList.innerHTML = '';
                historyEmpty.classList.remove('hidden');
                if (historyNoResults) historyNoResults.classList.add('hidden');
                document.getElementById('costStatistics')?.classList.add('hidden');
                return;
            }
            
            if (filteredHistory.length === 0) {
                historyList.innerHTML = '';
            historyEmpty.classList.add('hidden');
                if (historyNoResults) historyNoResults.classList.remove('hidden');
                document.getElementById('costStatistics')?.classList.add('hidden');
                return;
            }
            
            historyEmpty.classList.add('hidden');
            if (historyNoResults) historyNoResults.classList.add('hidden');
            historyList.innerHTML = '';
            
            filteredHistory.forEach((item, index) => {
                const historyCard = document.createElement('div');
                historyCard.className = 'glass-dark rounded-xl p-4 mb-3';
                
                const date = new Date(item.timestamp);
                const dateStr = date.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const modelsList = item.selectedModels.map(key => {
                    const config = MODEL_CONFIGS[key];
                    return config ? config.name : key;
                }).join(', ');
                
                const successCount = item.results.filter(r => !r.isError).length;
                const errorCount = item.results.filter(r => r.isError).length;
                
                historyCard.innerHTML = `
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1">
                            <div class="text-gray-800 font-semibold mb-1">${item.prompt.substring(0, 50)}${item.prompt.length > 50 ? '...' : ''}</div>
                            <div class="text-gray-600 text-xs space-x-2">
                                <span>ğŸ“± ${item.platformText}</span>
                                <span>â€¢</span>
                                <span>ğŸ¨ ${modelsList}</span>
                                <span>â€¢</span>
                                <span>ğŸ’° $${item.totalCost.toFixed(2)}</span>
                                <span>â€¢</span>
                                <span>âœ… ${successCount} æˆåŠŸ</span>
                                ${errorCount > 0 ? `<span>â€¢ âŒ ${errorCount} å¤±è´¥</span>` : ''}
                            </div>
                            <div class="text-gray-500 text-xs mt-1">${dateStr}</div>
                        </div>
                        <div class="flex gap-2 ml-4">
                            <button onclick="viewHistoryItem(${item.id})" class="glass text-gray-800 text-xs px-3 py-1 rounded-lg hover:bg-white/30 transition">
                                ğŸ‘ï¸ æŸ¥çœ‹
                            </button>
                            <button onclick="regenerateFromHistory(${item.id})" class="glass text-gray-800 text-xs px-3 py-1 rounded-lg hover:bg-white/30 transition">
                                ğŸ”„ é‡æ–°ç”Ÿæˆ
                            </button>
                            <button onclick="deleteHistoryItem(${item.id})" class="glass text-red-600 text-xs px-3 py-1 rounded-lg hover:bg-white/30 transition">
                                ğŸ—‘ï¸ åˆ é™¤
                            </button>
                        </div>
                    </div>
                    <div class="flex gap-2 flex-wrap" id="history-thumbnails-${item.id}">
                        ${item.results.slice(0, 4).map((r, idx) => {
                            if (r.isError) {
                                return `<div class="w-16 h-16 bg-red-100 rounded-lg flex items-center justify-center text-red-600 text-xs">âŒ</div>`;
                            } else if (r.thumbnail) {
                                // æ˜¾ç¤ºçœŸå®å›¾ç‰‡ç¼©ç•¥å›¾
                                return `<img src="${r.thumbnail}" alt="${r.modelName}" class="w-16 h-16 object-cover rounded-lg cursor-pointer" title="${r.modelName}" data-full-image="${r.imageUrl ? escapeHtml(r.imageUrl) : ''}">`;
                            } else if (r.imageUrl && (r.imageUrl.startsWith('data:image') || r.imageUrl.startsWith('http'))) {
                                // å¦‚æœæœ‰å®Œæ•´å›¾ç‰‡ä½†æ²¡æœ‰ç¼©ç•¥å›¾ï¼Œç›´æ¥ä½¿ç”¨å®Œæ•´å›¾ç‰‡ï¼ˆç¼©å°æ˜¾ç¤ºï¼‰
                                return `<img src="${r.imageUrl}" alt="${r.modelName}" class="w-16 h-16 object-cover rounded-lg cursor-pointer" title="${r.modelName}" data-full-image="${escapeHtml(r.imageUrl)}">`;
                            } else if (r.codeContent) {
                                // æ˜¾ç¤ºä»£ç é¢„è§ˆç¼©ç•¥å›¾ï¼ˆä½¿ç”¨iframeç¼©æ”¾æ˜¾ç¤ºï¼‰
                                const codePreviewId = `code-preview-${item.id}-${idx}`;
                                return `<div class="w-16 h-16 bg-white rounded-lg border border-gray-300 overflow-hidden relative cursor-pointer code-thumbnail group" data-code="${escapeHtml(JSON.stringify(r.codeContent))}" data-model="${escapeHtml(r.modelName)}" title="${r.modelName}">
                                    <iframe id="${codePreviewId}" srcdoc="${escapeHtml(r.codeContent)}" class="w-full h-full border-0 pointer-events-none" style="transform: scale(0.2); transform-origin: 0 0; width: 500%; height: 500%;"></iframe>
                                    <div class="absolute inset-0 bg-blue-500/10 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                        <span class="text-blue-600 text-xs font-medium">ğŸ’» ä»£ç </span>
                                    </div>
                                </div>`;
                            } else {
                                // æ²¡æœ‰ç¼©ç•¥å›¾æ—¶æ˜¾ç¤ºå ä½ç¬¦
                                return `<div class="w-16 h-16 bg-blue-100 rounded-lg flex items-center justify-center text-blue-600 text-xs" title="${r.modelName}">ğŸ“·</div>`;
                            }
                        }).join('')}
                        ${item.results.length > 4 ? `<div class="w-16 h-16 bg-gray-200 rounded-lg flex items-center justify-center text-gray-600 text-xs">+${item.results.length - 4}</div>` : ''}
                    </div>
                `;
                
                historyList.appendChild(historyCard);
                
                // ä¸ºç¼©ç•¥å›¾æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ˆæŸ¥çœ‹å¤§å›¾ï¼‰
                const thumbnails = historyCard.querySelectorAll(`#history-thumbnails-${item.id} img`);
                thumbnails.forEach(img => {
                    img.addEventListener('click', () => {
                        // ä¼˜å…ˆä½¿ç”¨å®Œæ•´å›¾ç‰‡ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ç¼©ç•¥å›¾
                        const fullImage = img.getAttribute('data-full-image');
                        showImageModal(fullImage || img.src);
                    });
                });
                
                // ä¸ºä»£ç é¢„è§ˆç¼©ç•¥å›¾æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ˆæŸ¥çœ‹ä»£ç é¢„è§ˆï¼‰
                const codeThumbnails = historyCard.querySelectorAll(`#history-thumbnails-${item.id} .code-thumbnail`);
                codeThumbnails.forEach(thumb => {
                    thumb.addEventListener('click', () => {
                        try {
                            const codeContent = JSON.parse(thumb.getAttribute('data-code'));
                            const modelName = thumb.getAttribute('data-model');
                            const platformRadio = document.querySelector('input[name="platform"]:checked');
                            const currentPlatform = platformRadio ? platformRadio.value : 'mobile';
                            showCodePreview(codeContent, modelName, currentPlatform);
                        } catch (e) {
                            console.error('è§£æä»£ç å†…å®¹å¤±è´¥:', e);
                        }
                    });
                });
            });
        }

        function updateCostStatistics(historyItems) {
            const costStatsEl = document.getElementById('costStatistics');
            const costStatsSummaryEl = document.getElementById('costStatsSummary');
            const costStatsDetailsEl = document.getElementById('costStatsDetails');
            
            if (!costStatsEl || !costStatsSummaryEl || !costStatsDetailsEl) return;
            
            // ä¼˜å…ˆä½¿ç”¨æœåŠ¡å™¨ç»Ÿè®¡æ•°æ®ï¼ˆå…¨ç«™ç»Ÿè®¡ï¼‰
            const serverStats = window.serverStatistics;
            
            let sortedStats = [];
            let grandTotal = 0;
            let totalGenerations = 0;
            let grandAverage = 0;
            let isServerStats = false;

            if (serverStats && serverStats.modelStats && serverStats.modelStats.length > 0) {
                // ä½¿ç”¨æœåŠ¡å™¨ç»Ÿè®¡æ•°æ®ï¼ˆå…¨ç«™ï¼‰
                sortedStats = serverStats.modelStats;
                grandTotal = serverStats.grandTotal || 0;
                totalGenerations = serverStats.totalGenerations || 0;
                grandAverage = serverStats.grandAverage || 0;
                isServerStats = true;
            } else if (historyItems.length > 0) {
                // ä½¿ç”¨æœ¬åœ°å†å²è®°å½•ç»Ÿè®¡
                const modelStats = {};
                
                historyItems.forEach(item => {
                    if (!item.results || !Array.isArray(item.results)) return;
                    
                    item.results.forEach(result => {
                        if (!result.modelName) return;
                        const cost = result.cost || 0;
                        
                        if (!modelStats[result.modelName]) {
                            modelStats[result.modelName] = {
                                totalCost: 0,
                                count: 0
                            };
                        }
                        
                        modelStats[result.modelName].totalCost += cost;
                        modelStats[result.modelName].count += 1;
                    });
                });
                
                sortedStats = Object.entries(modelStats)
                    .map(([modelName, stats]) => ({
                        modelName,
                        totalCost: stats.totalCost,
                        count: stats.count,
                        averageCost: stats.totalCost / stats.count
                    }))
                    .sort((a, b) => b.totalCost - a.totalCost);
                
                grandTotal = sortedStats.reduce((sum, stat) => sum + stat.totalCost, 0);
                totalGenerations = sortedStats.reduce((sum, stat) => sum + stat.count, 0);
                grandAverage = totalGenerations > 0 ? grandTotal / totalGenerations : 0;
            }
            
            if (sortedStats.length === 0) {
                costStatsEl.classList.add('hidden');
                return;
            }
            
            // æ˜¾ç¤ºç»Ÿè®¡
            costStatsEl.classList.remove('hidden');
            
            // é»˜è®¤æ˜¾ç¤ºçš„æ‘˜è¦ï¼ˆåªæ˜¾ç¤ºå¹³å‡æ¯æ¬¡ï¼‰
            const statsLabel = isServerStats ? 'å…¨ç«™å¹³å‡æ¯æ¬¡' : 'å¹³å‡æ¯æ¬¡';
            costStatsSummaryEl.innerHTML = `
                <div class="flex items-center gap-2 text-gray-700">
                    <span class="text-gray-600">${statsLabel}ï¼š</span>
                    <span class="text-lg font-bold text-gray-800">$${grandAverage.toFixed(4)}</span>
                    ${isServerStats ? '<span class="text-xs text-purple-600 ml-1">ğŸŒ å…¨ç«™</span>' : ''}
                </div>
            `;
            
            // è¯¦ç»†å†…å®¹ï¼ˆé»˜è®¤éšè—ï¼‰
            const detailsTitle = isServerStats ? 'æŒ‰æ¨¡å‹ç»Ÿè®¡ï¼ˆå…¨ç«™ï¼‰' : 'æŒ‰æ¨¡å‹ç»Ÿè®¡';
            let detailsHtml = `
                ${isServerStats ? '<div class="text-purple-600 text-xs font-medium mb-2">ğŸŒ å…¨ç«™ç»Ÿè®¡æ•°æ®</div>' : ''}
                <div class="grid grid-cols-3 gap-4 mb-3 pb-3 border-b border-gray-300">
                    <div class="text-center">
                        <div class="text-gray-600 text-xs">${isServerStats ? 'å…¨ç«™æ€»èŠ±è´¹' : 'æ€»èŠ±è´¹'}</div>
                        <div class="text-lg font-bold text-gray-800">$${grandTotal.toFixed(2)}</div>
                    </div>
                    <div class="text-center">
                        <div class="text-gray-600 text-xs">${isServerStats ? 'å…¨ç«™ç”Ÿæˆæ¬¡æ•°' : 'æ€»ç”Ÿæˆæ¬¡æ•°'}</div>
                        <div class="text-lg font-bold text-gray-800">${totalGenerations}</div>
                    </div>
                    <div class="text-center">
                        <div class="text-gray-600 text-xs">å¹³å‡æ¯æ¬¡</div>
                        <div class="text-lg font-bold text-gray-800">$${grandAverage.toFixed(4)}</div>
                    </div>
                </div>
                <div class="space-y-2">
                    <div class="text-gray-700 font-semibold text-xs mb-2">${detailsTitle}ï¼š</div>
            `;
            
            sortedStats.forEach(stat => {
                detailsHtml += `
                    <div class="flex items-center justify-between py-2 px-3 bg-white/30 rounded-lg">
                        <div class="flex-1">
                            <div class="text-gray-800 font-medium text-sm">${stat.modelName}</div>
                            <div class="text-gray-600 text-xs mt-0.5">ç”Ÿæˆ ${stat.count} æ¬¡</div>
                        </div>
                        <div class="text-right">
                            <div class="text-gray-800 font-bold text-sm">$${stat.totalCost.toFixed(2)}</div>
                            <div class="text-gray-600 text-xs">å¹³å‡ $${stat.averageCost.toFixed(4)}</div>
                        </div>
                    </div>
                `;
            });
            
            detailsHtml += `</div>`;
            costStatsDetailsEl.innerHTML = detailsHtml;
            
            // ç¡®ä¿è¯¦ç»†å†…å®¹é»˜è®¤éšè—
            costStatsDetailsEl.classList.add('hidden');
            
            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            const toggleBtnText = document.getElementById('toggleCostStatsText');
            if (toggleBtnText) {
                toggleBtnText.textContent = 'å±•å¼€';
            }
        }

        function toggleCostStatistics() {
            const costStatsDetailsEl = document.getElementById('costStatsDetails');
            const toggleBtnText = document.getElementById('toggleCostStatsText');
            
            if (!costStatsDetailsEl || !toggleBtnText) return;
            
            const isHidden = costStatsDetailsEl.classList.contains('hidden');
            if (isHidden) {
                costStatsDetailsEl.classList.remove('hidden');
                toggleBtnText.textContent = 'æ”¶èµ·';
            } else {
                costStatsDetailsEl.classList.add('hidden');
                toggleBtnText.textContent = 'å±•å¼€';
            }
        }

        function viewHistoryItem(historyId) {
            const item = generationHistory.find(h => h.id === historyId) || filteredHistory.find(h => h.id === historyId);
            if (!item) {
                alert('å†å²è®°å½•ä¸å­˜åœ¨');
                return;
            }
            
            // æ¸…ç©ºå½“å‰ç»“æœ
            currentResults = [];
            document.getElementById('resultsGrid').innerHTML = '';
            
            // åŠ è½½å†å²ç»“æœ - ä½¿ç”¨ä¿å­˜çš„å›¾ç‰‡æ•°æ®
            item.results.forEach(result => {
                if (result.isError) {
                    // é”™è¯¯ç»“æœ
                    addResultCard(result.modelName, '', result.cost, true, result.errorMsg, null);
                } else {
                    // æˆåŠŸç»“æœ - ä½¿ç”¨ä¿å­˜çš„å›¾ç‰‡URLæˆ–ä»£ç å†…å®¹
                    if (result.imageUrl) {
                        // æœ‰å›¾ç‰‡URLï¼Œæ­£å¸¸æ˜¾ç¤º
                        addResultCard(result.modelName, result.imageUrl, result.cost, false, '', result.codeContent);
                    } else if (result.codeContent) {
                        // åªæœ‰ä»£ç å†…å®¹ï¼Œæ˜¾ç¤ºä»£ç é¢„è§ˆ
                        addResultCard(result.modelName, '', result.cost, false, '', result.codeContent);
                    } else {
                        // æ²¡æœ‰å›¾ç‰‡ä¹Ÿæ²¡æœ‰ä»£ç ï¼Œæ˜¾ç¤ºæç¤º
                        const card = document.createElement('div');
                        card.className = 'image-card glass-dark rounded-2xl overflow-hidden';
                        card.innerHTML = `
                            <div class="aspect-square bg-blue-50 flex items-center justify-center p-6">
                                <div class="text-center">
                                    <div class="text-4xl mb-2">ğŸ“·</div>
                                    <div class="text-blue-600 text-sm font-medium mb-2">å›¾ç‰‡æ•°æ®æœªä¿å­˜</div>
                                    <div class="text-gray-600 text-xs mb-3">å†å²è®°å½•ä¸­ä¸åŒ…å«å›¾ç‰‡æ•°æ®</div>
                                    <button class="glass text-blue-600 font-medium text-sm px-4 py-2 rounded-lg hover:bg-white/30 transition">
                                        ğŸ”„ é‡æ–°ç”Ÿæˆ
                                    </button>
                                </div>
                            </div>
                            <div class="p-4">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-gray-800 font-semibold">${result.modelName}</span>
                                    <span class="text-gray-600 text-sm">$${result.cost.toFixed(2)}</span>
                                </div>
                            </div>
                        `;
                        card.querySelector('button').onclick = () => {
                            closeHistory();
                            regenerateFromHistory(historyId);
                        };
                        document.getElementById('resultsGrid').appendChild(card);
                    }
                }
            });
            
            // å¡«å……è¾“å…¥æ¡†
            document.getElementById('promptInput').value = item.prompt;
            updateCharCount();
            
            // è®¾ç½®å¹³å°é€‰æ‹©
            const platformRadio = document.querySelector(`input[name="platform"][value="${item.platform}"]`);
            if (platformRadio) {
                platformRadio.checked = true;
            }
            
            // è®¾ç½®æ¨¡å‹é€‰æ‹©
            Object.keys(MODEL_CONFIGS).forEach(key => {
                const checkbox = document.getElementById(`model-${key}`);
                if (checkbox) {
                    checkbox.checked = item.selectedModels.includes(key);
                }
            });
            
            updateCostEstimate();
            
            // å…³é—­å†å²è®°å½•æ¨¡æ€æ¡†
            closeHistory();
            
            // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
            document.getElementById('resultsGrid').scrollIntoView({ behavior: 'smooth' });
        }

        function regenerateFromHistory(historyId) {
            const item = generationHistory.find(h => h.id === historyId) || filteredHistory.find(h => h.id === historyId);
            if (!item) {
                alert('å†å²è®°å½•ä¸å­˜åœ¨');
                return;
            }
            
            // å¡«å……è¾“å…¥æ¡†
            document.getElementById('promptInput').value = item.prompt;
            updateCharCount();
            
            // è®¾ç½®å¹³å°é€‰æ‹©
            const platformRadio = document.querySelector(`input[name="platform"][value="${item.platform}"]`);
            if (platformRadio) {
                platformRadio.checked = true;
            }
            
            // è®¾ç½®æ¨¡å‹é€‰æ‹©
            Object.keys(MODEL_CONFIGS).forEach(key => {
                const checkbox = document.getElementById(`model-${key}`);
                if (checkbox) {
                    checkbox.checked = item.selectedModels.includes(key);
                }
            });
            
            updateCostEstimate();
            
            // å…³é—­å†å²è®°å½•æ¨¡æ€æ¡†
            closeHistory();
            
            // å¼€å§‹ç”Ÿæˆ
            startGeneration();
        }

        function deleteHistoryItem(historyId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å†å²è®°å½•å—ï¼Ÿ')) {
                return;
            }
            
            generationHistory = generationHistory.filter(h => h.id !== historyId);
            localStorage.setItem('generation_history', JSON.stringify(generationHistory));
            loadHistory();
        }

        function clearAllHistory() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }
            
            generationHistory = [];
            localStorage.setItem('generation_history', JSON.stringify(generationHistory));
            loadHistory();
        }

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, duration = 2000) {
            // åˆ›å»º toast å…ƒç´ 
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 right-4 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-opacity opacity-0';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => {
                toast.style.opacity = '1';
            }, 10);
            
            // è‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, duration);
        }

        // HTML è½¬ä¹‰å‡½æ•°
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // æ˜¾ç¤ºä»£ç é¢„è§ˆå¤§å›¾ï¼ˆå…¨å±é¢„è§ˆï¼‰
        function showCodePreview(codeContent, modelName, platform = 'mobile') {
            // åˆ›å»ºå…¨å±é¢„è§ˆæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 z-50';
            
            const modalContent = document.createElement('div');
            
            // æ ¹æ®å¹³å°è°ƒæ•´é¢„è§ˆå°ºå¯¸ï¼Œæ”¯æŒæ‹–æ‹½è°ƒæ•´å¤§å°
            if (platform === 'mobile') {
                // ç§»åŠ¨ç«¯ï¼šä½¿ç”¨ iPhone 16 å±å¹•æ¯”ä¾‹ï¼Œå¢åŠ é«˜åº¦ï¼Œæ”¯æŒè°ƒæ•´
                modalContent.className = 'relative flex flex-col';
                modalContent.style.width = '393px'; // iPhone 16 å®½åº¦
                modalContent.style.height = '900px'; // å¢åŠ é«˜åº¦ï¼Œä»852pxå¢åŠ åˆ°900px
                modalContent.style.minWidth = '300px'; // æœ€å°å®½åº¦ï¼Œæ”¯æŒè°ƒæ•´
                modalContent.style.minHeight = '600px'; // æœ€å°é«˜åº¦ï¼Œæ”¯æŒè°ƒæ•´
                modalContent.style.maxWidth = '90vw'; // åœ¨å°å±å¹•ä¸Šè‡ªé€‚åº”
                modalContent.style.maxHeight = '95vh'; // å¢åŠ æœ€å¤§é«˜åº¦ï¼Œä»90vhåˆ°95vh
                modalContent.style.resize = 'both'; // å…è®¸åŒå‘è°ƒæ•´å¤§å°
                modalContent.style.overflow = 'auto'; // å…è®¸æ»šåŠ¨
            } else {
                // PCç«¯ï¼šä½¿ç”¨æ¡Œé¢å±å¹•æ¯”ä¾‹ï¼Œå¢åŠ é«˜åº¦ï¼Œæ”¯æŒè°ƒæ•´
                modalContent.className = 'relative flex flex-col';
                modalContent.style.width = '90vw';
                modalContent.style.maxWidth = '1400px'; // å¢åŠ æœ€å¤§å®½åº¦
                modalContent.style.height = '85vh'; // å¢åŠ é«˜åº¦ï¼Œä»80vhåˆ°85vh
                modalContent.style.minWidth = '600px'; // æœ€å°å®½åº¦
                modalContent.style.minHeight = '500px'; // æœ€å°é«˜åº¦
                modalContent.style.maxHeight = '90vh'; // å¢åŠ æœ€å¤§é«˜åº¦
                modalContent.style.resize = 'both'; // å…è®¸åŒå‘è°ƒæ•´å¤§å°
                modalContent.style.overflow = 'auto'; // å…è®¸æ»šåŠ¨
            }
            
            const header = document.createElement('div');
            header.className = 'flex items-center justify-between mb-4 bg-gray-900/50 p-4 rounded-t-lg';
            header.innerHTML = `
                <h2 class="text-xl font-bold text-white">ğŸ” ${modelName} - é¢„è§ˆ</h2>
                <button class="close-preview-btn text-white hover:text-gray-300 text-3xl font-bold">&times;</button>
            `;
            
            const iframeContainer = document.createElement('div');
            iframeContainer.className = 'flex-1 bg-white rounded-lg overflow-hidden shadow-2xl';
            iframeContainer.style.minHeight = '0'; // è®©flex-1æ­£å¸¸å·¥ä½œ
            
            const iframe = document.createElement('iframe');
            iframe.className = 'w-full h-full border-0';
            iframe.srcdoc = codeContent;
            iframeContainer.appendChild(iframe);
            
            const footer = document.createElement('div');
            footer.className = 'mt-4 flex gap-3 bg-gray-900/50 p-4 rounded-b-lg';
            footer.innerHTML = `
                <button class="copy-preview-btn flex-1 glass-dark text-white font-bold py-3 rounded-xl hover:bg-white/30 transition">
                    ğŸ“‹ å¤åˆ¶ä»£ç 
                </button>
                <button class="download-preview-btn flex-1 glass-dark text-white font-bold py-3 rounded-xl hover:bg-white/30 transition">
                    â¬‡ï¸ ä¸‹è½½ä»£ç 
                </button>
                <button class="close-preview-btn flex-1 glass-dark text-white font-bold py-3 rounded-xl hover:bg-white/30 transition">
                    å…³é—­
                </button>
            `;
            
            // å…³é—­æŒ‰é’®
            header.querySelector('.close-preview-btn').onclick = () => {
                modal.remove();
                document.removeEventListener('keydown', handleEsc);
            };
            footer.querySelectorAll('.close-preview-btn').forEach(btn => {
                btn.onclick = () => {
                    modal.remove();
                    document.removeEventListener('keydown', handleEsc);
                };
            });
            
            // å¤åˆ¶ä»£ç æŒ‰é’®
            footer.querySelector('.copy-preview-btn').onclick = () => {
                navigator.clipboard.writeText(codeContent).then(() => {
                    showToast('âœ… ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                }).catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æŸ¥çœ‹Console');
                });
            };
            
            // ä¸‹è½½ä»£ç æŒ‰é’®
            footer.querySelector('.download-preview-btn').onclick = () => {
                downloadCode(codeContent, modelName);
            };
            
            modalContent.appendChild(header);
            modalContent.appendChild(iframeContainer);
            modalContent.appendChild(footer);
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // æŒ‰ ESC é”®å…³é—­
            const handleEsc = (e) => {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', handleEsc);
                }
            };
            document.addEventListener('keydown', handleEsc);
        }
    </script>
</body>
</html>
