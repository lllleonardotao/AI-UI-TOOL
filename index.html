<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI UI Design Comparator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        /* ç»ç’ƒæ€æ•ˆæœ - å¢å¼ºå¯¹æ¯”åº¦ */
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
        }
        
        .glass-dark {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* æ¸å˜èƒŒæ™¯ */
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        /* æŒ‰é’®åŠ¨ç”» */
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* å›¾ç‰‡å¡ç‰‡ */
        .image-card {
            transition: all 0.3s ease;
        }
        
        .image-card:hover {
            transform: scale(1.05);
        }
        
        /* éšè—æ»šåŠ¨æ¡ä½†ä¿æŒåŠŸèƒ½ */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="glass rounded-3xl p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">âœ¨ AI UI Design Comparator</h1>
                    <p class="text-gray-600">ä¸€é”®å¯¹æ¯”å¤šä¸ªAIæ¨¡å‹çš„UIè®¾è®¡ç”Ÿæˆæ•ˆæœ</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="showHistory()" class="glass-dark text-gray-800 font-medium px-4 py-2 rounded-xl hover:bg-white/30 transition">
                        ğŸ“œ å†å²è®°å½•
                    </button>
                    <button onclick="showSettings()" class="glass-dark text-gray-800 font-medium px-4 py-2 rounded-xl hover:bg-white/30 transition">
                        âš™ï¸ è®¾ç½®
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="grid md:grid-cols-3 gap-6">
            <!-- Left: Input Panel -->
            <div class="md:col-span-1">
                <div class="glass rounded-3xl p-6 sticky top-4">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ’¬ è¾“å…¥éœ€æ±‚</h2>
                    
                    <!-- Prompt Input -->
                    <div class="mb-4">
                        <label class="text-gray-700 text-sm font-medium mb-2 block">æè¿°ä½ æƒ³è¦çš„UIç•Œé¢</label>
                        <textarea 
                            id="promptInput"
                            rows="6"
                            class="w-full p-4 rounded-xl bg-white/50 border border-gray-300 text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none"
                            placeholder="ä¾‹å¦‚ï¼šæç®€é£æ ¼çš„ç§»åŠ¨APPç™»å½•é¡µé¢ï¼ŒåŒ…å«logoã€é‚®ç®±è¾“å…¥ã€å¯†ç è¾“å…¥ã€ç™»å½•æŒ‰é’®ï¼Œç»ç’ƒæ€è®¾è®¡ï¼Œç™½è‰²èƒŒæ™¯"
                        ></textarea>
                        <div class="text-gray-500 text-xs mt-1 text-right">
                            <span id="charCount">0</span>/500
                        </div>
                    </div>

                    <!-- Platform Selection -->
                    <div class="mb-4">
                        <label class="text-gray-700 text-sm font-medium mb-2 block">ğŸ“± ç›®æ ‡å¹³å°</label>
                        <div class="flex gap-2">
                            <label class="flex-1 flex items-center justify-center glass-dark p-3 rounded-lg cursor-pointer hover:bg-white/20 transition">
                                <input type="radio" name="platform" value="mobile" class="mr-2" checked>
                                <span class="text-gray-800 font-medium">æ‰‹æœºç«¯</span>
                            </label>
                            <label class="flex-1 flex items-center justify-center glass-dark p-3 rounded-lg cursor-pointer hover:bg-white/20 transition">
                                <input type="radio" name="platform" value="desktop" class="mr-2">
                                <span class="text-gray-800 font-medium">PCç«¯</span>
                            </label>
                        </div>
                    </div>

                    <!-- Model Selection -->
                    <div class="mb-4">
                        <label class="text-gray-700 text-sm font-medium mb-2 block">ğŸ¨ é€‰æ‹©AIæ¨¡å‹</label>
                        <div class="space-y-2">
                            <label class="flex items-center glass-dark p-3 rounded-lg cursor-pointer hover:bg-white/20 transition">
                                <input type="checkbox" id="model-gemini" class="mr-3" checked>
                                <span class="text-gray-800 font-medium flex-1">Gemini Image</span>
                                <span class="text-green-600 text-xs font-bold">å…è´¹ ğŸ‰</span>
                            </label>
                            <label class="flex items-center glass-dark p-3 rounded-lg cursor-pointer hover:bg-white/20 transition">
                                <input type="checkbox" id="model-flux" class="mr-3" checked>
                                <span class="text-gray-800 font-medium flex-1">Flux Pro</span>
                                <span class="text-gray-600 text-xs">$0.05</span>
                            </label>
                            <label class="flex items-center glass-dark p-3 rounded-lg cursor-pointer hover:bg-white/20 transition">
                                <input type="checkbox" id="model-gpt5" class="mr-3" checked>
                                <span class="text-gray-800 font-medium flex-1">GPT-5 Image</span>
                                <span class="text-gray-600 text-xs">$0.04</span>
                            </label>
                            <label class="flex items-center glass-dark p-3 rounded-lg cursor-pointer hover:bg-white/20 transition">
                                <input type="checkbox" id="model-claude" class="mr-3" checked>
                                <span class="text-gray-800 font-medium flex-1">Claude 3.5</span>
                                <span class="text-gray-600 text-xs">$0.01</span>
                            </label>
                        </div>
                    </div>

                    <!-- Cost Estimate -->
                    <div class="glass-dark p-3 rounded-lg mb-4">
                        <div class="flex justify-between text-gray-700 text-sm font-medium">
                            <span>é¢„è®¡æˆæœ¬</span>
                            <span id="costEstimate" class="font-mono">$0.10</span>
                        </div>
                    </div>

                    <!-- Generate Button -->
                    <button 
                        onclick="startGeneration()"
                        id="generateBtn"
                        class="w-full btn-primary text-white font-bold py-4 rounded-xl"
                    >
                        ğŸš€ å¼€å§‹ç”Ÿæˆ
                    </button>

                    <!-- Quick Templates -->
                    <div class="mt-4">
                        <label class="text-gray-600 text-xs font-medium mb-2 block">ğŸ“Œ å¿«é€Ÿæ¨¡æ¿</label>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="useTemplate('login')" class="text-xs glass-dark text-gray-700 font-medium px-3 py-1 rounded-lg hover:bg-white/20 transition">ç™»å½•é¡µ</button>
                            <button onclick="useTemplate('dashboard')" class="text-xs glass-dark text-gray-700 font-medium px-3 py-1 rounded-lg hover:bg-white/20 transition">ä»ªè¡¨ç›˜</button>
                            <button onclick="useTemplate('profile')" class="text-xs glass-dark text-gray-700 font-medium px-3 py-1 rounded-lg hover:bg-white/20 transition">ä¸ªäººä¸­å¿ƒ</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Results Panel -->
            <div class="md:col-span-2">
                <!-- Progress -->
                <div id="progressSection" class="glass rounded-3xl p-6 mb-6 hidden">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">â³ ç”Ÿæˆè¿›åº¦</h2>
                    <div class="space-y-3" id="progressList"></div>
                </div>

                <!-- Results -->
                <div class="glass rounded-3xl p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ“Š ç”Ÿæˆç»“æœ</h2>
                    <div id="resultsGrid" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <!-- Empty State -->
                        <div class="col-span-2 text-center py-12 text-gray-500">
                            <div class="text-6xl mb-4">ğŸ¨</div>
                            <p>è¾“å…¥ä½ çš„éœ€æ±‚ï¼Œç‚¹å‡»ç”ŸæˆæŒ‰é’®å¼€å§‹åˆ›ä½œ</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
        <div class="glass rounded-3xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">âš™ï¸ è®¾ç½®</h2>
            
            <!-- API Key -->
            <div class="mb-6">
                <label class="text-gray-700 text-sm font-medium mb-2 block">OpenRouter API Key</label>
                <input 
                    type="password" 
                    id="apiKeyInput"
                    class="w-full p-3 rounded-xl bg-white/50 border border-gray-300 text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500"
                    placeholder="sk-or-v1-xxxxx..."
                >
                <p class="text-gray-600 text-xs mt-2">
                    æ²¡æœ‰API Keyï¼Ÿ<a href="https://openrouter.ai/" target="_blank" class="text-purple-600 font-medium underline">ç‚¹å‡»æ³¨å†Œ</a>
                </p>
            </div>

            <!-- Custom Models -->
            <div class="mb-6">
                <label class="text-gray-700 text-sm font-medium mb-2 block">ğŸ¨ è‡ªå®šä¹‰æ¨¡å‹</label>
                <div id="customModelsList" class="space-y-2 mb-3">
                    <!-- Custom models will be added here -->
                </div>
                <button onclick="addCustomModel()" class="w-full glass-dark text-gray-800 font-medium py-2 px-4 rounded-lg hover:bg-white/30 transition">
                    â• æ·»åŠ æ–°æ¨¡å‹
                </button>
            </div>

            <!-- Add Model Form (hidden by default) -->
            <div id="addModelForm" class="mb-6 glass-dark p-4 rounded-xl hidden">
                <h3 class="text-gray-800 font-bold mb-3">æ·»åŠ æ–°æ¨¡å‹</h3>
                <div class="space-y-3">
                    <div>
                        <label class="text-gray-700 text-xs mb-1 block">æ¨¡å‹åç§°</label>
                        <input type="text" id="newModelName" placeholder="ä¾‹å¦‚ï¼šDALL-E 4" 
                               class="w-full p-2 rounded-lg bg-white/50 border border-gray-300 text-gray-800 text-sm">
                    </div>
                    <div>
                        <label class="text-gray-700 text-xs mb-1 block">æ¨¡å‹ID</label>
                        <input type="text" id="newModelId" placeholder="ä¾‹å¦‚ï¼šopenai/dall-e-4" 
                               class="w-full p-2 rounded-lg bg-white/50 border border-gray-300 text-gray-800 text-sm">
                    </div>
                    <div>
                        <label class="text-gray-700 text-xs mb-1 block">æˆæœ¬ï¼ˆæ¯æ¬¡ç”Ÿæˆï¼‰</label>
                        <input type="number" id="newModelCost" placeholder="0.00" step="0.01" 
                               class="w-full p-2 rounded-lg bg-white/50 border border-gray-300 text-gray-800 text-sm">
                    </div>
                    <div class="flex gap-2">
                        <button onclick="saveCustomModel()" class="flex-1 btn-primary text-white font-medium py-2 rounded-lg">
                            ä¿å­˜
                        </button>
                        <button onclick="cancelAddModel()" class="flex-1 glass text-gray-800 font-medium py-2 rounded-lg hover:bg-white/30">
                            å–æ¶ˆ
                        </button>
                    </div>
                </div>
            </div>

            <!-- Debug Mode -->
            <div class="mb-6">
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" id="debugMode" class="mr-2">
                    <span class="text-gray-700 text-sm font-medium">ğŸ› å¯ç”¨è°ƒè¯•æ¨¡å¼ï¼ˆæ˜¾ç¤ºè¯¦ç»†æ—¥å¿—ï¼‰</span>
                </label>
                <p class="text-gray-600 text-xs mt-1 ml-6">
                    å¼€å¯åä¼šåœ¨æ§åˆ¶å°æ˜¾ç¤ºè¯¦ç»†çš„APIè¯·æ±‚å’Œå“åº”ä¿¡æ¯
                </p>
            </div>

            <div class="flex gap-3">
                <button onclick="saveSettings()" class="flex-1 btn-primary text-white font-bold py-3 rounded-xl">
                    ä¿å­˜
                </button>
                <button onclick="closeSettings()" class="flex-1 glass-dark text-gray-800 font-bold py-3 rounded-xl hover:bg-white/30 transition">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
        <div class="glass rounded-3xl p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800">ğŸ“œ ç”Ÿæˆå†å²</h2>
                <button onclick="closeHistory()" class="text-gray-600 hover:text-gray-800 text-2xl">âœ•</button>
            </div>

            <!-- History Stats -->
            <div class="glass-dark p-4 rounded-xl mb-4">
                <div class="flex items-center justify-between">
                    <div>
                        <span class="text-gray-700 font-medium">å…± </span>
                        <span id="historyCount" class="text-purple-600 font-bold text-lg">0</span>
                        <span class="text-gray-700 font-medium"> æ¡è®°å½•</span>
                    </div>
                    <button onclick="clearAllHistory()" class="text-red-600 hover:text-red-700 font-medium text-sm">
                        ğŸ—‘ï¸ æ¸…ç©ºå…¨éƒ¨
                    </button>
                </div>
            </div>

            <!-- History List -->
            <div id="historyList" class="space-y-4">
                <!-- History items will be added here -->
            </div>

            <!-- Empty State -->
            <div id="historyEmpty" class="text-center py-12 hidden">
                <div class="text-6xl mb-4">ğŸ“­</div>
                <p class="text-gray-600">æš‚æ— ç”Ÿæˆå†å²</p>
            </div>
        </div>
    </div>

    <!-- Image Preview Modal -->
    <div id="imageModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center p-4 z-50" onclick="closeImageModal()">
        <div class="max-w-4xl max-h-[90vh] overflow-auto">
            <img id="modalImage" src="" class="w-full rounded-2xl">
        </div>
    </div>

    <script>
        // é…ç½®
        const OPENROUTER_API_URL = 'https://openrouter.ai/api/v1';
        const MODEL_CONFIGS = {
            'gemini': {
                name: 'Gemini Image (å…è´¹)',
                model: 'google/gemini-2.5-flash-image-preview',
                cost: 0,
                type: 'image',
                supportsModalities: true  // Geminiéœ€è¦modalitieså‚æ•°
            },
            'flux': {
                name: 'Flux Pro',
                model: 'black-forest-labs/flux.2-pro',
                cost: 0.05,
                type: 'image',
                supportsModalities: false  // Fluxä¸éœ€è¦modalities
            },
            'gpt5': {
                name: 'GPT-5 Image',
                model: 'openai/gpt-5-image',
                cost: 0.04,
                type: 'image',
                supportsModalities: false  // GPT-5ä¸éœ€è¦modalities
            },
            'claude': {
                name: 'Claude 3.5 (æè¿°)',
                model: 'anthropic/claude-3.5-sonnet',
                cost: 0.01,
                type: 'text-to-image-desc',
                supportsModalities: false
            }
        };

        // æ¨¡æ¿
        const TEMPLATES = {
            login: 'æç®€é£æ ¼çš„ç§»åŠ¨APPç™»å½•é¡µé¢ï¼ŒåŒ…å«logoã€é‚®ç®±è¾“å…¥æ¡†ã€å¯†ç è¾“å…¥æ¡†ã€ç™»å½•æŒ‰é’®ã€å¿˜è®°å¯†ç é“¾æ¥ï¼Œç»ç’ƒæ€è®¾è®¡ï¼Œç™½è‰²èƒŒæ™¯ï¼Œåœ†è§’å…ƒç´ ',
            dashboard: 'ç°ä»£ç®€çº¦çš„æ•°æ®ä»ªè¡¨ç›˜ç•Œé¢ï¼ŒåŒ…å«é¡¶éƒ¨ç»Ÿè®¡å¡ç‰‡ã€æŠ˜çº¿å›¾ã€é¥¼å›¾ã€æœ€è¿‘æ´»åŠ¨åˆ—è¡¨ï¼Œæ·±è‰²ä¸»é¢˜ï¼Œç»ç’ƒæ€æ•ˆæœ',
            profile: 'ç®€æ´çš„ä¸ªäººä¸­å¿ƒé¡µé¢ï¼Œé¡¶éƒ¨å¤´åƒå’Œç”¨æˆ·ä¿¡æ¯ã€è®¾ç½®é€‰é¡¹åˆ—è¡¨ã€é€€å‡ºç™»å½•æŒ‰é’®ï¼Œæç®€é£æ ¼ï¼Œç™½è‰²èƒŒæ™¯'
        };

        // åˆå§‹åŒ–
        let apiKey = localStorage.getItem('openrouter_api_key') || '';
        let currentResults = [];
        let customModels = JSON.parse(localStorage.getItem('custom_models') || '[]');
        let debugMode = localStorage.getItem('debug_mode') === 'true';
        let generationHistory = JSON.parse(localStorage.getItem('generation_history') || '[]');

        // è°ƒè¯•æ—¥å¿—å‡½æ•°
        function debugLog(...args) {
            if (debugMode) {
                console.log(...args);
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥API Key
        window.onload = () => {
            if (!apiKey) {
                showSettings();
            }
            updateCharCount();
            updateCostEstimate();
            loadCustomModels();

            // æ¢å¤è°ƒè¯•æ¨¡å¼è®¾ç½®
            const debugCheckbox = document.getElementById('debugMode');
            if (debugCheckbox) {
                debugCheckbox.checked = debugMode;
            }
        };

        // è‡ªå®šä¹‰æ¨¡å‹ç®¡ç†
        function loadCustomModels() {
            const list = document.getElementById('customModelsList');
            list.innerHTML = '';
            
            customModels.forEach((model, index) => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between glass p-3 rounded-lg';
                item.innerHTML = `
                    <div class="flex-1">
                        <div class="text-gray-800 font-medium">${model.name}</div>
                        <div class="text-gray-600 text-xs">${model.model}</div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="text-gray-600 text-sm">$${model.cost.toFixed(2)}</span>
                        <button onclick="deleteCustomModel(${index})" class="text-red-500 hover:text-red-700">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                `;
                list.appendChild(item);
                
                // æ·»åŠ åˆ°æ¨¡å‹é€‰æ‹©åˆ—è¡¨
                addModelToSelector(model, `custom-${index}`);
            });
        }

        function addModelToSelector(model, key) {
            // æ£€æµ‹æ˜¯å¦éœ€è¦modalitieså‚æ•°ï¼ˆåªæœ‰Geminiå›¾ç‰‡æ¨¡å‹éœ€è¦ï¼‰
            const needsModalities = model.model.includes('gemini') && model.model.includes('image');

            // æ·»åŠ åˆ°MODEL_CONFIGS
            MODEL_CONFIGS[key] = {
                name: model.name,
                model: model.model,
                cost: model.cost,
                type: 'image',
                supportsModalities: needsModalities
            };

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            if (document.getElementById(`model-${key}`)) return;
            
            // æ·»åŠ åˆ°UI
            const container = document.querySelector('.space-y-2');
            const label = document.createElement('label');
            label.className = 'flex items-center glass-dark p-3 rounded-lg cursor-pointer hover:bg-white/20 transition';
            label.innerHTML = `
                <input type="checkbox" id="model-${key}" class="mr-3">
                <span class="text-gray-800 font-medium flex-1">${model.name}</span>
                <span class="text-gray-600 text-xs">$${model.cost.toFixed(2)}</span>
            `;
            container.appendChild(label);
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬
            document.getElementById(`model-${key}`).addEventListener('change', updateCostEstimate);
        }

        function addCustomModel() {
            document.getElementById('addModelForm').classList.remove('hidden');
        }

        function cancelAddModel() {
            document.getElementById('addModelForm').classList.add('hidden');
            document.getElementById('newModelName').value = '';
            document.getElementById('newModelId').value = '';
            document.getElementById('newModelCost').value = '';
        }

        function saveCustomModel() {
            const name = document.getElementById('newModelName').value.trim();
            const modelId = document.getElementById('newModelId').value.trim();
            const cost = parseFloat(document.getElementById('newModelCost').value) || 0;
            
            if (!name || !modelId) {
                alert('âš ï¸ è¯·å¡«å†™æ¨¡å‹åç§°å’ŒID');
                return;
            }
            
            const newModel = {
                name: name,
                model: modelId,
                cost: cost
            };
            
            customModels.push(newModel);
            localStorage.setItem('custom_models', JSON.stringify(customModels));
            
            loadCustomModels();
            cancelAddModel();
            
            alert('âœ… æ¨¡å‹å·²æ·»åŠ ');
        }

        function deleteCustomModel(index) {
            if (!confirm('ç¡®å®šåˆ é™¤è¿™ä¸ªæ¨¡å‹å—ï¼Ÿ')) return;
            
            // ä»MODEL_CONFIGSåˆ é™¤
            delete MODEL_CONFIGS[`custom-${index}`];
            
            // ä»UIåˆ é™¤
            const checkbox = document.getElementById(`model-custom-${index}`);
            if (checkbox) {
                checkbox.parentElement.remove();
            }
            
            // ä»localStorageåˆ é™¤
            customModels.splice(index, 1);
            localStorage.setItem('custom_models', JSON.stringify(customModels));
            
            // é‡æ–°åŠ è½½
            loadCustomModels();
            updateCostEstimate();
        }

        // å­—ç¬¦è®¡æ•°
        document.getElementById('promptInput').addEventListener('input', (e) => {
            updateCharCount();
        });

        function updateCharCount() {
            const input = document.getElementById('promptInput');
            const count = input.value.length;
            document.getElementById('charCount').textContent = count;
            if (count > 500) {
                input.value = input.value.substring(0, 500);
            }
        }

        // æˆæœ¬ä¼°ç®—
        function updateCostEstimate() {
            let total = 0;
            for (let key in MODEL_CONFIGS) {
                const checkbox = document.getElementById(`model-${key}`);
                if (checkbox && checkbox.checked) {
                    total += MODEL_CONFIGS[key].cost;
                }
            }
            document.getElementById('costEstimate').textContent = `$${total.toFixed(2)}`;
        }

        // ç›‘å¬æ¨¡å‹é€‰æ‹©å˜åŒ–
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            cb.addEventListener('change', updateCostEstimate);
        });

        // è®¾ç½®ç›¸å…³
        function showSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
            document.getElementById('settingsModal').classList.add('flex');
            document.getElementById('apiKeyInput').value = apiKey;
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
            document.getElementById('settingsModal').classList.remove('flex');
        }

        function saveSettings() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (key) {
                apiKey = key;
                localStorage.setItem('openrouter_api_key', key);

                // ä¿å­˜è°ƒè¯•æ¨¡å¼è®¾ç½®
                const debugCheckbox = document.getElementById('debugMode');
                debugMode = debugCheckbox.checked;
                localStorage.setItem('debug_mode', debugMode.toString());

                closeSettings();
                alert('âœ… è®¾ç½®å·²ä¿å­˜');
            } else {
                alert('âš ï¸ è¯·è¾“å…¥æœ‰æ•ˆçš„API Key');
            }
        }

        // å†å²è®°å½•ç›¸å…³
        function showHistory() {
            loadHistory();
            document.getElementById('historyModal').classList.remove('hidden');
            document.getElementById('historyModal').classList.add('flex');
        }

        function closeHistory() {
            document.getElementById('historyModal').classList.add('hidden');
            document.getElementById('historyModal').classList.remove('flex');
        }

        function loadHistory() {
            const historyList = document.getElementById('historyList');
            const historyEmpty = document.getElementById('historyEmpty');
            const historyCount = document.getElementById('historyCount');

            historyCount.textContent = generationHistory.length;

            if (generationHistory.length === 0) {
                historyList.innerHTML = '';
                historyEmpty.classList.remove('hidden');
                return;
            }

            historyEmpty.classList.add('hidden');
            historyList.innerHTML = '';

            // æŒ‰æ—¶é—´å€’åºæ˜¾ç¤ºï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
            const sortedHistory = [...generationHistory].reverse();

            sortedHistory.forEach((item, index) => {
                const actualIndex = generationHistory.length - 1 - index;
                const historyItem = document.createElement('div');
                historyItem.className = 'glass-dark p-4 rounded-xl';

                // æ ¼å¼åŒ–æ—¶é—´
                const date = new Date(item.timestamp);
                const timeStr = date.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                // ç”Ÿæˆç¼©ç•¥å›¾ï¼ˆå–ç¬¬ä¸€ä¸ªæˆåŠŸçš„ç»“æœï¼‰
                let thumbnail = '';
                const firstSuccess = item.results.find(r => !r.isError);
                if (firstSuccess && firstSuccess.result && firstSuccess.result.content) {
                    const result = firstSuccess.result;
                    if (result.type === 'image') {
                        thumbnail = `<img src="${result.content}" class="w-20 h-20 object-cover rounded-lg cursor-pointer hover:opacity-80 transition" onclick="viewHistoryImage('${result.content.replace(/'/g, "\\'")}')" alt="é¢„è§ˆ">`;
                    } else if (result.type === 'html' || result.type === 'svg') {
                        thumbnail = `<div class="w-20 h-20 bg-gradient-to-br from-purple-400 to-blue-400 rounded-lg flex items-center justify-center text-white font-bold text-2xl cursor-pointer hover:opacity-80 transition" onclick="viewHistoryContent(${actualIndex})">${result.type.toUpperCase()}</div>`;
                    } else {
                        thumbnail = `<div class="w-20 h-20 bg-gray-300 rounded-lg flex items-center justify-center text-gray-600 font-bold">ğŸ“„</div>`;
                    }
                } else {
                    thumbnail = `<div class="w-20 h-20 bg-red-100 rounded-lg flex items-center justify-center text-red-600 font-bold text-2xl">âŒ</div>`;
                }

                historyItem.innerHTML = `
                    <div class="flex gap-4">
                        ${thumbnail}
                        <div class="flex-1">
                            <p class="text-gray-800 font-medium mb-2 line-clamp-2">${item.prompt}</p>
                            <div class="flex items-center gap-4 text-xs text-gray-600">
                                <span>â° ${timeStr}</span>
                                <span>ğŸ’° $${item.totalCost.toFixed(4)}</span>
                                <span>âœ… ${item.results.filter(r => !r.isError).length}/${item.results.length} æˆåŠŸ</span>
                            </div>
                        </div>
                        <div class="flex flex-col gap-2">
                            <button onclick="viewHistoryItem(${actualIndex})" class="px-4 py-2 glass text-gray-800 text-sm font-medium rounded-lg hover:bg-white/30 transition">
                                ğŸ‘ï¸ æŸ¥çœ‹
                            </button>
                            <button onclick="deleteHistoryItem(${actualIndex})" class="px-4 py-2 glass text-red-600 text-sm font-medium rounded-lg hover:bg-white/30 transition">
                                ğŸ—‘ï¸ åˆ é™¤
                            </button>
                        </div>
                    </div>
                `;

                historyList.appendChild(historyItem);
            });
        }

        function saveToHistory(prompt, results, totalCost) {
            const historyItem = {
                timestamp: Date.now(),
                prompt: prompt,
                results: results,
                totalCost: totalCost
            };

            generationHistory.push(historyItem);

            // é™åˆ¶å†å²è®°å½•æ•°é‡ï¼ˆæœ€å¤šä¿å­˜100æ¡ï¼‰
            if (generationHistory.length > 100) {
                generationHistory.shift();
            }

            localStorage.setItem('generation_history', JSON.stringify(generationHistory));
            debugLog('ğŸ’¾ å·²ä¿å­˜åˆ°å†å²è®°å½•');
        }

        function viewHistoryImage(imageUrl) {
            showImageModal(imageUrl);
        }

        function viewHistoryContent(index) {
            const item = generationHistory[index];
            if (!item) return;

            const firstSuccess = item.results.find(r => !r.isError);
            if (!firstSuccess || !firstSuccess.result) return;

            const result = firstSuccess.result;
            if (result.type === 'html') {
                showHtmlModal(result.content, firstSuccess.modelName);
            } else if (result.type === 'svg') {
                showCodeModal('SVG', result.content, firstSuccess.modelName);
            }
        }

        function viewHistoryItem(index) {
            const item = generationHistory[index];
            if (!item) return;

            // å…³é—­å†å²è®°å½•æ¨¡æ€æ¡†
            closeHistory();

            // é‡æ–°å¡«å……prompt
            document.getElementById('promptInput').value = item.prompt;
            updateCharCount();

            // æ˜¾ç¤ºç»“æœ
            currentResults = item.results;
            const resultsGrid = document.getElementById('resultsGrid');
            resultsGrid.innerHTML = '';

            item.results.forEach(result => {
                addResultCard(
                    result.modelName,
                    result.result,
                    result.cost,
                    result.isError,
                    result.errorMsg
                );
            });

            // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
            resultsGrid.scrollIntoView({ behavior: 'smooth' });
        }

        function deleteHistoryItem(index) {
            if (!confirm('ç¡®å®šåˆ é™¤è¿™æ¡å†å²è®°å½•å—ï¼Ÿ')) return;

            generationHistory.splice(index, 1);
            localStorage.setItem('generation_history', JSON.stringify(generationHistory));
            loadHistory();
        }

        function clearAllHistory() {
            if (!confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;

            generationHistory = [];
            localStorage.setItem('generation_history', JSON.stringify(generationHistory));
            loadHistory();
        }

        // æ¨¡æ¿ç›¸å…³
        function useTemplate(type) {
            document.getElementById('promptInput').value = TEMPLATES[type];
            updateCharCount();
        }

        // ç”Ÿæˆç›¸å…³
        async function startGeneration() {
            // éªŒè¯
            if (!apiKey) {
                alert('âš ï¸ è¯·å…ˆé…ç½®OpenRouter API Key');
                showSettings();
                return;
            }

            const prompt = document.getElementById('promptInput').value.trim();
            if (!prompt) {
                alert('âš ï¸ è¯·è¾“å…¥UIè®¾è®¡éœ€æ±‚');
                return;
            }

            // è·å–é€‰ä¸­çš„æ¨¡å‹
            const selectedModels = [];
            for (let key in MODEL_CONFIGS) {
                const checkbox = document.getElementById(`model-${key}`);
                if (checkbox && checkbox.checked) {
                    selectedModels.push(key);
                }
            }

            if (selectedModels.length === 0) {
                alert('âš ï¸ è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ¨¡å‹');
                return;
            }

            // ç¦ç”¨æŒ‰é’®
            const btn = document.getElementById('generateBtn');
            btn.disabled = true;
            btn.textContent = 'ğŸ”„ ç”Ÿæˆä¸­...';

            // æ˜¾ç¤ºè¿›åº¦åŒºåŸŸ
            document.getElementById('progressSection').classList.remove('hidden');
            document.getElementById('progressList').innerHTML = '';

            // æ¸…ç©ºç»“æœ
            currentResults = [];
            document.getElementById('resultsGrid').innerHTML = '';

            // è·å–å¹³å°é€‰æ‹©
            const platformRadio = document.querySelector('input[name="platform"]:checked');
            const platform = platformRadio ? platformRadio.value : 'mobile';
            const platformText = platform === 'mobile' ? 'mobile app (iOS/Android)' : 'desktop web application';
            const platformTitle = platform === 'mobile' ? 'mobile app UI design' : 'desktop web UI design';

            // ä¼˜åŒ–Promptï¼ˆåŠ å…¥UIè®¾è®¡çº¦æŸï¼‰
            const optimizedPrompt = `Create a clean, modern ${platformTitle}.

User requirements: ${prompt}

Design constraints:
- Style: flat design, minimalist, professional interface
- Platform: ${platformText}
- Layout: clear visual hierarchy, proper spacing
- Elements: realistic UI components (buttons, inputs, cards)
- Colors: harmonious color scheme
- Output: high-fidelity UI mockup, NOT illustration

Avoid: 3D elements, realistic photos, cartoon style`;

            // å¹¶å‘è°ƒç”¨æ‰€æœ‰æ¨¡å‹
            const promises = selectedModels.map(modelKey => 
                generateWithModel(modelKey, optimizedPrompt)
            );

            // ç­‰å¾…æ‰€æœ‰å®Œæˆ
            await Promise.allSettled(promises);

            // ä¿å­˜åˆ°å†å²è®°å½•
            const totalCost = currentResults.reduce((sum, r) => sum + r.cost, 0);
            saveToHistory(prompt, currentResults, totalCost);

            // æ¢å¤æŒ‰é’®
            btn.disabled = false;
            btn.textContent = 'ğŸš€ å¼€å§‹ç”Ÿæˆ';

            // éšè—è¿›åº¦
            setTimeout(() => {
                document.getElementById('progressSection').classList.add('hidden');
            }, 2000);
        }

        async function generateWithModel(modelKey, prompt) {
            const config = MODEL_CONFIGS[modelKey];

            // æ·»åŠ è¿›åº¦é¡¹
            addProgressItem(modelKey, 'pending');

            try {
                let result;

                if (config.type === 'image') {
                    // ç›´æ¥ç”Ÿæˆå›¾ç‰‡çš„æ¨¡å‹ï¼ˆGemini, Flux, GPT-5ï¼‰
                    result = await generateImage(config.model, prompt, config);
                } else {
                    // Claudeï¼šç”Ÿæˆæè¿°åç”¨å…è´¹çš„Geminiç”Ÿæˆå›¾
                    const description = await generateDescription(config.model, prompt);
                    // ä½¿ç”¨Geminié…ç½®
                    const geminiConfig = MODEL_CONFIGS['gemini'];
                    result = await generateImage(geminiConfig.model, description, geminiConfig);
                }

                // æˆåŠŸ
                updateProgressItem(modelKey, 'success');
                addResultCard(config.name, result, config.cost, false);

            } catch (error) {
                console.error(`${config.name} ç”Ÿæˆå¤±è´¥:`, error);
                updateProgressItem(modelKey, 'error', error.message);

                // æ·»åŠ é”™è¯¯å¡ç‰‡ï¼ˆä¸ä¼šæ¶ˆå¤±ï¼‰
                addResultCard(config.name, null, config.cost, true, error.message);
            }
        }

        async function generateImage(model, prompt, modelConfig = null) {
            debugLog('ğŸš€ Calling model:', model);
            debugLog('ğŸ“ Prompt:', prompt.substring(0, 100) + '...');

            // æ ¹æ®æ¨¡å‹ç±»å‹æ„å»ºä¸åŒçš„è¯·æ±‚ä½“
            const requestBody = {
                model: model,
                messages: [
                    {
                        role: 'user',
                        content: prompt
                    }
                ]
            };

            // æ ¹æ®æ¨¡å‹é…ç½®æ·»åŠ  modalities å‚æ•°
            if (modelConfig && modelConfig.supportsModalities) {
                requestBody.modalities = ["image", "text"];
                debugLog('âœ“ Adding modalities parameter for this model');
            } else {
                debugLog('âœ“ Skipping modalities parameter for this model');
            }

            debugLog('ğŸ“¤ Request body:', JSON.stringify(requestBody, null, 2));

            const response = await fetch(`${OPENROUTER_API_URL}/chat/completions`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json',
                    'HTTP-Referer': window.location.href,
                    'X-Title': 'AI UI Design Comparator'
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('âŒ API Error Response:', errorText);
                let errorMessage = 'ç”Ÿæˆå¤±è´¥';
                try {
                    const error = JSON.parse(errorText);
                    errorMessage = error.error?.message || error.message || errorMessage;
                } catch (e) {
                    // ä¿ç•™æ›´å¤šé”™è¯¯ä¿¡æ¯ï¼Œæœ€å¤š500å­—ç¬¦ï¼Œé¿å…ä¸¢å¤±å…³é”®ç»†èŠ‚
                    errorMessage = errorText.length > 500
                        ? errorText.substring(0, 500) + '...(è¯¦è§æ§åˆ¶å°)'
                        : errorText;
                }
                throw new Error(errorMessage);
            }

            const data = await response.json();
            debugLog('âœ… Full API Response:', JSON.stringify(data, null, 2));

            const message = data.choices?.[0]?.message;
            if (!message) {
                console.error('âŒ No message in response');
                console.error('Full data:', JSON.stringify(data, null, 2));
                throw new Error('APIå“åº”æ ¼å¼é”™è¯¯ï¼šæ²¡æœ‰message');
            }

            debugLog('ğŸ“¦ Message keys:', Object.keys(message));
            debugLog('ğŸ“¦ Message structure:', JSON.stringify(message, null, 2));

            // å°è¯•ä»å“åº”ä¸­æå–å†…å®¹ï¼ˆæ”¯æŒå¤šç§æ ¼å¼ï¼‰
            const result = extractImageFromResponse(message);

            if (!result) {
                console.error('âŒ No content found in response');
                console.error('Available message fields:', Object.keys(message));
                console.error('Full message:', JSON.stringify(message, null, 2));

                // æä¾›æ›´è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
                const messageInfo = {
                    hasContent: !!message.content,
                    contentType: typeof message.content,
                    isContentArray: Array.isArray(message.content),
                    hasImages: !!message.images,
                    hasImageUrl: !!message.image_url,
                    hasImage: !!message.image,
                    hasData: !!message.data,
                    availableKeys: Object.keys(message)
                };
                console.error('ğŸ“Š Message structure analysis:', messageInfo);

                throw new Error(`æ¨¡å‹${model}è¿”å›äº†æ•°æ®ï¼Œä½†æ— æ³•è§£æå†…å®¹ã€‚\n` +
                    `å¯ç”¨å­—æ®µ: ${Object.keys(message).join(', ')}\n` +
                    `è¯·å¯ç”¨è°ƒè¯•æ¨¡å¼å¹¶æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—æŸ¥çœ‹è¯¦ç»†å“åº”ã€‚`);
            }

            debugLog('âœ… Successfully extracted content');
            debugLog('Content type:', result.type);
            debugLog('Content length:', result.content.length);
            debugLog('Content preview:', result.content.substring(0, 100));

            return result;
        }

        // ä»APIå“åº”ä¸­æå–å†…å®¹çš„é€šç”¨å‡½æ•° - æ”¯æŒå¤šç§æ ¼å¼
        function extractImageFromResponse(message) {
            // æ–¹æ³•1: æ£€æŸ¥ content æ•°ç»„ (æœ€å¸¸è§çš„æ ¼å¼)
            if (Array.isArray(message.content)) {
                debugLog('ğŸ” Checking content array, length:', message.content.length);
                for (let i = 0; i < message.content.length; i++) {
                    const item = message.content[i];
                    debugLog(`  [${i}] type:`, item.type, 'keys:', Object.keys(item));

                    // Gemini æ ¼å¼: {type: "image_url", image_url: {url: "data:image/..."}}
                    if (item.type === 'image_url') {
                        if (typeof item.image_url === 'string') {
                            debugLog('âœ… Found image_url (string)');
                            return { type: 'image', content: item.image_url };
                        }
                        if (item.image_url && item.image_url.url) {
                            debugLog('âœ… Found image_url.url');
                            return { type: 'image', content: item.image_url.url };
                        }
                    }

                    // Claude/GPT æ ¼å¼: {type: "image", source: {data: "..."}}
                    if (item.type === 'image') {
                        if (item.url) {
                            debugLog('âœ… Found item.url');
                            return { type: 'image', content: item.url };
                        }
                        if (item.data) {
                            debugLog('âœ… Found item.data');
                            return { type: 'image', content: item.data };
                        }
                        if (item.source && item.source.data) {
                            debugLog('âœ… Found item.source.data');
                            return { type: 'image', content: item.source.data };
                        }
                    }

                    // è§†é¢‘æ ¼å¼
                    if (item.type === 'video' && item.url) {
                        debugLog('âœ… Found video');
                        return { type: 'video', content: item.url };
                    }

                    // éŸ³é¢‘æ ¼å¼
                    if (item.type === 'audio' && item.url) {
                        debugLog('âœ… Found audio');
                        return { type: 'audio', content: item.url };
                    }
                }
            }

            // æ–¹æ³•2: content æ˜¯å­—ç¬¦ä¸²ï¼Œå¯èƒ½åŒ…å«å„ç§æ ¼å¼
            if (typeof message.content === 'string') {
                debugLog('ğŸ” Checking string content');

                // æ£€æµ‹HTMLä»£ç 
                if (message.content.includes('<!DOCTYPE') ||
                    message.content.includes('<html') ||
                    (message.content.includes('<body') && message.content.includes('</body>'))) {
                    debugLog('âœ… Detected HTML code');
                    return { type: 'html', content: message.content };
                }

                // æ£€æµ‹SVGä»£ç 
                if (message.content.includes('<svg') && message.content.includes('</svg>')) {
                    debugLog('âœ… Detected SVG code');
                    return { type: 'svg', content: message.content };
                }

                // æ£€æµ‹JSONæ•°æ®
                if ((message.content.trim().startsWith('{') && message.content.trim().endsWith('}')) ||
                    (message.content.trim().startsWith('[') && message.content.trim().endsWith(']'))) {
                    try {
                        JSON.parse(message.content);
                        debugLog('âœ… Detected JSON data');
                        return { type: 'json', content: message.content };
                    } catch (e) {
                        // ä¸æ˜¯æœ‰æ•ˆçš„JSONï¼Œç»§ç»­æ£€æŸ¥å…¶ä»–æ ¼å¼
                    }
                }

                // å°è¯•æå–å›¾ç‰‡URL
                const imageUrl = extractImageUrl(message.content);
                if (imageUrl) {
                    debugLog('âœ… Extracted image URL from string');
                    return { type: 'image', content: imageUrl };
                }

                // æ£€æµ‹è§†é¢‘URL
                const videoUrl = extractMediaUrl(message.content, 'video');
                if (videoUrl) {
                    debugLog('âœ… Extracted video URL');
                    return { type: 'video', content: videoUrl };
                }

                // æ£€æµ‹éŸ³é¢‘URL
                const audioUrl = extractMediaUrl(message.content, 'audio');
                if (audioUrl) {
                    debugLog('âœ… Extracted audio URL');
                    return { type: 'audio', content: audioUrl };
                }

                // æ£€æµ‹æ–‡ä»¶ä¸‹è½½é“¾æ¥
                const fileUrl = extractFileUrl(message.content);
                if (fileUrl) {
                    debugLog('âœ… Extracted file download URL');
                    return { type: 'file', content: fileUrl.url, metadata: { filename: fileUrl.filename } };
                }

                // å¦‚æœéƒ½ä¸æ˜¯ï¼Œè¿”å›çº¯æ–‡æœ¬
                if (message.content.length > 0) {
                    debugLog('âœ… Treating as plain text');
                    return { type: 'text', content: message.content };
                }
            }

            // æ–¹æ³•3: æ£€æŸ¥ images æ•°ç»„
            if (Array.isArray(message.images) && message.images.length > 0) {
                debugLog('ğŸ” Checking images array');
                const imageData = message.images[0];
                if (typeof imageData === 'string') {
                    debugLog('âœ… Found images[0] (string)');
                    return { type: 'image', content: imageData };
                }
                if (imageData && typeof imageData === 'object') {
                    // æ£€æŸ¥åµŒå¥—çš„ image_url å¯¹è±¡ï¼ˆFlux/GPTæ ¼å¼ï¼‰
                    if (imageData.image_url) {
                        if (typeof imageData.image_url === 'string') {
                            debugLog('âœ… Found images[0].image_url (string)');
                            return { type: 'image', content: imageData.image_url };
                        }
                        if (imageData.image_url.url) {
                            debugLog('âœ… Found images[0].image_url.url');
                            return { type: 'image', content: imageData.image_url.url };
                        }
                    }
                    // æ£€æŸ¥ç›´æ¥å­—æ®µ
                    if (imageData.url) return { type: 'image', content: imageData.url };
                    if (imageData.data) return { type: 'image', content: imageData.data };
                    if (imageData.b64_json) return { type: 'image', content: `data:image/png;base64,${imageData.b64_json}` };
                }
            }

            // æ–¹æ³•4: ç›´æ¥å­—æ®µ
            if (message.image) {
                debugLog('âœ… Found message.image');
                return { type: 'image', content: message.image };
            }
            if (message.image_url) {
                debugLog('âœ… Found message.image_url');
                return { type: 'image', content: message.image_url };
            }

            // æ–¹æ³•5: æ£€æŸ¥dataå­—æ®µï¼ˆæŸäº›APIå¯èƒ½ä½¿ç”¨ï¼‰
            if (message.data) {
                debugLog('ğŸ” Checking message.data');
                if (typeof message.data === 'string' && message.data.startsWith('data:image')) {
                    debugLog('âœ… Found message.data (base64)');
                    return { type: 'image', content: message.data };
                }
                if (Array.isArray(message.data) && message.data.length > 0) {
                    const firstItem = message.data[0];
                    if (firstItem && (firstItem.url || firstItem.b64_json)) {
                        debugLog('âœ… Found message.data[0].url or b64_json');
                        const content = firstItem.url || `data:image/png;base64,${firstItem.b64_json}`;
                        return { type: 'image', content };
                    }
                }
            }

            // æ–¹æ³•6: æ£€æŸ¥artifactså­—æ®µï¼ˆClaudeç­‰å¯èƒ½ä½¿ç”¨ï¼‰
            if (message.artifacts && Array.isArray(message.artifacts)) {
                debugLog('ğŸ” Checking artifacts array');
                for (const artifact of message.artifacts) {
                    if (artifact.type === 'image' && artifact.data) {
                        debugLog('âœ… Found artifact image');
                        return { type: 'image', content: artifact.data };
                    }
                }
            }

            // æ–¹æ³•7: æ£€æŸ¥attachmentså­—æ®µ
            if (message.attachments && Array.isArray(message.attachments)) {
                debugLog('ğŸ” Checking attachments array');
                for (const attachment of message.attachments) {
                    if (attachment.type === 'image' || attachment.content_type?.startsWith('image/')) {
                        if (attachment.url) {
                            debugLog('âœ… Found attachment.url');
                            return { type: 'image', content: attachment.url };
                        }
                        if (attachment.data) {
                            debugLog('âœ… Found attachment.data');
                            return { type: 'image', content: attachment.data };
                        }
                    }
                }
            }

            // æœªæ‰¾åˆ°
            debugLog('âŒ No content found after checking all methods');
            return null;
        }

        // å›¾ç‰‡URLè§£æå™¨
        function extractImageUrl(text) {
            // æ–¹æ³•1: Markdownæ ¼å¼ ![](url)
            let match = text.match(/!\[.*?\]\((https?:\/\/\S+?\.(?:png|jpg|jpeg|webp|gif))\)/i);
            if (match) return match[1];

            // æ–¹æ³•2: çº¯URL
            match = text.match(/(https?:\/\/\S+?\.(?:png|jpg|jpeg|webp|gif))/i);
            if (match) return match[1];

            // æ–¹æ³•3: data:image base64
            match = text.match(/(data:image\/[a-zA-Z]+;base64,[A-Za-z0-9+/=]+)/);
            if (match) return match[1];

            return null;
        }

        // åª’ä½“URLè§£æå™¨ï¼ˆè§†é¢‘/éŸ³é¢‘ï¼‰
        function extractMediaUrl(text, type) {
            let extensions;
            if (type === 'video') {
                extensions = 'mp4|webm|ogg|mov|avi|mkv';
            } else if (type === 'audio') {
                extensions = 'mp3|wav|ogg|m4a|flac|aac';
            } else {
                return null;
            }

            // Markdownæ ¼å¼
            let match = text.match(new RegExp(`!\\[.*?\\]\\((https?:\\/\\/\\S+?\\.(?:${extensions}))\\)`, 'i'));
            if (match) return match[1];

            // çº¯URL
            match = text.match(new RegExp(`(https?:\\/\\/\\S+?\\.(?:${extensions}))`, 'i'));
            if (match) return match[1];

            return null;
        }

        // æ–‡ä»¶ä¸‹è½½é“¾æ¥è§£æå™¨
        function extractFileUrl(text) {
            // æ£€æµ‹å¸¸è§ä¸‹è½½é“¾æ¥æ ¼å¼
            // æ ¼å¼1: [filename](url)
            let match = text.match(/\[([^\]]+\.(pdf|doc|docx|xls|xlsx|zip|rar|7z))\]\((https?:\/\/[^\)]+)\)/i);
            if (match) return { url: match[3], filename: match[1] };

            // æ ¼å¼2: ç›´æ¥URL
            match = text.match(/(https?:\/\/\S+\.(pdf|doc|docx|xls|xlsx|zip|rar|7z))/i);
            if (match) {
                const url = match[1];
                const filename = url.split('/').pop();
                return { url, filename };
            }

            return null;
        }

        async function generateDescription(model, prompt) {
            const response = await fetch(`${OPENROUTER_API_URL}/chat/completions`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json',
                    'HTTP-Referer': window.location.href,
                    'X-Title': 'AI UI Design Comparator'
                },
                body: JSON.stringify({
                    model: model,
                    messages: [
                        {
                            role: 'user',
                            content: `Based on this UI requirement, create a detailed description for image generation:\n\n${prompt}\n\nProvide a concise, visual description focusing on layout, colors, and UI elements.`
                        }
                    ]
                })
            });

            if (!response.ok) {
                throw new Error('æè¿°ç”Ÿæˆå¤±è´¥');
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        // è¿›åº¦ç›¸å…³
        function addProgressItem(modelKey, status) {
            const config = MODEL_CONFIGS[modelKey];
            const item = document.createElement('div');
            item.id = `progress-${modelKey}`;
            item.className = 'flex items-center glass-dark p-3 rounded-lg';
            item.innerHTML = `
                <div class="spinner mr-3"></div>
                <span class="text-gray-800 font-medium flex-1">${config.name}</span>
                <span class="text-gray-600 text-sm">ç”Ÿæˆä¸­...</span>
            `;
            document.getElementById('progressList').appendChild(item);
        }

        function updateProgressItem(modelKey, status, message = '') {
            const item = document.getElementById(`progress-${modelKey}`);
            if (!item) return;

            if (status === 'success') {
                item.innerHTML = `
                    <span class="text-green-600 text-xl mr-3">âœ“</span>
                    <span class="text-gray-800 font-medium flex-1">${MODEL_CONFIGS[modelKey].name}</span>
                    <span class="text-green-600 text-sm font-medium">å®Œæˆ</span>
                `;
            } else if (status === 'error') {
                item.innerHTML = `
                    <span class="text-red-600 text-xl mr-3">âœ—</span>
                    <span class="text-gray-800 font-medium flex-1">${MODEL_CONFIGS[modelKey].name}</span>
                    <span class="text-red-600 text-sm">${message || 'å¤±è´¥'}</span>
                `;
            }
        }

        // ç»“æœç›¸å…³ - é€šç”¨å†…å®¹æ¸²æŸ“å™¨
        function addResultCard(modelName, result, cost, isError = false, errorMsg = '') {
            // ä¿å­˜ç»“æœï¼ˆå…¼å®¹æ—§æ ¼å¼å’Œæ–°æ ¼å¼ï¼‰
            const resultData = result && result.type ? result : { type: 'unknown', content: result };
            currentResults.push({ modelName, result: resultData, cost, isError, errorMsg });

            const card = document.createElement('div');
            card.className = 'image-card glass-dark rounded-2xl overflow-hidden';

            if (isError) {
                // é”™è¯¯å¡ç‰‡
                const errorDiv = document.createElement('div');
                errorDiv.className = 'aspect-square bg-red-50 flex items-center justify-center p-6';
                errorDiv.innerHTML = `
                    <div class="text-center">
                        <div class="text-4xl mb-2">âŒ</div>
                        <div class="text-red-600 text-sm font-medium mb-2">ç”Ÿæˆå¤±è´¥</div>
                        <div class="text-gray-600 text-xs">${errorMsg}</div>
                    </div>
                `;
                
                const infoDiv = document.createElement('div');
                infoDiv.className = 'p-4';
                infoDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-800 font-semibold">${modelName}</span>
                        <span class="text-gray-600 text-sm">$${cost.toFixed(2)}</span>
                    </div>
                    <button class="w-full glass text-gray-800 font-medium text-sm py-2 rounded-lg hover:bg-white/30 transition">
                        ğŸ”„ é‡è¯•
                    </button>
                `;
                infoDiv.querySelector('button').onclick = () => retryModel(modelName);
                
                card.appendChild(errorDiv);
                card.appendChild(infoDiv);
            } else {
                console.log('ğŸ“¦ Creating result card for:', modelName);
                console.log('ğŸ“¦ Content type:', resultData.type);
                console.log('ğŸ“¦ Content length:', resultData.content ? resultData.content.length : 0);

                // åˆ›å»ºå†…å®¹å®¹å™¨
                const contentContainer = document.createElement('div');

                // æ ¹æ®å†…å®¹ç±»å‹æ¸²æŸ“
                switch (resultData.type) {
                    case 'image':
                        renderImageContent(contentContainer, resultData.content, modelName);
                        break;
                    case 'html':
                        renderHtmlContent(contentContainer, resultData.content, modelName);
                        break;
                    case 'svg':
                        renderSvgContent(contentContainer, resultData.content, modelName);
                        break;
                    case 'json':
                        renderJsonContent(contentContainer, resultData.content, modelName);
                        break;
                    case 'text':
                        renderTextContent(contentContainer, resultData.content, modelName);
                        break;
                    case 'video':
                        renderVideoContent(contentContainer, resultData.content, modelName);
                        break;
                    case 'audio':
                        renderAudioContent(contentContainer, resultData.content, modelName);
                        break;
                    case 'file':
                        renderFileContent(contentContainer, resultData.content, resultData.metadata, modelName);
                        break;
                    default:
                        renderUnknownContent(contentContainer, resultData.content, modelName);
                }

                // åˆ›å»ºä¿¡æ¯æ 
                const infoDiv = createInfoBar(modelName, cost, resultData.type, resultData.content, contentContainer);

                card.appendChild(contentContainer);
                card.appendChild(infoDiv);
            }

            document.getElementById('resultsGrid').appendChild(card);
        }

        // å›¾ç‰‡å†…å®¹æ¸²æŸ“å™¨
        function renderImageContent(container, imageUrl, modelName) {
            container.className = 'aspect-square bg-gray-100 relative';

            const img = document.createElement('img');
            img.className = 'w-full h-full object-cover';
            img.alt = modelName;

            img.onload = function() {
                console.log('âœ… å›¾ç‰‡åŠ è½½æˆåŠŸ:', modelName);
            };

            img.onerror = function() {
                console.error('âŒ å›¾ç‰‡åŠ è½½å¤±è´¥:', modelName);
                container.innerHTML = `
                    <div class="w-full h-full flex flex-col items-center justify-center p-4">
                        <div class="text-4xl mb-2">âš ï¸</div>
                        <div class="text-gray-600 text-xs text-center mb-2">å›¾ç‰‡åŠ è½½å¤±è´¥</div>
                        <div class="text-gray-500 text-xs text-center mb-2">æ•°æ®é•¿åº¦: ${imageUrl.length}</div>
                    </div>
                `;
            };

            img.src = imageUrl;
            container.appendChild(img);
            container.style.cursor = 'pointer';
            container.onclick = () => showImageModal(imageUrl);
        }

        // HTMLä»£ç æ¸²æŸ“å™¨
        function renderHtmlContent(container, htmlCode, modelName) {
            container.className = 'aspect-square bg-white relative';

            const iframe = document.createElement('iframe');
            iframe.className = 'w-full h-full border-0';
            iframe.sandbox = 'allow-scripts allow-same-origin';  // æ·»åŠ allow-same-originä»¥æ”¯æŒé•¿å›¾æˆªå–
            iframe.srcdoc = htmlCode;

            container.appendChild(iframe);
            container.style.cursor = 'pointer';
            container.onclick = () => showHtmlModal(htmlCode, modelName);
        }

        // SVGä»£ç æ¸²æŸ“å™¨
        function renderSvgContent(container, svgCode, modelName) {
            container.className = 'aspect-square bg-white flex items-center justify-center p-4';
            container.innerHTML = svgCode;
            container.style.cursor = 'pointer';
            container.onclick = () => showCodeModal('SVG', svgCode, modelName);
        }

        // JSONæ•°æ®æ¸²æŸ“å™¨
        function renderJsonContent(container, jsonData, modelName) {
            container.className = 'aspect-square bg-gray-50 overflow-auto p-4';
            const pre = document.createElement('pre');
            pre.className = 'text-xs text-gray-800 whitespace-pre-wrap';
            try {
                const formatted = JSON.stringify(JSON.parse(jsonData), null, 2);
                pre.textContent = formatted;
            } catch (e) {
                pre.textContent = jsonData;
            }
            container.appendChild(pre);
            container.style.cursor = 'pointer';
            container.onclick = () => showCodeModal('JSON', jsonData, modelName);
        }

        // çº¯æ–‡æœ¬æ¸²æŸ“å™¨
        function renderTextContent(container, textContent, modelName) {
            container.className = 'aspect-square bg-gray-50 overflow-auto p-4';
            const pre = document.createElement('pre');
            pre.className = 'text-sm text-gray-800 whitespace-pre-wrap';
            pre.textContent = textContent;
            container.appendChild(pre);
            container.style.cursor = 'pointer';
            container.onclick = () => showCodeModal('Text', textContent, modelName);
        }

        // è§†é¢‘å†…å®¹æ¸²æŸ“å™¨
        function renderVideoContent(container, videoUrl, modelName) {
            container.className = 'aspect-square bg-black flex items-center justify-center';
            const video = document.createElement('video');
            video.className = 'w-full h-full';
            video.controls = true;
            video.src = videoUrl;
            container.appendChild(video);
        }

        // éŸ³é¢‘å†…å®¹æ¸²æŸ“å™¨
        function renderAudioContent(container, audioUrl, modelName) {
            container.className = 'aspect-square bg-gray-100 flex items-center justify-center p-8';
            const audioContainer = document.createElement('div');
            audioContainer.className = 'w-full text-center';
            audioContainer.innerHTML = `
                <div class="text-6xl mb-4">ğŸµ</div>
                <audio controls class="w-full">
                    <source src="${audioUrl}">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾
                </audio>
            `;
            container.appendChild(audioContainer);
        }

        // æ–‡ä»¶ä¸‹è½½é“¾æ¥æ¸²æŸ“å™¨
        function renderFileContent(container, fileUrl, metadata, modelName) {
            container.className = 'aspect-square bg-blue-50 flex items-center justify-center p-8';
            const filename = metadata?.filename || 'ä¸‹è½½æ–‡ä»¶';
            container.innerHTML = `
                <div class="text-center">
                    <div class="text-6xl mb-4">ğŸ“¦</div>
                    <div class="text-gray-800 font-medium mb-2">${filename}</div>
                    <a href="${fileUrl}" download="${filename}"
                       class="inline-block glass text-gray-800 font-medium text-sm py-2 px-4 rounded-lg hover:bg-white/30 transition">
                        ä¸‹è½½æ–‡ä»¶
                    </a>
                </div>
            `;
        }

        // æœªçŸ¥ç±»å‹æ¸²æŸ“å™¨
        function renderUnknownContent(container, content, modelName) {
            container.className = 'aspect-square bg-yellow-50 flex items-center justify-center p-6';
            container.innerHTML = `
                <div class="text-center">
                    <div class="text-4xl mb-2">â“</div>
                    <div class="text-gray-700 text-sm font-medium mb-2">æœªçŸ¥å†…å®¹ç±»å‹</div>
                    <div class="bg-white/50 p-2 rounded text-left max-h-32 overflow-auto">
                        <pre class="text-xs">${content ? content.substring(0, 200) : 'æ— æ•°æ®'}</pre>
                    </div>
                </div>
            `;
        }

        // åˆ›å»ºä¿¡æ¯æ 
        function createInfoBar(modelName, cost, contentType, content, contentContainer = null) {
            const infoDiv = document.createElement('div');
            infoDiv.className = 'p-4';

            // ç±»å‹å›¾æ ‡æ˜ å°„
            const typeIcons = {
                image: 'ğŸ–¼ï¸',
                html: 'ğŸ“„',
                svg: 'ğŸ¨',
                json: '{}',
                text: 'ğŸ“',
                video: 'ğŸ¬',
                audio: 'ğŸµ',
                file: 'ğŸ“¦'
            };

            const buttons = [];

            // æ ¹æ®ç±»å‹æ·»åŠ ä¸åŒçš„æ“ä½œæŒ‰é’®
            if (contentType === 'image') {
                buttons.push('<button class="download-btn flex-1 glass text-gray-800 font-medium text-xs py-2 rounded-lg hover:bg-white/30 transition">â¬‡ï¸ ä¸‹è½½</button>');
            } else if (contentType === 'html' || contentType === 'svg') {
                buttons.push('<button class="copy-image-btn flex-1 glass text-gray-800 font-medium text-xs py-2 rounded-lg hover:bg-white/30 transition">ğŸ–¼ï¸ å¤åˆ¶å›¾ç‰‡</button>');
                buttons.push('<button class="download-btn flex-1 glass text-gray-800 font-medium text-xs py-2 rounded-lg hover:bg-white/30 transition">â¬‡ï¸ ä¸‹è½½ä»£ç </button>');
                buttons.push('<button class="copy-btn flex-1 glass text-gray-800 font-medium text-xs py-2 rounded-lg hover:bg-white/30 transition">ğŸ“‹ å¤åˆ¶ä»£ç </button>');
            } else if (contentType === 'json' || contentType === 'text') {
                buttons.push('<button class="copy-btn flex-1 glass text-gray-800 font-medium text-xs py-2 rounded-lg hover:bg-white/30 transition">ğŸ“‹ å¤åˆ¶</button>');
            }

            infoDiv.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <span class="text-gray-800 font-semibold">${typeIcons[contentType] || 'ğŸ“„'} ${modelName}</span>
                    <span class="text-gray-600 text-sm">$${cost.toFixed(2)}</span>
                </div>
                ${buttons.length > 0 ? `<div class="flex gap-2">${buttons.join('')}</div>` : ''}
            `;

            // ç»‘å®šäº‹ä»¶
            setTimeout(() => {
                const downloadBtn = infoDiv.querySelector('.download-btn');
                const copyBtn = infoDiv.querySelector('.copy-btn');
                const copyImageBtn = infoDiv.querySelector('.copy-image-btn');

                if (downloadBtn) {
                    downloadBtn.onclick = (e) => {
                        e.stopPropagation();
                        downloadContent(content, contentType, modelName);
                    };
                }

                if (copyBtn) {
                    copyBtn.onclick = (e) => {
                        e.stopPropagation();
                        copyContentToClipboard(content, modelName);
                    };
                }

                if (copyImageBtn && contentContainer) {
                    copyImageBtn.onclick = async (e) => {
                        e.stopPropagation();
                        await copyAsImage(contentContainer, modelName, contentType);
                    };
                }
            }, 0);

            return infoDiv;
        }

        // ä¸‹è½½å†…å®¹
        function downloadContent(content, type, modelName) {
            let blob, filename;

            switch (type) {
                case 'image':
                    downloadImage(content, modelName);
                    return;
                case 'html':
                    blob = new Blob([content], { type: 'text/html' });
                    filename = `${modelName}_${Date.now()}.html`;
                    break;
                case 'svg':
                    blob = new Blob([content], { type: 'image/svg+xml' });
                    filename = `${modelName}_${Date.now()}.svg`;
                    break;
                default:
                    return;
            }

            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // å¤åˆ¶å†…å®¹åˆ°å‰ªè´´æ¿
        function copyContentToClipboard(content, modelName) {
            navigator.clipboard.writeText(content).then(() => {
                alert('âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                alert('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æŸ¥çœ‹Console');
            });
        }

        // å¤åˆ¶æ¸²æŸ“åçš„å†…å®¹ä¸ºå›¾ç‰‡ï¼ˆä½¿ç”¨ç¦»å±iframeæ–¹æ¡ˆï¼‰
        async function copyAsImage(container, modelName, contentType) {
            // æ˜¾ç¤ºåŠ è½½æç¤º
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'absolute inset-0 bg-black/50 flex items-center justify-center z-50';
            loadingDiv.innerHTML = '<div class="text-white text-sm font-bold">æ­£åœ¨ç”Ÿæˆé•¿å›¾...</div>';
            container.style.position = 'relative';
            container.appendChild(loadingDiv);

            try {
                console.log('ğŸ“¸ ç¦»å±iframeæˆªå›¾å¼€å§‹:', modelName, contentType);

                // è·å–è¦æˆªå›¾çš„å†…å®¹
                let contentHTML = '';

                if (contentType === 'html') {
                    const iframe = container.querySelector('iframe');
                    if (iframe && iframe.srcdoc) {
                        contentHTML = iframe.srcdoc;
                    } else {
                        throw new Error('æ— æ³•è·å–HTMLå†…å®¹');
                    }
                } else if (contentType === 'svg') {
                    contentHTML = container.innerHTML;
                } else {
                    throw new Error('ä¸æ”¯æŒçš„å†…å®¹ç±»å‹: ' + contentType);
                }

                console.log('ğŸ“¦ å†…å®¹é•¿åº¦:', contentHTML.length);

                // åˆ›å»ºç¦»å±iframe
                const offscreenIframe = document.createElement('iframe');
                offscreenIframe.style.cssText = `
                    position: fixed;
                    left: -9999px;
                    top: 0;
                    width: 1200px;
                    height: auto;
                    border: none;
                    background: white;
                `;
                document.body.appendChild(offscreenIframe);

                // å‡†å¤‡iframeå†…å®¹
                const iframeDoc = offscreenIframe.contentDocument || offscreenIframe.contentWindow.document;

                // æ„å»ºå®Œæ•´çš„HTMLæ–‡æ¡£
                const fullHTML = contentType === 'svg'
                    ? `<!DOCTYPE html>
                       <html>
                       <head>
                           <meta charset="UTF-8">
                           <style>
                               body { margin: 0; padding: 20px; background: white; }
                               svg { max-width: 100%; height: auto; }
                           </style>
                       </head>
                       <body>${contentHTML}</body>
                       </html>`
                    : contentHTML;

                iframeDoc.open();
                iframeDoc.write(fullHTML);
                iframeDoc.close();

                // ç­‰å¾…å†…å®¹åŠ è½½å®Œæˆ
                await new Promise((resolve) => {
                    if (iframeDoc.readyState === 'complete') {
                        resolve();
                    } else {
                        offscreenIframe.onload = resolve;
                        setTimeout(resolve, 2000); // æœ€å¤šç­‰2ç§’
                    }
                });

                // ç­‰å¾…èµ„æºåŠ è½½ï¼ˆå›¾ç‰‡ã€å­—ä½“ç­‰ï¼‰
                await new Promise(resolve => setTimeout(resolve, 500));

                // è·å–å†…å®¹çš„çœŸå®é«˜åº¦
                const body = iframeDoc.body;
                const html = iframeDoc.documentElement;
                const contentHeight = Math.max(
                    body.scrollHeight,
                    body.offsetHeight,
                    html.scrollHeight,
                    html.offsetHeight
                );

                console.log('ğŸ“ ç¦»å±å†…å®¹é«˜åº¦:', contentHeight, 'px');

                // è°ƒæ•´iframeé«˜åº¦ä»¥é€‚åº”å†…å®¹
                offscreenIframe.style.height = contentHeight + 'px';

                // ç­‰å¾…é«˜åº¦è°ƒæ•´åé‡æ–°æ¸²æŸ“
                await new Promise(resolve => setTimeout(resolve, 100));

                // åœ¨iframeå†…åŠ è½½å¹¶æ‰§è¡Œhtml2canvas
                console.log('ğŸ¨ å¼€å§‹ç¦»å±æˆªå›¾...');

                const canvas = await html2canvas(iframeDoc.body, {
                    backgroundColor: '#ffffff',
                    scale: 2,
                    logging: false,
                    useCORS: true,
                    allowTaint: true,
                    width: 1200,
                    height: contentHeight,
                    windowWidth: 1200,
                    windowHeight: contentHeight
                });

                console.log('âœ… æˆªå›¾å®Œæˆï¼Œå°ºå¯¸:', canvas.width, 'x', canvas.height);

                // æ¸…ç†ç¦»å±iframe
                document.body.removeChild(offscreenIframe);

                // ç§»é™¤åŠ è½½æç¤º
                container.removeChild(loadingDiv);

                // å°†canvasè½¬æ¢ä¸ºblobå¹¶å¤åˆ¶
                canvas.toBlob(async (blob) => {
                    try {
                        await navigator.clipboard.write([
                            new ClipboardItem({ 'image/png': blob })
                        ]);
                        alert(`âœ… é•¿å›¾å·²å¤åˆ¶åˆ°å‰ªè´´æ¿\nå°ºå¯¸: ${canvas.width} x ${canvas.height}`);
                        console.log('âœ… é•¿å›¾å¤åˆ¶æˆåŠŸ');
                    } catch (err) {
                        console.error('âŒ å‰ªè´´æ¿å†™å…¥å¤±è´¥:', err);
                        // é™çº§æ–¹æ¡ˆï¼šä¸‹è½½
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `${modelName}_${Date.now()}.png`;
                        a.click();
                        URL.revokeObjectURL(url);
                        alert('âš ï¸ æ— æ³•å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œå·²è‡ªåŠ¨ä¸‹è½½å›¾ç‰‡');
                    }
                }, 'image/png');

            } catch (error) {
                console.error('âŒ æˆªå›¾å¤±è´¥:', error);
                alert('âŒ æˆªå›¾å¤±è´¥: ' + error.message);
                // æ¸…ç†åŠ è½½æç¤º
                if (loadingDiv && loadingDiv.parentNode) {
                    container.removeChild(loadingDiv);
                }
            }
        }

        // æ˜¾ç¤ºHTMLæ¨¡æ€æ¡†
        function showHtmlModal(htmlCode, modelName) {
            // åˆ›å»ºå…¨å±æ¨¡æ€æ¡†æ˜¾ç¤ºHTML
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50';
            modal.innerHTML = `
                <div class="glass rounded-3xl p-6 max-w-6xl w-full max-h-[90vh] overflow-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">${modelName} - HTMLé¢„è§ˆ</h3>
                        <button class="close-btn text-gray-800 font-bold text-2xl">&times;</button>
                    </div>
                    <iframe class="w-full h-[70vh] border-0 rounded-xl bg-white" sandbox="allow-scripts"></iframe>
                </div>
            `;
            document.body.appendChild(modal);

            const iframe = modal.querySelector('iframe');
            iframe.srcdoc = htmlCode;

            modal.onclick = (e) => {
                if (e.target === modal || e.target.classList.contains('close-btn')) {
                    document.body.removeChild(modal);
                }
            };
        }

        // æ˜¾ç¤ºä»£ç æ¨¡æ€æ¡†
        function showCodeModal(type, code, modelName) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50';
            modal.innerHTML = `
                <div class="glass rounded-3xl p-6 max-w-4xl w-full max-h-[90vh] overflow-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">${modelName} - ${type}</h3>
                        <button class="close-btn text-gray-800 font-bold text-2xl">&times;</button>
                    </div>
                    <pre class="bg-gray-100 p-4 rounded-xl text-sm overflow-auto max-h-[70vh]">${code}</pre>
                </div>
            `;
            document.body.appendChild(modal);

            modal.onclick = (e) => {
                if (e.target === modal || e.target.classList.contains('close-btn')) {
                    document.body.removeChild(modal);
                }
            };
        }

        // æ˜¾ç¤ºåŸå§‹æ•°æ®ï¼ˆè°ƒè¯•ç”¨ï¼‰
        function showRawData(modelName) {
            const resultItem = currentResults.find(r => r.modelName === modelName);
            if (!resultItem) {
                alert('æœªæ‰¾åˆ°æ•°æ®');
                return;
            }

            const result = resultItem.result;
            const content = result.content;
            const len = content ? content.length : 0;

            console.log('='.repeat(50));
            console.log('æ¨¡å‹:', modelName);
            console.log('å†…å®¹ç±»å‹:', result.type);
            console.log('æ•°æ®é•¿åº¦:', len);
            console.log('å®Œæ•´æ•°æ®:', content);
            console.log('='.repeat(50));

            alert(`æ¨¡å‹: ${modelName}\nç±»å‹: ${result.type}\n\næ•°æ®é•¿åº¦: ${len} å­—ç¬¦\n\nå‰500ä¸ªå­—ç¬¦:\n${content ? content.substring(0, 500) : 'æ— æ•°æ®'}\n\nå®Œæ•´æ•°æ®å·²è¾“å‡ºåˆ°Console`);
        }

        // å…¼å®¹æ—§ä»£ç çš„copyToClipboard
        function copyToClipboard(modelName) {
            const resultItem = currentResults.find(r => r.modelName === modelName);
            if (!resultItem || !resultItem.result) {
                alert('æ— æ•°æ®å¯å¤åˆ¶');
                return;
            }

            copyContentToClipboard(resultItem.result.content, modelName);
        }

        function retryModel(modelName) {
            // æ‰¾åˆ°å¯¹åº”çš„æ¨¡å‹key
            const modelKey = Object.keys(MODEL_CONFIGS).find(
                key => MODEL_CONFIGS[key].name === modelName
            );
            
            if (!modelKey) {
                alert('æ¨¡å‹æœªæ‰¾åˆ°');
                return;
            }
            
            // è·å–å½“å‰prompt
            const prompt = document.getElementById('promptInput').value.trim();
            if (!prompt) {
                alert('è¯·è¾“å…¥UIè®¾è®¡éœ€æ±‚');
                return;
            }

            // è·å–å¹³å°é€‰æ‹©
            const platformRadio = document.querySelector('input[name="platform"]:checked');
            const platform = platformRadio ? platformRadio.value : 'mobile';
            const platformText = platform === 'mobile' ? 'mobile app (iOS/Android)' : 'desktop web application';
            const platformTitle = platform === 'mobile' ? 'mobile app UI design' : 'desktop web UI design';

            // é‡æ–°ç”Ÿæˆ
            const optimizedPrompt = `Create a clean, modern ${platformTitle}.

User requirements: ${prompt}

Design constraints:
- Style: flat design, minimalist, professional interface
- Platform: ${platformText}
- Layout: clear visual hierarchy, proper spacing
- Elements: realistic UI components (buttons, inputs, cards)
- Colors: harmonious color scheme
- Output: high-fidelity UI mockup, NOT illustration

Avoid: 3D elements, realistic photos, cartoon style`;

            generateWithModel(modelKey, optimizedPrompt);
        }

        function showImageModal(imageUrl) {
            document.getElementById('modalImage').src = imageUrl;
            document.getElementById('imageModal').classList.remove('hidden');
            document.getElementById('imageModal').classList.add('flex');
        }

        function closeImageModal() {
            document.getElementById('imageModal').classList.add('hidden');
            document.getElementById('imageModal').classList.remove('flex');
        }

        async function downloadImage(url, modelName) {
            try {
                const response = await fetch(url);
                const blob = await response.blob();
                const downloadUrl = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = `${modelName}_${Date.now()}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(downloadUrl);
            } catch (error) {
                console.error('ä¸‹è½½å¤±è´¥:', error);
                alert('âš ï¸ ä¸‹è½½å¤±è´¥ï¼Œè¯·å³é”®ä¿å­˜å›¾ç‰‡');
            }
        }
    </script>
</body>
</html>
